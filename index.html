<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Rowing Coach v1.6</title>
    <!-- Capacitor Core -->
    <script src="capacitor.js"></script>
    
    <!-- Firebase SDK v9+ (Modular) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, getDocs, deleteDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
        
        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAdwuu17GMfX_jiVyx5SOL_jmvrybq0uuo",
            authDomain: "ai-fitness-app-c5307.firebaseapp.com",
            projectId: "ai-fitness-app-c5307",
            storageBucket: "ai-fitness-app-c5307.firebasestorage.app",
            messagingSenderId: "462148834440",
            appId: "1:462148834440:web:32be31f4ae6f76e144bb3d"
        };
        
        // Initialize Firebase and make available globally
        const app = initializeApp(firebaseConfig);
        window.firebaseApp = app;
        window.firebaseAuth = getAuth(app);
        window.firebaseDb = getFirestore(app);
        window.firebaseModules = {
            signInAnonymously,
            onAuthStateChanged,
            doc,
            setDoc,
            getDoc,
            collection,
            query,
            orderBy,
            getDocs,
            deleteDoc,
            serverTimestamp
        };
        
        console.log('‚úì Firebase modules loaded');
    </script>
    
    <style>
        :root {
            --bg: #000;
            --text: #e0e0e0;
            --accent: #00FF99;
            --danger: #FF4444;
            --panel: #111;
            --border: #222;
            --card-bg: #0a0a0a;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .version-badge {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 255, 153, 0.2);
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 700;
            z-index: 10000;
        }
        
        /* TOP NAVIGATION */
        .top-nav-bar {
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            height: 70px;
            flex-shrink: 0;
        }
        
        .top-nav-item {
            flex: 1;
            background: transparent;
            border: none;
            color: #666;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: all 0.2s;
        }
        
        .top-nav-item.active {
            color: var(--accent);
            background: rgba(0,255,153,0.05);
        }
        
        .top-nav-icon { font-size: 20px; }
        
        .top-nav-label { font-size: 10px; letter-spacing: 0.5px; }
        
        .toast {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--panel);
            color: var(--text);
            padding: 12px 24px;
            border-radius: 8px;
            border: 1px solid var(--border);
            z-index: 9999;
            opacity: 0;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 600;
            max-width: 90%;
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        .toast.success { border-color: var(--accent); color: var(--accent); }
        .toast.error { border-color: var(--danger); color: var(--danger); }
        
        .screen {
            display: none;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }
        
        .screen.active { display: flex; }
        
        .screen-header {
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        
        .screen-title {
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 1.5px;
            color: #666;
            text-transform: uppercase;
            flex: 1;
            text-align: center;
        }
        
        .header-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 12px 20px;
            min-height: 44px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .scroll-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 16px;
            padding-bottom: 100px;
        }
        
        /* DASHBOARD - SWIPEABLE VIEWS */
        .dashboard-container {
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        .dashboard-carousel {
            display: flex;
            height: 100%;
            transition: transform 0.3s ease;
        }
        
        .dashboard-view {
            min-width: 100%;
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .dashboard-dots {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            z-index: 100;
        }
        
        .dashboard-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #333;
            transition: all 0.3s;
        }
        
        .dashboard-dot.active {
            background: var(--accent);
            width: 24px;
            border-radius: 4px;
        }
        
        /* AI COACH WIDGET */
        .ai-coach-widget {
            background: linear-gradient(135deg, #0a1a0a, #0a0a0a);
            border: 2px solid var(--accent);
            border-radius: 12px;
            padding: 16px;
            margin: 16px;
            box-shadow: 0 4px 20px rgba(0,255,153,0.1);
        }
        
        .ai-coach-message {
            font-size: 16px;
            line-height: 1.5;
            color: var(--text);
            font-weight: 600;
        }
        
        /* HR ZONE BAR */
        .hr-zone-sidebar {
            position: fixed;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 60px;
            height: 300px;
            background: rgba(0,0,0,0.8);
            border: 1px solid var(--border);
            border-radius: 12px 0 0 12px;
            display: flex;
            flex-direction: column;
            padding: 8px;
            z-index: 50;
        }
        
        .hr-zone-segment {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700;
            opacity: 0.3;
            transition: all 0.3s;
            border-radius: 6px;
            margin: 2px 0;
        }
        
        .hr-zone-segment.active {
            opacity: 1;
            transform: scale(1.1);
        }
        
        /* METRICS GRID */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1px;
            background: #222;
            margin: 16px;
        }
        
        .metric-item {
            background: #0a0a0a;
            padding: 20px 16px;
            text-align: center;
        }
        
        .metric-label {
            font-size: 10px;
            color: #666;
            font-weight: 700;
            margin-bottom: 6px;
        }
        
        .metric-value {
            font-size: 28px;
            font-weight: 900;
            color: var(--text);
            font-variant-numeric: tabular-nums;
        }
        
        .metric-value.accent {
            color: var(--accent);
        }
        
        /* LARGE PRINT VIEW */
        .large-print-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            padding: 20px;
        }
        
        .large-print-metric {
            text-align: center;
            margin-bottom: 32px;
        }
        
        .large-print-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .large-print-value {
            font-size: 72px;
            font-weight: 900;
            line-height: 1;
            color: var(--accent);
        }
        
        /* BUILDER */
        .builder-mode-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .builder-mode-btn {
            padding: 16px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 13px;
            font-weight: 700;
            text-align: center;
            cursor: pointer;
        }
        
        .builder-mode-btn.active {
            background: var(--accent);
            color: #000;
        }
        
        .builder-section {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }
        
        .builder-section-title {
            font-size: 11px;
            font-weight: 700;
            color: var(--accent);
            text-transform: uppercase;
            margin-bottom: 16px;
        }
        
        .builder-input-group {
            margin-bottom: 16px;
        }
        
        .builder-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 6px;
            font-weight: 700;
        }
        
        .builder-input {
            width: 100%;
            background: #000;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 12px;
            border-radius: 6px;
            font-size: 15px;
        }
        
        .builder-time-picker {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .builder-time-input {
            flex: 1;
            background: #000;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 12px;
            border-radius: 6px;
            font-size: 18px;
            text-align: center;
            font-weight: 700;
        }
        
        .builder-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #050505;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 8px;
        }
        
        .builder-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
        }
        
        .builder-checkbox.checked {
            background: var(--accent);
            border-color: var(--accent);
            color: #000;
        }
        
        .builder-interval-list {
            margin-top: 16px;
        }
        
        .builder-interval-item {
            background: #050505;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
        }
        
        .builder-interval-item.editable {
            border-color: var(--accent);
            background: #0a0a0a;
        }
        
        .builder-interval-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .builder-interval-title {
            font-size: 13px;
            font-weight: 700;
        }
        
        .builder-interval-actions {
            display: flex;
            gap: 8px;
        }
        
        .builder-icon-btn {
            width: 32px;
            height: 32px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text);
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .builder-interval-edit {
            display: none;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }
        
        .builder-interval-item.editable .builder-interval-edit {
            display: block;
        }
        
        /* REVIEW SCREEN */
        .review-workout-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--accent);
            margin: 16px;
            text-align: center;
        }
        
        .review-interval {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            margin: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .review-interval-info {
            flex: 1;
        }
        
        .review-interval-title {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .review-interval-desc {
            font-size: 12px;
            color: #666;
        }
        
        .review-actions {
            padding: 16px;
            display: flex;
            gap: 12px;
        }
        
        .btn {
            width: 100%;
            padding: 16px;
            min-height: 48px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-sm {
            padding: 10px 16px;
            min-height: 44px;
            font-size: 13px;
        }

        .btn-primary { background: var(--accent); color: #000; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        
        /* CARDS */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }
        
        .card-header {
            font-size: 11px;
            font-weight: 700;
            color: var(--accent);
            text-transform: uppercase;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }
        
        .editable-field {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .editable-label {
            font-size: 12px;
            color: #666;
            width: 80px;
        }
        
        .editable-input {
            flex: 1;
            background: #000;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 10px;
            border-radius: 6px;
            font-size: 15px;
        }
        
        /* HISTORY */
        .history-item {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            position: relative;
        }
        
        .history-delete {
            position: absolute;
            top: 12px;
            right: 12px;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--danger);
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
        }
        
        .history-date {
            font-size: 11px;
            color: #666;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .history-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 8px;
            padding-right: 60px;
        }
        
        .history-stats {
            display: flex;
            gap: 16px;
            font-size: 12px;
            color: var(--accent);
            font-family: monospace;
            flex-wrap: wrap;
        }
        
        /* STATS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .stat-item {
            background: #050505;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
            text-align: center;
        }
        
        .stat-item-value {
            font-size: 20px;
            font-weight: 900;
            color: var(--accent);
        }
        
        .stat-item-label {
            font-size: 10px;
            color: #666;
            margin-top: 4px;
            text-transform: uppercase;
        }
        
        /* NAVIGATION */
        .nav-bar {
            background: var(--panel);
            border-top: 1px solid var(--border);
            display: flex;
            height: 70px;
            flex-shrink: 0;
        }
        
        .nav-item {
            flex: 1;
            background: transparent;
            border: none;
            color: #666;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .nav-item.active {
            color: var(--accent);
            background: rgba(0,255,153,0.05);
        }
        
        .nav-icon { font-size: 20px; }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        /* TRAINING PLAN */
        .plan-week {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .plan-week-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .plan-week-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--accent);
        }
        
        .plan-week-focus {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
        }
        
        .plan-day {
            background: #050505;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .plan-day-info {
            flex: 1;
        }
        
        .plan-day-title {
            font-size: 13px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 4px;
        }
        
        .plan-day-desc {
            font-size: 11px;
            color: #666;
        }
        
        .plan-day-status {
            font-size: 10px;
            padding: 4px 8px;
            border-radius: 12px;
            background: #222;
            color: #666;
        }
        
        .plan-day-status.completed {
            background: rgba(0,255,153,0.1);
            color: var(--accent);
        }
        
        /* CHAT MESSAGES */
        .chat-message {
            max-width: 85%;
            padding: 14px 18px;
            border-radius: 16px;
            line-height: 1.5;
            font-size: 15px;
            margin-bottom: 12px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .chat-message.user {
            background: #0d3a2e;
            border: 1px solid #1a4a3e;
            margin-left: auto;
            border-radius: 16px 16px 4px 16px;
        }
        
        .chat-message.ai {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-left: 3px solid var(--accent);
            border-radius: 16px 16px 16px 4px;
        }
        
        .chat-header {
            font-size: 11px;
            font-weight: 700;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--accent);
        }
        
        .chat-message.user .chat-header {
            color: #00AAFF;
        }
        
        .quick-replies {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }
        
        .quick-reply-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-10px); opacity: 1; }
        }
        
        /* MOBILE RESPONSIVE */
        @media (max-width: 768px) {
            .metrics-grid {
                gap: 2px;
                margin: 8px;
            }
            
            .metric-item {
                padding: 16px 12px;
            }
            
            .metric-value {
                font-size: 24px;
            }
            
            .large-print-value {
                font-size: 56px;
            }
            
            .ai-coach-widget {
                margin: 8px;
                padding: 12px;
            }
            
            .ai-coach-message {
                font-size: 14px;
            }
            
            .scroll-content {
                padding: 8px;
            }

            .card {
                padding: 16px;
            }
        }

        /* ========================================
           DNA FACT SHEET - CORTEX BRANDING
           ======================================== */

        /* Safety Header - Blood Red Border */
        .dna-safety-section {
            background: var(--panel);
            border: 2px solid #FF0000;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .dna-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-size: 18px;
            font-weight: bold;
        }

        .dna-status-indicator {
            font-size: 24px;
            animation: pulse 2s ease-in-out infinite;
        }

        .dna-status-indicator.ready {
            color: #00FF99;
        }

        .dna-status-indicator.caution {
            color: #FF0000;
        }

        .dna-medical-flags {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .dna-flag {
            color: #FF4444;
            font-size: 14px;
            padding: 8px;
            background: rgba(255, 0, 0, 0.1);
            border-radius: 4px;
        }

        /* Performance Benchmarks - Neon Green */
        .dna-benchmarks-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .dna-benchmark {
            text-align: center;
            padding: 16px;
            background: rgba(0, 255, 153, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(0, 255, 153, 0.2);
        }

        .dna-benchmark-label {
            color: #888;
            font-size: 12px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .dna-benchmark-value {
            color: #00FF99;
            font-size: 36px;
            font-weight: bold;
            line-height: 1;
            margin-bottom: 4px;
        }

        .dna-benchmark-total {
            color: #666;
            font-size: 14px;
        }

        /* Lifestyle & Recovery */
        .dna-lifestyle-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .dna-lifestyle-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .dna-lifestyle-label {
            color: #888;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .dna-lifestyle-bar {
            background: #222;
            height: 24px;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .dna-lifestyle-fill {
            background: #00FF99;
            height: 100%;
            transition: width 0.3s ease;
        }

        .dna-lifestyle-fill.stress {
            background: #FF9900;
        }

        .dna-lifestyle-value {
            color: #00FF99;
            font-size: 14px;
            font-weight: bold;
        }

        .dna-lifestyle-text {
            color: var(--text);
            font-size: 14px;
        }

        /* AI Insight Card */
        .dna-ai-insight-card {
            background: var(--panel);
            border: 1px solid #00FF99;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            box-shadow: 0 0 20px rgba(0, 255, 153, 0.1);
        }

        .dna-ai-header {
            color: #00FF99;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .dna-ai-content {
            color: var(--text);
            font-size: 14px;
            line-height: 1.6;
        }

        /* Pulse animation for status indicator */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        /* ========================================
           TRAINING PLAN - TIMELINE VIEW
           ======================================== */

        .plan-view-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            background: var(--panel);
            padding: 4px;
            border-radius: 8px;
        }

        .plan-view-btn {
            flex: 1;
            padding: 8px 12px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .plan-view-btn.active {
            background: #00FF99;
            color: #000;
        }

        .plan-timeline {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .plan-week-card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.2s;
        }

        .plan-week-card.completed {
            border-color: #00FF99;
            opacity: 0.7;
        }

        .plan-week-card.current {
            border-color: #00FF99;
            box-shadow: 0 0 20px rgba(0, 255, 153, 0.3);
        }

        .plan-week-header {
            padding: 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .plan-week-header:hover {
            background: rgba(0, 255, 153, 0.05);
        }

        .plan-week-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .plan-week-number {
            font-size: 24px;
            font-weight: bold;
            color: #00FF99;
        }

        .plan-week-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .plan-week-label {
            font-size: 14px;
            font-weight: 600;
        }

        .plan-week-dates {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .plan-week-summary {
            display: flex;
            gap: 16px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .plan-week-stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .plan-week-expand {
            font-size: 20px;
            transition: transform 0.2s;
        }

        .plan-week-expand.expanded {
            transform: rotate(180deg);
        }

        .plan-week-days {
            display: none;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
        }

        .plan-week-days.expanded {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .plan-day-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .plan-day-card:hover {
            border-color: #00FF99;
            background: rgba(0, 255, 153, 0.05);
        }

        .plan-day-card.completed {
            border-color: #00FF99;
            background: rgba(0, 255, 153, 0.1);
        }

        .plan-day-card.rest {
            border-color: #FF0000;
            background: rgba(255, 0, 0, 0.05);
        }

        .plan-day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .plan-day-name {
            font-size: 13px;
            font-weight: 600;
            color: #00FF99;
        }

        .plan-day-date {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .plan-day-workout {
            font-size: 14px;
            margin-bottom: 4px;
        }

        .plan-day-details {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            gap: 12px;
        }

        .plan-day-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .plan-day-badge.rowing {
            background: rgba(59, 130, 246, 0.2);
            color: #3B82F6;
        }

        .plan-day-badge.weights {
            background: rgba(0, 255, 153, 0.2);
            color: #00FF99;
        }

        .plan-day-badge.rest {
            background: rgba(255, 0, 0, 0.2);
            color: #FF0000;
        }

        .plan-day-badge.completed {
            background: rgba(0, 255, 153, 0.3);
            color: #00FF99;
        }

        .plan-adaptive-alert {
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid #FF0000;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }

        .plan-adaptive-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .plan-adaptive-message {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .plan-adaptive-actions {
            display: flex;
            gap: 8px;
        }

        .plan-calendar-sync {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .plan-calendar-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .plan-calendar-icon {
            font-size: 20px;
        }

        /* ========================================
           TRAINING LOG & MODAL
           ======================================== */

        /* Modal Overlay */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text);
            font-size: 32px;
            cursor: pointer;
            padding: 0;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            padding: 20px;
            border-top: 1px solid var(--border);
        }

        /* Activity Cards with Color Coding */
        .activity-card {
            background: var(--panel);
            border-left: 4px solid;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            transition: transform 0.2s;
        }

        .activity-card:active {
            transform: scale(0.98);
        }

        .activity-card.rowing {
            border-left-color: #00A8E8;
        }

        .activity-card.weights {
            border-left-color: #00C853;
        }

        .activity-card.bjj {
            border-left-color: #9C27B0;
        }

        .activity-card.football {
            border-left-color: #FF6B00;
        }

        .activity-card.other {
            border-left-color: #666;
        }

        .activity-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .activity-card-title {
            font-size: 14px;
            font-weight: bold;
            color: var(--text);
        }

        .activity-card-date {
            font-size: 11px;
            color: #666;
        }

        .activity-card-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 8px;
            font-size: 11px;
        }

        .activity-card-stat {
            display: flex;
            flex-direction: column;
        }

        .activity-card-stat-label {
            color: #666;
            margin-bottom: 2px;
        }

        .activity-card-stat-value {
            color: var(--accent);
            font-weight: bold;
            font-size: 20px;
        }

        /* Date Dividers in Training Log */
        .training-log-date-divider {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 20px 0 12px 0;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }
    </style>
</head>
<body>
    <div class="version-badge">v1.6 PRODUCTION</div>
    <div id="toast" class="toast"></div>
    
    <!-- TOP NAVIGATION BAR -->
    <nav class="top-nav-bar">
        <button class="top-nav-item" onclick="app.navigate('screenSettings')">
            <span class="top-nav-icon">‚öôÔ∏è</span>
            <span class="top-nav-label">Settings</span>
        </button>
        <button class="top-nav-item" onclick="app.navigate('screenHRM')">
            <span class="top-nav-icon">‚ù§Ô∏è</span>
            <span class="top-nav-label">HR Mon</span>
        </button>
        <button class="top-nav-item" onclick="app.navigate('screenDNA')">
            <span class="top-nav-icon">üß¨</span>
            <span class="top-nav-label">DNA</span>
        </button>
        <button class="top-nav-item" style="opacity:0.3; cursor:not-allowed;">
            <span class="top-nav-icon">üìç</span>
            <span class="top-nav-label">TBD</span>
        </button>
    </nav>

    <!-- DASHBOARD SCREEN (SWIPEABLE) -->
    <div id="screenDashboard" class="screen active">
        <div class="screen-header">
            <button class="header-btn" onclick="app.endWorkout()">End</button>
            <div class="screen-title">Rowing</div>
            <button class="header-btn" id="manualStartBtn" style="display:none; background:var(--accent); color:#000;" onclick="app.onFirstStroke()">Start</button>
        </div>
        
        <div class="dashboard-container" id="dashboardContainer">
            <div class="dashboard-carousel" id="dashboardCarousel">
                
                <!-- View 1: All Data -->
                <div class="dashboard-view">
                    <div class="ai-coach-widget">
                        <div class="ai-coach-message" id="coachMessage">Start rowing to receive coaching!</div>
                    </div>
                    
                    <div class="metrics-grid">
                        <div class="metric-item" style="grid-column:1/-1;">
                            <div class="metric-label">CURRENT PACE</div>
                            <div class="metric-value" id="pace1" style="font-size:48px;">0:00</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">TIME</div>
                            <div class="metric-value" id="time1">0:00</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">DISTANCE</div>
                            <div class="metric-value" id="dist1">0</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">WATTS</div>
                            <div class="metric-value accent" id="watts1">0</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">S/M</div>
                            <div class="metric-value accent" id="rate1">0</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">HEART RATE</div>
                            <div class="metric-value" style="color:#ff6b6b;" id="hr1">--</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">AVG PACE</div>
                            <div class="metric-value" id="avgPace1">0:00</div>
                        </div>
                    </div>
                </div>
                
                <!-- View 2: Force Curve -->
                <div class="dashboard-view">
                    <div style="padding:20px;">
                        <div style="font-size:12px; color:#666; text-align:center; margin-bottom:16px;">FORCE CURVE</div>
                        <canvas id="forceCanvas" style="width:100%; height:300px; background:#000; border-radius:8px;"></canvas>
                    </div>
                </div>
                
                <!-- View 3: Paceboat -->
                <div class="dashboard-view">
                    <div style="padding:20px;">
                        <div style="font-size:12px; color:#666; text-align:center; margin-bottom:16px;">PACEBOAT</div>
                        <canvas id="paceboatCanvas" style="width:100%; height:400px; background:#000; border-radius:8px;"></canvas>
                    </div>
                </div>
                
                <!-- View 4: Bar Chart -->
                <div class="dashboard-view">
                    <div style="padding:20px;">
                        <div style="font-size:12px; color:#666; text-align:center; margin-bottom:16px;">PACE OVER TIME</div>
                        <canvas id="barCanvas" style="width:100%; height:300px; background:#000; border-radius:8px;"></canvas>
                    </div>
                </div>
                
                <!-- View 5: Large Print -->
                <div class="dashboard-view">
                    <div class="large-print-container">
                        <div class="large-print-metric">
                            <div class="large-print-label">PACE</div>
                            <div class="large-print-value" id="paceLP">0:00</div>
                        </div>
                        <div class="large-print-metric">
                            <div class="large-print-label">DISTANCE</div>
                            <div class="large-print-value" id="distLP">0m</div>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
        
        <!-- HR Zone Sidebar -->
        <div class="hr-zone-sidebar" id="hrSidebar" style="display:none;">
            <div class="hr-zone-segment" id="hrZ5" style="background:#dc143c;">Z5</div>
            <div class="hr-zone-segment" id="hrZ4" style="background:#ff6347;">Z4</div>
            <div class="hr-zone-segment" id="hrZ3" style="background:#ffa500;">Z3</div>
            <div class="hr-zone-segment" id="hrZ2" style="background:#50c878;">Z2</div>
            <div class="hr-zone-segment" id="hrZ1" style="background:#4a90e2;">Z1</div>
        </div>
        
        <div class="dashboard-dots">
            <div class="dashboard-dot active"></div>
            <div class="dashboard-dot"></div>
            <div class="dashboard-dot"></div>
            <div class="dashboard-dot"></div>
            <div class="dashboard-dot"></div>
        </div>
    </div>

    <!-- AI CHAT SCREEN -->
    <div id="screenChat" class="screen">
        <div class="screen-header">
            <div class="screen-title">AI Coach</div>
        </div>
        <div style="display:flex; flex-direction:column; height:100%;">
            <div class="scroll-content" id="chatMessages" style="flex:1; padding-bottom:20px;">
                <!-- Chat messages will appear here -->
            </div>
            <div class="typing-indicator" id="typingIndicator" style="display:none; padding:16px;">
                <div style="display:flex; gap:4px;">
                    <div style="width:8px; height:8px; background:var(--accent); border-radius:50%; animation:typing 1.4s infinite;"></div>
                    <div style="width:8px; height:8px; background:var(--accent); border-radius:50%; animation:typing 1.4s infinite 0.2s;"></div>
                    <div style="width:8px; height:8px; background:var(--accent); border-radius:50%; animation:typing 1.4s infinite 0.4s;"></div>
                </div>
            </div>
            <div style="position:sticky; bottom:0; border-top:1px solid var(--border); background:var(--panel); padding:12px; display:flex; gap:12px; align-items:flex-end;">
                <textarea 
                    id="chatInput" 
                    placeholder="Type your message..."
                    style="flex:1; background:#0a0a0a; border:1px solid var(--border); color:var(--text); padding:12px; border-radius:20px; font-size:15px; font-family:inherit; resize:none; max-height:120px; min-height:44px;"
                    onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault();app.sendMessage();}"
                ></textarea>
                <button onclick="app.sendMessage()" style="background:var(--accent); color:#000; border:none; width:44px; height:44px; border-radius:50%; font-size:20px; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0;">‚Üë</button>
            </div>
        </div>
    </div>

    <!-- BUILDER SCREEN -->
    <div id="screenBuilder" class="screen">
        <div class="screen-header">
            <div class="screen-title">Manual Builder</div>
        </div>
        <div class="scroll-content">
            <div class="builder-mode-selector">
                <div class="builder-mode-btn active" onclick="app.selectBuilderMode('single-distance')">Single Distance</div>
                <div class="builder-mode-btn" onclick="app.selectBuilderMode('single-time')">Single Time</div>
                <div class="builder-mode-btn" onclick="app.selectBuilderMode('single-calorie')">Single Calorie</div>
                <div class="builder-mode-btn" onclick="app.selectBuilderMode('fixed-intervals')">Fixed Intervals</div>
                <div class="builder-mode-btn" onclick="app.selectBuilderMode('variable-intervals')">Variable Intervals</div>
            </div>
            
            <div class="builder-section">
                <div class="builder-section-title">Global Targets (Optional)</div>
                
                <div class="builder-toggle" onclick="app.toggleBuilderTarget('splitPace')">
                    <div class="builder-checkbox" id="splitPaceCheckbox"></div>
                    <div style="flex:1; font-size:13px; font-weight:700;">Target Split /500m</div>
                </div>
                <div id="splitPaceInputs" style="display:none; margin-left:32px; margin-bottom:16px;">
                    <div class="builder-label">Split Pace (e.g., 1:55.0)</div>
                    <input type="text" class="builder-input" placeholder="1:55.0" id="splitPaceValue">
                </div>
                
                <div class="builder-toggle" onclick="app.toggleBuilderTarget('pacer')">
                    <div class="builder-checkbox" id="pacerCheckbox"></div>
                    <div style="flex:1; font-size:13px; font-weight:700;">Show Pacer</div>
                </div>
                <div id="pacerInputs" style="display:none; margin-left:32px; margin-bottom:16px;">
                    <select class="builder-input" style="margin-bottom:8px;" id="pacerMetric">
                        <option value="pace">Pace /500m</option>
                        <option value="watts">Watts</option>
                        <option value="calhr">Cal/hr</option>
                    </select>
                    <input type="text" class="builder-input" placeholder="Target value" id="pacerValue">
                </div>
                
                <div class="builder-toggle" onclick="app.toggleBuilderTarget('strokeRate')">
                    <div class="builder-checkbox" id="strokeRateCheckbox"></div>
                    <div style="flex:1; font-size:13px; font-weight:700;">Target Stroke Rate</div>
                </div>
                <div id="strokeRateInputs" style="display:none; margin-left:32px; margin-bottom:16px;">
                    <input type="number" class="builder-input" placeholder="s/m (e.g., 26)" id="strokeRateValue">
                </div>
                
                <div class="builder-toggle" onclick="app.toggleBuilderTarget('heartRate')">
                    <div class="builder-checkbox" id="heartRateCheckbox"></div>
                    <div style="flex:1; font-size:13px; font-weight:700;">Target Heart Rate Zone</div>
                </div>
                <div id="heartRateInputs" style="display:none; margin-left:32px; margin-bottom:16px;">
                    <select class="builder-input" id="heartRateZone">
                        <option value="1">Zone 1 (Recovery)</option>
                        <option value="2">Zone 2 (Endurance)</option>
                        <option value="3">Zone 3 (Tempo)</option>
                        <option value="4">Zone 4 (Threshold)</option>
                        <option value="5">Zone 5 (Max)</option>
                    </select>
                </div>
            </div>
            
            <div id="builderModeContent"></div>
            
            <button class="btn btn-primary" onclick="app.saveManualWorkout()">Review Workout</button>
        </div>
    </div>

    <!-- REVIEW SCREEN -->
    <div id="screenReview" class="screen">
        <div class="screen-header">
            <button class="header-btn" onclick="app.navigate('screenBuilder')">‚Üê Back</button>
            <div class="screen-title">Review Workout</div>
        </div>
        <div class="scroll-content">
            <div class="review-workout-title" id="reviewTitle">Your Workout</div>
            <div id="reviewIntervals"></div>
            <div class="review-actions">
                <button class="btn btn-outline" onclick="app.navigate('screenBuilder')" style="flex:1;">‚Üê Back</button>
                <button class="btn btn-primary" onclick="app.startWorkout()" style="flex:2;">üö£ Start Row</button>
            </div>
        </div>
    </div>

    <!-- HEART RATE MONITOR SCREEN -->
    <div id="screenHRM" class="screen">
        <div class="screen-header">
            <div class="screen-title">Heart Rate Monitor</div>
        </div>
        <div class="scroll-content">
            <!-- Connection Card -->
            <div style="background:linear-gradient(135deg, #1a0a0a 0%, #0a0a0a 100%); border:2px solid #ff6b6b; border-radius:12px; padding:20px; margin-bottom:20px;">
                <div style="display:flex; align-items:center; gap:12px; margin-bottom:16px;">
                    <div style="font-size:32px;">‚ù§Ô∏è</div>
                    <div style="flex:1;">
                        <div style="font-size:14px; font-weight:700; color:#ff6b6b;" id="hrmStatusText">Not Connected</div>
                        <div style="font-size:12px; color:#666; margin-top:4px;" id="hrmStatusDesc">Connect your Polar/Garmin/Wahoo HRM</div>
                    </div>
                </div>
                <button class="btn btn-primary" style="background:#ff6b6b;" id="hrmConnectButton" onclick="app.connectHRMDirect()">
                    Connect Heart Rate Monitor
                </button>
            </div>

            <!-- Live Display (Hidden until connected) -->
            <div id="hrmLiveDisplay" style="display:none; background:var(--card-bg); border:2px solid #ff6b6b; border-radius:12px; padding:20px; text-align:center; margin-bottom:20px;">
                <div style="font-size:72px; font-weight:900; color:#ff6b6b; line-height:1; margin-bottom:8px; font-variant-numeric:tabular-nums;" id="hrmCurrentBPM">--</div>
                <div style="font-size:11px; color:#666; text-transform:uppercase; letter-spacing:1px;">BEATS PER MINUTE</div>
                
                <div style="margin-top:16px; padding:12px; background:#050505; border-radius:8px;">
                    <div style="font-size:10px; color:#666; text-transform:uppercase; margin-bottom:6px;">TRAINING ZONE</div>
                    <div style="display:flex; height:40px; border-radius:8px; overflow:hidden;">
                        <div id="hrZone1Display" style="flex:1; background:#4a90e2; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700; opacity:0.3; transition:all 0.3s;">Z1</div>
                        <div id="hrZone2Display" style="flex:1; background:#50c878; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700; opacity:0.3; transition:all 0.3s;">Z2</div>
                        <div id="hrZone3Display" style="flex:1; background:#ffa500; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700; opacity:0.3; transition:all 0.3s;">Z3</div>
                        <div id="hrZone4Display" style="flex:1; background:#ff6347; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700; opacity:0.3; transition:all 0.3s;">Z4</div>
                        <div id="hrZone5Display" style="flex:1; background:#dc143c; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700; opacity:0.3; transition:all 0.3s;">Z5</div>
                    </div>
                </div>
            </div>

            <!-- Graph -->
            <div id="hrmGraphContainer" style="display:none; background:var(--card-bg); border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:20px;">
                <div style="font-size:11px; color:#666; text-transform:uppercase; margin-bottom:12px; text-align:center;">Heart Rate Over Time</div>
                <canvas id="hrmCanvas" style="width:100%; height:200px; background:#000; border-radius:8px;"></canvas>
                
                <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:12px; margin-top:16px;">
                    <div style="text-align:center;">
                        <div style="font-size:20px; font-weight:900; color:#ff6b6b;" id="hrmAvg">--</div>
                        <div style="font-size:9px; color:#666; text-transform:uppercase; margin-top:4px;">Average</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:20px; font-weight:900; color:#ff6b6b;" id="hrmMax">--</div>
                        <div style="font-size:9px; color:#666; text-transform:uppercase; margin-top:4px;">Max</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:20px; font-weight:900; color:#ff6b6b;" id="hrmMin">--</div>
                        <div style="font-size:9px; color:#666; text-transform:uppercase; margin-top:4px;">Min</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TRAINING PLAN SCREEN -->
    <div id="screenPlan" class="screen">
        <div class="screen-header">
            <div class="screen-title">Training Plan</div>
            <button class="header-btn" onclick="app.createNewPlan()">+ New Plan</button>
        </div>
        <div class="scroll-content">

            <!-- Calendar Sync Status -->
            <div class="plan-calendar-sync">
                <div class="plan-calendar-status">
                    <span class="plan-calendar-icon">üìÖ</span>
                    <span id="calendarSyncStatus">Not synced</span>
                </div>
                <button class="btn btn-sm btn-outline" onclick="app.syncGoogleCalendar()">Sync Calendar</button>
            </div>

            <!-- Adaptive Alert (shown when DNA indicates poor recovery) -->
            <div id="planAdaptiveAlert" style="display:none;">
                <!-- Filled by JavaScript -->
            </div>

            <!-- View Toggle -->
            <div class="plan-view-toggle">
                <button class="plan-view-btn active" onclick="app.setPlanView('timeline')">Timeline</button>
                <button class="plan-view-btn" onclick="app.setPlanView('week')">Week</button>
                <button class="plan-view-btn" onclick="app.setPlanView('month')">Month</button>
            </div>

            <!-- Plan Content -->
            <div id="planContent">
                <div class="empty-state">
                    <div class="empty-state-icon">üìÖ</div>
                    <div style="font-size:14px; line-height:1.6; margin-bottom: 24px;">
                        No training plan yet.<br>
                        Create a 12-week progressive plan tailored to your goals.
                    </div>
                    <button class="btn btn-primary" onclick="app.createNewPlan()" style="max-width: 280px; margin: 0 auto;">
                        Create 12-Week Plan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- HISTORY SCREEN -->
    <div id="screenHistory" class="screen">
        <div class="screen-header">
            <div class="screen-title">History (<span id="historyCount">0</span>)</div>
        </div>
        <div class="scroll-content">
            <div class="card">
                <div class="card-header">Database Summary</div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-item-value" id="totalWorkouts">0</div>
                        <div class="stat-item-label">Workouts</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-item-value" id="totalDistance">0</div>
                        <div class="stat-item-label">Total Meters</div>
                    </div>
                </div>
            </div>
            <div id="historyList"></div>
        </div>
    </div>

    <!-- DNA FACT SHEET SCREEN -->
    <div id="screenDNA" class="screen">
        <div class="screen-header">
            <div class="screen-title">ATHLETIC DNA</div>
        </div>
        <div class="scroll-content">

            <!-- Safety Header -->
            <div class="dna-safety-section">
                <div class="dna-status" id="dnaStatus">
                    <span class="dna-status-indicator" id="dnaStatusIndicator">‚óè</span>
                    <span id="dnaStatusText">READY</span>
                </div>
                <div class="dna-medical-flags">
                    <div class="dna-flag">‚ö†Ô∏è C5-C7 Disc Replacement</div>
                    <div class="dna-flag">‚ö†Ô∏è C4-C5 Instability</div>
                </div>
            </div>

            <!-- Performance Benchmarks -->
            <div class="card">
                <div class="card-header">Engine Benchmarks</div>
                <div class="dna-benchmarks-grid">
                    <div class="dna-benchmark">
                        <div class="dna-benchmark-label">2k PB</div>
                        <div class="dna-benchmark-value" id="dna2kPB">1:51.0</div>
                        <div class="dna-benchmark-total" id="dna2kTotal">(7:24.0)</div>
                    </div>
                    <div class="dna-benchmark">
                        <div class="dna-benchmark-label">5k PB</div>
                        <div class="dna-benchmark-value" id="dna5kPB">--:--</div>
                        <div class="dna-benchmark-total" id="dna5kTotal">--</div>
                    </div>
                    <div class="dna-benchmark">
                        <div class="dna-benchmark-label">Max HR</div>
                        <div class="dna-benchmark-value" id="dnaMaxHR">184</div>
                        <div class="dna-benchmark-total">BPM</div>
                    </div>
                    <div class="dna-benchmark">
                        <div class="dna-benchmark-label">Avg Drag</div>
                        <div class="dna-benchmark-value" id="dnaAvgDrag">132</div>
                        <div class="dna-benchmark-total"></div>
                    </div>
                </div>
            </div>

            <!-- Lifestyle & Recovery -->
            <div class="card">
                <div class="card-header">Lifestyle & Recovery</div>
                <div class="dna-lifestyle-grid">
                    <div class="dna-lifestyle-item">
                        <div class="dna-lifestyle-label">Sleep Quality</div>
                        <div class="dna-lifestyle-bar">
                            <div class="dna-lifestyle-fill" id="dnaSleepBar" style="width: 70%"></div>
                        </div>
                        <div class="dna-lifestyle-value" id="dnaSleepValue">7/10</div>
                    </div>
                    <div class="dna-lifestyle-item">
                        <div class="dna-lifestyle-label">Stress Level</div>
                        <div class="dna-lifestyle-bar">
                            <div class="dna-lifestyle-fill stress" id="dnaStressBar" style="width: 50%"></div>
                        </div>
                        <div class="dna-lifestyle-value" id="dnaStressValue">Medium</div>
                    </div>
                    <div class="dna-lifestyle-item">
                        <div class="dna-lifestyle-label">Activity Level</div>
                        <div class="dna-lifestyle-text" id="dnaActivityLevel">Sedentary (Office Job)</div>
                    </div>
                    <div class="dna-lifestyle-item">
                        <div class="dna-lifestyle-label">Injury History</div>
                        <button class="btn btn-outline" onclick="app.toggleInjuryDetails()">View Details</button>
                    </div>
                </div>
            </div>

            <!-- AI Insight Card -->
            <div class="dna-ai-insight-card">
                <div class="dna-ai-header">üß† Cortex Insight</div>
                <div class="dna-ai-content" id="dnaAIInsight">
                    Connect your PM5 and complete a workout to receive personalized insights.
                </div>
            </div>

            <!-- CSV Upload -->
            <div class="card">
                <div class="card-header">Import Workout Data</div>
                <p style="font-size: 12px; color: #888; margin-bottom: 12px;">
                    Upload your Concept2 Logbook CSV to automatically update your PBs and training history.
                </p>
                <input type="file" id="csvFileInput" accept=".csv" style="display:none;" onchange="app.showCSVMapper(event)">
                <button class="btn btn-outline" onclick="document.getElementById('csvFileInput').click()">
                    üìä Upload CSV File
                </button>
            </div>

            <!-- Workout History -->
            <div class="card">
                <div class="card-header">Recent Workouts (<span id="dnaWorkoutCount">0</span>)</div>
                <div id="dnaWorkoutList">
                    <p style="font-size: 12px; color: #666; text-align: center; padding: 20px;">
                        No workouts yet. Complete a workout or upload your Concept2 CSV to see your history.
                    </p>
                </div>
            </div>

        </div>
    </div>

    <!-- TRAINING LOG SCREEN -->
    <div id="screenTrainingLog" class="screen">
        <div class="screen-header">
            <div class="screen-title">TRAINING LOG</div>
            <button class="header-btn" onclick="app.showAddWorkoutModal()" style="background:var(--accent); color:#000; font-weight:bold;">+ Add</button>
        </div>
        <div class="scroll-content">

            <!-- Filters -->
            <div style="display:flex; gap:8px; margin-bottom:16px;">
                <select id="activityFilter" class="builder-input" style="flex:1;" onchange="app.filterTrainingLog()">
                    <option value="all">All Activities</option>
                    <option value="rowing">üö£ Rowing</option>
                    <option value="weights">üèãÔ∏è Weights</option>
                    <option value="bjj">ü•ã BJJ</option>
                    <option value="football">‚öΩ Football</option>
                    <option value="other">Other</option>
                </select>
                <select id="dateFilter" class="builder-input" style="flex:1;" onchange="app.filterTrainingLog()">
                    <option value="all">All Time</option>
                    <option value="7">Last 7 days</option>
                    <option value="30">Last 30 days</option>
                    <option value="90">Last 90 days</option>
                </select>
            </div>

            <!-- Search -->
            <input type="text" class="builder-input" id="trainingLogSearch" placeholder="üîç Search workouts..." oninput="app.filterTrainingLog()" style="margin-bottom:16px;">

            <!-- Workout List -->
            <div id="trainingLogList">
                <p style="font-size: 12px; color: #666; text-align: center; padding: 40px 20px;">
                    No workouts yet.<br>
                    Connect your PM5 and row, or click <strong>+ Add</strong> to log a workout.
                </p>
            </div>

        </div>
    </div>

    <!-- ADD WORKOUT MODAL -->
    <div id="addWorkoutModal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Add Workout</div>
                <button class="modal-close" onclick="app.closeAddWorkoutModal()">√ó</button>
            </div>
            <div class="modal-body">

                <!-- Activity Type Selection -->
                <div class="card" style="margin-bottom:16px;">
                    <div class="card-header">Activity Type</div>
                    <select id="addWorkoutType" class="builder-input" onchange="app.updateAddWorkoutForm()">
                        <option value="">Select activity...</option>
                        <option value="rowing">üö£ Rowing</option>
                        <option value="weights">üèãÔ∏è Weights</option>
                        <option value="bjj">ü•ã BJJ</option>
                        <option value="football">‚öΩ Football</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <!-- Dynamic Form Content -->
                <div id="addWorkoutFormContent"></div>

            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="app.closeAddWorkoutModal()">Cancel</button>
                <button class="btn btn-primary" onclick="app.saveManualWorkoutEntry()">Save Workout</button>
            </div>
        </div>
    </div>

    <!-- CSV COLUMN MAPPER MODAL -->
    <div id="csvMapperModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <div class="modal-title">Map CSV Columns</div>
                <button class="modal-close" onclick="app.closeCSVMapper()">√ó</button>
            </div>
            <div class="modal-body">
                <p style="color: #888; font-size: 12px; margin-bottom: 16px;">
                    Select which column in your CSV file corresponds to each field:
                </p>

                <!-- Preview Table -->
                <div style="overflow-x: auto; margin-bottom: 20px; border: 1px solid var(--border); border-radius: 8px; max-height: 200px; overflow-y: auto;">
                    <table id="csvPreviewTable" style="border-collapse: collapse; font-size: 11px; min-width: 100%;">
                        <!-- Filled by JavaScript -->
                    </table>
                </div>

                <!-- Column Mapping -->
                <div class="card">
                    <div class="card-header">Column Mapping</div>
                    <div style="display: grid; grid-template-columns: 150px 1fr; gap: 12px; align-items: center;">

                        <label style="color: #888;">Date:</label>
                        <select id="csvMapDate" class="builder-input"></select>

                        <label style="color: #888;">Description:</label>
                        <select id="csvMapDescription" class="builder-input"></select>

                        <label style="color: #888;">Work Time:</label>
                        <select id="csvMapTime" class="builder-input"></select>

                        <label style="color: #888;">Work Distance:</label>
                        <select id="csvMapDistance" class="builder-input"></select>

                        <label style="color: #888;">Pace (/500m):</label>
                        <select id="csvMapPace" class="builder-input"></select>

                        <label style="color: #888;">Avg Watts:</label>
                        <select id="csvMapWatts" class="builder-input"></select>

                        <label style="color: #888;">Avg Heart Rate:</label>
                        <select id="csvMapHR" class="builder-input"></select>

                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="app.closeCSVMapper()">Cancel</button>
                <button class="btn btn-primary" onclick="app.importWithMapping()">Import Workouts</button>
            </div>
        </div>
    </div>

    <!-- DAY DETAILS MODAL -->
    <div id="dayDetailsModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <div class="modal-title" id="dayDetailsTitle">Workout Details</div>
                <button class="modal-close" onclick="app.closeDayDetails()">√ó</button>
            </div>
            <div class="modal-body" id="dayDetailsBody">
                <!-- Filled by JavaScript -->
            </div>
            <div class="modal-footer" id="dayDetailsFooter">
                <button class="btn btn-outline" id="dayDetailsDeleteBtn" style="color: #FF0000; border-color: #FF0000;">Delete</button>
                <button class="btn btn-outline" id="dayDetailsEditBtn">Edit</button>
                <button class="btn btn-primary" id="dayDetailsCompleteBtn">Mark Complete</button>
            </div>
        </div>
    </div>

    <!-- SETTINGS SCREEN -->
    <div id="screenSettings" class="screen">
        <div class="screen-header">
            <div class="screen-title">Settings</div>
        </div>
        <div class="scroll-content">
            <div class="card">
                <div class="card-header">User Profile</div>
                
                <div class="editable-field">
                    <div class="editable-label">Name</div>
                    <input type="text" class="editable-input" id="editName" placeholder="Your name">
                </div>
                
                <div class="editable-field">
                    <div class="editable-label">Age</div>
                    <input type="number" class="editable-input" id="editAge" placeholder="30">
                </div>
                
                <div class="editable-field">
                    <div class="editable-label">Weight (kg)</div>
                    <input type="number" class="editable-input" id="editWeight" placeholder="75">
                </div>
                
                <div style="display:flex; gap:12px; margin-top:16px;">
                    <button class="btn btn-primary" onclick="app.saveProfile()">Save Profile</button>
                    <button class="btn btn-outline" onclick="app.loadProfile()">Cancel</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Heart Rate Zones</div>
                <div style="font-size:12px; color:#888; margin-bottom:16px;">Configure your training zones based on max HR</div>
                
                <div class="editable-field">
                    <div class="editable-label">Max Heart Rate</div>
                    <input type="number" class="editable-input" id="editMaxHR" placeholder="190">
                </div>
                
                <div style="margin-top:16px; padding:16px; background:#050505; border-radius:8px;">
                    <div style="font-size:11px; color:#666; text-transform:uppercase; margin-bottom:12px;">Zones Preview</div>
                    <div style="display:flex; flex-direction:column; gap:8px;">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <div style="width:40px; height:30px; background:#4a90e2; border-radius:4px; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700;">Z1</div>
                            <div style="flex:1; font-size:12px;">
                                <div style="color:#e0e0e0;">Recovery (50-60%)</div>
                                <div style="color:#666; font-size:11px;" id="zone1Range">95-114 bpm</div>
                            </div>
                        </div>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <div style="width:40px; height:30px; background:#50c878; border-radius:4px; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700;">Z2</div>
                            <div style="flex:1; font-size:12px;">
                                <div style="color:#e0e0e0;">Aerobic (60-70%)</div>
                                <div style="color:#666; font-size:11px;" id="zone2Range">114-133 bpm</div>
                            </div>
                        </div>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <div style="width:40px; height:30px; background:#ffa500; border-radius:4px; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700;">Z3</div>
                            <div style="flex:1; font-size:12px;">
                                <div style="color:#e0e0e0;">Tempo (70-80%)</div>
                                <div style="color:#666; font-size:11px;" id="zone3Range">133-152 bpm</div>
                            </div>
                        </div>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <div style="width:40px; height:30px; background:#ff6347; border-radius:4px; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700;">Z4</div>
                            <div style="flex:1; font-size:12px;">
                                <div style="color:#e0e0e0;">Threshold (80-90%)</div>
                                <div style="color:#666; font-size:11px;" id="zone4Range">152-171 bpm</div>
                            </div>
                        </div>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <div style="width:40px; height:30px; background:#dc143c; border-radius:4px; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700;">Z5</div>
                            <div style="flex:1; font-size:12px;">
                                <div style="color:#e0e0e0;">Max (90-100%)</div>
                                <div style="color:#666; font-size:11px;" id="zone5Range">171-190 bpm</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="display:flex; gap:12px; margin-top:16px;">
                    <button class="btn btn-primary" onclick="app.saveHRZones()">Save Zones</button>
                    <button class="btn btn-outline" onclick="app.loadHRZones()">Reset</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Firebase Cloud Storage</div>
                <div style="margin-bottom:12px;">
                    <div style="font-size:12px; color:#666; margin-bottom:4px;">User ID</div>
                    <div style="color:#e0e0e0; font-size:14px; font-family:monospace; word-break:break-all;" id="firebaseUserId">Loading...</div>
                </div>
                <div style="margin-bottom:12px;">
                    <div style="font-size:12px; color:#666; margin-bottom:4px;">Status</div>
                    <div style="color:#e0e0e0; font-size:14px;" id="firebaseStatus">Checking...</div>
                </div>
                <button class="btn btn-outline" onclick="app.testFirebaseSync()">
                    Test Cloud Sync
                </button>
                <div style="margin-top:12px; padding:12px; background:rgba(0,255,153,0.05); border:1px solid var(--accent); border-radius:8px; font-size:11px; color:#ccc;">
                    üí° <strong>Test without clearing cache:</strong> Click "Test Cloud Sync" to verify your data is saving to Firebase. Check console (F12) for detailed logs.
                </div>
            </div>

            <div class="card">
                <div class="card-header">Connect Devices</div>
                <div style="font-size:12px; color:#888; margin-bottom:16px;">Connect PM5 and Heart Rate Monitor via Bluetooth</div>
                
                <!-- PM5 Connection -->
                <div style="background:#050505; border:1px solid var(--border); border-radius:8px; padding:16px; margin-bottom:16px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <div>
                            <div style="font-size:14px; font-weight:700; margin-bottom:4px;">Concept2 PM5</div>
                            <div style="font-size:12px; color:#666;" id="pm5StatusSettings">Not connected</div>
                        </div>
                        <div style="width:12px; height:12px; border-radius:50%; background:#666;" id="pm5IndicatorSettings"></div>
                    </div>
                    <button class="btn btn-primary" onclick="app.connectPM5()" id="pm5ConnectBtnSettings">Connect PM5</button>
                </div>
                
                <!-- HRM Connection -->
                <div style="background:#050505; border:1px solid var(--border); border-radius:8px; padding:16px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <div>
                            <div style="font-size:14px; font-weight:700; margin-bottom:4px;">Heart Rate Monitor</div>
                            <div style="font-size:12px; color:#666;" id="hrmStatusSettings">Not connected</div>
                        </div>
                        <div style="width:12px; height:12px; border-radius:50%; background:#666;" id="hrmIndicatorSettings"></div>
                    </div>
                    <button class="btn btn-outline" onclick="app.connectHRM()" id="hrmConnectBtnSettings">Connect HRM</button>
                </div>
                
                <div style="margin-top:16px; padding:12px; background:rgba(0,255,153,0.05); border:1px solid var(--accent); border-radius:8px; font-size:11px; color:#ccc;">
                    üí° <strong>Tip:</strong> Connect PM5 first for rowing data, then connect HRM for heart rate monitoring.
                </div>
            </div>

            <div class="card">
                <div class="card-header">Import Data</div>
                <label for="csvUpload" style="display:block; width:100%; padding:16px; border:2px dashed #222; border-radius:8px; text-align:center; cursor:pointer; color:#888;">
                    üìÅ Import CSV
                </label>
                <input type="file" id="csvUpload" accept=".csv" style="display:none;" onchange="app.importCSV(event)">
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="nav-bar">
        <button class="nav-item" onclick="app.navigate('screenChat')">
            <span class="nav-icon">ü§ñ</span>
            AI Chat
        </button>
        <button class="nav-item active" onclick="app.navigate('screenDashboard')">
            <span class="nav-icon">üö£</span>
            Row
        </button>
        <button class="nav-item" onclick="app.navigate('screenBuilder')">
            <span class="nav-icon">üîß</span>
            Builder
        </button>
        <button class="nav-item" onclick="app.navigate('screenPlan')">
            <span class="nav-icon">üìÖ</span>
            Plan
        </button>
        <button class="nav-item" onclick="app.navigate('screenTrainingLog')">
            <span class="nav-icon">üìä</span>
            Log
        </button>
    </nav>

    <!-- DEVICES MODAL -->
    <div id="devicesModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:10000; padding:20px;">
        <div style="max-width:500px; margin:80px auto; background:var(--card-bg); border:1px solid var(--border); border-radius:12px; padding:20px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="font-size:18px; font-weight:700; color:var(--accent);">Connect Devices</h2>
                <button onclick="app.closeDevicesModal()" style="background:transparent; border:none; color:#666; font-size:24px; cursor:pointer;">√ó</button>
            </div>
            
            <!-- PM5 Connection -->
            <div style="background:#050505; border:1px solid var(--border); border-radius:8px; padding:16px; margin-bottom:16px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <div>
                        <div style="font-size:15px; font-weight:700; margin-bottom:4px;">Concept2 PM5</div>
                        <div style="font-size:12px; color:#666;" id="pm5Status">Not connected</div>
                    </div>
                    <div style="width:12px; height:12px; border-radius:50%; background:#666;" id="pm5Indicator"></div>
                </div>
                <button class="btn btn-primary" onclick="app.connectPM5()" id="pm5ConnectBtn">Connect PM5</button>
            </div>
            
            <!-- HRM Connection -->
            <div style="background:#050505; border:1px solid var(--border); border-radius:8px; padding:16px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <div>
                        <div style="font-size:15px; font-weight:700; margin-bottom:4px;">Heart Rate Monitor</div>
                        <div style="font-size:12px; color:#666;" id="hrmStatus">Not connected</div>
                    </div>
                    <div style="width:12px; height:12px; border-radius:50%; background:#666;" id="hrmIndicator"></div>
                </div>
                <button class="btn btn-outline" onclick="app.connectHRM()" id="hrmConnectBtn">Connect HRM</button>
            </div>
            
            <div style="margin-top:20px; padding:12px; background:rgba(0,255,153,0.05); border:1px solid var(--accent); border-radius:8px; font-size:12px; color:#ccc;">
                üí° <strong>Tip:</strong> Connect PM5 first, then connect your chest strap HRM if you want separate HR monitoring.
            </div>
        </div>
    </div>

    <script>
        // ========================================================================
        // FIREBASE CONFIGURATION
        // ========================================================================
        
        // Set to true to enable Firebase cloud storage
        const FIREBASE_ENABLED = true;
        
        // ========================================================================
        // STORAGE ABSTRACTION LAYER
        // ========================================================================
        
        class DataStore {
            constructor() {
                this.userId = null;
                this.isFirebase = FIREBASE_ENABLED;
            }
            
            async init() {
                if (this.isFirebase) {
                    // Wait for Firebase modules to load
                    await new Promise(resolve => {
                        const checkInterval = setInterval(() => {
                            if (window.firebaseAuth && window.firebaseDb && window.firebaseModules) {
                                clearInterval(checkInterval);
                                resolve();
                            }
                        }, 100);
                    });
                    
                    // Initialize Firebase
                    try {
                        const { signInAnonymously, onAuthStateChanged } = window.firebaseModules;
                        const auth = window.firebaseAuth;
                        
                        // Sign in anonymously
                        const result = await signInAnonymously(auth);
                        this.userId = result.user.uid;
                        
                        console.log('‚úì Firebase initialized. User ID:', this.userId);
                        
                        // Listen for auth state changes
                        onAuthStateChanged(auth, (user) => {
                            if (user) {
                                this.userId = user.uid;
                                console.log('‚úì User authenticated:', this.userId);
                            }
                        });
                    } catch (error) {
                        console.error('‚ùå Firebase init error:', error);
                        this.isFirebase = false; // Fallback to localStorage
                    }
                } else {
                    // localStorage fallback
                    this.userId = localStorage.getItem('anonymous_user_id');
                    if (!this.userId) {
                        this.userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                        localStorage.setItem('anonymous_user_id', this.userId);
                    }
                    console.log('‚úì localStorage mode. User ID:', this.userId);
                }
            }
            
            async saveProfile(profile) {
                if (this.isFirebase) {
                    const { doc, setDoc, serverTimestamp } = window.firebaseModules;
                    const db = window.firebaseDb;
                    
                    await setDoc(doc(db, 'users', this.userId), {
                        profile: profile,
                        updatedAt: serverTimestamp()
                    }, { merge: true });
                    
                    console.log('‚úì Profile saved to Firebase');
                } else {
                    localStorage.setItem('rowing_coach_profile_v1', JSON.stringify(profile));
                }
            }
            
            async loadProfile() {
                if (this.isFirebase) {
                    const { doc, getDoc } = window.firebaseModules;
                    const db = window.firebaseDb;
                    
                    const docSnap = await getDoc(doc(db, 'users', this.userId));
                    return docSnap.exists() ? docSnap.data().profile : null;
                } else {
                    const data = localStorage.getItem('rowing_coach_profile_v1');
                    return data ? JSON.parse(data) : null;
                }
            }
            
            async saveWorkout(workout) {
                if (this.isFirebase) {
                    const { doc, setDoc } = window.firebaseModules;
                    const db = window.firebaseDb;

                    await setDoc(doc(db, 'users', this.userId, 'workouts', workout.id), workout);
                    console.log('‚úì Workout saved to Firebase:', workout.id);
                } else {
                    const workouts = await this.loadWorkouts();
                    const existing = workouts.findIndex(w => w.id === workout.id);
                    if (existing >= 0) {
                        workouts[existing] = workout;
                    } else {
                        workouts.push(workout);
                    }
                    localStorage.setItem('rowing_coach_workouts_v1', JSON.stringify(workouts));
                }
            }
            
            async loadWorkouts() {
                if (this.isFirebase) {
                    const { collection, query, orderBy, getDocs } = window.firebaseModules;
                    const db = window.firebaseDb;
                    
                    const q = query(
                        collection(db, 'users', this.userId, 'workouts'),
                        orderBy('date', 'desc')
                    );
                    
                    const snapshot = await getDocs(q);
                    const workouts = snapshot.docs.map(doc => doc.data());
                    
                    console.log(`‚úì Loaded ${workouts.length} workouts from Firebase`);
                    return workouts;
                } else {
                    const data = localStorage.getItem('rowing_coach_workouts_v1');
                    return data ? JSON.parse(data) : [];
                }
            }
            
            async deleteWorkout(workoutId) {
                if (this.isFirebase) {
                    const { doc, deleteDoc } = window.firebaseModules;
                    const db = window.firebaseDb;
                    
                    await deleteDoc(doc(db, 'users', this.userId, 'workouts', workoutId));
                    console.log('‚úì Workout deleted from Firebase:', workoutId);
                } else {
                    const workouts = await this.loadWorkouts();
                    const filtered = workouts.filter(w => w.id !== workoutId);
                    localStorage.setItem('rowing_coach_workouts_v1', JSON.stringify(filtered));
                }
            }
            
            async saveChat(messages) {
                if (this.isFirebase) {
                    const { doc, setDoc, serverTimestamp } = window.firebaseModules;
                    const db = window.firebaseDb;
                    
                    await setDoc(doc(db, 'users', this.userId), {
                        chatHistory: messages,
                        chatUpdatedAt: serverTimestamp()
                    }, { merge: true });
                } else {
                    localStorage.setItem('rowing_coach_chat_v1', JSON.stringify(messages));
                }
            }
            
            async loadChat() {
                if (this.isFirebase) {
                    const { doc, getDoc } = window.firebaseModules;
                    const db = window.firebaseDb;
                    
                    const docSnap = await getDoc(doc(db, 'users', this.userId));
                    return docSnap.exists() ? (docSnap.data().chatHistory || []) : [];
                } else {
                    const data = localStorage.getItem('rowing_coach_chat_v1');
                    return data ? JSON.parse(data) : [];
                }
            }
        }
        
        const STORAGE_KEYS = {
            PROFILE: 'rowing_coach_profile_v1',
            WORKOUTS: 'rowing_coach_workouts_v1'
        };

        // PM5 Bluetooth Services (Concept2 specific)
        // Primary service for rowing data
        const PM5_SERVICE_UUID = '00001826-0000-1000-8000-00805f9b34fb'; // Fitness Machine Service
        const PM5_ROWING_SERVICE = 'ce060030-43e5-11e4-916c-0800200c9a66'; // Concept2 PM Service
        const PM5_CHARACTERISTIC_UUID = '00002ad2-0000-1000-8000-00805f9b34fb'; // Rowing Data
        const PM5_DEVICE_INFO = '0000180a-0000-1000-8000-00805f9b34fb'; // Device Info

        class AIRowingCoach {
            constructor() {
                this.dataStore = new DataStore();
                this.profile = null;
                this.workouts = [];
                this.chatHistory = [];
                this.trainingPlan = null;
                this.currentView = 0;
                this.builderMode = 'single-distance';
                this.builderTargets = { splitPace: false, pacer: false, strokeRate: false, heartRate: false };
                this.builderIntervals = [];
                this.editingInterval = -1;
                this.reviewWorkout = null;
                this.activeWorkout = null;
                this.workoutTimer = null;
                this.isCountingDown = false;
                this.waitingForFirstStroke = false;
                this.workoutTimeRemaining = 0;
                this.workoutTimeTotal = 0;
                
                // Rowing data
                this.liveData = { time: 0, dist: 0, pace: 0, watts: 0, rate: 0, hr: 0 };
                this.paceHistory = [];
                
                // PM5 & HRM
                this.pm5Device = null;
                this.pm5Characteristic = null;
                this.hrmDevice = null;
                this.hrmCharacteristic = null;
                
                this.init();
            }

            async init() {
                // Initialize Capacitor Bluetooth
                if (window.Capacitor && window.Capacitor.Plugins.BleClient) {
                    try {
                        await window.Capacitor.Plugins.BleClient.initialize();
                        console.log('‚úì Capacitor Bluetooth initialized');
                    } catch (e) {
                        console.warn('Bluetooth init:', e);
                    }
                }

                // Initialize storage (Firebase or localStorage)
                await this.dataStore.init();

                await this.loadData();
                this.loadProfile();
                await this.loadDNA();
                await this.loadTrainingPlan();
                this.initAudioCoach();
                this.setupDashboardSwipe();
                this.renderBuilderMode();
                this.renderHistory();
                this.renderDNA();
                this.renderTrainingLog();
                this.updateStats();
                this.renderChat();
                
                // Chat input auto-resize
                const chatInput = document.getElementById('chatInput');
                if (chatInput) {
                    chatInput.addEventListener('input', () => {
                        chatInput.style.height = 'auto';
                        chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
                    });
                }
                
                // Welcome message if no chat history
                if (this.chatHistory.length === 0) {
                    this.addChatMessage('ai', 'Hey! ü§ñ I\'m Coach, your AI rowing assistant.\n\nI can help you:\n‚Ä¢ Create custom workouts\n‚Ä¢ Build training plans\n‚Ä¢ Analyze your performance\n‚Ä¢ Answer rowing questions\n\nWhat would you like to do?', ['Create workout', 'Build 4-week plan', 'Analyze my data']);
                }
            }

            async loadData() {
                try {
                    this.profile = await this.dataStore.loadProfile();
                    this.workouts = await this.dataStore.loadWorkouts();
                    this.chatHistory = await this.dataStore.loadChat();

                    console.log(`‚úì Loaded ${this.workouts.length} workouts from storage`);

                    // Add sample workouts if empty (for testing)
                    if (this.workouts.length === 0) {
                        console.log('‚ö†Ô∏è No workouts found - adding 8 sample workouts...');
                        this.workouts = this.getSampleWorkouts();
                        console.log('‚úì Sample workouts created:', this.workouts.length);

                        // Save sample workouts
                        for (const workout of this.workouts) {
                            await this.dataStore.saveWorkout(workout);
                        }
                        console.log('‚úì Sample workouts saved to storage');
                    }

                    console.log(`‚úì Total workouts ready: ${this.workouts.length}`);
                } catch (error) {
                    console.error('‚ùå Load error:', error);
                }
            }

            getSampleWorkouts() {
                const now = Date.now();
                const day = 24 * 60 * 60 * 1000;

                return [
                    // Today - Rowing
                    {
                        id: 'sample_1',
                        date: new Date(now).toISOString(),
                        activityType: 'rowing',
                        duration: 1200,
                        distance: 5000,
                        avgPace: 120,
                        avgHR: 165,
                        completed: true,
                        description: '5k Steady State',
                        metadata: { distance: 5000, avgPace: 120, avgHR: 165 }
                    },
                    // Today - Football
                    {
                        id: 'sample_2',
                        date: new Date(now - 2 * 60 * 60 * 1000).toISOString(),
                        activityType: 'football',
                        duration: 5400,
                        completed: true,
                        description: 'Team Practice',
                        metadata: { intensity: 7, avgHR: 155 }
                    },
                    // Yesterday - Rowing intervals
                    {
                        id: 'sample_3',
                        date: new Date(now - day).toISOString(),
                        activityType: 'rowing',
                        duration: 1500,
                        distance: 4000,
                        avgPace: 112,
                        avgHR: 178,
                        completed: true,
                        description: '8x500m Intervals',
                        metadata: { distance: 4000, avgPace: 112, avgHR: 178 }
                    },
                    // 2 days ago - BJJ
                    {
                        id: 'sample_4',
                        date: new Date(now - 2 * day).toISOString(),
                        activityType: 'bjj',
                        duration: 3600,
                        completed: true,
                        description: 'No-Gi Rolling',
                        metadata: { intensity: 9, avgHR: 172 }
                    },
                    // 3 days ago - Weights
                    {
                        id: 'sample_5',
                        date: new Date(now - 3 * day).toISOString(),
                        activityType: 'weights',
                        duration: 2700,
                        completed: true,
                        description: 'Upper Body Strength',
                        metadata: { intensity: 8, avgHR: 145 }
                    },
                    // 4 days ago - Rowing
                    {
                        id: 'sample_6',
                        date: new Date(now - 4 * day).toISOString(),
                        activityType: 'rowing',
                        duration: 1800,
                        distance: 10000,
                        avgPace: 108,
                        avgHR: 152,
                        completed: true,
                        description: '10k Long Pull',
                        metadata: { distance: 10000, avgPace: 108, avgHR: 152 }
                    },
                    // 5 days ago - Football
                    {
                        id: 'sample_7',
                        date: new Date(now - 5 * day).toISOString(),
                        activityType: 'football',
                        duration: 5400,
                        completed: true,
                        description: 'Match Day',
                        metadata: { intensity: 10, avgHR: 175 }
                    },
                    // 6 days ago - Rowing
                    {
                        id: 'sample_8',
                        date: new Date(now - 6 * day).toISOString(),
                        activityType: 'rowing',
                        duration: 900,
                        distance: 2000,
                        avgPace: 111,
                        avgHR: 184,
                        completed: true,
                        description: '2k Test',
                        metadata: { distance: 2000, avgPace: 111, avgHR: 184 }
                    }
                ];
            }

            async saveData() {
                try {
                    if (this.profile) {
                        await this.dataStore.saveProfile(this.profile);
                    }
                    await this.dataStore.saveChat(this.chatHistory);
                    // Note: Workouts saved individually via saveWorkout()
                } catch (error) {
                    console.error('Save error:', error);
                }
            }

            // ========================================================================
            // DNA FACT SHEET FUNCTIONALITY
            // ========================================================================

            async loadDNA() {
                try {
                    // Initialize default DNA profile
                    this.dnaProfile = {
                        medical_constraints: [
                            "C5-C7 Disc Replacement",
                            "C4-C5 Instability"
                        ],
                        performance_benchmarks: {
                            "2k_split": "1:51.0",
                            "2k_total": "7:24.0",
                            "5k_split": null,
                            "5k_total": null,
                            "max_hr": 184,
                            "avg_drag": 132
                        },
                        lifestyle: {
                            job: "office",
                            activity_level: "Sedentary (Office Job)",
                            sleep_quality: 7,
                            stress_level: "medium"
                        },
                        ai_summary: "Connect your PM5 and complete a workout to receive personalized insights.",
                        status: "ready",  // "ready" or "caution"
                        last_updated: new Date().toISOString()
                    };

                    // Try to load from localStorage or Firebase
                    const stored = localStorage.getItem('rowing_coach_dna_v1');
                    if (stored) {
                        this.dnaProfile = { ...this.dnaProfile, ...JSON.parse(stored) };
                    }

                    console.log('‚úì DNA Profile loaded');
                } catch (error) {
                    console.error('DNA load error:', error);
                }
            }

            async saveDNA() {
                try {
                    this.dnaProfile.last_updated = new Date().toISOString();
                    localStorage.setItem('rowing_coach_dna_v1', JSON.stringify(this.dnaProfile));
                    console.log('‚úì DNA Profile saved');
                } catch (error) {
                    console.error('DNA save error:', error);
                }
            }

            renderDNA() {
                if (!this.dnaProfile) return;

                const pb = this.dnaProfile.performance_benchmarks;
                const lifestyle = this.dnaProfile.lifestyle;

                // Update status indicator
                const statusIndicator = document.getElementById('dnaStatusIndicator');
                const statusText = document.getElementById('dnaStatusText');
                if (statusIndicator && statusText) {
                    if (this.dnaProfile.status === 'ready') {
                        statusIndicator.className = 'dna-status-indicator ready';
                        statusText.textContent = 'READY';
                        statusText.style.color = '#00FF99';
                    } else {
                        statusIndicator.className = 'dna-status-indicator caution';
                        statusText.textContent = 'CAUTION: DELOAD RECOMMENDED';
                        statusText.style.color = '#FF0000';
                    }
                }

                // Update benchmarks
                const set = (id, value) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = value || '--';
                };

                set('dna2kPB', pb['2k_split'] || '--:--');
                set('dna2kTotal', pb['2k_total'] ? `(${pb['2k_total']})` : '');
                set('dna5kPB', pb['5k_split'] || '--:--');
                set('dna5kTotal', pb['5k_total'] || '--');
                set('dnaMaxHR', pb.max_hr || '--');
                set('dnaAvgDrag', pb.avg_drag || '--');

                // Update lifestyle
                set('dnaSleepValue', `${lifestyle.sleep_quality}/10`);
                set('dnaStressValue', lifestyle.stress_level || 'Medium');
                set('dnaActivityLevel', lifestyle.activity_level || 'Unknown');

                // Update progress bars
                const sleepBar = document.getElementById('dnaSleepBar');
                if (sleepBar) {
                    sleepBar.style.width = `${(lifestyle.sleep_quality / 10) * 100}%`;
                }

                const stressBar = document.getElementById('dnaStressBar');
                if (stressBar) {
                    const stressMap = { low: 30, medium: 50, high: 80 };
                    stressBar.style.width = `${stressMap[lifestyle.stress_level] || 50}%`;
                }

                // Update AI insight
                set('dnaAIInsight', this.dnaProfile.ai_summary);

                // Update workout history list
                const workoutList = document.getElementById('dnaWorkoutList');
                const workoutCount = document.getElementById('dnaWorkoutCount');

                if (workoutCount) {
                    workoutCount.textContent = this.workouts.length;
                }

                if (workoutList && this.workouts.length > 0) {
                    // Show last 10 workouts
                    const recentWorkouts = this.workouts.slice(0, 10);
                    workoutList.innerHTML = recentWorkouts.map(w => `
                        <div style="background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-size: 14px; font-weight: bold; color: var(--text);">
                                    ${w.description || 'Workout'}
                                </div>
                                <div style="font-size: 11px; color: #666;">
                                    ${new Date(w.date).toLocaleDateString()}
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; font-size: 11px;">
                                <div>
                                    <div style="color: #666;">Distance</div>
                                    <div style="color: #00FF99; font-weight: bold;">${w.distance}m</div>
                                </div>
                                <div>
                                    <div style="color: #666;">Avg Pace</div>
                                    <div style="color: #00FF99; font-weight: bold;">${this.formatPace(w.avgPace)}</div>
                                </div>
                                <div>
                                    <div style="color: #666;">Avg HR</div>
                                    <div style="color: #FF6B6B; font-weight: bold;">${w.avgHR || '--'}</div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            }

            async updateDNAProfile(workoutData) {
                if (!this.dnaProfile) return;

                // Update performance benchmarks if new PBs detected
                const avgPace = workoutData.avgPace;  // in seconds per 500m
                const distance = workoutData.distance;
                const avgHR = workoutData.avgHR;

                // Check for 2k PB
                if (distance >= 2000 && distance <= 2050) {
                    const current2kSplit = this.convertPaceToSeconds(this.dnaProfile.performance_benchmarks['2k_split']);
                    if (!current2kSplit || avgPace < current2kSplit) {
                        this.dnaProfile.performance_benchmarks['2k_split'] = this.formatPace(avgPace);
                        const totalTime = (avgPace * 4);  // 2000m = 4 x 500m
                        this.dnaProfile.performance_benchmarks['2k_total'] = this.formatTime(totalTime);
                        this.showToast('üéâ New 2k PB!', 'success');
                    }
                }

                // Check for 5k PB
                if (distance >= 5000 && distance <= 5050) {
                    const current5kSplit = this.convertPaceToSeconds(this.dnaProfile.performance_benchmarks['5k_split']);
                    if (!current5kSplit || avgPace < current5kSplit) {
                        this.dnaProfile.performance_benchmarks['5k_split'] = this.formatPace(avgPace);
                        const totalTime = (avgPace * 10);  // 5000m = 10 x 500m
                        this.dnaProfile.performance_benchmarks['5k_total'] = this.formatTime(totalTime);
                        this.showToast('üéâ New 5k PB!', 'success');
                    }
                }

                // Update Max HR if exceeded
                if (avgHR > this.dnaProfile.performance_benchmarks.max_hr) {
                    this.dnaProfile.performance_benchmarks.max_hr = avgHR;
                }

                // Generate AI insight using simple analysis
                this.generateAIInsight(workoutData);

                await this.saveDNA();
                this.renderDNA();
                this.renderTrainingLog();
            }

            generateAIInsight(workoutData) {
                // Simple rule-based insight generation (will be replaced with Claude API later)
                const insights = [];

                // Check pacing consistency
                if (workoutData.intervals && workoutData.intervals.length > 1) {
                    const splits = workoutData.intervals.map(i => i.avgPace);
                    const spread = Math.max(...splits) - Math.min(...splits);
                    if (spread < 2) {
                        insights.push("Excellent pacing consistency! Your split spread was under 2 seconds.");
                    } else if (spread > 5) {
                        insights.push(`Your pacing varied by ${spread.toFixed(1)}s. Focus on maintaining consistent effort.`);
                    }
                }

                // Check HR response
                if (workoutData.avgHR) {
                    const maxHR = this.dnaProfile.performance_benchmarks.max_hr;
                    const hrPercent = (workoutData.avgHR / maxHR) * 100;
                    if (hrPercent > 90) {
                        insights.push(`High HR effort at ${hrPercent.toFixed(0)}% of max. Consider 48hr recovery.`);
                    } else if (hrPercent < 70) {
                        insights.push(`Good Zone 2 work at ${hrPercent.toFixed(0)}% of max HR.`);
                    }
                }

                // Medical safety check
                if (workoutData.avgHR > 175) {
                    insights.push("‚ö†Ô∏è Remember your C5-C7 condition. Monitor for hand numbness.");
                }

                this.dnaProfile.ai_summary = insights.join(' ') || this.dnaProfile.ai_summary;
            }

            convertPaceToSeconds(paceString) {
                if (!paceString || paceString === '--:--') return null;
                const [min, sec] = paceString.split(':').map(Number);
                return min * 60 + sec;
            }

            formatPace(seconds) {
                if (!seconds || seconds === 0) return '--:--';
                const mins = Math.floor(seconds / 60);
                const secs = (seconds % 60).toFixed(1);
                return `${mins}:${secs.padStart(4, '0')}`;
            }

            formatTime(seconds) {
                if (!seconds || seconds === 0) return '0:00';
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            toggleInjuryDetails() {
                this.showToast('Injury details: Hand numbness/weakness. C5-C7 disc replacement. Monitor during high-intensity efforts.', 'success');
            }

            async showCSVMapper(event) {
                const file = event.target.files[0];
                if (!file) return;

                try {
                    const text = await file.text();
                    const lines = text.split('\n').filter(line => line.trim());

                    if (lines.length < 2) {
                        this.showToast('CSV file is empty or invalid', 'error');
                        return;
                    }

                    // Store CSV data for later import
                    this.pendingCSV = { text, lines };

                    // Parse header
                    const headerCols = this.parseCSVLine(lines[0]);
                    console.log('üìã Found', headerCols.length, 'columns:', headerCols);

                    // Build preview table (first 3 rows)
                    const previewTable = document.getElementById('csvPreviewTable');
                    let tableHTML = '<thead><tr>';
                    headerCols.forEach((col, idx) => {
                        tableHTML += `<th style="padding: 8px; border-bottom: 2px solid var(--border); text-align: left; white-space: nowrap;">${idx}: ${col}</th>`;
                    });
                    tableHTML += '</tr></thead><tbody>';

                    // Add up to 3 data rows for preview
                    for (let i = 1; i < Math.min(4, lines.length); i++) {
                        const rowCols = this.parseCSVLine(lines[i]);
                        tableHTML += '<tr>';
                        rowCols.forEach(cell => {
                            tableHTML += `<td style="padding: 8px; border-bottom: 1px solid var(--border); white-space: nowrap;">${cell}</td>`;
                        });
                        tableHTML += '</tr>';
                    }
                    tableHTML += '</tbody>';
                    previewTable.innerHTML = tableHTML;

                    // Fill dropdown selectors
                    const dropdowns = ['csvMapDate', 'csvMapDescription', 'csvMapTime', 'csvMapDistance', 'csvMapPace', 'csvMapWatts', 'csvMapHR'];
                    dropdowns.forEach(id => {
                        const select = document.getElementById(id);
                        select.innerHTML = '<option value="-1">-- Skip this field --</option>';
                        headerCols.forEach((col, idx) => {
                            select.innerHTML += `<option value="${idx}">${idx}: ${col}</option>`;
                        });
                    });

                    // Apply smart defaults based on column names
                    headerCols.forEach((name, idx) => {
                        const lower = name.toLowerCase().trim();

                        // Date - prefer "Date" over "Date Entered"
                        if (lower === 'date' && document.getElementById('csvMapDate').value === '-1') {
                            document.getElementById('csvMapDate').value = idx;
                        } else if (lower.includes('date') && !lower.includes('entered') && document.getElementById('csvMapDate').value === '-1') {
                            document.getElementById('csvMapDate').value = idx;
                        }

                        // Description
                        if ((lower.includes('description') || lower === 'type') && document.getElementById('csvMapDescription').value === '-1') {
                            document.getElementById('csvMapDescription').value = idx;
                        }

                        // Work Time - prefer "Work Time (Seconds)" over "Rest Time"
                        if (lower.includes('work time') && lower.includes('seconds')) {
                            document.getElementById('csvMapTime').value = idx;
                        } else if (lower.includes('time') && lower.includes('seconds') && !lower.includes('rest') && document.getElementById('csvMapTime').value === '-1') {
                            document.getElementById('csvMapTime').value = idx;
                        }

                        // Work Distance - prefer "Work Distance" over "Rest Distance"
                        if (lower.includes('work distance')) {
                            document.getElementById('csvMapDistance').value = idx;
                        } else if (lower === 'distance' && document.getElementById('csvMapDistance').value === '-1') {
                            document.getElementById('csvMapDistance').value = idx;
                        }

                        // Pace
                        if ((lower.includes('pace') || lower.includes('avg pace')) && document.getElementById('csvMapPace').value === '-1') {
                            document.getElementById('csvMapPace').value = idx;
                        }

                        // Watts
                        if (lower.includes('watts') && document.getElementById('csvMapWatts').value === '-1') {
                            document.getElementById('csvMapWatts').value = idx;
                        }

                        // Heart Rate
                        if ((lower.includes('heart') || lower.includes('avg hr')) && document.getElementById('csvMapHR').value === '-1') {
                            document.getElementById('csvMapHR').value = idx;
                        }
                    });

                    // Show modal
                    document.getElementById('csvMapperModal').style.display = 'flex';
                    console.log('‚úì Column mapper ready');

                } catch (error) {
                    console.error('CSV mapper error:', error);
                    if (error.name === 'NotReadableError') {
                        this.showToast('Cannot read file - please check file permissions', 'error');
                    } else if (error.message.includes('Unexpected end of data')) {
                        this.showToast('CSV file is empty or corrupted', 'error');
                    } else {
                        this.showToast('Failed to read CSV: ' + (error.message || 'Invalid file format'), 'error');
                    }
                }
            }

            closeCSVMapper() {
                document.getElementById('csvMapperModal').style.display = 'none';
                this.pendingCSV = null;
                // Reset file input
                document.getElementById('csvFileInput').value = '';
            }

            async importWithMapping() {
                if (!this.pendingCSV) {
                    this.showToast('No CSV file loaded', 'error');
                    return;
                }

                try {
                    // Get user's column mapping
                    const mapping = {
                        date: parseInt(document.getElementById('csvMapDate').value),
                        description: parseInt(document.getElementById('csvMapDescription').value),
                        time: parseInt(document.getElementById('csvMapTime').value),
                        distance: parseInt(document.getElementById('csvMapDistance').value),
                        pace: parseInt(document.getElementById('csvMapPace').value),
                        watts: parseInt(document.getElementById('csvMapWatts').value),
                        hr: parseInt(document.getElementById('csvMapHR').value)
                    };

                    console.log('üìä User column mapping:', mapping);

                    // Validate at least date is selected
                    if (mapping.date === -1) {
                        this.showToast('Please select a Date column', 'error');
                        return;
                    }

                    const { lines } = this.pendingCSV;
                    const headerCols = this.parseCSVLine(lines[0]);
                    let importedCount = 0;
                    let skippedCount = 0;

                    // Parse each data row
                    for (let i = 1; i < lines.length; i++) {
                        try {
                            const cols = this.parseCSVLine(lines[i]);

                            // Extract values using user's mapping
                            const dateStr = mapping.date !== -1 ? cols[mapping.date] : '';
                            const description = mapping.description !== -1 ? cols[mapping.description] : 'Imported workout';
                            const timeValue = mapping.time !== -1 ? cols[mapping.time] : '0';
                            const distanceValue = mapping.distance !== -1 ? cols[mapping.distance] : '0';
                            const paceValue = mapping.pace !== -1 ? cols[mapping.pace] : '0:00';
                            const wattsValue = mapping.watts !== -1 ? cols[mapping.watts] : '0';
                            const hrValue = mapping.hr !== -1 ? cols[mapping.hr] : '0';

                            if (!dateStr) {
                                skippedCount++;
                                continue;
                            }

                            // Parse values
                            const duration = this.parseTimeToSeconds(timeValue);
                            const distance = parseInt(distanceValue) || 0;
                            const pace = this.parsePaceToSeconds(paceValue);
                            const watts = parseInt(wattsValue) || 0;
                            const avgHR = parseInt(hrValue) || 0;

                            // Parse date
                            let workoutDate;
                            try {
                                workoutDate = new Date(dateStr);
                                if (isNaN(workoutDate.getTime())) {
                                    console.warn(`Invalid date on line ${i + 1}: ${dateStr}`);
                                    skippedCount++;
                                    continue;
                                }
                            } catch (e) {
                                console.warn(`Date parse error on line ${i + 1}:`, e);
                                skippedCount++;
                                continue;
                            }

                            // Create workout object
                            const workout = {
                                id: 'csv_' + Date.now() + '_' + i,
                                date: workoutDate.toISOString(),
                                activityType: 'rowing',
                                duration: duration,
                                distance: distance,
                                avgPace: pace || (duration && distance ? (duration / (distance / 500)) : 0),
                                avgHR: avgHR,
                                avgWatts: watts,
                                description: description || 'Imported from CSV',
                                metadata: {
                                    distance: distance,
                                    avgPace: pace || (duration && distance ? (duration / (distance / 500)) : 0),
                                    avgHR: avgHR,
                                    avgWatts: watts,
                                    source: 'csv_import'
                                }
                            };

                            console.log(`‚úì Line ${i + 1}: ${distance}m, pace=${paceValue}, time=${timeValue}s`);
                            await this.dataStore.saveWorkout(workout);
                            importedCount++;

                        } catch (rowError) {
                            console.error(`Error parsing line ${i + 1}:`, rowError);
                            skippedCount++;
                        }
                    }

                    // Close modal
                    this.closeCSVMapper();

                    // Show results
                    this.showToast(`‚úì Imported ${importedCount} workouts${skippedCount > 0 ? ` (skipped ${skippedCount})` : ''}`, 'success');

                    // Refresh Training Log
                    this.renderTrainingLog();
                    this.navigate('screenTrainingLog');

                } catch (error) {
                    console.error('Import error:', error);
                    this.showToast('Import failed: ' + error.message, 'error');
                }
            }

            parsePaceToSeconds(paceStr) {
                if (!paceStr || paceStr === '--:--' || paceStr === '0:00') return 0;

                // Handle format like "2:25.7" or "2:25"
                const parts = paceStr.split(':');
                if (parts.length === 2) {
                    const mins = parseInt(parts[0]) || 0;
                    const secs = parseFloat(parts[1]) || 0;
                    return mins * 60 + secs;
                }

                return parseFloat(paceStr) || 0;
            }

            async handleCSVUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                this.showToast('Processing CSV file...', 'success');

                try {
                    const text = await file.text();
                    const lines = text.split('\n').filter(line => line.trim());

                    if (lines.length < 2) {
                        throw new Error('CSV file is empty or invalid');
                    }

                    // Parse header to get column positions
                    const headerCols = this.parseCSVLine(lines[0]);
                    console.log('üìã CSV Columns found:', headerCols.length);
                    console.log('üìã Column names:', headerCols);

                    // Find column indexes dynamically
                    const colMap = {};
                    headerCols.forEach((name, idx) => {
                        const lower = name.toLowerCase().trim();
                        if (lower.includes('date')) colMap.date = idx;
                        if (lower.includes('description') || lower.includes('type')) colMap.description = idx;
                        if (lower.includes('work time') || lower.includes('time')) colMap.time = idx;
                        if (lower.includes('work distance') || lower.includes('distance')) colMap.distance = idx;
                        if (lower.includes('avg pace') || lower.includes('pace')) colMap.pace = idx;
                        if (lower.includes('avg watts') || lower.includes('watts')) colMap.watts = idx;
                        if (lower.includes('avg hr') || lower.includes('heart')) colMap.hr = idx;
                    });

                    console.log('üìã Column mapping:', colMap);

                    if (!colMap.distance || !colMap.pace) {
                        throw new Error('Could not find Distance or Pace columns. Please check your CSV format.');
                    }

                    // Process data rows
                    const dataLines = lines.slice(1);
                    let imported = 0;
                    let skipped = 0;

                    console.log(`üìä Processing ${dataLines.length} rows...`);

                    for (let i = 0; i < dataLines.length; i++) {
                        try {
                            const cols = this.parseCSVLine(dataLines[i]);

                            if (cols.length < 3) {
                                console.log(`‚è≠Ô∏è Line ${i+2}: Too few columns (${cols.length})`);
                                skipped++;
                                continue;
                            }

                            // Extract fields using column map
                            const dateStr = cols[colMap.date] || '';
                            const description = cols[colMap.description] || 'Imported Workout';
                            const workTimeStr = cols[colMap.time] || '0';
                            const distanceStr = cols[colMap.distance] || '0';
                            const avgPaceStr = cols[colMap.pace] || '';
                            const avgWattsStr = cols[colMap.watts] || '0';
                            const avgHRStr = cols[colMap.hr] || '';

                            console.log(`üìù Line ${i+2}: dist=${distanceStr}, pace=${avgPaceStr}, time=${workTimeStr}`);

                            // Parse values
                            const distance = parseInt(distanceStr.replace(/[^0-9]/g, '')) || 0;
                            const workTime = this.parseTimeToSeconds(workTimeStr);
                            const avgPace = this.parsePaceToSeconds(avgPaceStr);
                            const avgWatts = parseInt(avgWattsStr.replace(/[^0-9]/g, '')) || 0;
                            const avgHR = parseInt(avgHRStr.replace(/[^0-9]/g, '')) || null;

                            // Validate
                            if (distance === 0) {
                                console.log(`‚è≠Ô∏è Line ${i+2}: Distance is 0, skipping`);
                                skipped++;
                                continue;
                            }

                            if (avgPace === 0) {
                                console.log(`‚è≠Ô∏è Line ${i+2}: Pace is 0, skipping`);
                                skipped++;
                                continue;
                            }

                            // Parse date
                            let workoutDate;
                            try {
                                workoutDate = new Date(dateStr);
                                if (isNaN(workoutDate.getTime())) {
                                    workoutDate = new Date();
                                }
                            } catch (e) {
                                workoutDate = new Date();
                            }

                            // Create workout
                            const workout = {
                                id: `import_${workoutDate.getTime()}_${imported}`,
                                date: workoutDate.toISOString(),
                                activityType: 'rowing',
                                type: 'imported',
                                description: description,
                                duration: workTime,
                                distance: distance,
                                avgPace: avgPace,
                                avgWatts: avgWatts,
                                avgHR: avgHR,
                                completed: true,
                                metadata: {
                                    distance: distance,
                                    avgPace: avgPace,
                                    avgHR: avgHR
                                }
                            };

                            // Save
                            await this.dataStore.saveWorkout(workout);
                            this.workouts.unshift(workout);
                            imported++;

                            // Update DNA for rowing
                            await this.updateDNAProfile(workout);

                            console.log(`‚úì Line ${i+2}: Imported successfully`);

                        } catch (lineError) {
                            console.error(`‚ùå Line ${i + 2}:`, lineError.message);
                            skipped++;
                        }
                    }

                    console.log(`‚úÖ Import complete: ${imported} imported, ${skipped} skipped`);
                    console.log(`üìä Total workouts in memory: ${this.workouts.length}`);

                    if (imported > 0) {
                        this.showToast(`‚úì Imported ${imported} workouts! (${skipped} skipped)`, 'success');

                        console.log('üîÑ Refreshing displays...');
                        this.renderDNA();
                        this.renderTrainingLog();
                        this.updateStats();
                        console.log('‚úÖ Displays refreshed');

                        // Navigate to Training Log to show imported workouts
                        setTimeout(() => {
                            this.navigate('screenTrainingLog');
                        }, 500);
                    } else {
                        throw new Error(`No valid workouts found. ${skipped} rows skipped. Check console for details.`);
                    }

                } catch (error) {
                    console.error('‚ùå CSV import error:', error);
                    this.showToast('CSV import failed: ' + error.message, 'error');
                }

                // Reset file input
                event.target.value = '';
            }

            parseCSVLine(line) {
                // Handle CSV with quoted fields
                const result = [];
                let current = '';
                let inQuotes = false;

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];

                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current.trim());

                return result;
            }

            parseTimeToSeconds(timeStr) {
                // Parse format: mm:ss.t or hh:mm:ss.t or just seconds
                if (!timeStr || timeStr === '') return 0;

                // Remove any non-numeric characters except : and .
                timeStr = timeStr.toString().trim();

                // If it's just a number, return it
                if (!timeStr.includes(':')) {
                    const num = parseFloat(timeStr);
                    return isNaN(num) ? 0 : num;
                }

                const parts = timeStr.split(':');

                try {
                    if (parts.length === 2) {
                        // mm:ss.t
                        const min = parseInt(parts[0]) || 0;
                        const sec = parseFloat(parts[1]) || 0;
                        return min * 60 + sec;
                    } else if (parts.length === 3) {
                        // hh:mm:ss.t
                        const hr = parseInt(parts[0]) || 0;
                        const min = parseInt(parts[1]) || 0;
                        const sec = parseFloat(parts[2]) || 0;
                        return hr * 3600 + min * 60 + sec;
                    }
                } catch (e) {
                    console.warn('Time parse error:', timeStr, e);
                    return 0;
                }

                return 0;
            }

            parsePaceToSeconds(paceStr) {
                // Parse pace format: m:ss.t (pace per 500m)
                if (!paceStr || paceStr === '') return 0;

                paceStr = paceStr.toString().trim();

                // If it's just a number, return it
                if (!paceStr.includes(':')) {
                    const num = parseFloat(paceStr);
                    return isNaN(num) ? 0 : num;
                }

                const parts = paceStr.split(':');

                try {
                    if (parts.length === 2) {
                        const min = parseInt(parts[0]) || 0;
                        const sec = parseFloat(parts[1]) || 0;
                        return min * 60 + sec;
                    }
                } catch (e) {
                    console.warn('Pace parse error:', paceStr, e);
                    return 0;
                }

                return 0;
            }

            // ========================================================================
            // TRAINING PLAN
            // ========================================================================

            async loadTrainingPlan() {
                try {
                    // Load from Firebase or localStorage
                    const planData = localStorage.getItem('trainingPlan');
                    if (planData) {
                        this.trainingPlan = JSON.parse(planData);
                        console.log('‚úì Training plan loaded:', this.trainingPlan.weeks.length, 'weeks');
                    } else {
                        this.trainingPlan = null;
                    }
                } catch (error) {
                    console.error('Error loading training plan:', error);
                    this.trainingPlan = null;
                }
            }

            async saveTrainingPlan(plan) {
                try {
                    this.trainingPlan = plan;
                    localStorage.setItem('trainingPlan', JSON.stringify(plan));
                    console.log('‚úì Training plan saved');
                } catch (error) {
                    console.error('Error saving training plan:', error);
                }
            }

            createNewPlan() {
                // Show loading state
                this.showToast('Creating your 12-week plan...', 'info');

                // Sample 12-week rowing plan with progressive volume
                const startDate = new Date();
                const weeks = [];

                for (let weekNum = 1; weekNum <= 12; weekNum++) {
                    const weekStart = new Date(startDate);
                    weekStart.setDate(startDate.getDate() + (weekNum - 1) * 7);

                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 6);

                    const days = this.generateWeekDays(weekNum, weekStart);

                    const week = {
                        weekNumber: weekNum,
                        startDate: weekStart.toISOString(),
                        endDate: weekEnd.toISOString(),
                        theme: this.getWeekTheme(weekNum),
                        days: days,
                        totalDistance: days.reduce((sum, d) => sum + (d.distance || 0), 0),
                        totalDuration: days.reduce((sum, d) => sum + (d.duration || 0), 0),
                        workoutCount: days.filter(d => d.type !== 'rest').length
                    };

                    weeks.push(week);
                }

                const plan = {
                    id: 'plan_' + Date.now(),
                    title: '12-Week Rowing Development',
                    created: new Date().toISOString(),
                    startDate: startDate.toISOString(),
                    weeks: weeks,
                    currentWeek: 1
                };

                this.saveTrainingPlan(plan);
                this.renderTrainingPlan();
                this.showToast('‚úì 12-week plan created', 'success');
            }

            getWeekTheme(weekNum) {
                const themes = [
                    'Base Building',
                    'Aerobic Development',
                    'Technique Focus',
                    'Volume Increase',
                    'Recovery Week',
                    'Threshold Work',
                    'Lactate Tolerance',
                    'Race Prep',
                    'Taper Begin',
                    'Peak Week',
                    'Race Week',
                    'Recovery & Reflection'
                ];
                return themes[(weekNum - 1) % themes.length];
            }

            generateWeekDays(weekNum, weekStart) {
                // Progressive training structure
                const isRecoveryWeek = weekNum % 4 === 0;
                const baseDistance = 5000 + (weekNum * 200);

                const days = [];
                const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

                for (let dayIdx = 0; dayIdx < 7; dayIdx++) {
                    const date = new Date(weekStart);
                    date.setDate(weekStart.getDate() + dayIdx);

                    let workout;

                    if (isRecoveryWeek) {
                        // Recovery week - lighter load
                        workout = this.getRecoveryDayWorkout(dayIdx, Math.floor(baseDistance * 0.7));
                    } else {
                        // Normal training week
                        workout = this.getRegularDayWorkout(dayIdx, weekNum, baseDistance);
                    }

                    days.push({
                        ...workout,
                        dayName: dayNames[dayIdx],
                        date: date.toISOString(),
                        completed: false
                    });
                }

                return days;
            }

            getRecoveryDayWorkout(dayIdx, baseDistance) {
                const workouts = {
                    0: { type: 'rowing', title: 'Easy Steady State', distance: Math.floor(baseDistance * 0.8), duration: 1500, intensity: 'Zone 2', description: 'Easy aerobic rowing at conversational pace' },
                    1: { type: 'rest', title: 'Active Recovery', description: 'Light stretching, walking, or yoga' },
                    2: { type: 'rowing', title: 'Technique Focus', distance: Math.floor(baseDistance * 0.6), duration: 1200, intensity: 'Zone 1-2', description: 'Low rate (18-20spm), focus on form' },
                    3: { type: 'rest', title: 'Rest Day', description: 'Full rest or light mobility work' },
                    4: { type: 'rowing', title: 'Easy Distance', distance: baseDistance, duration: 2000, intensity: 'Zone 2', description: 'Comfortable steady state' },
                    5: { type: 'rest', title: 'Rest Day', description: 'Full rest' },
                    6: { type: 'rest', title: 'Rest Day', description: 'Full rest or very light activity' }
                };
                return workouts[dayIdx];
            }

            getRegularDayWorkout(dayIdx, weekNum, baseDistance) {
                const pb2k = this.dnaProfile?.performance_benchmarks?.['2k_split'] || '1:51.0';
                const targetPace = this.formatPace(this.convertPaceToSeconds(pb2k) + 6);

                const workouts = {
                    0: { type: 'rowing', title: 'Intervals 8x500m', distance: 4000, duration: 1500, intensity: 'Zone 4', description: `8x500m @ 2k+6s, 90s rest. Target: ${targetPace}` },
                    1: { type: 'weights', title: 'Strength Training', duration: 2700, intensity: 'Moderate', description: 'Squats 3x8, Deadlifts 3x6, Core work' },
                    2: { type: 'rowing', title: 'Steady State', distance: Math.floor(baseDistance * 1.2), duration: 2400, intensity: 'Zone 2', description: 'Conversational pace, focus on consistency' },
                    3: { type: 'rest', title: 'Active Recovery', description: 'Light stretching, foam rolling' },
                    4: { type: 'rowing', title: 'Pyramid Workout', distance: 5000, duration: 1800, intensity: 'Zone 3-4', description: '500-1000-1500-1000-500 @ 2k+8s with 2min rest' },
                    5: { type: 'rowing', title: 'Long Slow Distance', distance: Math.floor(baseDistance * 1.5), duration: 3600, intensity: 'Zone 2', description: 'Build aerobic base, comfortable pace' },
                    6: { type: 'rest', title: 'Rest Day', description: 'Full rest' }
                };

                const workout = workouts[dayIdx];

                // Adjust distance for week progression (every 3 weeks increase)
                if (workout.type === 'rowing' && weekNum > 3) {
                    const multiplier = 1 + Math.floor(weekNum / 3) * 0.05;
                    workout.distance = Math.floor(workout.distance * multiplier);
                }

                return workout;
            }

            renderTrainingPlan() {
                const container = document.getElementById('planContent');
                if (!container) return;

                if (!this.trainingPlan) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìÖ</div>
                            <div style="font-size:14px; line-height:1.6; margin-bottom: 24px;">
                                No training plan yet.<br>
                                Create a 12-week progressive plan tailored to your goals.
                            </div>
                            <button class="btn btn-primary" onclick="app.createNewPlan()" style="max-width: 280px; margin: 0 auto;">
                                Create 12-Week Plan
                            </button>
                        </div>
                    `;
                    return;
                }

                // Render based on current view
                const viewType = this.currentPlanView || 'timeline';
                if (viewType === 'week') {
                    this.renderWeekView();
                } else if (viewType === 'month') {
                    this.renderMonthView();
                } else {
                    this.renderTimelineView();
                }
            }

            renderWeekDays(week) {
                let html = '';
                week.days.forEach((day, idx) => {
                    const date = new Date(day.date);
                    const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    const isRest = day.type === 'rest';

                    html += `
                        <div class="plan-day-card ${isRest ? 'rest' : ''} ${day.completed ? 'completed' : ''}"
                             onclick="app.showDayDetails(${week.weekNumber}, ${idx})">
                            <div class="plan-day-header">
                                <div>
                                    <div class="plan-day-name">${day.dayName}</div>
                                    <div class="plan-day-date">${dateStr}</div>
                                </div>
                                <div>
                                    <span class="plan-day-badge ${day.type}">${day.type}</span>
                                    ${day.completed ? '<span class="plan-day-badge completed">‚úì</span>' : ''}
                                </div>
                            </div>
                            <div class="plan-day-workout">${day.title}</div>
                            <div class="plan-day-details">
                                ${day.distance ? `<span>üìè ${day.distance}m</span>` : ''}
                                ${day.duration ? `<span>‚è±Ô∏è ${this.formatTime(day.duration)}</span>` : ''}
                                ${day.intensity ? `<span>üí™ ${day.intensity}</span>` : ''}
                            </div>
                        </div>
                    `;
                });
                return html;
            }

            toggleWeekExpansion(weekNumber) {
                const daysContainer = document.getElementById(`days_${weekNumber}`);
                const expandIcon = document.getElementById(`expand_${weekNumber}`);

                if (daysContainer.classList.contains('expanded')) {
                    daysContainer.classList.remove('expanded');
                    expandIcon.classList.remove('expanded');
                } else {
                    daysContainer.classList.add('expanded');
                    expandIcon.classList.add('expanded');
                }
            }

            showDayDetails(weekNumber, dayIndex) {
                const week = this.trainingPlan.weeks.find(w => w.weekNumber === weekNumber);
                if (!week) return;

                const day = week.days[dayIndex];
                if (!day) return;

                // Build modal content
                const modal = document.getElementById('dayDetailsModal');
                const titleEl = document.getElementById('dayDetailsTitle');
                const bodyEl = document.getElementById('dayDetailsBody');
                const completeBtn = document.getElementById('dayDetailsCompleteBtn');
                const editBtn = document.getElementById('dayDetailsEditBtn');
                const deleteBtn = document.getElementById('dayDetailsDeleteBtn');

                const date = new Date(day.date);
                const dateStr = date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });

                titleEl.textContent = `${day.dayName} - ${day.title}`;

                bodyEl.innerHTML = `
                    <div style="margin-bottom: 16px;">
                        <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 12px;">${dateStr}</div>
                        <div style="font-size: 14px; line-height: 1.6; color: var(--text);">${day.description || 'No description'}</div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                        ${day.distance ? `
                        <div style="background: var(--panel); padding: 12px; border-radius: 8px;">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Distance</div>
                            <div style="font-size: 18px; font-weight: bold; color: #00FF99;">${day.distance}m</div>
                        </div>
                        ` : ''}
                        ${day.duration ? `
                        <div style="background: var(--panel); padding: 12px; border-radius: 8px;">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Duration</div>
                            <div style="font-size: 18px; font-weight: bold; color: #00FF99;">${this.formatTime(day.duration)}</div>
                        </div>
                        ` : ''}
                        ${day.intensity ? `
                        <div style="background: var(--panel); padding: 12px; border-radius: 8px;">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Intensity</div>
                            <div style="font-size: 18px; font-weight: bold; color: #00FF99;">${day.intensity}</div>
                        </div>
                        ` : ''}
                    </div>

                    <div style="background: ${day.completed ? 'rgba(0, 255, 153, 0.1)' : 'rgba(255, 0, 0, 0.05)'};
                                border: 1px solid ${day.completed ? '#00FF99' : '#FF0000'};
                                border-radius: 8px; padding: 12px; text-align: center;">
                        <div style="font-size: 14px; font-weight: 600; color: ${day.completed ? '#00FF99' : '#FF0000'};">
                            ${day.completed ? '‚úì Completed' : 'Not Completed'}
                        </div>
                    </div>
                `;

                // Set up button handlers
                completeBtn.onclick = () => {
                    day.completed = !day.completed;
                    this.saveTrainingPlan(this.trainingPlan);
                    this.renderTrainingPlan();
                    this.closeDayDetails();
                    this.showToast(day.completed ? '‚úì Marked complete' : 'Marked incomplete', 'success');
                };

                completeBtn.textContent = day.completed ? 'Mark Incomplete' : 'Mark Complete';

                editBtn.onclick = () => {
                    this.editPlanDay(weekNumber, dayIndex);
                };

                deleteBtn.onclick = () => {
                    this.deletePlanDay(weekNumber, dayIndex);
                };

                // Show modal
                modal.style.display = 'flex';
            }

            closeDayDetails() {
                document.getElementById('dayDetailsModal').style.display = 'none';
            }

            editPlanDay(weekNumber, dayIndex) {
                const week = this.trainingPlan.weeks.find(w => w.weekNumber === weekNumber);
                if (!week) return;

                const day = week.days[dayIndex];
                if (!day) return;

                // Switch modal to edit mode
                const modal = document.getElementById('dayDetailsModal');
                const titleEl = document.getElementById('dayDetailsTitle');
                const bodyEl = document.getElementById('dayDetailsBody');
                const footerEl = document.getElementById('dayDetailsFooter');

                titleEl.textContent = 'Edit Workout';

                // Build inline edit form
                bodyEl.innerHTML = `
                    <div class="builder-input-group">
                        <div class="builder-label">Workout Title</div>
                        <input type="text" class="builder-input" id="editDayTitle" value="${day.title || ''}" placeholder="e.g. 8x500m Intervals" style="font-size: 16px;">
                    </div>

                    <div class="builder-input-group">
                        <div class="builder-label">Description</div>
                        <textarea class="builder-input" id="editDayDescription" rows="3" placeholder="e.g. 8x500m @ 2k+6s with 90s rest" style="font-size: 16px;">${day.description || ''}</textarea>
                    </div>

                    ${day.type === 'rowing' ? `
                    <div class="builder-input-group">
                        <div class="builder-label">Distance (meters)</div>
                        <input type="number" class="builder-input" id="editDayDistance" value="${day.distance || ''}" placeholder="5000" style="font-size: 16px;">
                    </div>

                    <div class="builder-input-group">
                        <div class="builder-label">Duration (seconds)</div>
                        <input type="number" class="builder-input" id="editDayDuration" value="${day.duration || ''}" placeholder="1200" style="font-size: 16px;">
                    </div>

                    <div class="builder-input-group">
                        <div class="builder-label">Intensity Zone</div>
                        <select class="builder-input" id="editDayIntensity" style="font-size: 16px;">
                            <option value="Zone 1" ${day.intensity === 'Zone 1' ? 'selected' : ''}>Zone 1 (Recovery)</option>
                            <option value="Zone 2" ${day.intensity === 'Zone 2' ? 'selected' : ''}>Zone 2 (Aerobic)</option>
                            <option value="Zone 3" ${day.intensity === 'Zone 3' ? 'selected' : ''}>Zone 3 (Tempo)</option>
                            <option value="Zone 4" ${day.intensity === 'Zone 4' ? 'selected' : ''}>Zone 4 (Threshold)</option>
                            <option value="Zone 5" ${day.intensity === 'Zone 5' ? 'selected' : ''}>Zone 5 (VO2 Max)</option>
                        </select>
                    </div>
                    ` : day.type === 'weights' || day.type === 'bjj' || day.type === 'football' ? `
                    <div class="builder-input-group">
                        <div class="builder-label">Duration (minutes)</div>
                        <input type="number" class="builder-input" id="editDayDurationMins" value="${day.duration ? Math.floor(day.duration / 60) : ''}" placeholder="60" style="font-size: 16px;">
                    </div>

                    <div class="builder-input-group">
                        <div class="builder-label">Intensity</div>
                        <select class="builder-input" id="editDayIntensity" style="font-size: 16px;">
                            <option value="Light" ${day.intensity === 'Light' ? 'selected' : ''}>Light</option>
                            <option value="Moderate" ${day.intensity === 'Moderate' ? 'selected' : ''}>Moderate</option>
                            <option value="Hard" ${day.intensity === 'Hard' ? 'selected' : ''}>Hard</option>
                            <option value="Very Hard" ${day.intensity === 'Very Hard' ? 'selected' : ''}>Very Hard</option>
                        </select>
                    </div>
                    ` : ''}
                `;

                // Change footer buttons
                footerEl.innerHTML = `
                    <button class="btn btn-outline" onclick="app.cancelEditPlanDay(${weekNumber}, ${dayIndex})" style="min-height: 48px; flex: 1;">Cancel</button>
                    <button class="btn btn-primary" onclick="app.saveEditPlanDay(${weekNumber}, ${dayIndex})" style="min-height: 48px; flex: 1;">Save Changes</button>
                `;
            }

            cancelEditPlanDay(weekNumber, dayIndex) {
                // Return to view mode
                this.showDayDetails(weekNumber, dayIndex);
            }

            saveEditPlanDay(weekNumber, dayIndex) {
                const week = this.trainingPlan.weeks.find(w => w.weekNumber === weekNumber);
                if (!week) return;

                const day = week.days[dayIndex];
                if (!day) return;

                // Get values from form
                const title = document.getElementById('editDayTitle').value.trim();
                const description = document.getElementById('editDayDescription').value.trim();

                if (!title) {
                    this.showToast('Please enter a workout title', 'error');
                    return;
                }

                day.title = title;
                day.description = description;

                if (day.type === 'rowing') {
                    const distance = parseInt(document.getElementById('editDayDistance').value) || 0;
                    const duration = parseInt(document.getElementById('editDayDuration').value) || 0;
                    const intensity = document.getElementById('editDayIntensity').value;

                    day.distance = distance;
                    day.duration = duration;
                    day.intensity = intensity;
                } else if (day.type === 'weights' || day.type === 'bjj' || day.type === 'football') {
                    const durationMins = parseInt(document.getElementById('editDayDurationMins').value) || 0;
                    const intensity = document.getElementById('editDayIntensity').value;

                    day.duration = durationMins * 60;
                    day.intensity = intensity;
                }

                // Save and refresh
                this.saveTrainingPlan(this.trainingPlan);
                this.renderTrainingPlan();
                this.closeDayDetails();
                this.showToast('‚úì Workout updated', 'success');
            }

            deletePlanDay(weekNumber, dayIndex) {
                // Show delete confirmation in modal
                const bodyEl = document.getElementById('dayDetailsBody');
                const footerEl = document.getElementById('dayDetailsFooter');
                const titleEl = document.getElementById('dayDetailsTitle');

                titleEl.textContent = 'Delete Workout?';

                bodyEl.innerHTML = `
                    <div style="padding: 20px 0; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
                        <div style="font-size: 16px; line-height: 1.6; margin-bottom: 12px;">
                            This will remove the workout and convert this day to a rest day.
                        </div>
                        <div style="font-size: 14px; color: var(--text-secondary);">
                            This action cannot be undone.
                        </div>
                    </div>
                `;

                footerEl.innerHTML = `
                    <button class="btn btn-outline" onclick="app.cancelDeletePlanDay(${weekNumber}, ${dayIndex})" style="min-height: 48px; flex: 1;">Cancel</button>
                    <button class="btn btn-primary" onclick="app.confirmDeletePlanDay(${weekNumber}, ${dayIndex})" style="min-height: 48px; flex: 1; background: #FF0000; border-color: #FF0000;">Delete Workout</button>
                `;
            }

            cancelDeletePlanDay(weekNumber, dayIndex) {
                // Return to view mode
                this.showDayDetails(weekNumber, dayIndex);
            }

            confirmDeletePlanDay(weekNumber, dayIndex) {
                const week = this.trainingPlan.weeks.find(w => w.weekNumber === weekNumber);
                if (!week) return;

                const day = week.days[dayIndex];
                if (!day) return;

                // Convert to rest day
                day.type = 'rest';
                day.title = 'Rest Day';
                day.description = 'Recovery';
                day.distance = null;
                day.duration = null;
                day.intensity = null;
                day.completed = false;

                // Save and refresh
                this.saveTrainingPlan(this.trainingPlan);
                this.renderTrainingPlan();
                this.closeDayDetails();
                this.showToast('‚úì Workout removed - now a rest day', 'success');
            }

            setPlanView(viewType) {
                // Update button states
                document.querySelectorAll('.plan-view-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');

                this.currentPlanView = viewType;

                if (viewType === 'timeline') {
                    this.renderTimelineView();
                } else if (viewType === 'week') {
                    this.renderWeekView();
                } else if (viewType === 'month') {
                    this.renderMonthView();
                }
            }

            renderTimelineView() {
                const container = document.getElementById('planContent');
                if (!container || !this.trainingPlan) return;

                // Check if adaptive alert should show
                this.checkAdaptiveAlert();

                // Render timeline view
                let html = '<div class="plan-timeline">';

                this.trainingPlan.weeks.forEach((week, idx) => {
                    const isCurrent = idx + 1 === this.trainingPlan.currentWeek;
                    const isCompleted = week.days.every(d => d.completed);
                    const completedDays = week.days.filter(d => d.completed).length;

                    const startDate = new Date(week.startDate);
                    const endDate = new Date(week.endDate);
                    const dateRange = `${startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;

                    html += `
                        <div class="plan-week-card ${isCurrent ? 'current' : ''} ${isCompleted ? 'completed' : ''}" id="week_${week.weekNumber}">
                            <div class="plan-week-header" onclick="app.toggleWeekExpansion(${week.weekNumber})">
                                <div class="plan-week-title">
                                    <div class="plan-week-number">W${week.weekNumber}</div>
                                    <div class="plan-week-info">
                                        <div class="plan-week-label">${week.theme}</div>
                                        <div class="plan-week-dates">${dateRange}</div>
                                    </div>
                                </div>
                                <div style="display:flex; align-items:center; gap:16px;">
                                    <div class="plan-week-summary">
                                        <div class="plan-week-stat">
                                            <span>üèãÔ∏è</span>
                                            <span>${week.workoutCount} workouts</span>
                                        </div>
                                        <div class="plan-week-stat">
                                            <span>‚úì</span>
                                            <span>${completedDays}/7</span>
                                        </div>
                                    </div>
                                    <div class="plan-week-expand" id="expand_${week.weekNumber}">‚ñº</div>
                                </div>
                            </div>
                            <div class="plan-week-days" id="days_${week.weekNumber}">
                                ${this.renderWeekDays(week)}
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                container.innerHTML = html;
            }

            renderWeekView() {
                const container = document.getElementById('planContent');
                if (!container || !this.trainingPlan) return;

                // Show current week only
                const currentWeek = this.trainingPlan.weeks.find(w => w.weekNumber === this.trainingPlan.currentWeek);
                if (!currentWeek) return;

                const startDate = new Date(currentWeek.startDate);
                const endDate = new Date(currentWeek.endDate);
                const dateRange = `${startDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric' })} - ${endDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}`;

                let html = `
                    <div style="margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <button class="btn btn-sm btn-outline" onclick="app.previousWeek()" ${this.trainingPlan.currentWeek === 1 ? 'disabled' : ''}>‚Üê Prev</button>
                            <div>
                                <div style="font-size: 18px; font-weight: bold; text-align: center;">Week ${currentWeek.weekNumber}: ${currentWeek.theme}</div>
                                <div style="font-size: 12px; color: var(--text-secondary); text-align: center;">${dateRange}</div>
                            </div>
                            <button class="btn btn-sm btn-outline" onclick="app.nextWeek()" ${this.trainingPlan.currentWeek === this.trainingPlan.weeks.length ? 'disabled' : ''}>Next ‚Üí</button>
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        ${this.renderWeekDays(currentWeek)}
                    </div>
                `;

                container.innerHTML = html;
            }

            renderMonthView() {
                const container = document.getElementById('planContent');
                if (!container || !this.trainingPlan) return;

                // Get current month from current week
                const currentWeek = this.trainingPlan.weeks.find(w => w.weekNumber === this.trainingPlan.currentWeek);
                const currentDate = currentWeek ? new Date(currentWeek.startDate) : new Date();

                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const monthName = currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

                // Get first and last day of month
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startingDayOfWeek = firstDay.getDay(); // 0 = Sunday

                // Build calendar grid
                let html = `
                    <div style="margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <button class="btn btn-sm btn-outline" onclick="app.previousMonth()">‚Üê Prev</button>
                            <div style="font-size: 18px; font-weight: bold;">${monthName}</div>
                            <button class="btn btn-sm btn-outline" onclick="app.nextMonth()">Next ‚Üí</button>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 8px;">
                        <div style="text-align: center; font-size: 11px; font-weight: 600; padding: 8px; color: var(--text-secondary);">Sun</div>
                        <div style="text-align: center; font-size: 11px; font-weight: 600; padding: 8px; color: var(--text-secondary);">Mon</div>
                        <div style="text-align: center; font-size: 11px; font-weight: 600; padding: 8px; color: var(--text-secondary);">Tue</div>
                        <div style="text-align: center; font-size: 11px; font-weight: 600; padding: 8px; color: var(--text-secondary);">Wed</div>
                        <div style="text-align: center; font-size: 11px; font-weight: 600; padding: 8px; color: var(--text-secondary);">Thu</div>
                        <div style="text-align: center; font-size: 11px; font-weight: 600; padding: 8px; color: var(--text-secondary);">Fri</div>
                        <div style="text-align: center; font-size: 11px; font-weight: 600; padding: 8px; color: var(--text-secondary);">Sat</div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;">
                `;

                // Add empty cells for days before month starts
                for (let i = 0; i < startingDayOfWeek; i++) {
                    html += '<div style="min-height: 80px;"></div>';
                }

                // Add days of the month
                for (let day = 1; day <= lastDay.getDate(); day++) {
                    const date = new Date(year, month, day);
                    const dateStr = date.toISOString().split('T')[0];

                    // Find workout for this day
                    let workoutForDay = null;
                    for (const week of this.trainingPlan.weeks) {
                        const dayWorkout = week.days.find(d => d.date.split('T')[0] === dateStr);
                        if (dayWorkout) {
                            workoutForDay = dayWorkout;
                            break;
                        }
                    }

                    const isToday = date.toDateString() === new Date().toDateString();
                    const hasWorkout = workoutForDay !== null;
                    const isCompleted = workoutForDay?.completed;
                    const isRest = workoutForDay?.type === 'rest';

                    html += `
                        <div style="
                            min-height: 80px;
                            border: 1px solid var(--border);
                            border-radius: 4px;
                            padding: 4px;
                            background: ${isToday ? 'rgba(0, 255, 153, 0.1)' : 'var(--panel)'};
                            border-color: ${isToday ? '#00FF99' : 'var(--border)'};
                            ${hasWorkout ? 'cursor: pointer;' : ''}
                        "
                        ${hasWorkout ? `onclick="app.showMonthDayDetails('${dateStr}')"` : ''}>
                            <div style="font-size: 12px; font-weight: ${isToday ? 'bold' : 'normal'}; color: ${isToday ? '#00FF99' : 'var(--text)'}; margin-bottom: 4px;">
                                ${day}
                            </div>
                            ${hasWorkout ? `
                                <div style="font-size: 9px; line-height: 1.3;">
                                    <div style="color: ${isRest ? '#FF0000' : '#00FF99'}; font-weight: 600; margin-bottom: 2px;">
                                        ${workoutForDay.title}
                                    </div>
                                    ${workoutForDay.distance ? `<div style="color: var(--text-secondary);">${workoutForDay.distance}m</div>` : ''}
                                    ${isCompleted ? '<div style="color: #00FF99;">‚úì Done</div>' : ''}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }

                html += '</div>';
                container.innerHTML = html;
            }

            previousWeek() {
                if (this.trainingPlan.currentWeek > 1) {
                    this.trainingPlan.currentWeek--;
                    this.saveTrainingPlan(this.trainingPlan);
                    this.renderWeekView();
                }
            }

            nextWeek() {
                if (this.trainingPlan.currentWeek < this.trainingPlan.weeks.length) {
                    this.trainingPlan.currentWeek++;
                    this.saveTrainingPlan(this.trainingPlan);
                    this.renderWeekView();
                }
            }

            previousMonth() {
                // TODO: Implement month navigation
                this.showToast('Month navigation coming soon', 'info');
            }

            nextMonth() {
                // TODO: Implement month navigation
                this.showToast('Month navigation coming soon', 'info');
            }

            showMonthDayDetails(dateStr) {
                // Find workout for this date
                for (const week of this.trainingPlan.weeks) {
                    const dayIndex = week.days.findIndex(d => d.date.split('T')[0] === dateStr);
                    if (dayIndex !== -1) {
                        this.showDayDetails(week.weekNumber, dayIndex);
                        break;
                    }
                }
            }

            checkAdaptiveAlert() {
                const alertContainer = document.getElementById('planAdaptiveAlert');
                if (!alertContainer || !this.dnaProfile) return;

                // Check DNA status for poor recovery indicators
                const poorSleep = this.dnaProfile.lifestyle.sleep_quality < 6;
                const highStress = this.dnaProfile.lifestyle.stress_level === 'high';

                if (poorSleep || highStress) {
                    const todayDate = new Date().toDateString();
                    const currentWeek = this.trainingPlan?.weeks.find(w => w.weekNumber === this.trainingPlan.currentWeek);
                    const todayWorkout = currentWeek?.days.find(d => new Date(d.date).toDateString() === todayDate);

                    if (todayWorkout && todayWorkout.type === 'rowing' && todayWorkout.intensity?.includes('Zone 4')) {
                        alertContainer.style.display = 'block';
                        alertContainer.innerHTML = `
                            <div class="plan-adaptive-header">
                                <span>‚ö†Ô∏è</span>
                                <span>Recovery Alert</span>
                            </div>
                            <div class="plan-adaptive-message">
                                Your DNA shows ${poorSleep ? 'poor sleep' : 'high stress'}. Today's high-intensity workout (${todayWorkout.title}) may be too much. Scale back to recovery pace?
                            </div>
                            <div class="plan-adaptive-actions">
                                <button class="btn btn-sm btn-outline" onclick="app.dismissAdaptiveAlert()">Keep As Planned</button>
                                <button class="btn btn-sm btn-primary" onclick="app.scaleWorkout()">Scale to Recovery</button>
                            </div>
                        `;
                    } else {
                        alertContainer.style.display = 'none';
                    }
                } else {
                    alertContainer.style.display = 'none';
                }
            }

            dismissAdaptiveAlert() {
                document.getElementById('planAdaptiveAlert').style.display = 'none';
            }

            scaleWorkout() {
                // Find today's workout and modify it
                const todayDate = new Date().toDateString();
                const currentWeek = this.trainingPlan?.weeks.find(w => w.weekNumber === this.trainingPlan.currentWeek);
                const todayWorkout = currentWeek?.days.find(d => new Date(d.date).toDateString() === todayDate);

                if (todayWorkout) {
                    todayWorkout.title = 'Recovery Row (Modified)';
                    todayWorkout.intensity = 'Zone 1-2';
                    todayWorkout.description = 'Light recovery row. Listen to your body.';
                    todayWorkout.distance = Math.floor(todayWorkout.distance * 0.6);

                    this.saveTrainingPlan(this.trainingPlan);
                    this.renderTrainingPlan();
                    this.showToast('‚úì Workout scaled to recovery pace', 'success');
                }
            }

            syncGoogleCalendar() {
                // TODO: Implement Google Calendar OAuth and sync
                this.showToast('Google Calendar sync coming soon. Stay tuned!', 'info');

                // Future implementation will:
                // 1. OAuth with Google Calendar API
                // 2. Create calendar events for each workout
                // 3. Bi-directional sync (calendar changes update plan)
                // 4. Set reminders and notifications
            }

            // ========================================================================
            // TRAINING LOG
            // ========================================================================

            renderTrainingLog() {
                const container = document.getElementById('trainingLogList');
                if (!container) {
                    console.warn('Training log container not found');
                    return;
                }

                console.log(`Rendering training log with ${this.workouts.length} total workouts`);

                // Get filtered workouts
                const filtered = this.getFilteredWorkouts();

                console.log(`After filtering: ${filtered.length} workouts`);

                if (filtered.length === 0) {
                    container.innerHTML = `
                        <p style="font-size: 12px; color: #666; text-align: center; padding: 40px 20px;">
                            No workouts found (${this.workouts.length} total).<br>
                            Try adjusting your filters or add a new workout.
                        </p>
                    `;
                    return;
                }

                // Group by date
                const grouped = {};
                filtered.forEach(workout => {
                    const date = new Date(workout.date).toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    });
                    if (!grouped[date]) grouped[date] = [];
                    grouped[date].push(workout);
                });

                // Render
                let html = '';
                Object.keys(grouped).forEach(date => {
                    html += `<div class="training-log-date-divider">${date}</div>`;
                    grouped[date].forEach(workout => {
                        html += this.renderActivityCard(workout);
                    });
                });

                container.innerHTML = html;
            }

            renderActivityCard(workout) {
                const activityType = workout.activityType || workout.type || 'rowing';
                const metadata = workout.metadata || workout;

                // Activity-specific rendering
                let statsHtml = '';

                if (activityType === 'rowing') {
                    statsHtml = `
                        <div class="activity-card-stat">
                            <div class="activity-card-stat-label">Distance</div>
                            <div class="activity-card-stat-value">${metadata.distance || 0}m</div>
                        </div>
                        <div class="activity-card-stat">
                            <div class="activity-card-stat-label">Avg Pace</div>
                            <div class="activity-card-stat-value">${this.formatPace(metadata.avgPace)}</div>
                        </div>
                        <div class="activity-card-stat">
                            <div class="activity-card-stat-label">Avg HR</div>
                            <div class="activity-card-stat-value" style="color:#ff6b6b;">${metadata.avgHR || '--'}</div>
                        </div>
                    `;
                } else {
                    // Simple activities (football, etc.)
                    statsHtml = `
                        <div class="activity-card-stat">
                            <div class="activity-card-stat-label">Duration</div>
                            <div class="activity-card-stat-value">${this.formatTime(metadata.duration || workout.duration)}</div>
                        </div>
                        <div class="activity-card-stat">
                            <div class="activity-card-stat-label">Intensity</div>
                            <div class="activity-card-stat-value">${metadata.intensity || '--'}/10</div>
                        </div>
                        ${metadata.avgHR ? `
                        <div class="activity-card-stat">
                            <div class="activity-card-stat-label">Avg HR</div>
                            <div class="activity-card-stat-value" style="color:#ff6b6b;">${metadata.avgHR}</div>
                        </div>
                        ` : ''}
                    `;
                }

                const icon = this.getActivityIcon(activityType);
                const description = workout.description || this.getActivityName(activityType);

                return `
                    <div class="activity-card ${activityType}">
                        <div class="activity-card-header">
                            <div class="activity-card-title">${icon} ${description}</div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="activity-card-date">${new Date(workout.date).toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'})}</div>
                                <button class="btn btn-sm btn-outline" onclick="event.stopPropagation(); app.editWorkout('${workout.id}')" style="padding: 4px 8px; font-size: 11px;">Edit</button>
                                <button class="btn btn-sm btn-outline" onclick="event.stopPropagation(); app.deleteWorkout('${workout.id}')" style="padding: 4px 8px; font-size: 11px; color: #FF0000; border-color: #FF0000;">Delete</button>
                            </div>
                        </div>
                        <div class="activity-card-stats">
                            ${statsHtml}
                        </div>
                    </div>
                `;
            }

            getFilteredWorkouts() {
                const activityFilter = document.getElementById('activityFilter')?.value || 'all';
                const dateFilter = document.getElementById('dateFilter')?.value || 'all';
                const searchQuery = document.getElementById('trainingLogSearch')?.value.toLowerCase() || '';

                console.log(`üîç Filter settings: activity=${activityFilter}, date=${dateFilter}, search="${searchQuery}"`);

                let filtered = [...this.workouts];
                console.log(`üîç Starting with ${filtered.length} workouts`);

                // Activity type filter
                if (activityFilter !== 'all') {
                    const beforeCount = filtered.length;
                    filtered = filtered.filter(w => {
                        const type = w.activityType || w.type || 'rowing';
                        return type === activityFilter;
                    });
                    console.log(`üîç After activity filter: ${filtered.length} (was ${beforeCount})`);
                }

                // Date filter
                if (dateFilter !== 'all') {
                    const beforeCount = filtered.length;
                    const days = parseInt(dateFilter);
                    const cutoff = Date.now() - (days * 24 * 60 * 60 * 1000);
                    filtered = filtered.filter(w => new Date(w.date).getTime() >= cutoff);
                    console.log(`üîç After date filter: ${filtered.length} (was ${beforeCount}), cutoff: ${new Date(cutoff).toLocaleDateString()}`);
                }

                // Search filter
                if (searchQuery) {
                    const beforeCount = filtered.length;
                    filtered = filtered.filter(w => {
                        const desc = (w.description || '').toLowerCase();
                        const type = this.getActivityName(w.activityType || w.type || 'rowing').toLowerCase();
                        return desc.includes(searchQuery) || type.includes(searchQuery);
                    });
                    console.log(`üîç After search filter: ${filtered.length} (was ${beforeCount})`);
                }

                console.log(`üîç Final filtered count: ${filtered.length}`);
                return filtered;
            }

            filterTrainingLog() {
                this.renderTrainingLog();
            }

            getActivityIcon(type) {
                const icons = {
                    rowing: 'üö£',
                    weights: 'üèãÔ∏è',
                    bjj: 'ü•ã',
                    football: '‚öΩ',
                    other: 'üèÉ'
                };
                return icons[type] || 'üèÉ';
            }

            getActivityName(type) {
                const names = {
                    rowing: 'Rowing',
                    weights: 'Weights',
                    bjj: 'BJJ',
                    football: 'Football',
                    other: 'Workout',
                    imported: 'Imported Workout'
                };
                return names[type] || 'Workout';
            }

            async deleteWorkout(workoutId) {
                if (!confirm('Delete this workout? This cannot be undone.')) {
                    return;
                }

                try {
                    // Remove from local array
                    this.workouts = this.workouts.filter(w => w.id !== workoutId);

                    // Remove from storage
                    await this.dataStore.deleteWorkout(workoutId);

                    // Refresh UI
                    this.renderTrainingLog();
                    this.updateStats();
                    this.showToast('‚úì Workout deleted', 'success');
                } catch (error) {
                    console.error('Delete workout error:', error);
                    if (!navigator.onLine) {
                        this.showToast('No internet connection - workout not deleted', 'error');
                    } else if (error.code === 'permission-denied') {
                        this.showToast('Permission denied - please sign in again', 'error');
                    } else {
                        this.showToast('Failed to delete workout: ' + (error.message || 'Unknown error'), 'error');
                    }
                }
            }

            editWorkout(workoutId) {
                const workout = this.workouts.find(w => w.id === workoutId);
                if (!workout) {
                    this.showToast('Workout not found', 'error');
                    return;
                }

                // Open modal with pre-filled data
                const modal = document.getElementById('addWorkoutModal');
                if (!modal) return;

                modal.style.display = 'flex';

                // Set activity type
                const activityType = workout.activityType || workout.type || 'rowing';
                document.getElementById('addWorkoutType').value = activityType;

                // Update form with fields for this activity type
                this.updateAddWorkoutForm();

                // Pre-fill values
                setTimeout(() => {
                    const metadata = workout.metadata || workout;
                    document.getElementById('addWorkoutDate').value = new Date(workout.date).toISOString().split('T')[0];
                    document.getElementById('addWorkoutTime').value = new Date(workout.date).toTimeString().slice(0, 5);
                    document.getElementById('addWorkoutDescription').value = workout.description || '';

                    if (activityType === 'rowing') {
                        document.getElementById('addWorkoutDistance').value = metadata.distance || '';
                        document.getElementById('addWorkoutDuration').value = metadata.duration || '';
                        document.getElementById('addWorkoutPace').value = this.formatPace(metadata.avgPace || 0);
                        document.getElementById('addWorkoutHR').value = metadata.avgHR || '';
                        document.getElementById('addWorkoutWatts').value = metadata.avgWatts || '';
                    } else if (activityType === 'weights' || activityType === 'bjj' || activityType === 'football') {
                        document.getElementById('addWorkoutDuration').value = metadata.duration || '';
                        document.getElementById('addWorkoutIntensity').value = metadata.intensity || '';
                        document.getElementById('addWorkoutHR').value = metadata.avgHR || '';
                        if (activityType === 'weights') {
                            document.getElementById('addWorkoutExercises').value = metadata.exercises || '';
                        }
                    }

                    // Store the workout ID for updating
                    modal.dataset.editingId = workoutId;
                }, 100);
            }

            showAddWorkoutModal() {
                const modal = document.getElementById('addWorkoutModal');
                if (modal) {
                    modal.style.display = 'flex';
                    // Clear editing state
                    delete modal.dataset.editingId;
                    // Reset form
                    document.getElementById('addWorkoutType').value = '';
                    document.getElementById('addWorkoutFormContent').innerHTML = '';
                }
            }

            closeAddWorkoutModal() {
                const modal = document.getElementById('addWorkoutModal');
                if (modal) {
                    modal.style.display = 'none';
                    // Clear editing state
                    delete modal.dataset.editingId;
                }
            }

            updateAddWorkoutForm() {
                const type = document.getElementById('addWorkoutType').value;
                const container = document.getElementById('addWorkoutFormContent');

                if (!type || !container) return;

                if (type === 'rowing') {
                    container.innerHTML = `
                        <div class="card">
                            <div class="card-header">Workout Details</div>
                            <div class="builder-input-group">
                                <div class="builder-label">Date & Time</div>
                                <input type="datetime-local" class="builder-input" id="addWorkoutDate" value="${this.getCurrentDateTime()}">
                            </div>
                            <div class="builder-input-group">
                                <div class="builder-label">Distance (meters)</div>
                                <input type="number" class="builder-input" id="addWorkoutDistance" placeholder="5000">
                            </div>
                            <div class="builder-input-group">
                                <div class="builder-label">Duration (mm:ss)</div>
                                <input type="text" class="builder-input" id="addWorkoutDuration" placeholder="20:00">
                            </div>
                            <div class="builder-input-group">
                                <div class="builder-label">Avg Pace (/500m)</div>
                                <input type="text" class="builder-input" id="addWorkoutPace" placeholder="2:00.0">
                            </div>
                            <div class="builder-input-group">
                                <div class="builder-label">Avg Heart Rate (optional)</div>
                                <input type="number" class="builder-input" id="addWorkoutHR" placeholder="155">
                            </div>
                            <div class="builder-input-group">
                                <div class="builder-label">Notes (optional)</div>
                                <textarea class="builder-input" id="addWorkoutNotes" placeholder="How did it feel?" rows="3"></textarea>
                            </div>
                        </div>
                    `;
                } else {
                    // Simple activities (football, bjj, weights, other)
                    container.innerHTML = `
                        <div class="card">
                            <div class="card-header">Workout Details</div>
                            <div class="builder-input-group">
                                <div class="builder-label">Date & Time</div>
                                <input type="datetime-local" class="builder-input" id="addWorkoutDate" value="${this.getCurrentDateTime()}">
                            </div>
                            <div class="builder-input-group">
                                <div class="builder-label">Duration (minutes)</div>
                                <input type="number" class="builder-input" id="addWorkoutDuration" placeholder="60">
                            </div>
                            <div class="builder-input-group">
                                <div class="builder-label">Intensity (1-10)</div>
                                <input type="number" class="builder-input" id="addWorkoutIntensity" min="1" max="10" placeholder="7">
                            </div>
                            <div class="builder-input-group">
                                <div class="builder-label">Avg Heart Rate (optional)</div>
                                <input type="number" class="builder-input" id="addWorkoutHR" placeholder="155">
                            </div>
                            <div class="builder-input-group">
                                <div class="builder-label">Notes</div>
                                <textarea class="builder-input" id="addWorkoutNotes" placeholder="What did you do?" rows="3"></textarea>
                            </div>
                        </div>
                    `;
                }
            }

            getCurrentDateTime() {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            }

            async saveManualWorkoutEntry() {
                try {
                    const modal = document.getElementById('addWorkoutModal');
                    const editingId = modal?.dataset?.editingId;
                    const isEditing = !!editingId;

                    const type = document.getElementById('addWorkoutType').value;
                    if (!type) {
                        this.showToast('Please select an activity type', 'error');
                        return;
                    }

                    // Parse date field (supports both datetime-local and separate date/time fields)
                    let workoutDate;
                    const dateInput = document.getElementById('addWorkoutDate');
                    const timeInput = document.getElementById('addWorkoutTime');

                    if (timeInput && timeInput.value) {
                        // Separate date and time fields
                        const dateStr = dateInput.value;
                        const timeStr = timeInput.value;
                        workoutDate = new Date(`${dateStr}T${timeStr}`);
                    } else {
                        // datetime-local field
                        workoutDate = new Date(dateInput.value);
                    }

                    const description = document.getElementById('addWorkoutDescription')?.value || '';
                    const notes = document.getElementById('addWorkoutNotes')?.value || '';
                    const avgHR = parseInt(document.getElementById('addWorkoutHR')?.value) || null;

                    let workout;

                    if (type === 'rowing') {
                        const distance = parseInt(document.getElementById('addWorkoutDistance').value) || 0;
                        const durationStr = document.getElementById('addWorkoutDuration').value;
                        const paceStr = document.getElementById('addWorkoutPace').value;
                        const watts = parseInt(document.getElementById('addWorkoutWatts')?.value) || 0;

                        const duration = this.parseTimeToSeconds(durationStr);
                        const avgPace = this.parsePaceToSeconds(paceStr);

                        if (distance === 0) {
                            this.showToast('Please enter distance', 'error');
                            return;
                        }

                        workout = {
                            id: isEditing ? editingId : Date.now().toString(),
                            date: workoutDate.toISOString(),
                            activityType: 'rowing',
                            duration: duration,
                            avgWatts: watts,
                            completed: true,
                            description: description || notes || 'Rowing Session',
                            metadata: {
                                distance: distance,
                                avgPace: avgPace,
                                avgHR: avgHR,
                                avgWatts: watts
                            }
                        };

                        // For backwards compatibility, also add at root level
                        workout.distance = distance;
                        workout.avgPace = avgPace;
                        workout.avgHR = avgHR;

                    } else {
                        // Simple activities
                        const durationMins = parseInt(document.getElementById('addWorkoutDuration').value) || 0;
                        const intensity = parseInt(document.getElementById('addWorkoutIntensity').value) || 5;
                        const exercises = document.getElementById('addWorkoutExercises')?.value || '';

                        if (durationMins === 0) {
                            this.showToast('Please enter duration', 'error');
                            return;
                        }

                        workout = {
                            id: isEditing ? editingId : Date.now().toString(),
                            date: workoutDate.toISOString(),
                            activityType: type,
                            duration: durationMins * 60,
                            completed: true,
                            description: description || notes || this.getActivityName(type),
                            metadata: {
                                intensity: intensity,
                                avgHR: avgHR,
                                exercises: exercises,
                                duration: durationMins * 60
                            }
                        };
                    }

                    console.log(isEditing ? 'Updating workout:' : 'Saving workout:', workout);

                    // Save or update workout
                    if (isEditing) {
                        // Update existing workout
                        const index = this.workouts.findIndex(w => w.id === editingId);
                        if (index !== -1) {
                            this.workouts[index] = workout;
                        }
                        await this.dataStore.saveWorkout(workout);
                        this.showToast('‚úì Workout updated!', 'success');
                    } else {
                        // Create new workout
                        this.workouts.unshift(workout);
                        await this.dataStore.saveWorkout(workout);
                        this.showToast('‚úì Workout saved!', 'success');
                    }

                    // Update DNA if rowing
                    if (type === 'rowing') {
                        await this.updateDNAProfile(workout);
                    }

                    // Update displays
                    this.renderTrainingLog();
                    this.renderDNA();
                    this.updateStats();

                    // Close modal
                    this.closeAddWorkoutModal();

                } catch (error) {
                    console.error('Save workout error:', error);
                    if (!navigator.onLine) {
                        this.showToast('No internet connection - workout not saved', 'error');
                    } else if (error.code === 'permission-denied') {
                        this.showToast('Permission denied - please sign in again', 'error');
                    } else if (error.message.includes('validation')) {
                        this.showToast('Invalid workout data - please check your inputs', 'error');
                    } else {
                        this.showToast('Failed to save workout: ' + (error.message || 'Unknown error'), 'error');
                    }
                }
            }

            // ========================================================================
            // AUDIO COACH (Web Speech API)
            // ========================================================================

            initAudioCoach() {
                // Initialize Web Speech API
                if ('speechSynthesis' in window) {
                    this.audioEnabled = true;
                    this.audioQueue = [];
                    console.log('‚úì Audio Coach enabled');
                } else {
                    this.audioEnabled = false;
                    console.warn('‚ö†Ô∏è Web Speech API not supported');
                }
            }

            speak(text, priority = false) {
                if (!this.audioEnabled) return;

                // Cancel current speech if priority message
                if (priority && window.speechSynthesis.speaking) {
                    window.speechSynthesis.cancel();
                }

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 1.0;  // Normal speed
                utterance.pitch = 1.0;  // Normal pitch
                utterance.volume = 1.0;  // Full volume

                // Use a clear, athletic voice if available
                const voices = window.speechSynthesis.getVoices();
                const preferredVoice = voices.find(v => v.name.includes('Samantha') || v.name.includes('Karen'));
                if (preferredVoice) {
                    utterance.voice = preferredVoice;
                }

                window.speechSynthesis.speak(utterance);
            }

            // Audio cues for interval workouts
            announceIntervalStart(intervalNum, targetSplit) {
                const message = `Interval ${intervalNum} starting. Target split ${targetSplit}.`;
                this.speak(message, true);
            }

            announceIntervalMidpoint() {
                this.speak('Halfway there. Hold the pace.', false);
            }

            announceIntervalEnd(intervalNum) {
                this.speak(`Interval ${intervalNum} complete. Nice work.`, true);
            }

            announceRestStart(restTime) {
                this.speak(`Rest period. ${restTime} seconds.`, true);
            }

            announceWorkoutComplete() {
                this.speak('Workout complete. Great effort.', true);
            }

            announcePaceCheck(currentPace, targetPace) {
                const diff = currentPace - targetPace;
                if (Math.abs(diff) > 3) {
                    if (diff > 0) {
                        this.speak(`You're ${Math.abs(diff).toFixed(0)} seconds slow. Pick it up.`, true);
                    } else {
                        this.speak(`You're ${Math.abs(diff).toFixed(0)} seconds fast. Ease back.`, true);
                    }
                }
            }

            // ========================================================================
            // CHAT FUNCTIONALITY
            // ========================================================================

            async sendMessage() {
                const input = document.getElementById('chatInput');
                const message = input.value.trim();
                
                if (!message) return;

                this.addChatMessage('user', message);
                input.value = '';
                input.style.height = 'auto';

                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) {
                    typingIndicator.style.display = 'flex';
                }

                await this.sleep(800);

                if (typingIndicator) {
                    typingIndicator.style.display = 'none';
                }

                this.processMessage(message);
            }

            processMessage(message) {
                const lower = message.toLowerCase();
                
                // Workout creation
                if (lower.includes('workout') || lower.includes('interval') || lower.includes('create')) {
                    this.addChatMessage('ai', 'I can help you create a workout! You have two options:\n\n1. **Tell me what you want** (e.g., "6x500m with 2min rest")\n2. **Use the Manual Builder** for precise control\n\nWhat would you like?', ['Use Manual Builder', '6x500m intervals', '30min steady']);
                    return;
                }
                
                // Training plan
                if (lower.includes('plan') || lower.includes('4-week') || lower.includes('training')) {
                    this.generateTrainingPlan();
                    this.addChatMessage('ai', 'Perfect! I\'ve created a personalized 4-week training plan tailored to your goals.\n\nCheck the **Plan** tab to see your full schedule.\n\nThis is a progressive program:\n‚Ä¢ Week 1: Base building\n‚Ä¢ Week 2: Intensity increase\n‚Ä¢ Week 3: Peak volume\n‚Ä¢ Week 4: Taper & test', ['View Plan']);
                    return;
                }
                
                // Data analysis
                if (lower.includes('analyze') || lower.includes('performance') || lower.includes('progress')) {
                    const totalWorkouts = this.workouts.length;
                    const totalDist = this.workouts.reduce((sum, w) => sum + (w.distance || 0), 0);
                    
                    this.addChatMessage('ai', `Here's your training summary:\n\nüìä **Total Workouts:** ${totalWorkouts}\nüìè **Total Distance:** ${Math.floor(totalDist/1000)}km\n\n${totalWorkouts > 0 ? 'You\'re making great progress! Keep it up! üí™' : 'Import your CSV to see detailed analysis.'}`, ['Import CSV', 'View History']);
                    return;
                }
                
                // Builder redirect
                if (lower.includes('builder') || lower.includes('manual')) {
                    this.addChatMessage('ai', 'Taking you to the Manual Builder...', null);
                    setTimeout(() => this.navigate('screenBuilder'), 500);
                    return;
                }
                
                // Profile updates
                if (lower.includes('weight') && (lower.includes('change') || lower.includes('update'))) {
                    const match = message.match(/(\d+)\s*kg/i);
                    if (match) {
                        const newWeight = parseInt(match[1]);
                        if (this.profile) {
                            this.profile.weight = newWeight;
                            this.saveData();
                            this.loadProfile();
                            this.addChatMessage('ai', `‚úì Updated your weight to ${newWeight}kg!`, null);
                            return;
                        }
                    }
                }
                
                // Default helpful response
                this.addChatMessage('ai', 'I can help with:\n\nüèãÔ∏è **Create Workouts** - Custom intervals or steady state\nüìÖ **Training Plans** - 4-week periodized programs\nüìä **Performance Analysis** - Track your progress\n‚öôÔ∏è **Settings** - Update your profile\n\nWhat would you like to do?', ['Create workout', 'Build plan', 'View history']);
            }

            addChatMessage(sender, text, quickReplies = null) {
                const msg = {
                    sender: sender,
                    text: text,
                    quickReplies: quickReplies,
                    timestamp: new Date().toISOString()
                };

                this.chatHistory.push(msg);
                this.saveData();
                this.renderChat();
            }

            renderChat() {
                const container = document.getElementById('chatMessages');
                if (!container) return;
                
                const html = this.chatHistory.map((msg) => {
                    const isUser = msg.sender === 'user';
                    
                    let quickRepliesHtml = '';
                    if (msg.quickReplies && msg.quickReplies.length > 0) {
                        quickRepliesHtml = `
                            <div class="quick-replies">
                                ${msg.quickReplies.map(reply => {
                                    let onclick = `app.handleQuickReply('${reply.replace(/'/g, "\\'")}')`;
                                    
                                    if (reply === 'Use Manual Builder') onclick = `app.navigate('screenBuilder')`;
                                    if (reply === 'Import CSV') onclick = `app.navigate('screenSettings')`;
                                    if (reply === 'View History') onclick = `app.navigate('screenHistory')`;
                                    
                                    return `<button class="quick-reply-btn" onclick="${onclick}">${reply}</button>`;
                                }).join('')}
                            </div>
                        `;
                    }
                    
                    const formattedText = msg.text
                        .replace(/\n/g, '<br>')
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/‚Ä¢ /g, '‚Ä¢ ');
                    
                    return `
                        <div class="chat-message ${isUser ? 'user' : 'ai'}">
                            <div class="chat-header">
                                ${isUser ? 'üë§ You' : 'ü§ñ Coach'}
                            </div>
                            ${formattedText}
                            ${quickRepliesHtml}
                        </div>
                    `;
                }).join('');

                container.innerHTML = html;
                
                // Scroll to bottom
                setTimeout(() => {
                    container.scrollTop = container.scrollHeight;
                }, 100);
            }

            handleQuickReply(text) {
                const input = document.getElementById('chatInput');
                if (input) {
                    // Special navigation handlers
                    if (text === 'View Plan') {
                        this.navigate('screenPlan');
                        return;
                    }
                    if (text === 'Use Manual Builder') {
                        this.navigate('screenBuilder');
                        return;
                    }
                    if (text === 'Import CSV') {
                        this.navigate('screenSettings');
                        return;
                    }
                    if (text === 'View History') {
                        this.navigate('screenHistory');
                        return;
                    }
                    
                    // Default: type and send
                    input.value = text;
                    this.sendMessage();
                }
            }

            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            // ========================================================================
            // DEVICES MODAL
            // ========================================================================

            openDevicesModal() {
                document.getElementById('devicesModal').style.display = 'block';
            }

            closeDevicesModal() {
                document.getElementById('devicesModal').style.display = 'none';
            }

            // ========================================================================
            // PM5 CONNECTION
            // ========================================================================

            async connectPM5() {
            const btn = document.getElementById('pm5ConnectBtn');
            const status = document.getElementById('pm5Status');
            const indicator = document.getElementById('pm5Indicator');

            const btnSettings = document.getElementById('pm5ConnectBtnSettings');
            const statusSettings = document.getElementById('pm5StatusSettings');
            const indicatorSettings = document.getElementById('pm5IndicatorSettings');

            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Connecting...';
            }
            if (btnSettings) {
                btnSettings.disabled = true;
                btnSettings.textContent = 'Connecting...';
            }
            if (status) status.textContent = 'Searching for PM5...';
            if (statusSettings) statusSettings.textContent = 'Searching for PM5...';

            try {
                console.log('üîç Requesting PM5...');

                // Use Capacitor Bluetooth LE plugin
                const { BleClient } = window.Capacitor.Plugins;

                const device = await BleClient.requestDevice({
                    services: [PM5_SERVICE_UUID],
                    optionalServices: []
                });

                console.log(`‚úì Device: ${device.name || device.deviceId}`);
                if (status) status.textContent = `Connecting to ${device.name || 'PM5'}...`;
                if (statusSettings) statusSettings.textContent = `Connecting to ${device.name || 'PM5'}...`;

                await BleClient.connect(device.deviceId);
                console.log('‚úì PM5 connected');

                this.pm5Device = device;

                // Start notifications
                await BleClient.startNotifications(
                    device.deviceId,
                    PM5_SERVICE_UUID,
                    PM5_CHARACTERISTIC_UUID,
                    (value) => this.handlePM5Data(value)
                );

                console.log('‚úì PM5 notifications started');

                if (status) status.textContent = `Connected: ${device.name || 'PM5'}`;
                if (statusSettings) statusSettings.textContent = `Connected: ${device.name || 'PM5'}`;
                if (indicator) indicator.style.background = '#00FF99';
                if (indicatorSettings) indicatorSettings.style.background = '#00FF99';

                if (btn) {
                    btn.textContent = 'Disconnect';
                    btn.disabled = false;
                    btn.onclick = () => this.disconnectPM5();
                }
                if (btnSettings) {
                    btnSettings.textContent = 'Disconnect';
                    btnSettings.disabled = false;
                    btnSettings.onclick = () => this.disconnectPM5();
                }

                this.showToast('PM5 connected!', 'success');
            } catch (error) {
                console.error('‚ùå PM5 error:', error);
                if (status) status.textContent = 'Connection failed';
                if (statusSettings) statusSettings.textContent = 'Connection failed';
                if (indicator) indicator.style.background = '#FF4444';
                if (indicatorSettings) indicatorSettings.style.background = '#FF4444';

                if (btn) {
                    btn.textContent = 'Retry';
                    btn.disabled = false;
                }
                if (btnSettings) {
                    btnSettings.textContent = 'Retry';
                    btnSettings.disabled = false;
                }

                this.showToast('PM5 connection failed: ' + error.message, 'error');
            }
            }

            async disconnectPM5() {
            if (!this.pm5Device) return;

            try {
                const { BleClient } = window.Capacitor.Plugins;
                await BleClient.disconnect(this.pm5Device.deviceId);
                this.pm5Device = null;

                const status = document.getElementById('pm5Status');
                const indicator = document.getElementById('pm5Indicator');
                const btn = document.getElementById('pm5ConnectBtn');
                const statusSettings = document.getElementById('pm5StatusSettings');
                const indicatorSettings = document.getElementById('pm5IndicatorSettings');
                const btnSettings = document.getElementById('pm5ConnectBtnSettings');

                if (status) status.textContent = 'Not connected';
                if (statusSettings) statusSettings.textContent = 'Not connected';
                if (indicator) indicator.style.background = '#666';
                if (indicatorSettings) indicatorSettings.style.background = '#666';

                if (btn) {
                    btn.textContent = 'Connect PM5';
                    btn.onclick = () => this.connectPM5();
                }
                if (btnSettings) {
                    btnSettings.textContent = 'Connect PM5';
                    btnSettings.onclick = () => this.connectPM5();
                }

                this.showToast('PM5 disconnected', 'success');
            } catch (error) {
                console.error('‚ùå Disconnect error:', error);
            }
            }

            handlePM5Data(value) {
                // Parse PM5 data and update dashboard
                console.log('PM5 data:', value);
                
                // Check if this is the first stroke
                if (this.waitingForFirstStroke) {
                    // Any PM5 data means user started rowing
                    this.onFirstStroke();
                }
                
                // TODO: Implement full PM5 data parsing based on Concept2 spec
                // For now, update basic metrics when data arrives
                // This will be replaced with proper parsing of the PM5 protocol
            }

            // ========================================================================
            // HRM CONNECTION
            // ========================================================================

            async connectHRM() {
            const HRM_SERVICE = 0x180D;
            const HRM_CHARACTERISTIC = 0x2A37;

            const btn = document.getElementById('hrmConnectBtn');
            const status = document.getElementById('hrmStatus');
            const indicator = document.getElementById('hrmIndicator');

            const btnSettings = document.getElementById('hrmConnectBtnSettings');
            const statusSettings = document.getElementById('hrmStatusSettings');
            const indicatorSettings = document.getElementById('hrmIndicatorSettings');

            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Connecting...';
            }
            if (btnSettings) {
                btnSettings.disabled = true;
                btnSettings.textContent = 'Connecting...';
            }
            if (status) status.textContent = 'Connecting...';
            if (statusSettings) statusSettings.textContent = 'Connecting...';

            try {
                console.log('üîç Requesting HRM...');

                const { BleClient } = window.Capacitor.Plugins;

                const device = await BleClient.requestDevice({
                    services: [HRM_SERVICE],
                    optionalServices: []
                });

                console.log(`‚úì Device: ${device.name || device.deviceId}`);
                if (status) status.textContent = `Connecting to ${device.name || 'HRM'}...`;
                if (statusSettings) statusSettings.textContent = `Connecting to ${device.name || 'HRM'}...`;

                await BleClient.connect(device.deviceId);
                console.log('‚úì HRM connected');

                this.hrmDevice = device;

                await BleClient.startNotifications(
                    device.deviceId,
                    HRM_SERVICE,
                    HRM_CHARACTERISTIC,
                    (value) => this.handleHRMData(value)
                );

                console.log('‚úì HRM notifications started');

                if (status) status.textContent = `Connected: ${device.name || 'HRM'}`;
                if (statusSettings) statusSettings.textContent = `Connected: ${device.name || 'HRM'}`;
                if (indicator) indicator.style.background = '#ff6b6b';
                if (indicatorSettings) indicatorSettings.style.background = '#ff6b6b';

                if (btn) {
                    btn.textContent = 'Disconnect';
                    btn.disabled = false;
                    btn.onclick = () => this.disconnectHRM();
                }
                if (btnSettings) {
                    btnSettings.textContent = 'Disconnect';
                    btnSettings.disabled = false;
                    btnSettings.onclick = () => this.disconnectHRM();
                }

                this.showToast('HRM connected!', 'success');
            } catch (error) {
                console.error('‚ùå HRM error:', error);
                if (status) status.textContent = 'Connection failed';
                if (statusSettings) statusSettings.textContent = 'Connection failed';
                if (indicator) indicator.style.background = '#FF4444';
                if (indicatorSettings) indicatorSettings.style.background = '#FF4444';

                if (btn) {
                    btn.textContent = 'Retry';
                    btn.disabled = false;
                }
                if (btnSettings) {
                    btnSettings.textContent = 'Retry';
                    btnSettings.disabled = false;
                }

                this.showToast('HRM connection failed: ' + error.message, 'error');
            }
            }

            async disconnectHRM() {
            if (!this.hrmDevice) return;

            try {
                const { BleClient } = window.Capacitor.Plugins;
                await BleClient.disconnect(this.hrmDevice.deviceId);
                this.hrmDevice = null;

                const status = document.getElementById('hrmStatus');
                const indicator = document.getElementById('hrmIndicator');
                const btn = document.getElementById('hrmConnectBtn');
                const statusSettings = document.getElementById('hrmStatusSettings');
                const indicatorSettings = document.getElementById('hrmIndicatorSettings');
                const btnSettings = document.getElementById('hrmConnectBtnSettings');

                if (status) status.textContent = 'Not connected';
                if (statusSettings) statusSettings.textContent = 'Not connected';
                if (indicator) indicator.style.background = '#666';
                if (indicatorSettings) indicatorSettings.style.background = '#666';

                if (btn) {
                    btn.textContent = 'Connect HRM';
                    btn.onclick = () => this.connectHRM();
                }
                if (btnSettings) {
                    btnSettings.textContent = 'Connect HRM';
                    btnSettings.onclick = () => this.connectHRM();
                }

                this.showToast('HRM disconnected', 'success');
            } catch (error) {
                console.error('‚ùå Disconnect error:', error);
            }
            }

            handleHRMData(value) {
                const flags = value.getUint8(0);
                const hrValueFormat = flags & 0x01;
                
                let hr;
                if (hrValueFormat === 0) {
                    hr = value.getUint8(1);
                } else {
                    hr = value.getUint16(1, true);
                }
                
                this.liveData.hr = hr;
                this.updateHRZone();
            }

            // ========================================================================
            // HRM CONNECTION (DIRECT - FROM HRM SCREEN)
            // ========================================================================

            async connectHRMDirect() {
            const HRM_SERVICE = 0x180D;
            const HRM_CHARACTERISTIC = 0x2A37;

            const btn = document.getElementById('hrmConnectButton');
            const statusText = document.getElementById('hrmStatusText');
            const statusDesc = document.getElementById('hrmStatusDesc');

            btn.disabled = true;
            btn.textContent = 'Connecting...';
            statusText.textContent = 'Connecting...';

            try {
                console.log('üîç Requesting HRM...');

                const { BleClient } = window.Capacitor.Plugins;

                const device = await BleClient.requestDevice({
                    services: [HRM_SERVICE],
                    optionalServices: []
                });

                console.log(`‚úì Device: ${device.name || device.deviceId}`);
                statusDesc.textContent = `Connecting to ${device.name || 'HRM'}...`;

                await BleClient.connect(device.deviceId);
                console.log('‚úì HRM connected');

                this.hrmDevice = device;

                await BleClient.startNotifications(
                    device.deviceId,
                    HRM_SERVICE,
                    HRM_CHARACTERISTIC,
                    (value) => this.handleHRMDataDirect(value)
                );

                console.log('‚úì HRM notifications started');

                statusText.textContent = `Connected: ${device.name || 'HRM'}`;
                statusDesc.textContent = 'Receiving heart rate data';
                btn.textContent = 'Disconnect';
                btn.disabled = false;
                btn.onclick = () => this.disconnectHRMDirect();

                // Show live display and graph
                document.getElementById('hrmLiveDisplay').style.display = 'block';
                document.getElementById('hrmGraphContainer').style.display = 'block';

                // Initialize canvas
                this.initHRMCanvas();

                this.showToast('HRM connected!', 'success');
            } catch (error) {
                console.error('‚ùå HRM error:', error);
                statusText.textContent = 'Connection Failed';
                statusDesc.textContent = error.message;
                btn.textContent = 'Retry';
                btn.disabled = false;

                this.showToast('HRM connection failed: ' + error.message, 'error');
            }
            }

            async disconnectHRMDirect() {
            if (!this.hrmDevice) return;

            try {
                const { BleClient } = window.Capacitor.Plugins;
                await BleClient.disconnect(this.hrmDevice.deviceId);

                this.hrmDevice = null;
                this.hrmCharacteristic = null;
                this.hrHistory = [];
                this.currentHR = 0;

                document.getElementById('hrmStatusText').textContent = 'Not Connected';
                document.getElementById('hrmStatusDesc').textContent = 'Connect your Polar/Garmin/Wahoo HRM';
                document.getElementById('hrmLiveDisplay').style.display = 'none';
                document.getElementById('hrmGraphContainer').style.display = 'none';

                const btn = document.getElementById('hrmConnectButton');
                btn.textContent = 'Connect Heart Rate Monitor';
                btn.onclick = () => this.connectHRMDirect();

                this.showToast('HRM disconnected', 'success');
            } catch (error) {
                console.error('‚ùå Disconnect error:', error);
            }
            }

            initHRMCanvas() {
                this.hrCanvas = document.getElementById('hrmCanvas');
                if (this.hrCanvas) {
                    this.hrCtx = this.hrCanvas.getContext('2d');
                    this.hrCanvas.width = this.hrCanvas.offsetWidth;
                    this.hrCanvas.height = 200;
                }
                this.hrHistory = [];
                this.currentHR = 0;
            }

            handleHRMDataDirect(value) {
                const flags = value.getUint8(0);
                const hrValueFormat = flags & 0x01;
                
                let hr;
                if (hrValueFormat === 0) {
                    hr = value.getUint8(1);
                } else {
                    hr = value.getUint16(1, true);
                }
                
                this.currentHR = hr;
                this.hrHistory.push(hr);
                
                // Keep last 60 readings
                if (this.hrHistory.length > 60) {
                    this.hrHistory.shift();
                }
                
                this.updateHRMDisplay();
                this.updateHRMGraph();
            }

            updateHRMDisplay() {
                const bpmElem = document.getElementById('hrmCurrentBPM');
                if (bpmElem) {
                    bpmElem.textContent = this.currentHR;
                }
                
                // Update zone visualization
                const zone = this.calculateHRZone(this.currentHR);
                for (let i = 1; i <= 5; i++) {
                    const zoneElem = document.getElementById(`hrZone${i}Display`);
                    if (zoneElem) {
                        if (i === zone) {
                            zoneElem.style.opacity = '1';
                            zoneElem.style.transform = 'scale(1.1)';
                        } else {
                            zoneElem.style.opacity = '0.3';
                            zoneElem.style.transform = 'scale(1)';
                        }
                    }
                }
            }

            calculateHRZone(hr) {
                // Default zones (can be customized in settings)
                if (hr < 120) return 1;
                if (hr < 140) return 2;
                if (hr < 160) return 3;
                if (hr < 180) return 4;
                return 5;
            }

            updateHRMGraph() {
                if (!this.hrCtx || this.hrHistory.length < 2) return;
                
                const ctx = this.hrCtx;
                const canvas = this.hrCanvas;
                const width = canvas.width;
                const height = canvas.height;
                
                // Clear
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, width, height);
                
                // Calculate stats
                const avg = Math.round(this.hrHistory.reduce((a, b) => a + b, 0) / this.hrHistory.length);
                const max = Math.max(...this.hrHistory);
                const min = Math.min(...this.hrHistory);
                
                // Update stats display
                document.getElementById('hrmAvg').textContent = avg;
                document.getElementById('hrmMax').textContent = max;
                document.getElementById('hrmMin').textContent = min;
                
                // Draw grid
                ctx.strokeStyle = '#222';
                ctx.lineWidth = 1;
                for (let i = 0; i < 5; i++) {
                    const y = (height / 5) * i;
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(width, y);
                    ctx.stroke();
                }
                
                // Draw HR line
                const minHR = Math.max(min - 10, 0);
                const maxHR = max + 10;
                const hrRange = maxHR - minHR;
                
                ctx.strokeStyle = '#ff6b6b';
                ctx.lineWidth = 3;
                ctx.beginPath();
                
                this.hrHistory.forEach((hr, i) => {
                    const x = (width / 60) * i;
                    const y = height - ((hr - minHR) / hrRange) * height;
                    
                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                
                ctx.stroke();
            }

            // ========================================================================
            // DASHBOARD - SWIPEABLE
            // ========================================================================

            setupDashboardSwipe() {
                const container = document.getElementById('dashboardContainer');
                const carousel = document.getElementById('dashboardCarousel');
                
                let startX = 0;
                let currentX = 0;
                let isDragging = false;
                
                container.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].clientX;
                    isDragging = true;
                });
                
                container.addEventListener('touchmove', (e) => {
                    if (!isDragging) return;
                    currentX = e.touches[0].clientX;
                    const diff = currentX - startX;
                    const offset = -this.currentView * 100;
                    carousel.style.transform = `translateX(calc(${offset}% + ${diff}px))`;
                });
                
                container.addEventListener('touchend', (e) => {
                    if (!isDragging) return;
                    isDragging = false;
                    
                    const diff = currentX - startX;
                    if (Math.abs(diff) > 50) {
                        if (diff > 0 && this.currentView > 0) {
                            this.currentView--;
                        } else if (diff < 0 && this.currentView < 4) {
                            this.currentView++;
                        }
                    }
                    
                    this.updateDashboardView();
                });
            }

            updateDashboardView() {
                const carousel = document.getElementById('dashboardCarousel');
                carousel.style.transform = `translateX(-${this.currentView * 100}%)`;
                
                document.querySelectorAll('.dashboard-dot').forEach((dot, i) => {
                    if (i === this.currentView) {
                        dot.classList.add('active');
                    } else {
                        dot.classList.remove('active');
                    }
                });
            }

            updateDashboardMetrics() {
                const mins = Math.floor(this.liveData.pace / 60);
                const secs = Math.floor(this.liveData.pace % 60);
                const paceStr = `${mins}:${secs.toString().padStart(2, '0')}`;
                
                const timeMins = Math.floor(this.liveData.time / 60);
                const timeSecs = Math.floor(this.liveData.time % 60);
                const timeStr = `${timeMins}:${timeSecs.toString().padStart(2, '0')}`;
                
                // All Data view
                document.getElementById('pace1').textContent = paceStr;
                document.getElementById('time1').textContent = timeStr;
                document.getElementById('dist1').textContent = this.liveData.dist + 'm';
                document.getElementById('watts1').textContent = Math.floor(this.liveData.watts);
                document.getElementById('rate1').textContent = this.liveData.rate;
                document.getElementById('hr1').textContent = this.liveData.hr || '--';
                document.getElementById('avgPace1').textContent = paceStr;
                
                // Large Print view
                document.getElementById('paceLP').textContent = paceStr;
                document.getElementById('distLP').textContent = this.liveData.dist + 'm';
            }

            updateCoachMessage() {
                const msg = document.getElementById('coachMessage');
                if (this.liveData.pace > 125) {
                    msg.textContent = '‚ö†Ô∏è Power dropping! Focus on leg drive!';
                } else if (this.liveData.pace < 110 && this.liveData.time < 60) {
                    msg.textContent = '‚ö†Ô∏è Too fast! Settle into rhythm.';
                } else if (this.liveData.pace > 110 && this.liveData.pace < 120) {
                    msg.textContent = 'üí™ Perfect pace! Keep this rhythm.';
                } else {
                    msg.textContent = 'Looking good. Stay focused.';
                }
            }

            updateHRZone() {
                if (!this.liveData.hr || !this.profile) return;
                
                const sidebar = document.getElementById('hrSidebar');
                sidebar.style.display = 'flex';
                
                let zone = 1;
                if (this.liveData.hr > 180) zone = 5;
                else if (this.liveData.hr > 160) zone = 4;
                else if (this.liveData.hr > 140) zone = 3;
                else if (this.liveData.hr > 120) zone = 2;
                
                for (let i = 1; i <= 5; i++) {
                    const elem = document.getElementById(`hrZ${i}`);
                    if (i === zone) {
                        elem.classList.add('active');
                    } else {
                        elem.classList.remove('active');
                    }
                }
            }

            drawForceC() {
                const canvas = document.getElementById('forceCanvas');
                if (!canvas) return;
                canvas.width = canvas.offsetWidth;
                canvas.height = 300;
                const ctx = canvas.getContext('2d');
                
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.strokeStyle = '#00FF99';
                ctx.lineWidth = 3;
                ctx.beginPath();
                
                for (let i = 0; i < 50; i++) {
                    const x = (canvas.width / 50) * i;
                    const y = canvas.height - Math.sin(i * 0.2) * (this.liveData.watts / 2) - 50;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();
            }

            drawPaceboat() {
                const canvas = document.getElementById('paceboatCanvas');
                if (!canvas) return;
                canvas.width = canvas.offsetWidth;
                canvas.height = 400;
                const ctx = canvas.getContext('2d');
                
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // User boat
                ctx.fillStyle = '#00FF99';
                ctx.fillRect(50, 150, 60, 30);
                ctx.fillText('YOU', 60, 140);
                
                // Target boat
                ctx.fillStyle = '#FF6B6B';
                ctx.fillRect(150, 150, 60, 30);
                ctx.fillText('TARGET', 160, 140);
            }

            drawBarChart() {
                const canvas = document.getElementById('barCanvas');
                if (!canvas) return;
                canvas.width = canvas.offsetWidth;
                canvas.height = 300;
                const ctx = canvas.getContext('2d');
                
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                const barWidth = canvas.width / 20;
                this.paceHistory.forEach((pace, i) => {
                    const height = (pace / 150) * canvas.height;
                    ctx.fillStyle = '#00FF99';
                    ctx.fillRect(i * barWidth, canvas.height - height, barWidth - 2, height);
                });
            }

            // ========================================================================
            // PM5 CONNECTION
            // ========================================================================

            async connectPM5() {
            const btn = document.getElementById('pm5ConnectBtn');
            const status = document.getElementById('pm5Status');
            const indicator = document.getElementById('pm5Indicator');

            const btnSettings = document.getElementById('pm5ConnectBtnSettings');
            const statusSettings = document.getElementById('pm5StatusSettings');
            const indicatorSettings = document.getElementById('pm5IndicatorSettings');

            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Connecting...';
            }
            if (btnSettings) {
                btnSettings.disabled = true;
                btnSettings.textContent = 'Connecting...';
            }
            if (status) status.textContent = 'Searching for PM5...';
            if (statusSettings) statusSettings.textContent = 'Searching for PM5...';

            try {
                console.log('üîç Requesting PM5...');

                // Use Capacitor Bluetooth LE plugin
                const { BleClient } = window.Capacitor.Plugins;

                const device = await BleClient.requestDevice({
                    services: [PM5_SERVICE_UUID],
                    optionalServices: []
                });

                console.log(`‚úì Device: ${device.name || device.deviceId}`);
                if (status) status.textContent = `Connecting to ${device.name || 'PM5'}...`;
                if (statusSettings) statusSettings.textContent = `Connecting to ${device.name || 'PM5'}...`;

                await BleClient.connect(device.deviceId);
                console.log('‚úì PM5 connected');

                this.pm5Device = device;

                // Start notifications
                await BleClient.startNotifications(
                    device.deviceId,
                    PM5_SERVICE_UUID,
                    PM5_CHARACTERISTIC_UUID,
                    (value) => this.handlePM5Data(value)
                );

                console.log('‚úì PM5 notifications started');

                if (status) status.textContent = `Connected: ${device.name || 'PM5'}`;
                if (statusSettings) statusSettings.textContent = `Connected: ${device.name || 'PM5'}`;
                if (indicator) indicator.style.background = '#00FF99';
                if (indicatorSettings) indicatorSettings.style.background = '#00FF99';

                if (btn) {
                    btn.textContent = 'Disconnect';
                    btn.disabled = false;
                    btn.onclick = () => this.disconnectPM5();
                }
                if (btnSettings) {
                    btnSettings.textContent = 'Disconnect';
                    btnSettings.disabled = false;
                    btnSettings.onclick = () => this.disconnectPM5();
                }

                this.showToast('PM5 connected!', 'success');
            } catch (error) {
                console.error('‚ùå PM5 error:', error);
                if (status) status.textContent = 'Connection failed';
                if (statusSettings) statusSettings.textContent = 'Connection failed';
                if (indicator) indicator.style.background = '#FF4444';
                if (indicatorSettings) indicatorSettings.style.background = '#FF4444';

                if (btn) {
                    btn.textContent = 'Retry';
                    btn.disabled = false;
                }
                if (btnSettings) {
                    btnSettings.textContent = 'Retry';
                    btnSettings.disabled = false;
                }

                this.showToast('PM5 connection failed: ' + error.message, 'error');
            }
            }

            handlePM5Data(value) {
                // Parse PM5 data
                console.log('PM5 data:', value);
            }

            // ========================================================================
            // BUILDER
            // ========================================================================

            selectBuilderMode(mode) {
                this.builderMode = mode;
                document.querySelectorAll('.builder-mode-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
                this.renderBuilderMode();
            }

            renderBuilderMode() {
                const container = document.getElementById('builderModeContent');
                if (!container) return;
                
                let html = '<div class="builder-section"><div class="builder-section-title">Workout Details</div>';
                
                if (this.builderMode === 'single-distance') {
                    html += `
                        <div class="builder-input-group">
                            <div class="builder-label">Total Distance (meters)</div>
                            <input type="number" class="builder-input" id="totalDistance" placeholder="5000">
                        </div>
                        <div class="builder-input-group">
                            <div class="builder-label">Split Length (meters)</div>
                            <input type="number" class="builder-input" id="splitDistance" placeholder="1000">
                        </div>
                    `;
                } else if (this.builderMode === 'single-time') {
                    html += `
                        <div class="builder-input-group">
                            <div class="builder-label">Total Time</div>
                            <div class="builder-time-picker">
                                <input type="number" class="builder-time-input" id="totalMins" placeholder="30" min="0">
                                <span style="color:#666;">:</span>
                                <input type="number" class="builder-time-input" id="totalSecs" placeholder="00" min="0" max="59">
                            </div>
                        </div>
                        <div class="builder-input-group">
                            <div class="builder-label">Split Time</div>
                            <div class="builder-time-picker">
                                <input type="number" class="builder-time-input" id="splitMins" placeholder="5" min="0">
                                <span style="color:#666;">:</span>
                                <input type="number" class="builder-time-input" id="splitSecs" placeholder="00" min="0" max="59">
                            </div>
                        </div>
                    `;
                } else if (this.builderMode === 'fixed-intervals') {
                    html += `
                        <div class="builder-input-group">
                            <div class="builder-label">Work Type</div>
                            <select class="builder-input" id="workType">
                                <option value="distance">Distance</option>
                                <option value="time">Time</option>
                            </select>
                        </div>
                        <div class="builder-input-group">
                            <div class="builder-label">Work Value</div>
                            <input type="number" class="builder-input" id="workValue" placeholder="500">
                        </div>
                        <div class="builder-input-group">
                            <div class="builder-label">Number of Intervals</div>
                            <input type="number" class="builder-input" id="numSets" placeholder="6">
                        </div>
                        <div class="builder-input-group">
                            <div class="builder-label">Rest Time</div>
                            <div class="builder-time-picker">
                                <input type="number" class="builder-time-input" id="restMins" placeholder="1" min="0">
                                <span style="color:#666;">:</span>
                                <input type="number" class="builder-time-input" id="restSecs" placeholder="00" min="0" max="59">
                            </div>
                        </div>
                    `;
                } else if (this.builderMode === 'variable-intervals') {
                    html += `
                        <div class="builder-input-group">
                            <div class="builder-label">Work Value (meters)</div>
                            <input type="number" class="builder-input" id="varWorkValue" placeholder="500">
                        </div>
                        <div class="builder-input-group">
                            <div class="builder-label">Rest Time</div>
                            <div class="builder-time-picker">
                                <input type="number" class="builder-time-input" id="varRestMins" placeholder="1" min="0">
                                <span style="color:#666;">:</span>
                                <input type="number" class="builder-time-input" id="varRestSecs" placeholder="00" min="0" max="59">
                            </div>
                        </div>
                        <button class="btn btn-outline" onclick="app.addVariableInterval()">Add Interval</button>
                        
                        <div class="builder-interval-list">
                            ${this.builderIntervals.map((interval, i) => `
                                <div class="builder-interval-item ${i === this.editingInterval ? 'editable' : ''}" onclick="app.editInterval(${i})">
                                    <div class="builder-interval-header">
                                        <div class="builder-interval-title">${i + 1}. ${interval.workValue}m / ${interval.restTime}s rest</div>
                                        <div class="builder-interval-actions">
                                            <button class="builder-icon-btn" onclick="event.stopPropagation(); app.copyInterval(${i})">üìã</button>
                                            <button class="builder-icon-btn" onclick="event.stopPropagation(); app.deleteInterval(${i})">üóëÔ∏è</button>
                                        </div>
                                    </div>
                                    <div class="builder-interval-edit">
                                        <div class="builder-input-group">
                                            <div class="builder-label">Work Value (meters)</div>
                                            <input type="number" class="builder-input" value="${interval.workValue}" onchange="app.updateInterval(${i}, 'workValue', this.value)">
                                        </div>
                                        <div class="builder-input-group">
                                            <div class="builder-label">Rest Time (seconds)</div>
                                            <input type="number" class="builder-input" value="${interval.restTime}" onchange="app.updateInterval(${i}, 'restTime', this.value)">
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                html += '</div>';
                container.innerHTML = html;
            }

            toggleBuilderTarget(target) {
                this.builderTargets[target] = !this.builderTargets[target];
                
                const checkbox = document.getElementById(`${target}Checkbox`);
                const inputs = document.getElementById(`${target}Inputs`);
                
                if (this.builderTargets[target]) {
                    checkbox.classList.add('checked');
                    checkbox.textContent = '‚úì';
                    inputs.style.display = 'block';
                } else {
                    checkbox.classList.remove('checked');
                    checkbox.textContent = '';
                    inputs.style.display = 'none';
                }
            }

            addVariableInterval() {
                const workValue = document.getElementById('varWorkValue').value;
                const restMins = parseInt(document.getElementById('varRestMins').value) || 0;
                const restSecs = parseInt(document.getElementById('varRestSecs').value) || 0;
                
                if (!workValue) {
                    this.showToast('Enter work value', 'error');
                    return;
                }
                
                this.builderIntervals.push({
                    workValue: parseInt(workValue),
                    restTime: restMins * 60 + restSecs
                });
                
                this.renderBuilderMode();
            }

            editInterval(index) {
                this.editingInterval = this.editingInterval === index ? -1 : index;
                this.renderBuilderMode();
            }

            updateInterval(index, field, value) {
                this.builderIntervals[index][field] = parseInt(value);
            }

            copyInterval(index) {
                const interval = {...this.builderIntervals[index]};
                this.builderIntervals.push(interval);
                this.renderBuilderMode();
            }

            deleteInterval(index) {
                this.builderIntervals.splice(index, 1);
                this.renderBuilderMode();
            }

            saveManualWorkout() {
                this.reviewWorkout = {
                    mode: this.builderMode,
                    intervals: []
                };
                
                // Handle different workout modes
                if (this.builderMode === 'single-distance') {
                    const total = parseInt(document.getElementById('totalDistance').value);
                    const split = parseInt(document.getElementById('splitDistance').value);
                    
                    if (!total) {
                        this.showToast('Enter total distance', 'error');
                        return;
                    }
                    
                    this.reviewWorkout.intervals = [{ type: 'distance', value: total, split: split || total }];
                    
                } else if (this.builderMode === 'single-time') {
                    const mins = parseInt(document.getElementById('totalMins').value) || 0;
                    const secs = parseInt(document.getElementById('totalSecs').value) || 0;
                    const splitMins = parseInt(document.getElementById('splitMins').value) || 0;
                    const splitSecs = parseInt(document.getElementById('splitSecs').value) || 0;
                    
                    const totalTime = mins * 60 + secs;
                    const splitTime = splitMins * 60 + splitSecs;
                    
                    if (totalTime === 0) {
                        this.showToast('Enter total time', 'error');
                        return;
                    }
                    
                    this.reviewWorkout.intervals = [{ 
                        type: 'time', 
                        value: totalTime, 
                        split: splitTime || totalTime,
                        displayValue: `${mins}:${secs.toString().padStart(2, '0')}`
                    }];
                    
                } else if (this.builderMode === 'fixed-intervals') {
                    const workType = document.getElementById('workType').value;
                    const workValue = parseInt(document.getElementById('workValue').value);
                    const numSets = parseInt(document.getElementById('numSets').value);
                    const restMins = parseInt(document.getElementById('restMins').value) || 0;
                    const restSecs = parseInt(document.getElementById('restSecs').value) || 0;
                    
                    if (!workValue || !numSets) {
                        this.showToast('Enter work value and number of sets', 'error');
                        return;
                    }
                    
                    const restTime = restMins * 60 + restSecs;
                    
                    for (let i = 0; i < numSets; i++) {
                        this.reviewWorkout.intervals.push({
                            type: workType,
                            workValue: workValue,
                            restTime: restTime
                        });
                    }
                    
                } else if (this.builderMode === 'variable-intervals') {
                    if (this.builderIntervals.length === 0) {
                        this.showToast('Add at least one interval', 'error');
                        return;
                    }
                    this.reviewWorkout.intervals = this.builderIntervals;
                }
                
                // Capture global targets
                if (document.getElementById('splitPaceCheckbox').classList.contains('checked')) {
                    this.reviewWorkout.targetSplit = document.getElementById('splitPaceValue').value;
                }
                if (document.getElementById('heartRateCheckbox').classList.contains('checked')) {
                    this.reviewWorkout.targetHRZone = document.getElementById('heartRateZone').value;
                }
                if (document.getElementById('strokeRateCheckbox').classList.contains('checked')) {
                    this.reviewWorkout.targetStrokeRate = document.getElementById('strokeRateValue').value;
                }
                
                this.renderReview();
                this.navigate('screenReview');
            }

            renderReview() {
                const titleElem = document.getElementById('reviewTitle');
                const intervalsElem = document.getElementById('reviewIntervals');
                
                titleElem.textContent = 'Review Your Workout';
                
                let html = '';
                
                if (!this.reviewWorkout || !this.reviewWorkout.intervals || this.reviewWorkout.intervals.length === 0) {
                    html = `
                        <div style="text-align:center; padding:40px 20px; color:#666;">
                            <div style="font-size:48px; margin-bottom:12px;">üìã</div>
                            <div style="font-size:14px;">No workout data to review</div>
                        </div>
                    `;
                } else {
                    // Workout Summary Card
                    html += `
                        <div style="background:var(--card-bg); border:1px solid var(--border); border-radius:12px; padding:20px; margin-bottom:16px;">
                            <div style="font-size:12px; color:#666; text-transform:uppercase; margin-bottom:12px;">Workout Summary</div>
                    `;
                    
                    // Mode
                    const modeNames = {
                        'single-time': 'Time-Based',
                        'single-distance': 'Distance-Based',
                        'fixed-intervals': 'Fixed Intervals',
                        'variable-intervals': 'Variable Intervals',
                        'just-row': 'Just Row'
                    };
                    html += `
                        <div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid #222;">
                            <div style="color:#888;">Mode</div>
                            <div style="font-weight:700; color:var(--accent);">${modeNames[this.builderMode] || this.builderMode}</div>
                        </div>
                    `;
                    
                    // Calculate totals
                    let totalWork = 0;
                    let totalRest = 0;
                    let intervalCount = this.reviewWorkout.intervals.length;
                    let isTimeMode = false;
                    
                    this.reviewWorkout.intervals.forEach(interval => {
                        if (interval.type === 'time') {
                            isTimeMode = true;
                        }
                        if (interval.workValue) totalWork += parseInt(interval.workValue);
                        if (interval.value) totalWork += parseInt(interval.value);
                        if (interval.restTime) totalRest += parseInt(interval.restTime);
                    });
                    
                    // Total Work - display based on type
                    if (isTimeMode || this.builderMode === 'single-time') {
                        const mins = Math.floor(totalWork / 60);
                        const secs = totalWork % 60;
                        html += `
                            <div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid #222;">
                                <div style="color:#888;">Total Time</div>
                                <div style="font-weight:700; font-size:20px; color:var(--accent);">${mins}:${secs.toString().padStart(2, '0')}</div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid #222;">
                                <div style="color:#888;">Total Distance</div>
                                <div style="font-weight:700; font-size:20px; color:var(--accent);">${totalWork}m</div>
                            </div>
                        `;
                    }
                    
                    // Intervals
                    if (intervalCount > 1) {
                        html += `
                            <div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid #222;">
                                <div style="color:#888;">Intervals</div>
                                <div style="font-weight:700;">${intervalCount} sets</div>
                            </div>
                        `;
                    }
                    
                    // Total Rest
                    if (totalRest > 0) {
                        html += `
                            <div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid #222;">
                                <div style="color:#888;">Total Rest</div>
                                <div style="font-weight:700;">${totalRest}s (${Math.round(totalRest/60)}min)</div>
                            </div>
                        `;
                    }
                    
                    // Global Targets
                    if (this.reviewWorkout.targetSplit) {
                        html += `
                            <div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid #222;">
                                <div style="color:#888;">Target Split</div>
                                <div style="font-weight:700; color:#4a90e2;">${this.reviewWorkout.targetSplit}/500m</div>
                            </div>
                        `;
                    }
                    
                    if (this.reviewWorkout.targetHRZone) {
                        html += `
                            <div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid #222;">
                                <div style="color:#888;">Target HR Zone</div>
                                <div style="font-weight:700; color:#ff6b6b;">Zone ${this.reviewWorkout.targetHRZone}</div>
                            </div>
                        `;
                    }
                    
                    if (this.reviewWorkout.targetStrokeRate) {
                        html += `
                            <div style="display:flex; justify-content:space-between; padding:12px 0;">
                                <div style="color:#888;">Target Stroke Rate</div>
                                <div style="font-weight:700;">${this.reviewWorkout.targetStrokeRate} s/m</div>
                            </div>
                        `;
                    }
                    
                    html += `</div>`;
                    
                    // Intervals Breakdown (if multiple intervals)
                    if (intervalCount > 1) {
                        html += `
                            <div style="background:var(--card-bg); border:1px solid var(--border); border-radius:12px; padding:20px;">
                                <div style="font-size:12px; color:#666; text-transform:uppercase; margin-bottom:12px;">Intervals Breakdown</div>
                        `;
                        
                        this.reviewWorkout.intervals.forEach((interval, i) => {
                            const workValue = interval.workValue || interval.value;
                            const workUnit = (interval.type === 'time') ? 's' : 'm';
                            const restValue = interval.restTime || 0;
                            
                            // Format time display if needed
                            let displayValue = workValue;
                            if (interval.type === 'time') {
                                const mins = Math.floor(workValue / 60);
                                const secs = workValue % 60;
                                displayValue = `${mins}:${secs.toString().padStart(2, '0')}`;
                            }
                            
                            html += `
                                <div style="background:#050505; border:1px solid #222; border-radius:8px; padding:16px; margin-bottom:12px;">
                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                        <div style="font-weight:700; font-size:14px;">Set ${i + 1}</div>
                                        <div style="font-size:18px; font-weight:900; color:var(--accent);">${displayValue}${workUnit === 's' ? '' : workUnit}</div>
                                    </div>
                                    ${restValue > 0 ? `
                                        <div style="display:flex; justify-content:space-between; font-size:12px; color:#888;">
                                            <div>Rest</div>
                                            <div>${restValue}s</div>
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        });
                        
                        html += `</div>`;
                    }
                }
                
                intervalsElem.innerHTML = html;
            }

            startWorkout() {
                if (!this.reviewWorkout || !this.reviewWorkout.intervals || this.reviewWorkout.intervals.length === 0) {
                    this.showToast('No workout to start', 'error');
                    return;
                }
                
                // Set up active workout
                this.activeWorkout = {
                    ...this.reviewWorkout,
                    startTime: null, // Will be set on first stroke
                    currentInterval: 0,
                    isResting: false
                };
                
                // Get first interval
                const firstInterval = this.reviewWorkout.intervals[0];
                
                // Initialize countdown for time-based workouts (but don't start yet)
                if (firstInterval.type === 'time' || this.builderMode === 'single-time') {
                    this.workoutTimeRemaining = firstInterval.value; // seconds remaining
                    this.workoutTimeTotal = firstInterval.value; // total seconds for progress
                    this.isCountingDown = false; // Wait for first stroke
                    this.waitingForFirstStroke = true;
                } else {
                    this.isCountingDown = false;
                    this.waitingForFirstStroke = true;
                    this.workoutTimeRemaining = 0;
                }
                
                // Display ready state
                this.updateDashboardReadyState();
                
                this.showToast('Ready! Pull first stroke to begin.', 'success');
                setTimeout(() => {
                    this.navigate('screenDashboard');
                }, 500);
            }
            
            updateDashboardReadyState() {
                // Show initial time without starting countdown
                if (this.workoutTimeRemaining > 0) {
                    const mins = Math.floor(this.workoutTimeRemaining / 60);
                    const secs = this.workoutTimeRemaining % 60;
                    const timeStr = `${mins}:${secs.toString().padStart(2, '0')}`;
                    document.getElementById('time1').textContent = timeStr;
                }
                
                const coachMsg = document.getElementById('coachMessage');
                if (coachMsg) {
                    coachMsg.textContent = `üö£ Ready to row! Pull first stroke to start timer.`;
                }
                
                // Show manual start button for testing (hidden when PM5 is connected)
                const startBtn = document.getElementById('manualStartBtn');
                if (startBtn) {
                    startBtn.style.display = 'block';
                }
            }
            
            onFirstStroke() {
                // Called when PM5 detects first stroke or user starts rowing
                if (this.waitingForFirstStroke) {
                    this.waitingForFirstStroke = false;
                    this.activeWorkout.startTime = Date.now();
                    
                    // Hide manual start button
                    const startBtn = document.getElementById('manualStartBtn');
                    if (startBtn) {
                        startBtn.style.display = 'none';
                    }
                    
                    // Start countdown if time-based workout
                    if (this.workoutTimeRemaining > 0) {
                        this.isCountingDown = true;
                        this.startWorkoutTimer();
                    }
                    
                    this.showToast('Workout started!', 'success');
                }
            }
            
            startWorkoutTimer() {
                // Clear any existing timer
                if (this.workoutTimer) {
                    clearInterval(this.workoutTimer);
                }
                
                // Update every second
                this.workoutTimer = setInterval(() => {
                    if (this.isCountingDown && this.workoutTimeRemaining > 0) {
                        this.workoutTimeRemaining--;
                        this.updateDashboardWorkoutDisplay();
                        
                        // Workout complete
                        if (this.workoutTimeRemaining === 0) {
                            this.completeWorkout();
                        }
                    }
                }, 1000);
            }
            
            updateDashboardWorkoutDisplay() {
                if (!this.isCountingDown) return;
                
                const mins = Math.floor(this.workoutTimeRemaining / 60);
                const secs = this.workoutTimeRemaining % 60;
                const timeStr = `${mins}:${secs.toString().padStart(2, '0')}`;
                
                // Update all time displays
                document.getElementById('time1').textContent = timeStr;
                
                // Update coach message with progress
                const progress = Math.round((1 - this.workoutTimeRemaining / this.workoutTimeTotal) * 100);
                const coachMsg = document.getElementById('coachMessage');
                if (coachMsg) {
                    if (this.workoutTimeRemaining <= 60) {
                        coachMsg.textContent = `üî• Final minute! Push hard!`;
                    } else if (this.workoutTimeRemaining <= 120) {
                        coachMsg.textContent = `üí™ ${mins} minutes left - stay strong!`;
                    } else {
                        coachMsg.textContent = `‚è±Ô∏è ${mins}:${secs.toString().padStart(2, '0')} remaining (${progress}% complete)`;
                    }
                }
            }
            
            completeWorkout() {
                clearInterval(this.workoutTimer);
                
                // Check if there are more intervals
                if (this.activeWorkout && this.activeWorkout.intervals && 
                    this.activeWorkout.currentInterval < this.activeWorkout.intervals.length - 1) {
                    
                    // Move to rest period if there's rest time
                    const currentInterval = this.activeWorkout.intervals[this.activeWorkout.currentInterval];
                    if (currentInterval.restTime && currentInterval.restTime > 0) {
                        this.startRestPeriod(currentInterval.restTime);
                    } else {
                        // No rest, move to next interval immediately
                        this.startNextInterval();
                    }
                } else {
                    // All intervals complete - finish workout
                    this.finishWorkout();
                }
            }
            
            startRestPeriod(restSeconds) {
                this.activeWorkout.isResting = true;
                this.isCountingDown = true;
                this.workoutTimeRemaining = restSeconds;
                
                const coachMsg = document.getElementById('coachMessage');
                if (coachMsg) {
                    coachMsg.textContent = `üí§ Rest period - ${restSeconds}s`;
                }
                
                // Countdown rest time
                this.workoutTimer = setInterval(() => {
                    if (this.workoutTimeRemaining > 0) {
                        this.workoutTimeRemaining--;
                        
                        // Update display
                        const mins = Math.floor(this.workoutTimeRemaining / 60);
                        const secs = this.workoutTimeRemaining % 60;
                        document.getElementById('time1').textContent = `REST ${mins}:${secs.toString().padStart(2, '0')}`;
                        
                        if (coachMsg) {
                            coachMsg.textContent = `üí§ Rest: ${this.workoutTimeRemaining}s remaining`;
                        }
                    } else {
                        // Rest complete - start next interval
                        this.startNextInterval();
                    }
                }, 1000);
            }
            
            startNextInterval() {
                clearInterval(this.workoutTimer);
                this.activeWorkout.currentInterval++;
                this.activeWorkout.isResting = false;
                this.waitingForFirstStroke = true;
                
                const nextInterval = this.activeWorkout.intervals[this.activeWorkout.currentInterval];
                
                if (nextInterval.type === 'time' || nextInterval.workValue) {
                    this.workoutTimeRemaining = nextInterval.value || nextInterval.workValue;
                    this.workoutTimeTotal = this.workoutTimeRemaining;
                }
                
                this.showToast(`Next interval - pull to start!`, 'success');
                this.updateDashboardReadyState();
            }
            
            finishWorkout() {
                this.isCountingDown = false;
                this.showToast('üéâ Workout complete!', 'success');
                
                // Save workout to history
                const workout = {
                    id: Date.now().toString(),
                    date: new Date().toISOString(),
                    type: this.activeWorkout.mode || 'manual',
                    duration: Math.round((Date.now() - this.activeWorkout.startTime) / 1000),
                    distance: this.liveData.dist || 0,
                    avgPace: this.liveData.pace || 0,
                    avgHR: this.liveData.hr || 0,
                    completed: true
                };
                
                this.workouts.push(workout);
                this.dataStore.saveWorkouts(this.workouts);
                this.renderHistory();
                this.updateStats();
                
                this.activeWorkout = null;
                
                const coachMsg = document.getElementById('coachMessage');
                if (coachMsg) {
                    coachMsg.textContent = `üéâ Great work! Workout complete.`;
                }
            }

            async endWorkout() {
                if (!this.activeWorkout) {
                    this.showToast('No active workout', 'error');
                    return;
                }

                if (confirm('End workout early?')) {
                    clearInterval(this.workoutTimer);
                    this.isCountingDown = false;

                    // Save partial workout
                    const workout = {
                        id: Date.now().toString(),
                        date: new Date().toISOString(),
                        type: this.activeWorkout.mode || 'manual',
                        duration: Math.round((Date.now() - this.activeWorkout.startTime) / 1000),
                        distance: this.liveData.dist || 0,
                        avgPace: this.liveData.pace || 0,
                        avgHR: this.liveData.hr || 0,
                        avgWatts: this.liveData.watts || 0,
                        completed: false,
                        description: 'Manual Workout'
                    };

                    this.workouts.unshift(workout);  // Add to beginning of array
                    await this.dataStore.saveWorkout(workout);

                    // Update DNA profile with workout data
                    await this.updateDNAProfile(workout);

                    this.renderHistory();
                    this.renderDNA();
                    this.renderTrainingLog();
                    this.updateStats();

                    this.activeWorkout = null;
                    this.showToast('Workout ended and saved', 'success');
                }
            }

            // ========================================================================
            // CSV IMPORT - FIXED
            // ========================================================================

            importCSV(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const csv = e.target.result;
                        const lines = csv.split('\n');
                        
                        console.log(`üìÑ Lines: ${lines.length}`);
                        
                        // SKIP HEADER (line 0)
                        const headers = lines[0].split(',').map(h => h.trim());
                        console.log(`üìã Headers: ${headers.join(', ')}`);
                        
                        let imported = 0;
                        const existingIds = new Set(this.workouts.map(w => w.id));
                        
                        // START FROM LINE 1
                        for (let i = 1; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (!line) continue;
                            
                            const values = line.split(',');
                            if (values.length < headers.length) continue;
                            
                            const row = {};
                            headers.forEach((header, idx) => {
                                row[header] = values[idx]?.trim();
                            });
                            
                            // Parse DD/M/YYYY HH:MM
                            const dateStr = row['Date'];
                            if (!dateStr || dateStr === 'Date') continue;
                            
                            let parsedDate = new Date().toISOString();
                            try {
                                const parts = dateStr.split(' ');
                                if (parts.length >= 1) {
                                    const [day, month, year] = parts[0].split('/');
                                    const d = new Date(year, month - 1, day);
                                    if (!isNaN(d.getTime())) {
                                        parsedDate = d.toISOString();
                                    }
                                }
                            } catch (e) {
                                console.warn('Date parse:', dateStr);
                            }
                            
                            const id = row['Log ID'] || String(Date.now() + Math.random());
                            
                            if (!existingIds.has(id)) {
                                this.workouts.push({
                                    id: id,
                                    date: parsedDate,
                                    description: row['Description'] || '',
                                    distance: parseInt(row['Work Distance']) || 0,
                                    pace: row['Pace'] || '',
                                    avgWatts: parseInt(row['Avg Watts']) || 0,
                                    avgHR: parseInt(row['Avg Heart Rate']) || 0
                                });
                                imported++;
                                existingIds.add(id);
                            }
                        }
                        
                        console.log(`‚úÖ Imported ${imported} workouts`);
                        console.log(`üìä Total: ${this.workouts.length}`);
                        
                        this.workouts.sort((a, b) => new Date(b.date) - new Date(a.date));
                        
                        this.saveData();
                        this.renderHistory();
                        this.updateStats();
                        
                        this.showToast(`‚úì Imported ${imported} workouts!`, 'success');
                        
                        event.target.value = '';
                    } catch (error) {
                        console.error('‚ùå CSV Error:', error);
                        this.showToast('Import failed: ' + error.message, 'error');
                    }
                };
                
                reader.readAsText(file);
            }

            // ========================================================================
            // HISTORY
            // ========================================================================

            renderHistory() {
                const container = document.getElementById('historyList');
                if (!container) return;

                if (this.workouts.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìä</div><div>No workouts yet</div></div>';
                    return;
                }

                const html = this.workouts.map((workout, idx) => {
                    let dateStr = 'Invalid Date';
                    try {
                        const d = new Date(workout.date);
                        if (!isNaN(d.getTime())) {
                            dateStr = d.toLocaleDateString();
                        }
                    } catch (e) {
                        console.warn('Date error:', workout.date);
                    }
                    
                    return `
                        <div class="history-item">
                            <button class="history-delete" onclick="app.deleteWorkout(${idx})">Delete</button>
                            <div class="history-date">${dateStr}</div>
                            <div class="history-title">${workout.description || 'Workout'}</div>
                            <div class="history-stats">
                                <span>${workout.distance}m</span>
                                <span>${workout.pace || '--'}</span>
                                <span>${workout.avgWatts || '--'}W</span>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = html;
            }

            updateStats() {
                document.getElementById('totalWorkouts').textContent = this.workouts.length;
                document.getElementById('historyCount').textContent = this.workouts.length;
                
                const totalDist = this.workouts.reduce((sum, w) => sum + (w.distance || 0), 0);
                document.getElementById('totalDistance').textContent = Math.floor(totalDist / 1000) + 'k';
            }

            // ========================================================================
            // SETTINGS
            // ========================================================================

            loadProfile() {
                if (!this.profile) return;
                document.getElementById('editName').value = this.profile.name || '';
                document.getElementById('editAge').value = this.profile.age || '';
                document.getElementById('editWeight').value = this.profile.weight || '';
                
                this.loadHRZones();
            }
            
            loadHRZones() {
                const maxHR = this.profile?.maxHR || 190;
                document.getElementById('editMaxHR').value = maxHR;
                
                // Update zone ranges
                document.getElementById('zone1Range').textContent = `${Math.round(maxHR * 0.5)}-${Math.round(maxHR * 0.6)} bpm`;
                document.getElementById('zone2Range').textContent = `${Math.round(maxHR * 0.6)}-${Math.round(maxHR * 0.7)} bpm`;
                document.getElementById('zone3Range').textContent = `${Math.round(maxHR * 0.7)}-${Math.round(maxHR * 0.8)} bpm`;
                document.getElementById('zone4Range').textContent = `${Math.round(maxHR * 0.8)}-${Math.round(maxHR * 0.9)} bpm`;
                document.getElementById('zone5Range').textContent = `${Math.round(maxHR * 0.9)}-${maxHR} bpm`;
            }
            
            async saveHRZones() {
                const maxHR = parseInt(document.getElementById('editMaxHR').value);
                
                if (!maxHR || maxHR < 100 || maxHR > 220) {
                    this.showToast('Enter valid max HR (100-220)', 'error');
                    return;
                }
                
                this.profile = this.profile || {};
                this.profile.maxHR = maxHR;
                await this.dataStore.saveProfile(this.profile);
                
                this.loadHRZones();
                this.showToast('HR zones saved!', 'success');
            }

            async saveProfile() {
                const name = document.getElementById('editName').value;
                const age = parseInt(document.getElementById('editAge').value);
                const weight = parseInt(document.getElementById('editWeight').value);
                
                if (!name || !age || !weight) {
                    this.showToast('Fill all fields', 'error');
                    return;
                }
                
                this.profile = { name, age, weight, maxHR: 220 - age };
                await this.dataStore.saveProfile(this.profile);
                
                this.showToast('Profile saved!', 'success');
            }

            async testFirebaseSync() {
                console.log('üîç Testing Firebase sync...');
                
                try {
                    // Save a test value
                    const testData = {
                        testTimestamp: new Date().toISOString(),
                        testMessage: 'Firebase sync working!'
                    };
                    
                    await this.dataStore.saveProfile({ ...this.profile, ...testData });
                    console.log('‚úì Test data saved to Firebase');
                    
                    // Read it back
                    const retrieved = await this.dataStore.loadProfile();
                    console.log('‚úì Test data retrieved:', retrieved);
                    
                    if (retrieved && retrieved.testTimestamp === testData.testTimestamp) {
                        this.showToast('‚úì Firebase sync working! Check console for details.', 'success');
                        document.getElementById('firebaseStatus').textContent = '‚úì Connected & Syncing';
                        document.getElementById('firebaseStatus').style.color = '#00FF99';
                    } else {
                        throw new Error('Data mismatch');
                    }
                } catch (error) {
                    console.error('‚ùå Firebase sync test failed:', error);
                    this.showToast('Firebase sync failed. Check console.', 'error');
                    document.getElementById('firebaseStatus').textContent = '‚úó Sync Failed';
                    document.getElementById('firebaseStatus').style.color = '#FF4444';
                }
            }

            updateFirebaseStatus() {
                const userIdElem = document.getElementById('firebaseUserId');
                const statusElem = document.getElementById('firebaseStatus');
                
                if (userIdElem && this.dataStore) {
                    userIdElem.textContent = this.dataStore.userId || 'Not initialized';
                }
                
                if (statusElem && this.dataStore) {
                    if (this.dataStore.isFirebase) {
                        statusElem.textContent = '‚úì Firebase Enabled';
                        statusElem.style.color = '#00FF99';
                    } else {
                        statusElem.textContent = 'localStorage (offline)';
                        statusElem.style.color = '#FFA500';
                    }
                }
            }

            // ========================================================================
            // TRAINING PLAN GENERATION
            // ========================================================================

            generateTrainingPlan() {
                this.trainingPlan = {
                    weeks: [
                        {
                            number: 1,
                            focus: 'Base Building',
                            days: [
                                { day: 'Monday', title: '30min Steady State', desc: 'Easy pace, build aerobic base', status: 'pending' },
                                { day: 'Tuesday', title: 'Rest', desc: 'Recovery day', status: 'pending' },
                                { day: 'Wednesday', title: '4x1500m', desc: 'Intervals @ 2:00 pace, 3min rest', status: 'pending' },
                                { day: 'Thursday', title: 'Rest', desc: 'Recovery day', status: 'pending' },
                                { day: 'Friday', title: '40min Steady State', desc: 'Zone 2 training', status: 'pending' },
                                { day: 'Saturday', title: '6x500m', desc: 'Speed work @ 1:50, 2min rest', status: 'pending' },
                                { day: 'Sunday', title: 'Rest or light 20min', desc: 'Active recovery', status: 'pending' }
                            ]
                        },
                        {
                            number: 2,
                            focus: 'Intensity Increase',
                            days: [
                                { day: 'Monday', title: '35min Steady State', desc: 'Controlled pace', status: 'pending' },
                                { day: 'Tuesday', title: 'Rest', desc: 'Recovery day', status: 'pending' },
                                { day: 'Wednesday', title: '5x1500m', desc: 'Intervals @ 1:58, 2:30 rest', status: 'pending' },
                                { day: 'Thursday', title: 'Rest', desc: 'Recovery day', status: 'pending' },
                                { day: 'Friday', title: '45min Steady State', desc: 'Build endurance', status: 'pending' },
                                { day: 'Saturday', title: '8x500m', desc: 'Speed @ 1:48, 90s rest', status: 'pending' },
                                { day: 'Sunday', title: '25min Easy', desc: 'Active recovery', status: 'pending' }
                            ]
                        },
                        {
                            number: 3,
                            focus: 'Peak Volume',
                            days: [
                                { day: 'Monday', title: '40min Progressive', desc: 'Start easy, finish strong', status: 'pending' },
                                { day: 'Tuesday', title: 'Rest', desc: 'Recovery day', status: 'pending' },
                                { day: 'Wednesday', title: '6x1500m', desc: 'Intervals @ 1:56, 2min rest', status: 'pending' },
                                { day: 'Thursday', title: 'Rest', desc: 'Recovery day', status: 'pending' },
                                { day: 'Friday', title: '50min Steady State', desc: 'Peak aerobic volume', status: 'pending' },
                                { day: 'Saturday', title: '3x2000m', desc: 'Race pace @ 1:52, 4min rest', status: 'pending' },
                                { day: 'Sunday', title: '30min Easy', desc: 'Recovery', status: 'pending' }
                            ]
                        },
                        {
                            number: 4,
                            focus: 'Taper & Test',
                            days: [
                                { day: 'Monday', title: '30min Easy', desc: 'Reduce volume', status: 'pending' },
                                { day: 'Tuesday', title: 'Rest', desc: 'Recovery', status: 'pending' },
                                { day: 'Wednesday', title: '3x1000m', desc: 'Sharpening @ 1:50, full rest', status: 'pending' },
                                { day: 'Thursday', title: 'Rest', desc: 'Pre-test recovery', status: 'pending' },
                                { day: 'Friday', title: 'Rest', desc: 'Final prep', status: 'pending' },
                                { day: 'Saturday', title: '2000m TIME TRIAL', desc: 'Test day - all out!', status: 'pending' },
                                { day: 'Sunday', title: 'Celebrate!', desc: 'Recovery & reflection', status: 'pending' }
                            ]
                        }
                    ],
                    created: new Date().toISOString()
                };
                
                this.renderTrainingPlan();
            }

            renderTrainingPlan() {
                const container = document.getElementById('planContent');
                if (!container || !this.trainingPlan) return;
                
                // Plan Overview
                let html = `
                    <div style="background:linear-gradient(135deg, rgba(0,255,153,0.1) 0%, rgba(0,255,153,0.02) 100%); border:2px solid var(--accent); border-radius:12px; padding:20px; margin-bottom:20px;">
                        <div style="font-size:16px; font-weight:700; color:var(--accent); margin-bottom:12px;">üéØ Your 4-Week Training Plan</div>
                        <div style="font-size:13px; line-height:1.6; color:#ccc; margin-bottom:16px;">
                            This progressive program is designed to build your aerobic base, increase training intensity, reach peak volume, and then taper for a final test. Each week builds on the previous one, gradually preparing you for peak performance.
                        </div>
                        <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:12px;">
                            <div style="background:rgba(0,0,0,0.3); border-radius:8px; padding:12px;">
                                <div style="font-size:11px; color:#888; text-transform:uppercase; margin-bottom:4px;">Objective</div>
                                <div style="font-size:13px; font-weight:700;">2000m Time Trial</div>
                            </div>
                            <div style="background:rgba(0,0,0,0.3); border-radius:8px; padding:12px;">
                                <div style="font-size:11px; color:#888; text-transform:uppercase; margin-bottom:4px;">Duration</div>
                                <div style="font-size:13px; font-weight:700;">4 Weeks</div>
                            </div>
                        </div>
                        <div style="margin-top:16px; padding-top:16px; border-top:1px solid rgba(0,255,153,0.2); font-size:12px; color:#888;">
                            üí° <strong>Tip:</strong> Click any workout to view details or make adjustments
                        </div>
                    </div>
                `;
                
                // Weekly Breakdown
                html += this.trainingPlan.weeks.map(week => `
                    <div class="plan-week">
                        <div class="plan-week-header">
                            <div class="plan-week-title">Week ${week.number}</div>
                            <div class="plan-week-focus">${week.focus}</div>
                        </div>
                        ${week.days.map((day, dayIndex) => `
                            <div class="plan-day" onclick="app.viewPlanDay(${week.number}, ${dayIndex})" style="cursor:pointer;">
                                <div class="plan-day-info">
                                    <div class="plan-day-title">${day.day}: ${day.title}</div>
                                    <div class="plan-day-desc">${day.desc}</div>
                                </div>
                                <div class="plan-day-status ${day.status}">${day.status === 'completed' ? '‚úì' : '‚óã'}</div>
                            </div>
                        `).join('')}
                    </div>
                `).join('');
                
                container.innerHTML = html;
            }
            
            viewPlanDay(weekNum, dayIndex) {
                const week = this.trainingPlan.weeks.find(w => w.number === weekNum);
                if (!week) return;
                
                const day = week.days[dayIndex];
                if (!day) return;
                
                const message = `
<strong>${day.day} - Week ${weekNum}</strong>

<strong>Workout:</strong> ${day.title}
<strong>Details:</strong> ${day.desc}
<strong>Status:</strong> ${day.status === 'completed' ? '‚úì Completed' : '‚óã Pending'}

Would you like to:
‚Ä¢ View detailed strategy for this workout
‚Ä¢ Adjust the workout parameters
‚Ä¢ Mark as completed
‚Ä¢ Get AI coaching tips
                `.trim();
                
                alert(message);
                // Future: Open a modal with edit options
            }

            generateNewPlan() {
                if (!confirm('Create a new 4-week training plan? This will replace your current plan.')) return;
                
                this.generateTrainingPlan();
                this.showToast('New training plan created!', 'success');
            }

            // ========================================================================
            // NAVIGATION
            // ========================================================================

            navigate(screenId) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(screenId).classList.add('active');

                // Update BOTTOM navigation
                const navItems = document.querySelectorAll('.nav-item');
                navItems.forEach(item => item.classList.remove('active'));
                
                const screenMap = {
                    'screenChat': 0,
                    'screenDashboard': 1,
                    'screenBuilder': 2,
                    'screenPlan': 3,
                    'screenHistory': 4
                };
                
                const index = screenMap[screenId];
                if (index !== undefined && navItems[index]) {
                    navItems[index].classList.add('active');
                }
                
                // Update TOP navigation
                const topNavItems = document.querySelectorAll('.top-nav-item');
                topNavItems.forEach(item => item.classList.remove('active'));
                
                const topScreenMap = {
                    'screenSettings': 0,
                    'screenHRM': 1,
                    'screenDNA': 2
                };
                
                const topIndex = topScreenMap[screenId];
                if (topIndex !== undefined && topNavItems[topIndex]) {
                    topNavItems[topIndex].classList.add('active');
                }
                
                // Update Firebase status when opening settings
                if (screenId === 'screenSettings') {
                    this.updateFirebaseStatus();
                }

                // Render training plan when opening plan screen
                if (screenId === 'screenPlan') {
                    this.renderTrainingPlan();
                }
            }

            showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = `toast ${type}`;
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 3000);
            }
        }

        const app = new AIRowingCoach();
    </script>
</body>
</html>
