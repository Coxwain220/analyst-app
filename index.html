<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyst V9 - DEEP PROBE</title>
    <style>
        :root { --bg-color: #000000; --text-primary: #FF0000; }
        body { background-color: var(--bg-color); color: var(--text-primary); font-family: monospace; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        
        #lobby { width: 100%; max-width: 400px; text-align: center; }
        button {
            background: #222; color: white; border: 1px solid #555;
            padding: 15px; font-size: 1rem; font-weight: bold; cursor: pointer; width: 100%;
            margin-bottom: 15px; border-radius: 5px;
        }
        #console {
            background: #111; color: #888; padding: 10px; width: 100%; height: 200px; 
            overflow-y: auto; border: 1px solid #333; font-size: 0.8rem; text-align: left;
            margin-top: 20px; white-space: pre-wrap;
        }
        #cockpit { display: none; width: 100%; flex-direction: column; align-items: center; }
        .huge { font-size: 2rem; font-weight: 900; margin: 20px 0; word-break: break-all; }
    </style>
</head>
<body>

    <div id="lobby">
        <h1>V9 DEEP PROBE</h1>
        <button id="btnScan">START DIAGNOSTIC SCAN</button>
        <div id="console">Ready...</div>
    </div>

    <div id="cockpit">
        <h1>CONNECTED</h1>
        <div class="huge" id="hexDisplay">WAITING FOR STROKES...</div>
        <p>Take screenshot when numbers change</p>
    </div>

    <script>
        const btnScan = document.getElementById('btnScan');
        const consoleLog = document.getElementById('console');
        
        // STANDARD C2 UUIDs
        const C2_SERVICE = 'ce060000-43e5-11e4-916c-0800200c9a66';
        const C2_CHAR    = 'ce060031-43e5-11e4-916c-0800200c9a66';
        
        // COMMON SERVICES (To keep the connection pipe open)
        const DEVICE_INFO = 0x180A;
        const HR_SERVICE  = 0x180D;

        function log(msg) {
            consoleLog.innerHTML = "> " + msg + "\n" + consoleLog.innerHTML;
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        btnScan.addEventListener('click', async () => {
            try {
                log("1. Requesting Device...");
                
                // WIDE NET CONFIGURATION
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'PM5' }],
                    optionalServices: [C2_SERVICE, DEVICE_INFO, HR_SERVICE]
                });

                log(`2. Found: ${device.name}`);
                log("3. Connecting...");
                
                const server = await device.gatt.connect();
                log("4. CONNECTED. PAUSING 2s (Stabilizing)...");
                
                // CRITICAL PAUSE FOR PM5
                await delay(2000);

                log("5. Enumerating Services...");
                const services = await server.getPrimaryServices();
                
                let targetService = null;

                for (const s of services) {
                    log(`   - Found Service: ${s.uuid}`);
                    if (s.uuid === C2_SERVICE || s.uuid.startsWith('ce060000')) {
                        targetService = s;
                        log("   *** MATCH FOUND! ***");
                    }
                }

                if (!targetService) {
                    throw new Error("Connected, but C2 Service (ce06...) not found in list.");
                }

                log("6. Getting Characteristic...");
                const characteristic = await targetService.getCharacteristic(C2_CHAR);
                
                log("7. Starting Stream...");
                await characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', handleData);
                
                document.getElementById('lobby').style.display = 'none';
                document.getElementById('cockpit').style.display = 'flex';

            } catch (error) {
                log(`FAIL: ${error.message}`);
                log("DEBUG: " + JSON.stringify(error));
            }
        });

        function handleData(event) {
            const value = event.target.value;
            let hexStr = Array.from(new Uint8Array(value.buffer))
                .map(b => b.toString(16).padStart(2,'0').toUpperCase())
                .join(' ');
            document.getElementById('hexDisplay').innerText = hexStr;
        }
    </script>
</body>
</html>

