<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Analyst AI - V4.1 Backup (Clean)</title>
    <style>
        :root { --bg-color: #000000; --text-primary: #FF0000; --text-secondary: #FF6666; }
        body { background-color: var(--bg-color); color: var(--text-primary); font-family: 'Roboto', 'Inter', sans-serif; margin: 0; overflow: hidden; width: 100vw; height: 100vh; position: fixed; }
        
        /* LOBBY */
        #lobby-screen { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; width: 100%; z-index: 100; background: #000; text-align: center; }
        .lobby-btn { background: #333; color: #888; border: none; padding: 20px 40px; font-size: 24px; font-weight: 900; border-radius: 8px; margin-top: 30px; cursor: not-allowed; transition: all 0.3s; }
        .lobby-btn.ready { background: var(--text-primary); color: black; cursor: pointer; }

        /* COCKPIT */
        #cockpit-container { display: none; width: 100vw; height: 100vh; background: black; }
        .force-landscape-mode { 
            display: grid !important; 
            transform: rotate(90deg); transform-origin: bottom left; 
            width: 100vh !important; height: 100vw !important; 
            position: absolute; top: -100vw; left: 0; 
            grid-template-columns: 1fr 1fr 1fr; grid-template-rows: 15% 60% 20% 5%; 
        }

        .header { grid-column: 1 / span 3; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; border-bottom: 1px solid #333; }
        .data-box { display: flex; flex-direction: column; justify-content: center; align-items: center; border-right: 1px solid #222; }
        .label { font-size: 1.5vh; color: var(--text-secondary); letter-spacing: 1px; }
        .huge-number { font-size: 18vh; font-weight: 900; line-height: 0.9; }
        .big-number { font-size: 8vh; font-weight: 900; }
        
        .debug-footer { grid-column: 1 / span 3; background: #220000; color: #FF9999; font-family: monospace; font-size: 1.5vh; display: flex; align-items: center; padding-left: 10px; border-top: 1px solid red; overflow: hidden; white-space: nowrap; }
        #connectBtnSmall { background: #333; color: white; border: 1px solid #555; padding: 5px 15px; border-radius: 4px; font-weight: bold; }
    </style>
</head>
<body>
    <div id="lobby-screen">
        <h1 style="font-size: 40px; margin-bottom: 10px;">BACKUP SYSTEM</h1>
        <p style="color: #666; margin-bottom: 40px;">V4.1 CLEAN MODE</p>
        <button id="startBtn" class="lobby-btn">LOADING...</button>
        <div style="margin-top: 20px; font-size: 12px; color: #444;">TAP TO ROTATE & CONNECT</div>
    </div>

    <div id="cockpit-container">
        <div class="header">
            <div style="font-size:2vh; color:#666;">BACKUP <span style="color:var(--text-primary)">ACTIVE</span></div>
            <div>PM5: <span id="btStatus" style="color:#555">‚óè</span> <button id="connectBtnSmall">CONNECT</button></div>
        </div>

        <div class="data-box">
            <div class="huge-number" id="splitDisplay">0:00</div>
            <div class="label">/500M PACE</div>
        </div>

        <div class="data-box">
            <div class="big-number" id="wattsDisplay">0</div>
            <div class="label">WATTS</div>
            <div style="height:2vh;"></div>
            <div class="big-number" id="rateDisplay">0</div>
            <div class="label">STROKE RATE</div>
        </div>

        <div class="data-box">
            <div class="big-number" id="hrDisplay">--</div>
            <div class="label">HEART RATE (PM5)</div>
        </div>

        <div class="debug-footer" id="debugConsole">RAW HEX: Waiting for stroke...</div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const startBtn = document.getElementById('startBtn');
        const connectBtn = document.getElementById('connectBtnSmall');
        
        setTimeout(() => { startBtn.innerText = "START BACKUP SESSION"; startBtn.classList.add('ready'); startBtn.disabled = false; }, 500);
        
        startBtn.addEventListener('click', () => {
            document.getElementById('lobby-screen').style.display = 'none'; 
            const cockpit = document.getElementById('cockpit-container'); 
            cockpit.style.display = 'grid'; 
            cockpit.classList.add('force-landscape-mode');
        });
        
        const PM5_SERVICE = 'ce060000-43e5-11e4-916c-0800200c9a66';
        const ROWING_STATUS = 'ce060031-43e5-11e4-916c-0800200c9a66';

        function handleData(event) {
            const value = event.target.value;
            const data = new DataView(value.buffer);
            
            // 1. CAPTURE HEX (The Mission)
            let hexStr = Array.from(new Uint8Array(value.buffer))
                .map(b => b.toString(16).padStart(2,'0').toUpperCase())
                .join(' ');
            document.getElementById('debugConsole').innerText = "RAW HEX: " + hexStr;

            // 2. BASIC PARSE
            let realRate = 0;
            if (data.byteLength >= 9) { realRate = data.getUint8(8); }
            
            // ESTIMATION MATH (Fallback)
            let estimatedWatts = 0; let estimatedPace = 0;
            if (realRate > 15) { 
                estimatedWatts = 150 + ((realRate - 18) * 9); 
                let paceSeconds = 500 * (2.8 / Math.pow(estimatedWatts, 0.333)); 
                estimatedPace = Math.floor(paceSeconds); 
            }

            document.getElementById('rateDisplay').innerText = realRate;
            if (realRate > 0) { 
                document.getElementById('wattsDisplay').innerText = Math.floor(estimatedWatts); 
                let mins = Math.floor(estimatedPace / 60); 
                let secs = Math.floor(estimatedPace % 60); 
                document.getElementById('splitDisplay').innerText = mins + ":" + (secs < 10 ? "0" : "") + secs; 
            }
        }

        connectBtn.addEventListener('click', async () => {
            try {
                connectBtn.innerText = "SEARCHING...";
                
                // --- TARGETED FILTER (Valid Backup Strategy) ---
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [PM5_SERVICE] }]
                });

                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(PM5_SERVICE);
                const characteristic = await service.getCharacteristic(ROWING_STATUS);
                
                await characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', handleData);
                
                document.getElementById('btStatus').style.color = "#00FF00";
                connectBtn.style.display = 'none';
            } catch (error) {
                console.log(error);
                alert("BACKUP FAILED: " + error);
                connectBtn.innerText = "RETRY";
            }
        });
        
        // FAKE HEART RATE SIMULATION REMOVED
    });
    </script>
</body>
</html>
