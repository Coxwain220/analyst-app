<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Analyst - Conversational Core</title>
    <style>
        :root { --bg: #000000; --ai-bubble: #222; --user-bubble: #00FF00; --text: #FFF; --dim: #666; }
        body { background-color: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* HEADER */
        .header { padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.9); z-index: 10; }
        .header-title { font-weight: 800; letter-spacing: 1px; font-size: 14px; }
        .status-dot { height: 8px; width: 8px; background-color: var(--user-bubble); border-radius: 50%; display: inline-block; box-shadow: 0 0 5px var(--user-bubble); }

        /* CHAT AREA */
        #chat-window { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
        
        .message { max-width: 80%; padding: 12px 16px; border-radius: 18px; font-size: 15px; line-height: 1.4; position: relative; animation: popIn 0.3s ease-out; }
        .message.ai { align-self: flex-start; background-color: var(--ai-bubble); color: #ddd; border-bottom-left-radius: 4px; }
        .message.user { align-self: flex-end; background-color: var(--user-bubble); color: #000; font-weight: 500; border-bottom-right-radius: 4px; }
        .message.system { align-self: center; background: none; color: var(--dim); font-size: 12px; font-style: italic; padding: 5px; border-radius: 0; }

        @keyframes popIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* INPUT AREA */
        .input-deck { padding: 15px; background: #111; border-top: 1px solid #333; display: flex; gap: 10px; }
        input { flex-grow: 1; background: #222; border: none; padding: 12px 15px; border-radius: 25px; color: white; font-size: 16px; outline: none; }
        button { background: var(--user-bubble); color: black; border: none; width: 45px; height: 45px; border-radius: 50%; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        /* TYPING INDICATOR */
        .typing { display: none; align-self: flex-start; margin-left: 10px; margin-bottom: 10px; }
        .dot { height: 6px; width: 6px; background: #555; border-radius: 50%; display: inline-block; animation: wave 1.3s linear infinite; }
        .dot:nth-child(2) { animation-delay: -1.1s; }
        .dot:nth-child(3) { animation-delay: -0.9s; }
        @keyframes wave { 0%, 60%, 100% { transform: initial; } 30% { transform: translateY(-5px); } }

    </style>
</head>
<body>

    <div class="header">
        <div class="header-title">ANALYST <span style="color:#666">CORE</span></div>
        <div class="status-dot"></div>
    </div>

    <div id="chat-window">
        </div>

    <div class="typing" id="typingIndicator">
        <div class="dot"></div><div class="dot"></div><div class="dot"></div>
    </div>

    <div class="input-deck">
        <input type="text" id="userInput" placeholder="Message Analyst..." autocomplete="off">
        <button id="sendBtn">↑</button>
    </div>

    <script>
        // --- DATA STRUCTURE ---
        // We store the "Physics" data in 'profile' (hard numbers)
        // We store the "Context" data in 'transcript' (soft conversation for AI)
        const db = {
            profile: { name: null, weight: null, age: null },
            transcript: [], // Stores full conversation history
            metadata: { created: new Date().toISOString() }
        };

        // --- CONVERSATION FLOW ---
        // A simple state machine that feels conversational
        const SCRIPT = [
            { 
                id: 'intro', 
                text: "Hello. I am the Analyst Core. I'm here to learn about you—not just your stats, but your lifestyle and goals. Let's start simply: What should I call you?", 
                extract: 'name' 
            },
            { 
                id: 'weight', 
                text: "Nice to meet you, {name}. To calibrate the physics engine for the rower, I need your approximate weight (in kg).", 
                extract: 'weight_parser' 
            },
            { 
                id: 'context_1', 
                text: "Got it. {weight}kg locked in. Now, tell me about your training history. Are you an athlete? A beginner? Recovering from injury?", 
                extract: 'transcript_only' 
            },
            { 
                id: 'context_2', 
                text: "Understood. And what does your typical week look like regarding stress and sleep? (This helps me adjust intensity).", 
                extract: 'transcript_only' 
            },
            { 
                id: 'finish', 
                text: "I have stored this dossier. I will use your weight for the physics calculations, and your history to guide our sessions. Ready to initialize the Flight Deck?", 
                extract: 'confirmation' 
            }
        ];

        let step = 0;

        // --- DOM ---
        const chat = document.getElementById('chat-window');
        const input = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const typing = document.getElementById('typingIndicator');

        // --- INIT ---
        window.onload = () => {
            // Check if profile exists? (Optional: Load name)
            triggerAI();
        };

        // --- LOGIC ---
        sendBtn.addEventListener('click', handleUserSend);
        input.addEventListener('keypress', (e) => { if(e.key === 'Enter') handleUserSend(); });

        async function handleUserSend() {
            const text = input.value.trim();
            if (!text) return;

            // 1. UI: Show User Message
            addMessage(text, 'user');
            input.value = "";
            input.focus();

            // 2. Data: Save to Transcript
            db.transcript.push({ sender: 'user', text: text, timestamp: new Date() });

            // 3. Logic: Extract Data based on current step
            const currentStep = SCRIPT[step];
            
            // EXTRACTION LOGIC
            if (currentStep.extract === 'name') {
                db.profile.name = text; 
            }
            else if (currentStep.extract === 'weight_parser') {
                // Soft Parser: Find the number in the sentence
                const num = text.match(/\d+/); 
                if (num) {
                    db.profile.weight = parseInt(num[0]);
                } else {
                    // Fallback if no number found
                    addMessage("I didn't catch a number there. Just type the digits (e.g., 85).", 'ai');
                    return; // Don't advance step
                }
            }
            else if (currentStep.extract === 'confirmation') {
                saveAndLaunch();
                return;
            }

            // 4. Advance
            step++;
            if (step < SCRIPT.length) {
                await wait(600); // Simulate thinking
                triggerAI();
            }
        }

        async function triggerAI() {
            showTyping(true);
            
            // Simulate processing time based on text length
            await wait(1000); 

            const currentStep = SCRIPT[step];
            let msg = currentStep.text;

            // Dynamic Replacement (inject name/weight into text)
            if (db.profile.name) msg = msg.replace("{name}", db.profile.name);
            if (db.profile.weight) msg = msg.replace("{weight}", db.profile.weight);

            showTyping(false);
            addMessage(msg, 'ai');

            // Save AI message to transcript too
            db.transcript.push({ sender: 'ai', text: msg, timestamp: new Date() });
            
            // Speak it (Voice First)
            speak(msg);
        }

        function saveAndLaunch() {
            // Save to LocalStorage
            localStorage.setItem('analyst_db', JSON.stringify(db));
            
            // Compatibility for V1 Dashboard (needs simple profile)
            localStorage.setItem('analyst_profile', JSON.stringify({
                name: db.profile.name,
                weight: db.profile.weight
            }));

            addMessage("System Initialized. Launching...", 'system');
            
            setTimeout(() => {
                window.location.href = 'v1.html';
            }, 1500);
        }

        // --- UI UTILITIES ---
        function addMessage(text, type) {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.innerText = text;
            chat.appendChild(div);
            // Auto scroll to bottom
            setTimeout(() => chat.scrollTop = chat.scrollHeight, 50);
        }

        function showTyping(show) {
            typing.style.display = show ? 'block' : 'none';
            if(show) chat.scrollTop = chat.scrollHeight;
        }

        function wait(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // --- VOICE ENGINE ---
        function speak(text) {
            if ('speechSynthesis' in window) {
                // Cancel previous
                window.speechSynthesis.cancel();

                const utt = new SpeechSynthesisUtterance(text);
                utt.rate = 1.0;
                
                // Try to find a good voice
                const voices = window.speechSynthesis.getVoices();
                const aiVoice = voices.find(v => v.lang.includes('en') && (v.name.includes('Samantha') || v.name.includes('Google')));
                if (aiVoice) utt.voice = aiVoice;

                window.speechSynthesis.speak(utt);
            }
        }
    </script>
</body>
</html>
