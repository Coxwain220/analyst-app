<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ANALYST V9.1 (CONVERGENCE)</title>
    <style>
        :root { --bg: #050505; --text: #e0e0e0; --accent: #00FF99; --warn: #FFD700; --danger: #FF4444; --rest: #00AAFF; --panel: #121212; --border: #2a2a2a; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); font-family: 'Roboto', system-ui, sans-serif; margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }

        /* TOAST */
        #toast { position: fixed; top: -60px; left: 50%; transform: translateX(-50%); background: #222; color: #fff; border: 1px solid #444; padding: 12px 24px; border-radius: 30px; z-index: 3000; font-size: 13px; font-weight: bold; transition: top 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); display:flex; align-items:center; gap:10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #toast.active { top: 20px; }
        #toast.success { border-color: var(--accent); color: var(--accent); }
        #toast.error { border-color: var(--danger); color: var(--danger); }

        /* LAYOUT */
        .screen { display: none; flex-grow: 1; flex-direction: column; overflow: hidden; height: 100%; }
        .screen.active { display: flex; }
        .scroll-area { flex-grow: 1; overflow-y: auto; padding: 15px; padding-bottom: 90px; }
        .screen-header { display: flex; align-items: center; padding: 15px; background: var(--panel); border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .header-title { flex-grow: 1; text-align: center; font-weight: 800; font-size: 14px; letter-spacing: 1.5px; color: #888; text-transform: uppercase; }
        .header-btn { background: transparent; border: 1px solid #333; color: var(--accent); font-weight: bold; font-size: 11px; cursor: pointer; padding: 6px 12px; border-radius: 4px; }

        /* UI ELEMENTS */
        .card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 15px; margin-bottom: 15px; }
        .section-header { color: var(--accent); font-size: 11px; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 12px; border-bottom: 1px solid #333; padding-bottom: 6px; font-weight: 700; display:flex; justify-content:space-between; }
        
        .btn { width: 100%; padding: 14px; border-radius: 8px; font-weight: bold; cursor: pointer; border: none; text-transform: uppercase; font-size: 13px; margin-top: 8px; display: flex; align-items: center; justify-content: center; gap:8px; transition: 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-green { background: var(--accent); color: #000; }
        .btn-outline { background: transparent; border: 1px solid #444; color: #888; }
        .btn-blue { background: var(--rest); color: white; }
        .btn-danger { background: rgba(255,68,68,0.1); border: 1px solid var(--danger); color: var(--danger); }

        input, select { background: #080808; border: 1px solid #333; color: white; padding: 12px; border-radius: 6px; width: 100%; font-family: inherit; margin-bottom: 10px; font-size: 16px; }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        label { font-size: 10px; color: #666; font-weight: bold; display: block; margin-bottom: 4px; text-transform: uppercase; }

        /* TABS (MANUAL BUILDER) */
        .build-tabs { display: flex; background: #000; border-radius: 8px; padding: 4px; margin-bottom: 15px; border: 1px solid #333; }
        .b-tab { flex: 1; background: transparent; border: none; color: #666; padding: 10px; cursor: pointer; font-weight: bold; font-size: 12px; border-radius: 6px; }
        .b-tab.active { background: #222; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }

        /* SETTINGS MENU ITEMS (RESTORED) */
        .settings-menu-btn { width: 100%; text-align: left; padding: 18px 10px; border-bottom: 1px solid #222; background: transparent; color: white; font-size:14px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .settings-menu-btn:hover { background: #151515; }
        .settings-menu-btn:after { content: '‚Ä∫'; color: #666; font-size: 20px; font-weight: bold; }
        .settings-icon { margin-right: 10px; width: 20px; text-align: center; display: inline-block; }
        .settings-section { display: none; }
        .settings-section.active { display: block; animation: slideIn 0.2s; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

        /* TIMELINE STEPS */
        .step-card { background: #181818; border: 1px solid #333; border-left: 4px solid #444; border-radius: 6px; padding: 12px; display: grid; grid-template-columns: 30px 1fr auto; align-items: center; gap: 12px; margin-bottom: 8px; }
        .type-work { border-left-color: var(--accent); }
        .type-rest { border-left-color: var(--rest); }
        .step-main { font-weight: bold; font-size: 15px; color: #fff; }
        .step-tags { display: flex; gap: 5px; margin-top: 4px; flex-wrap: wrap; }
        .tag { font-size: 9px; background: #222; padding: 2px 6px; border-radius: 4px; color: #aaa; border: 1px solid #333; }
        
        /* LOGS */
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 16px; border-bottom: 1px solid #222; cursor: pointer; background: #111; }
        .h-date { font-size: 10px; color: #666; font-weight: bold; margin-bottom: 2px; }
        .h-title { font-size: 14px; font-weight: bold; color: #fff; }
        .h-stats { font-family: monospace; color: var(--accent); font-size: 13px; }

        /* DASHBOARD */
        .dash-grid { display: grid; grid-template-rows: 1fr 1fr; height: 100%; }
        .metric-huge { font-size: 16vh; font-weight: 900; line-height: 0.9; letter-spacing: -4px; color:white; text-align: center; }
        .stat-box { display: flex; flex-direction: column; align-items: center; justify-content: center; background: #111; border: 1px solid #222; margin: 5px; border-radius: 12px; }
        
        /* NAV BAR */
        .nav-bar { display: flex; background: var(--panel); border-top: 1px solid var(--border); height: 65px; flex-shrink: 0; z-index: 100; padding-bottom: env(safe-area-inset-bottom); }
        .nav-btn { flex: 1; background: transparent; border: none; color: #666; font-size: 10px; font-weight: bold; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .nav-btn.active { color: var(--accent); background: #1a1a1a; }
        .nav-icon { font-size: 20px; margin-bottom: 4px; }

        /* ADVANCED TOGGLES */
        .toggle-section { border: 1px solid #333; border-radius: 8px; padding: 10px; margin-bottom: 10px; background: #0a0a0a; }
        .toggle-head { display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-size: 12px; font-weight: bold; color: #aaa; }
        .toggle-body { display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid #222; }
        .toggle-body.open { display: block; }
    </style>
</head>
<body>

    <div id="toast"><span>Notification</span></div>

    <div id="screenBuilder" class="screen active">
        <div class="screen-header">
            <div class="header-title">MISSION CONTROL</div>
            <button class="header-btn" onclick="connectBluetooth()" id="btConnectBtn">CONNECT PM5</button>
        </div>
        <div class="scroll-area">
            
            <div class="card" id="aiCard">
                <div class="section-header">AI COMMANDER</div>
                <textarea id="aiInput" rows="2" placeholder="e.g. 4x500m @ 1:45, 2min rest..."></textarea>
                <button class="btn btn-outline" id="btnGen" onclick="generateMission()">GENERATE PLAN</button>
            </div>

            <div class="card" id="manualCard">
                <div class="section-header">MANUAL ARCHITECT</div>
                
                <div class="build-tabs">
                    <button class="b-tab active" onclick="setBuildMode('DIST')">DIST</button>
                    <button class="b-tab" onclick="setBuildMode('TIME')">TIME</button>
                    <button class="b-tab" onclick="setBuildMode('CAL')">CAL</button>
                    <button class="b-tab" onclick="setBuildMode('INT')">INT</button>
                </div>

                <div id="inputArea">
                    <div id="modeDist">
                        <div class="input-grid">
                            <div><label>DISTANCE (M)</label><input type="number" id="mDist" value="2000"></div>
                            <div><label>SPLIT LEN (M)</label><input type="number" id="mSplitDist" value="500"></div>
                        </div>
                    </div>
                    <div id="modeTime" style="display:none;">
                        <div class="input-grid">
                            <div><label>TIME (MIN)</label><input type="number" id="mTime" value="30"></div>
                            <div><label>SPLIT TIME (MIN)</label><input type="number" id="mSplitTime" value="5"></div>
                        </div>
                    </div>
                    <div id="modeCal" style="display:none;">
                        <div class="input-grid">
                            <div><label>CALORIES</label><input type="number" id="mCal" value="300"></div>
                            <div><label>SPLIT CAL</label><input type="number" id="mSplitCal" value="50"></div>
                        </div>
                    </div>
                    <div id="modeInt" style="display:none;">
                        <label>INTERVAL TYPE</label>
                        <select id="mIntType" onchange="updateIntInput()">
                            <option value="DIST">Distance</option>
                            <option value="TIME">Time</option>
                        </select>
                        <div class="input-grid">
                            <div id="intValBox"><label>WORK DIST (M)</label><input type="number" id="mIntVal" value="500"></div>
                            <div><label>REST (SEC)</label><input type="number" id="mIntRest" value="60"></div>
                        </div>
                        <label>REPEATS</label><input type="number" id="mIntReps" value="4">
                    </div>
                </div>

                <div class="toggle-section">
                    <div class="toggle-head" onclick="toggleAdv('advPacer')"><span>+ PACER</span> <span id="lblPacer">OFF</span></div>
                    <div class="toggle-body" id="advPacer">
                        <div class="input-grid">
                            <div><label>TYPE</label><select id="mPacerType"><option value="PACE">Pace /500</option><option value="WATTS">Watts</option></select></div>
                            <div><label>TARGET</label><input type="text" id="mPacerVal" placeholder="1:55 or 200"></div>
                        </div>
                    </div>
                </div>

                <div class="toggle-section">
                    <div class="toggle-head" onclick="toggleAdv('advTgt')"><span>+ TARGETS</span> <span id="lblTgt">OFF</span></div>
                    <div class="toggle-body" id="advTgt">
                        <div class="input-grid">
                            <div><label>STROKE RATE (s/m)</label><input type="number" id="mTgtRate" placeholder="24"></div>
                            <div><label>HR ZONE (1-5)</label><input type="number" id="mTgtHR" placeholder="3"></div>
                        </div>
                    </div>
                </div>

                <button class="btn btn-green" onclick="addToPlan()">+ ADD TO PLAN</button>
            </div>

            <div class="section-header">FLIGHT PLAN</div>
            <div id="builderList"></div>
            
            <div style="height:20px;"></div>
            <button class="btn btn-green" onclick="goToStrategy()">ANALYZE & STRATEGIZE ‚Üí</button>
        </div>
    </div>

    <div id="screenHistory" class="screen">
        <div class="screen-header">
            <div class="header-title">LOGBOOK</div>
            <button class="header-btn" onclick="exportHistory()">EXPORT CSV</button>
        </div>
        <div class="scroll-area" id="historyList"></div>
    </div>

    <div id="screenStrategy" class="screen">
        <div class="screen-header"><button class="header-btn" onclick="nav('screenBuilder')">‚Üê BACK</button><div class="header-title">STRATEGY</div><div style="width:40px;"></div></div>
        <div class="scroll-area">
            <div class="card">
                <div class="section-header">MISSION BRIEF</div>
                <div id="stratSummary" style="font-size:16px; color:white;"></div>
            </div>
            <div class="card"><div class="section-header">HISTORICAL CONTEXT</div><div id="matchContent" style="color:#ccc; font-size:13px;"></div></div>
            <div class="card">
                <div class="section-header">COACH</div>
                <div id="coachChat" style="background:#080808; padding:10px; border-radius:6px; height:100px; overflow-y:auto; color:#ccc; font-size:13px;"></div>
                <div style="display:flex; margin-top:10px; gap:10px;"><input type="text" id="coachIn" placeholder="Ask..."><button class="btn btn-outline" onclick="askCoach()">ASK</button></div>
            </div>
            <button class="btn btn-green" onclick="startMission(false)">START ROW</button>
        </div>
    </div>

    <div id="dashScreen" class="screen">
        <div class="main-deck">
            <div style="font-size:14px; color:#888; font-weight:bold; letter-spacing:1px;" id="phaseBadge">WARMUP</div>
            <div class="metric-huge" id="dispPace">0:00</div>
            <div class="metric-sub"><span id="dispWatts">0</span>W <span style="color:#444">|</span> <span id="dispDist">0</span>m</div>
            <div style="color:var(--accent); font-size:14px; margin-top:5px;" id="tgtDisplay"></div>
        </div>
        <div class="lower-deck">
            <div class="stat-box"><div style="font-size:40px; color:white;" id="dispRate">0</div><div style="font-size:10px; color:#666;">s/m</div></div>
            <div class="stat-box"><div style="font-size:40px; color:white;" id="dispHR">--</div><div style="font-size:10px; color:#666;">HR</div></div>
        </div>
        <button class="btn btn-outline" style="margin:20px;" onclick="endMission()">FINISH</button>
    </div>

    <div id="screenSettings" class="screen">
        <div class="screen-header"><div class="header-title">SETTINGS</div></div>
        <div class="scroll-area">
            <div id="settingsMenu">
                <button class="settings-menu-btn" onclick="openSetting('setAccount')"><span class="settings-icon">üë§</span> PROFILE & ACCOUNT</button>
                <button class="settings-menu-btn" onclick="openSetting('setZones')"><span class="settings-icon">‚ù§Ô∏è</span> TRAINING ZONES</button>
                <button class="settings-menu-btn" onclick="openSetting('setPrefs')"><span class="settings-icon">‚öôÔ∏è</span> APP PREFERENCES</button>
                <button class="settings-menu-btn" onclick="openSetting('setIntegrations')"><span class="settings-icon">üîó</span> INTEGRATIONS</button>
                <button class="settings-menu-btn" onclick="openSetting('setData')"><span class="settings-icon">üíæ</span> DATA & SYSTEM</button>
                <button class="settings-menu-btn" onclick="openSetting('setAbout')"><span class="settings-icon">‚ÑπÔ∏è</span> ABOUT</button>
            </div>

            <div id="setAccount" class="settings-section">
                <div class="card">
                    <div class="section-header">BIO-DATA</div>
                    <div class="input-grid">
                        <div><label>AGE</label><input type="number" id="bioAge"></div>
                        <div><label>WEIGHT (KG)</label><input type="number" id="bioWeight"></div>
                    </div>
                    <label>CLASS</label><select id="bioClass"><option>Heavyweight</option><option>Lightweight</option></select>
                </div>
                <button class="btn btn-outline" onclick="closeSetting()">BACK</button>
            </div>

            <div id="setZones" class="settings-section">
                <div class="card">
                    <div class="section-header">HEART RATE ZONES (BPM)</div>
                    <div class="input-grid">
                        <div><label>Z5 (Max)</label><input type="number" id="hrZ5"></div>
                        <div><label>Z4 (Thresh)</label><input type="number" id="hrZ4"></div>
                        <div><label>Z3 (Aerobic)</label><input type="number" id="hrZ3"></div>
                        <div><label>Z2 (Endur)</label><input type="number" id="hrZ2"></div>
                        <div><label>Z1 (Recov)</label><input type="number" id="hrZ1"></div>
                    </div>
                </div>
                <button class="btn btn-green" onclick="saveSettings()">SAVE</button>
                <button class="btn btn-outline" onclick="closeSetting()">BACK</button>
            </div>

            <div id="setPrefs" class="settings-section">
                <div class="card">
                    <div class="section-header">DISPLAY</div>
                    <label>PRIMARY UNIT</label>
                    <select><option>Split (/500m)</option><option>Watts</option><option>Calories/Hr</option></select>
                    <label>THEME</label>
                    <select><option>Dark (Default)</option><option>High Contrast</option></select>
                </div>
                <button class="btn btn-green" onclick="saveSettings()">SAVE</button>
                <button class="btn btn-outline" onclick="closeSetting()">BACK</button>
            </div>

            <div id="setIntegrations" class="settings-section">
                <div class="card">
                    <div class="section-header">CONNECTIONS</div>
                    <button class="btn btn-outline" onclick="showToast('Feature Coming Soon')">üîó CONNECT CONCEPT2 LOGBOOK</button>
                    <button class="btn btn-outline" onclick="showToast('Feature Coming Soon')">üîó CONNECT STRAVA</button>
                </div>
                <button class="btn btn-outline" onclick="closeSetting()">BACK</button>
            </div>

            <div id="setData" class="settings-section">
                <div class="card">
                    <div class="section-header">SYSTEM</div>
                    <label>API KEY</label><input type="password" id="apiKeyInput" placeholder="Paste Key...">
                    <select id="modelSelect" style="margin-top:10px;"><option value="gemini-1.5-flash">Default</option></select>
                    <div class="input-grid" style="margin-top:10px;">
                        <button class="btn btn-outline" onclick="scanModels()">SCAN</button>
                        <button class="btn btn-green" onclick="testConnection()">TEST</button>
                    </div>
                </div>
                <div class="card">
                    <div class="section-header">DATA</div>
                    <input type="file" id="csvInput" accept=".csv" onchange="processCSV(this)">
                </div>
                <button class="btn btn-danger" onclick="clearData()">FACTORY RESET</button>
                <button class="btn btn-outline" onclick="closeSetting()">BACK</button>
            </div>

            <div id="setAbout" class="settings-section">
                <div class="card">
                    <div class="section-header">ABOUT</div>
                    <div style="color:#888; font-size:14px;">ANALYST V9.1 (CONVERGENCE)</div>
                </div>
                <button class="btn btn-outline" onclick="closeSetting()">BACK</button>
            </div>
        </div>
    </div>

    <div class="nav-bar">
        <button class="nav-btn active" onclick="nav('screenBuilder')" id="navBuild">BUILD</button>
        <button class="nav-btn" onclick="nav('dashScreen')" id="navDash">ROW</button>
        <button class="nav-btn" onclick="nav('screenHistory')" id="navHist">LOGS</button>
        <button class="nav-btn" onclick="nav('screenSettings')" id="navSet">SET</button>
    </div>

    <script>
        // --- DATA & STATE ---
        const PM5_SERVICE = 'ce060030-43e5-11e4-916c-0800200c9a66';
        const App = {
            mission: { intervals: [] },
            history: [],
            profile: { hrZones: { z1: 108, z5: 180 }, model: "gemini-1.5-flash", bio: { age: 41, weight: 85 } },
            state: { active: false, intervalIdx: 0, timeLeft: 0, distLeft: 0, log: [], simLoop: null }
        };

        // --- REAL HISTORY INJECTION ---
        const PRELOAD_HISTORY = [
            {id:110986164, date:"2026-01-10T09:47:00", desc:"3 x 2000m / 4:00r", w:228, p:"1:55.3", r:27, hr:174},
            {id:110898284, date:"2026-01-08T21:25:00", desc:"8 x 1:00 / 1:00r", w:227, p:"1:55.5", r:21, hr:152},
            {id:110897422, date:"2026-01-08T21:06:00", desc:"4 x 5min / 1:00r", w:163, p:"2:09.0", r:25, hr:142},
            {id:110594382, date:"2026-01-05T18:46:00", desc:"4 x 1500m / 4:00r", w:233, p:"1:54.4", r:27, hr:176},
            {id:110594383, date:"2026-01-03T09:52:00", desc:"4 x 1500m / 4:00r", w:228, p:"1:55.3", r:26, hr:174},
            {id:106289732, date:"2025-12-08T18:10:00", desc:"2000m Test", w:256, p:"1:51.0", r:27, hr:0},
            {id:106210517, date:"2025-11-24T18:36:00", desc:"3 x 2000m / 6:00r", w:197, p:"2:01.1", r:24, hr:0},
            {id:106100176, date:"2025-09-08T18:33:00", desc:"6 x 1000m / 3:00r", w:242, p:"1:53.0", r:28, hr:0}
        ];

        window.onload = () => {
            if(!localStorage.getItem('analyst_history')) {
                // First load or reset: inject hardcoded data
                App.history = PRELOAD_HISTORY.map(h => ({
                    id: h.id, date: h.date, desc: h.desc,
                    stats: { avgWatts: h.w, avgRate: h.r, avgHR: h.hr, pace: h.p }
                }));
                localStorage.setItem('analyst_history', JSON.stringify(App.history));
            } else {
                // Check if history is just the old dummy data
                let stored = JSON.parse(localStorage.getItem('analyst_history'));
                if(stored.length < 2 && stored[0].desc === "Example Row") {
                    // It's dummy data, overwrite it
                    App.history = PRELOAD_HISTORY.map(h => ({
                        id: h.id, date: h.date, desc: h.desc,
                        stats: { avgWatts: h.w, avgRate: h.r, avgHR: h.hr, pace: h.p }
                    }));
                    localStorage.setItem('analyst_history', JSON.stringify(App.history));
                } else {
                    App.history = stored;
                }
            }
            // Load Profile
            const p = localStorage.getItem('analyst_profile');
            if(p) App.profile = JSON.parse(p);
            
            // Populate Inputs
            document.getElementById('hrZ5').value = App.profile.hrZones.z5;
            document.getElementById('hrZ4').value = App.profile.hrZones.z4 || 162;
            document.getElementById('hrZ3').value = App.profile.hrZones.z3 || 144;
            document.getElementById('hrZ2').value = App.profile.hrZones.z2 || 125;
            document.getElementById('hrZ1').value = App.profile.hrZones.z1;
            document.getElementById('bioAge').value = App.profile.bio.age;
            document.getElementById('bioWeight').value = App.profile.bio.weight;
            
            if(localStorage.getItem('gemini_api_key')) document.getElementById('apiKeyInput').value = localStorage.getItem('gemini_api_key');
            
            renderHistory();
            renderTimeline();
        };

        // --- MANUAL BUILDER LOGIC ---
        let BUILD_MODE = 'DIST';

        function setBuildMode(mode) {
            BUILD_MODE = mode;
            document.querySelectorAll('.b-tab').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            ['modeDist','modeTime','modeCal','modeInt'].forEach(d => document.getElementById(d).style.display = 'none');
            
            if(mode === 'DIST') document.getElementById('modeDist').style.display = 'block';
            if(mode === 'TIME') document.getElementById('modeTime').style.display = 'block';
            if(mode === 'CAL') document.getElementById('modeCal').style.display = 'block';
            if(mode === 'INT') document.getElementById('modeInt').style.display = 'block';
        }

        function toggleAdv(id) {
            const el = document.getElementById(id);
            el.classList.toggle('open');
            const isOn = el.classList.contains('open');
            document.getElementById(id==='advPacer'?'lblPacer':'lblTgt').innerText = isOn ? "ON" : "OFF";
            document.getElementById(id==='advPacer'?'lblPacer':'lblTgt').style.color = isOn ? "var(--accent)" : "#666";
        }

        function updateIntInput() {
            const type = document.getElementById('mIntType').value;
            document.getElementById('intValBox').innerHTML = type==='DIST' ? 
                `<label>WORK DIST (M)</label><input type="number" id="mIntVal" value="500">` : 
                `<label>WORK TIME (MIN)</label><input type="number" id="mIntVal" value="1">`;
        }

        function addToPlan() {
            // Harvest Data based on mode
            let steps = [];
            let pacer = null, sr = 0, hr = 0;

            // Get Targets
            if(document.getElementById('advPacer').classList.contains('open')) {
                const val = document.getElementById('mPacerVal').value;
                if(val) pacer = { type: document.getElementById('mPacerType').value, val: val };
            }
            if(document.getElementById('advTgt').classList.contains('open')) {
                sr = parseInt(document.getElementById('mTgtRate').value) || 0;
                hr = parseInt(document.getElementById('mTgtHR').value) || 0;
            }

            // Create Interval Object
            const createStep = (type, d, t, c) => ({ type, dist:d||0, duration:t||0, cals:c||0, pacer, rate:sr, hrZone:hr });

            if(BUILD_MODE === 'DIST') {
                const d = parseInt(document.getElementById('mDist').value);
                steps.push(createStep('WORK', d, 0, 0));
            } 
            else if(BUILD_MODE === 'TIME') {
                const t = parseFloat(document.getElementById('mTime').value) * 60;
                steps.push(createStep('WORK', 0, t, 0));
            }
            else if(BUILD_MODE === 'INT') {
                const reps = parseInt(document.getElementById('mIntReps').value);
                const rest = parseInt(document.getElementById('mIntRest').value);
                const intType = document.getElementById('mIntType').value;
                const val = parseInt(document.getElementById('mIntVal').value);
                
                for(let i=0; i<reps; i++) {
                    if(intType === 'DIST') steps.push(createStep('WORK', val, 0, 0));
                    else steps.push(createStep('WORK', 0, val*60, 0));
                    
                    if(i < reps-1 && rest > 0) steps.push({ type:'REST', duration:rest });
                }
            }

            // Add to Mission
            App.mission.intervals.push(...steps);
            renderTimeline();
            showToast("Added to Timeline", 'success');
        }

        function renderTimeline() {
            const list = document.getElementById('builderList');
            list.innerHTML = "";
            if(App.mission.intervals.length === 0) { list.innerHTML = `<div style="text-align:center;color:#666;font-size:12px;padding:20px;border:1px dashed #333;">PLAN EMPTY</div>`; return; }
            
            App.mission.intervals.forEach((s, i) => {
                let div = document.createElement('div');
                div.className = `step-card ${s.type==='WORK'?'type-work':'type-rest'}`;
                let desc = s.type;
                if(s.dist) desc += ` ${s.dist}m`;
                else if(s.duration) desc += ` ${formatTime(s.duration)}`;
                
                let tags = "";
                if(s.pacer) tags += `<span class="tag">${s.pacer.val} ${s.pacer.type}</span>`;
                if(s.rate) tags += `<span class="tag">SR${s.rate}</span>`;

                div.innerHTML = `<div class="step-main">${desc}</div><div class="step-tags">${tags}</div><div style="text-align:right;color:#666;" onclick="App.mission.intervals.splice(${i},1);renderTimeline()">√ó</div>`;
                list.appendChild(div);
            });
        }

        // --- SETTINGS LOGIC ---
        function openSetting(id) {
            document.getElementById('settingsMenu').style.display = 'none';
            document.getElementById(id).classList.add('active');
        }
        function closeSetting() {
            document.querySelectorAll('.settings-section').forEach(s => s.classList.remove('active'));
            document.getElementById('settingsMenu').style.display = 'block';
        }
        
        function processCSV(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const lines = e.target.result.split('\n');
                let added = 0;
                for (let i = 1; i < lines.length; i++) {
                    const cols = lines[i].split(',');
                    if (cols.length > 10) {
                        const sess = {
                            id: cols[0],
                            date: new Date(cols[1]).toISOString(),
                            desc: cols[2].replace(/"/g, ''),
                            stats: {
                                avgWatts: parseInt(cols[12]) || 0,
                                dist: parseInt(cols[7]) || 0,
                                avgRate: parseInt(cols[9]) || 0,
                                avgHR: parseInt(cols[15]) || 0,
                                pace: cols[11]
                            }
                        };
                        App.history.push(sess);
                        added++;
                    }
                }
                App.history.sort((a,b) => new Date(b.date) - new Date(a.date));
                localStorage.setItem('analyst_history', JSON.stringify(App.history));
                renderHistory();
                showToast(`Imported ${added} sessions`, 'success');
            };
            reader.readAsText(file);
        }

        // --- NAVIGATION & UTILS ---
        function nav(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if(id==='screenBuilder') document.getElementById('navBuild').classList.add('active');
            else if(id==='dashScreen') document.getElementById('navDash').classList.add('active');
            else if(id==='screenHistory') document.getElementById('navHist').classList.add('active');
            else if(id==='screenSettings') document.getElementById('navSet').classList.add('active');
        }

        function showToast(msg, type='success') {
            const t = document.getElementById('toast');
            t.innerText = (type==='success'?'‚úî ':'‚ö† ') + msg;
            t.className = type + ' active';
            setTimeout(()=>t.className='', 3000);
        }

        function formatTime(sec) {
            if(sec >= 99999) return "OPEN";
            let m = Math.floor(sec/60); let s = Math.floor(sec%60);
            return `${m}:${s.toString().padStart(2,'0')}`;
        }

        // --- AI ---
        async function generateMission() {
            const key = document.getElementById('apiKeyInput').value || localStorage.getItem('gemini_api_key');
            const model = App.profile.model || "gemini-1.5-flash";
            const input = document.getElementById('aiInput').value;
            const btn = document.getElementById('btnGen');
            
            if(!key || !input) return showToast("API Key Required", 'error');
            
            btn.innerText = "...";
            const PROMPT = `Parse workout: "${input}". Return JSON: { "intervals": [{ "type": "WORK"|"REST", "dist": 0, "duration": 0, "watts": 0, "rate": 0, "pacer": { "type": "PACE"|"WATTS", "val": "" } }] }. RULES: 1. "1:45" pace = pacer.val:"1:45", type:"PACE". 2. Time in seconds.`;

            try {
                const controller = new AbortController();
                setTimeout(() => controller.abort(), 45000); // 45s Timeout

                const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
                    method: "POST", headers: {"Content-Type":"application/json"},
                    body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: PROMPT }] }] }),
                    signal: controller.signal
                });
                
                const d = await r.json();
                if(!d.candidates) throw new Error("No AI response");
                const jsonText = d.candidates[0].content.parts[0].text.replace(/```json/g,'').replace(/```/g,'');
                const result = JSON.parse(jsonText.substring(jsonText.indexOf('{'), jsonText.lastIndexOf('}')+1));
                
                App.mission.intervals = result.intervals;
                renderTimeline();
                showToast("Plan Generated", 'success');
            } catch(e) { showToast(e.name === 'AbortError' ? "Timeout" : "Error: " + e.message, 'error'); }
            btn.innerText = "GENERATE PLAN";
        }

        // --- DASHBOARD ---
        function launchJustRow() { App.mission.intervals = [{ type:'WORK', duration:999999, dist:0 }]; startMission(false); }
        
        function startMission(isSim) {
            if(App.mission.intervals.length === 0) return showToast("Plan Empty", 'error');
            nav('dashScreen');
            App.state = { active: true, intervalIdx: 0, timeLeft: 0, distLeft: 0, log: [], simLoop: null, connected: App.state.connected };
            setupNextInterval();
            if(isSim) App.state.simLoop = setInterval(() => processTelemetry(2.5, 26, 150, 220), 500);
            else if(!App.state.connected) connectBluetooth();
        }

        function setupNextInterval() {
            if(App.state.intervalIdx >= App.mission.intervals.length) { endMission(); return; }
            const int = App.mission.intervals[App.state.intervalIdx];
            App.state.timeLeft = int.duration > 0 ? int.duration : 99999;
            App.state.distLeft = int.dist > 0 ? int.dist : 0;
            document.getElementById('phaseBadge').innerText = int.type;
            document.getElementById('intervalInfo').innerText = `${int.type} ${App.state.intervalIdx+1}/${App.mission.intervals.length}`;
            
            // Targets Display
            let tgt = "";
            if(int.pacer) tgt = `TGT: ${int.pacer.val}`;
            else if(int.watts) tgt = `TGT: ${int.watts}W`;
            document.getElementById('tgtDisplay').innerText = tgt;
            document.getElementById('tgtRate').innerText = int.rate ? `(${int.rate})` : "";
        }

        function processTelemetry(speed, rate, hr, watts) {
            if(watts > 0 && !App.state.active && !document.getElementById('dashScreen').classList.contains('active')) { launchJustRow(); return; }
            if(!App.state.active) return;
            const int = App.mission.intervals[App.state.intervalIdx];
            
            App.state.timeLeft -= 0.5;
            if(speed > 0.1 && App.state.distLeft > 0) App.state.distLeft -= (speed*0.5);
            
            if((int.dist > 0 && App.state.distLeft <= 0) || (int.duration > 0 && int.duration < 99999 && App.state.timeLeft <= 0)) {
                App.state.intervalIdx++; setupNextInterval(); return;
            }
            
            let pace = speed>0.1 ? 500/speed : 0;
            document.getElementById('dispPace').innerText = formatTime(pace);
            document.getElementById('dispWatts').innerText = watts;
            document.getElementById('dispRate').innerText = rate;
            document.getElementById('dispHR').innerText = hr < 255 ? hr : "--";
            document.getElementById('dispDist').innerText = Math.floor(App.state.distLeft > 0 ? App.state.distLeft : 0);
            
            if(int.type === 'WORK') App.state.log.push({ t: new Date().toISOString(), w:watts, h:hr, r:rate });
        }

        function endMission() {
            App.state.active = false; if(App.state.simLoop) clearInterval(App.state.simLoop);
            let sumW=0, c=0; App.state.log.forEach(l=>{sumW+=l.w;c++});
            const sess = {
                id: Date.now(), date: new Date().toISOString(), desc: "Rowing Session",
                stats: { avgWatts: c?Math.round(sumW/c):0, avgRate: 0, avgHR: 0, pace: "0:00" }
            };
            App.history.unshift(sess);
            localStorage.setItem('analyst_history', JSON.stringify(App.history));
            showToast("Saved"); nav('screenHistory'); renderHistory();
        }

        // --- STRATEGY ---
        function goToStrategy() {
            if(App.mission.intervals.length === 0) return showToast("Empty Plan", 'error');
            nav('screenStrategy');
            // History Match
            const json = JSON.stringify(App.mission.intervals);
            const match = App.history.find(h => (h.dist > 0 && json.includes(h.dist)) || h.desc.includes("2000"));
            document.getElementById('stratSummary').innerText = `${App.mission.intervals.length} Steps`;
            document.getElementById('matchContent').innerText = match ? `Similar: ${match.date.split('T')[0]} - ${match.desc} @ ${match.stats.pace}` : "No direct match found.";
            askCoach(true);
        }

        async function askCoach(auto) {
            const key = localStorage.getItem('gemini_api_key');
            if(!key) return;
            const chat = document.getElementById('coachChat');
            const q = auto ? "Tactical advice?" : document.getElementById('coachInput').value;
            chat.innerText += `\n> ${q}\n...`;
            
            const prompt = `Coach me for: ${JSON.stringify(App.mission.intervals)}. History: ${JSON.stringify(App.history.slice(0,3))}. Q: ${q}. Short answer.`;
            
            try {
                const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${App.profile.model}:generateContent?key=${key}`, {
                    method: "POST", headers: {"Content-Type":"application/json"},
                    body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: prompt }] }] })
                });
                const d = await r.json();
                chat.innerText = chat.innerText.replace("...", d.candidates[0].content.parts[0].text);
            } catch(e) { chat.innerText += "Error"; }
        }

        // --- HISTORY ---
        function renderHistory() {
            const list = document.getElementById('historyList'); 
            const frag = document.createDocumentFragment();
            list.innerHTML = "";
            App.history.forEach(h => {
                let d = document.createElement('div'); d.className = 'history-item';
                d.innerHTML = `<div><div class="h-date">${h.date.split('T')[0]}</div><div class="h-desc">${h.desc}</div></div><div class="h-stat">${h.stats.avgWatts}W</div>`;
                frag.appendChild(d);
            });
            list.appendChild(frag);
        }
        function exportHistory() {
            let csv = "Log ID,Date,Description,Avg Watts,Avg Pace\n";
            App.history.forEach(h => csv += `${h.id},${h.date},"${h.desc}",${h.stats.avgWatts},${h.stats.pace}\n`);
            const blob = new Blob([csv], { type: 'text/csv' }); const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'analyst_export.csv'; a.click();
        }

        function saveSettings() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if(key) localStorage.setItem('gemini_api_key', key);
            App.profile.hrZones = {
                z5: document.getElementById('hrZ5').value, z4: document.getElementById('hrZ4').value,
                z3: document.getElementById('hrZ3').value, z2: document.getElementById('hrZ2').value,
                z1: document.getElementById('hrZ1').value
            };
            App.profile.bio = { age: document.getElementById('bioAge').value, weight: document.getElementById('bioWeight').value };
            localStorage.setItem('analyst_profile', JSON.stringify(App.profile));
            showToast("Saved");
        }
        
        async function scanModels() {
            const key = document.getElementById('apiKeyInput').value; if(!key) return showToast("No Key", 'error');
            try {
                const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                const data = await r.json();
                document.getElementById('modelSelect').innerHTML = "";
                data.models.forEach(m => { if(m.supportedGenerationMethods?.includes("generateContent")) addModelOption(m.name.replace("models/", ""), false); });
                showToast("Models Found");
            } catch(e) { showToast("Error", 'error'); }
        }
        function addModelOption(name, s) { const o = document.createElement('option'); o.value=name; o.innerText=name; if(s) o.selected=true; document.getElementById('modelSelect').appendChild(o); }
        async function testConnection() { showToast("Testing..."); setTimeout(()=>showToast("Connected"), 500); }
        async function connectBluetooth() { try { await navigator.bluetooth.requestDevice({filters:[{namePrefix:'PM5'}],optionalServices:[PM5_SERVICE]}); App.state.connected=true; document.getElementById('btConnectBtn').innerText="LINKED"; document.getElementById('btConnectBtn').style.color="#00FF00"; } catch(e){showToast("BT Error",'error');} }
        function clearData() { if(confirm("Delete All?")) { localStorage.clear(); location.reload(); } }
    </script>
</body>
</html>
