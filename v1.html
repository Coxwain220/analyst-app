<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ANALYST V5.1 (AUTO-DISCOVERY)</title>
    <style>
        :root { --bg: #000; --text: #fff; --accent: #00FF00; --warn: #FFAA00; --danger: #FF0000; --rest: #0088FF; --panel: #111; --border: #333; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); font-family: 'Roboto', -apple-system, sans-serif; margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }

        /* TOAST */
        #toast { position: fixed; top: -50px; left: 50%; transform: translateX(-50%); background: #222; color: #fff; border: 1px solid #444; padding: 10px 20px; border-radius: 0 0 8px 8px; z-index: 2000; font-size: 12px; font-weight: bold; transition: top 0.3s ease; box-shadow: 0 5px 15px rgba(0,0,0,0.5); white-space: nowrap; }
        #toast.active { top: 0; }
        #toast.success { border-color: var(--accent); color: var(--accent); }
        #toast.error { border-color: var(--danger); color: var(--danger); }

        /* NAV */
        .nav-bar { display: flex; background: var(--panel); border-top: 1px solid var(--border); height: 60px; flex-shrink: 0; }
        .nav-btn { flex: 1; background: transparent; border: none; color: #666; font-size: 10px; font-weight: bold; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.2s; }
        .nav-btn.active { color: var(--accent); background: #1a1a1a; }
        .nav-icon { font-size: 18px; margin-bottom: 4px; }

        /* SCREENS */
        .screen { display: none; flex-grow: 1; flex-direction: column; overflow: hidden; }
        .screen.active { display: flex; }
        .scroll-area { flex-grow: 1; overflow-y: auto; padding: 20px; }

        .screen-header { display: flex; align-items: center; padding: 15px; background: var(--panel); border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .header-title { flex-grow: 1; text-align: center; font-weight: bold; font-size: 14px; letter-spacing: 1px; color: #888; }
        .header-btn { background: transparent; border: none; color: var(--accent); font-weight: bold; font-size: 12px; cursor: pointer; padding: 10px; }

        /* UI */
        .card { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .section-header { color: var(--accent); font-size: 11px; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        
        .btn { width: 100%; padding: 14px; border-radius: 6px; font-weight: bold; cursor: pointer; border: none; text-transform: uppercase; font-size: 14px; margin-top: 5px; }
        .btn-green { background: var(--accent); color: black; }
        .btn-outline { background: transparent; border: 1px solid #555; color: #888; }
        .btn-danger { background: #300; border: 1px solid #500; color: #f88; }
        .btn-sim { background: #333; color: #aaa; border: 1px solid #555; font-size: 10px; margin-top: 10px; }

        input, textarea, select { background: #000; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 4px; width: 100%; font-family: inherit; margin-bottom: 10px; }
        
        /* DEBUG CONSOLE */
        #debugLog { background: #000; border: 1px solid #333; color: #0f0; font-family: monospace; font-size: 10px; padding: 10px; height: 100px; overflow-y: scroll; white-space: pre-wrap; margin-top: 10px; }

        /* DASHBOARD */
        #dashScreen { display: none; height: 100%; grid-template-rows: 60px 1fr 120px; }
        #dashScreen.active { display: grid; }
        .main-deck { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .metric-huge { font-size: 14vh; font-weight: 900; line-height: 0.9; letter-spacing: -2px; }
        .metric-sub { font-size: 4vh; color: #888; font-weight: 700; margin-top: 10px; }
        .lower-deck { display: grid; grid-template-columns: 1fr 1fr; background: var(--panel); border-top: 1px solid var(--border); }
        .stat-box { display: flex; flex-direction: column; align-items: center; justify-content: center; border-right: 1px solid var(--border); }
        
        .hr-bar-container { width: 100%; height: 6px; background: #222; margin-top: 5px; border-radius: 3px; display: flex; }
        .hr-zone { height: 100%; opacity: 0.3; flex-grow: 1; margin: 0 1px; }
        .hr-zone.active { opacity: 1; box-shadow: 0 0 10px currentColor; }
        .z1 { background: #666; } .z2 { background: #0088FF; } .z3 { background: #00FF00; } .z4 { background: #FFAA00; } .z5 { background: #FF0000; } 

        .manual-tabs { display: flex; margin-bottom: 15px; border-bottom: 1px solid #333; }
        .m-tab { flex: 1; background: transparent; border: none; color: #666; padding: 10px; cursor: pointer; font-weight: bold; }
        .m-tab.active { color: white; border-bottom: 2px solid var(--accent); }
    </style>
</head>
<body>

    <div id="toast"><span>Notification</span></div>

    <div id="screenBuilder" class="screen active">
        <div class="scroll-area">
            
            <div class="card">
                <div class="section-header">MANUAL MISSION SETUP</div>
                <div class="manual-tabs">
                    <button class="m-tab active" onclick="setManualMode('SINGLE')" id="tabSingle">SINGLE</button>
                    <button class="m-tab" onclick="setManualMode('INTERVAL')" id="tabInterval">INTERVALS</button>
                </div>
                <div id="inputsSingle">
                    <label>DISTANCE (M)</label><input type="number" id="inpDist" value="2000">
                </div>
                <div id="inputsInterval" style="display:none;">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                        <div><label>SETS</label><input type="number" id="inpSets" value="4"></div>
                        <div><label>DIST (M)</label><input type="number" id="inpIntDist" value="500"></div>
                    </div>
                    <label>REST (SEC)</label><input type="number" id="inpRest" value="60">
                </div>
                <div style="margin-top:15px; border-top:1px solid #333; padding-top:10px;">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                        <div><label>PACE</label><input type="text" id="inpPace" value="1:54"></div>
                        <div><label>RATE</label><input type="number" id="inpRate" value="26"></div>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px;">
                    <button class="btn btn-outline" onclick="launchManual(true)">SIMULATE</button>
                    <button class="btn btn-green" onclick="launchManual(false)">START ROW</button>
                </div>
            </div>

            <div class="card">
                <div class="section-header">AI MISSION BUILDER</div>
                <label style="font-size:10px; color:#666;">NATURAL LANGUAGE INPUT</label>
                <textarea id="aiInput" rows="3" placeholder="e.g. 8 x 1min, 2min rest..."></textarea>
                <button class="btn btn-outline" onclick="generateMission()">GENERATE WITH AI</button>
            </div>

            <div id="missionPreview" class="card" style="display:none;">
                <div class="section-header">AI PREVIEW</div>
                <div id="missionDetails" style="font-size:12px; color:#ccc; white-space: pre-wrap;"></div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px;">
                    <button class="btn btn-outline" onclick="startMission(true)">SIMULATE AI</button>
                    <button class="btn btn-green" onclick="startMission(false)">START AI ROW</button>
                </div>
            </div>
        </div>
    </div>

    <div id="screenSettings" class="screen">
        <div class="screen-header">
            <button class="header-btn" onclick="nav('screenBuilder')">DONE</button>
            <div class="header-title">SETTINGS</div>
            <div style="width:40px;"></div>
        </div>
        <div class="scroll-area">
            <div class="card">
                <div class="section-header">API & MODEL CONFIG</div>
                <label>API KEY</label>
                <input type="password" id="apiKeyInput" placeholder="Paste Key...">
                
                <label style="margin-top:10px;">AVAILABLE MODELS</label>
                <select id="modelSelect">
                    <option value="" disabled selected>Click SCAN to find models</option>
                </select>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                    <button class="btn btn-outline" onclick="scanModels()">SCAN FOR MODELS</button>
                    <button class="btn btn-green" onclick="testConnection()">TEST</button>
                </div>
                
                <div id="debugLog">System Ready.</div>
            </div>

            <div class="card">
                <div class="section-header">HEART RATE ZONES</div>
                <div style="display:grid; grid-template-columns: 1fr; gap:10px;">
                    <div><label>Z5</label><input type="number" id="hrZ5" value="180"></div>
                    <div><label>Z1</label><input type="number" id="hrZ1" value="108"></div>
                </div>
            </div>
            
            <button class="btn btn-danger" onclick="localStorage.clear(); location.reload();">RESET ALL</button>
        </div>
    </div>

    <div id="dashScreen">
        <div class="comms-bar" style="border-bottom:1px solid #333; padding:10px 20px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:10px; color:#666;">MISSION CONTROL</span>
                <span id="phaseBadge" style="background:#222; padding:4px 8px; border-radius:4px; font-size:10px; font-weight:bold; color:#888;">IDLE</span>
            </div>
            <div id="intervalInfo" style="font-size:14px; color:#fff; font-weight:bold;">--</div>
        </div>

        <div class="main-deck">
            <div class="metric-huge" id="dispPace">0:00</div>
            <div class="metric-sub"><span id="dispWatts">0</span>W <span style="color:#444">|</span> <span id="dispDist">0</span>m</div>
        </div>

        <div class="lower-deck">
            <div class="stat-box">
                <div class="metric-sub" id="dispRate" style="color:white; margin:0;">--</div>
                <div style="font-size:10px; color:#666;">RATE (TGT: <span id="tgtRate" style="color:var(--accent)">--</span>)</div>
            </div>
            <div class="stat-box">
                <div class="metric-sub" id="dispHR" style="color:white; margin:0;">--</div>
                <div style="font-size:10px; color:#666;">HEART RATE</div>
                <div class="hr-bar-container">
                    <div class="hr-zone z1" id="z1"></div>
                    <div class="hr-zone z2" id="z2"></div>
                    <div class="hr-zone z3" id="z3"></div>
                    <div class="hr-zone z4" id="z4"></div>
                    <div class="hr-zone z5" id="z5"></div>
                </div>
            </div>
        </div>
        
        <div style="background:#111; padding:10px; display:flex; justify-content:center;">
            <button class="btn btn-outline" style="width:auto; padding:10px 30px;" onclick="location.reload()">STOP / SAVE</button>
        </div>
    </div>

    <div class="nav-bar">
        <button class="nav-btn active" onclick="nav('screenBuilder')" id="navBuild"><span class="nav-icon">⚡</span>BUILD</button>
        <button class="nav-btn" onclick="nav('dashScreen')" id="navDash"><span class="nav-icon">⏱</span>ROW</button>
        <button class="nav-btn" onclick="nav('screenSettings')" id="navSet"><span class="nav-icon">⚙</span>SET</button>
    </div>

    <script>
        const PM5_SERVICE = 'ce060030-43e5-11e4-916c-0800200c9a66';
        const PM5_CHAR_32 = 'ce060032-43e5-11e4-916c-0800200c9a66'; 
        
        let MISSION = { description: "", intervals: [] };
        let STATE = { active: false, intervalIdx: 0, timeLeft: 0, distLeft: 0, log: [], simLoop: null };
        let MANUAL_MODE = 'SINGLE';
        let HR_ZONES = { z1: 108, z2: 125, z3: 144, z4: 162, z5: 180 };

        window.onload = () => {
            const key = localStorage.getItem('gemini_api_key');
            if(key) document.getElementById('apiKeyInput').value = key;
            const model = localStorage.getItem('gemini_model');
            if(model) addModelOption(model, true);
        };

        // --- UTILS ---
        function showToast(msg, type='success') {
            const t = document.getElementById('toast');
            t.innerText = (type==='success'?'✔ ':'⚠ ') + msg;
            t.className = type + ' active';
            setTimeout(()=>t.className='', 3000);
        }
        function nav(id) {
            document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
            if(id==='screenBuilder') document.getElementById('navBuild').classList.add('active');
            if(id==='dashScreen') document.getElementById('navDash').classList.add('active');
            if(id==='screenSettings') document.getElementById('navSet').classList.add('active');
        }
        function logDebug(msg) {
            const d = document.getElementById('debugLog');
            d.innerText += "\n" + msg;
            d.scrollTop = d.scrollHeight;
        }

        // --- AI SCANNER ---
        async function scanModels() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if(!key) return showToast("API Key Missing", 'error');
            localStorage.setItem('gemini_api_key', key);
            
            logDebug("Scanning available models...");
            
            try {
                const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                const data = await r.json();
                
                if(!r.ok) throw new Error(data.error?.message || "Scan Failed");
                
                const select = document.getElementById('modelSelect');
                select.innerHTML = ""; // Clear
                
                let found = 0;
                data.models.forEach(m => {
                    // Filter for models that support generateContent
                    if(m.supportedGenerationMethods && m.supportedGenerationMethods.includes("generateContent")) {
                        const name = m.name.replace("models/", "");
                        addModelOption(name, found===0);
                        found++;
                    }
                });
                
                logDebug(`Found ${found} usable models.`);
                showToast(`Found ${found} models`, 'success');
                
            } catch(e) {
                logDebug("SCAN ERROR: " + e.message);
                showToast("Scan Failed. Check Log.", 'error');
            }
        }

        function addModelOption(name, selectIt) {
            const sel = document.getElementById('modelSelect');
            const opt = document.createElement('option');
            opt.value = name;
            opt.innerText = name;
            if(selectIt) {
                opt.selected = true;
                localStorage.setItem('gemini_model', name);
            }
            sel.appendChild(opt);
        }

        async function testConnection() {
            const key = document.getElementById('apiKeyInput').value.trim();
            const model = document.getElementById('modelSelect').value;
            
            if(!model) return showToast("Scan Models first!", 'error');
            
            logDebug(`Testing ${model}...`);
            try {
                const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
                    method: "POST", headers: {"Content-Type":"application/json"},
                    body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: "Say OK" }] }] })
                });
                const data = await r.json();
                if(r.ok) {
                    logDebug("SUCCESS: " + JSON.stringify(data));
                    showToast("Connected!", 'success');
                    localStorage.setItem('gemini_model', model);
                } else {
                    logDebug("FAIL: " + JSON.stringify(data));
                    showToast("Model Failed", 'error');
                }
            } catch(e) { logDebug("NET ERROR: "+e.message); }
        }

        async function generateMission() {
            const key = localStorage.getItem('gemini_api_key');
            const model = localStorage.getItem('gemini_model');
            const input = document.getElementById('aiInput').value;
            
            if(!key || !model || !input) return showToast("Setup required in Settings", 'error');
            
            document.getElementById('missionPreview').style.display = 'block';
            document.getElementById('missionDetails').innerText = "GENERATING...";

            const PROMPT = `Parse workout: "${input}". JSON Format: { "description": "txt", "intervals": [{ "type": "WORK"|"REST", "dist": 0, "duration": 0, "rate": 0 }] }. If minutes use duration (sec), if meters use dist.`;

            try {
                const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
                    method: "POST", headers: {"Content-Type":"application/json"},
                    body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: PROMPT }] }] })
                });
                const d = await r.json();
                if(!r.ok) throw new Error(d.error?.message);
                
                const jsonText = d.candidates[0].content.parts[0].text.replace(/```json/g,'').replace(/```/g,'');
                MISSION = JSON.parse(jsonText);
                document.getElementById('missionDetails').innerText = JSON.stringify(MISSION, null, 2);
            } catch(e) {
                document.getElementById('missionDetails').innerText = "ERROR: " + e.message;
            }
        }

        // --- DASHBOARD ---
        function setManualMode(mode) {
            MANUAL_MODE = mode;
            document.getElementById('tabSingle').className = mode === 'SINGLE' ? 'm-tab active' : 'm-tab';
            document.getElementById('tabInterval').className = mode === 'INTERVAL' ? 'm-tab active' : 'm-tab';
            document.getElementById('inputsSingle').style.display = mode === 'SINGLE' ? 'block' : 'none';
            document.getElementById('inputsInterval').style.display = mode === 'INTERVAL' ? 'block' : 'none';
        }

        function launchManual(isSim) {
            MISSION = { description: "Manual " + MANUAL_MODE, intervals: [] };
            const tgtRate = parseInt(document.getElementById('inpRate').value) || 20;

            if(MANUAL_MODE === 'SINGLE') {
                const dist = parseInt(document.getElementById('inpDist').value);
                MISSION.intervals.push({ type:'WORK', dist: dist, duration:99999, rate:tgtRate });
            } else {
                const sets = parseInt(document.getElementById('inpSets').value);
                const dist = parseInt(document.getElementById('inpIntDist').value);
                const rest = parseInt(document.getElementById('inpRest').value);
                for(let i=0; i<sets; i++) {
                    MISSION.intervals.push({ type:'WORK', dist: dist, duration:99999, rate:tgtRate });
                    if(i < sets-1) MISSION.intervals.push({ type:'REST', duration:rest, rate:0 });
                }
            }
            startMission(isSim);
        }

        function startMission(isSim) {
            nav('dashScreen');
            STATE = { active: true, intervalIdx: 0, timeLeft: 0, distLeft: 0, log: [], simLoop: null };
            setupNextInterval();

            if(isSim) {
                STATE.simLoop = setInterval(() => {
                    if(!STATE.active) return;
                    processTelemetry(2.5, 24, 145, 200);
                }, 500);
            } else {
                connectBluetooth();
            }
        }

        function setupNextInterval() {
            if(STATE.intervalIdx >= MISSION.intervals.length) {
                STATE.active = false;
                if(STATE.simLoop) clearInterval(STATE.simLoop);
                alert("Workout Complete");
                nav('screenBuilder');
                return;
            }
            const int = MISSION.intervals[STATE.intervalIdx];
            STATE.timeLeft = int.duration || 99999;
            STATE.distLeft = int.dist || 0;
            
            document.getElementById('phaseBadge').innerText = int.type;
            document.getElementById('phaseBadge').style.background = int.type==='WORK' ? '#00FF00' : '#0088FF';
            document.getElementById('phaseBadge').style.color = int.type==='WORK' ? '#000' : '#fff';
            document.getElementById('intervalInfo').innerText = `${int.type} ${STATE.intervalIdx+1}/${MISSION.intervals.length}`;
            document.getElementById('tgtRate').innerText = int.rate || "--";
        }

        function processTelemetry(speed, rate, hr, watts) {
            if(!STATE.active) return;
            const int = MISSION.intervals[STATE.intervalIdx];
            
            STATE.timeLeft -= 0.5;
            if(speed > 0.1 && STATE.distLeft > 0) STATE.distLeft -= (speed * 0.5);
            
            if( (int.dist > 0 && STATE.distLeft <= 0) || (int.duration < 99999 && STATE.timeLeft <= 0) ) {
                STATE.intervalIdx++;
                setupNextInterval();
                return;
            }

            let paceSec = speed > 0.1 ? 500/speed : 0;
            let m = Math.floor(paceSec/60);
            let s = Math.floor(paceSec%60);
            document.getElementById('dispPace').innerText = speed > 0.1 ? `${m}:${s.toString().padStart(2,'0')}` : "0:00";
            document.getElementById('dispWatts').innerText = watts;
            document.getElementById('dispRate').innerText = rate;
            document.getElementById('dispHR').innerText = hr < 255 ? hr : "--";
            document.getElementById('dispDist').innerText = Math.floor(STATE.distLeft > 0 ? STATE.distLeft : 0);

            document.querySelectorAll('.hr-zone').forEach(z=>z.classList.remove('active'));
            if(hr > HR_ZONES.z4) document.getElementById('z5').classList.add('active');
            else if(hr > HR_ZONES.z3) document.getElementById('z4').classList.add('active');
            else if(hr > HR_ZONES.z2) document.getElementById('z3').classList.add('active');
            else if(hr > HR_ZONES.z1) document.getElementById('z2').classList.add('active');
            else if(hr > 0) document.getElementById('z1').classList.add('active');
        }

        async function connectBluetooth() {
            try {
                const device = await navigator.bluetooth.requestDevice({ filters: [{ namePrefix: 'PM5' }], optionalServices: [PM5_SERVICE] });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(PM5_SERVICE);
                const char = await service.getCharacteristic(PM5_CHAR_32);
                await char.startNotifications();
                char.addEventListener('characteristicvaluechanged', (e) => {
                    let d = e.target.value;
                    let speed = (d.getUint8(3) | (d.getUint8(4)<<8)) * 0.001;
                    processTelemetry(speed, d.getUint8(5), d.getUint8(6), (d.getUint8(11)|(d.getUint8(12)<<8)));
                });
            } catch(e) { showToast("BT Error: "+e.message, 'error'); }
        }
    </script>
</body>
</html>
