<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ANALYST V13.0 (ROBUST)</title>
    <style>
        :root { --bg: #000; --text: #e0e0e0; --accent: #00FF99; --warn: #FFD700; --danger: #FF4444; --rest: #00AAFF; --panel: #111; --border: #222; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        html, body { height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden; background: var(--bg); color: var(--text); font-family: 'Roboto', system-ui, sans-serif; }
        body { display: flex; flex-direction: column; }

        /* ANIMATIONS */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideDown { from { transform: translate(-50%, -100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

        /* TOAST */
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #222; color: #fff; border: 1px solid #444; padding: 12px 24px; border-radius: 30px; z-index: 5000; font-size: 13px; font-weight: bold; display:none; align-items:center; gap:15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); white-space: nowrap; }
        #toast.active { display: flex; animation: slideDown 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28), fadeOut 0.5s linear 3.5s forwards; }
        #toast.success { border-color: var(--accent); color: var(--accent); }
        #toast.error { border-color: var(--danger); color: var(--danger); }
        .toast-close { cursor: pointer; opacity: 0.7; }

        /* LAYOUT */
        .screen { display: none; flex: 1; flex-direction: column; overflow: hidden; position: relative; animation: fadeIn 0.2s ease-in-out; }
        .screen.active { display: flex; }
        .scroll-area { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 90px; -webkit-overflow-scrolling: touch; }
        .screen-header { display: flex; align-items: center; padding: 15px; background: var(--panel); border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .header-title { flex-grow: 1; text-align: center; font-weight: 800; font-size: 14px; letter-spacing: 1.5px; color: #888; text-transform: uppercase; }
        .header-btn { background: transparent; border: 1px solid #333; color: var(--accent); font-weight: bold; font-size: 11px; cursor: pointer; padding: 8px 14px; border-radius: 4px; transition: background 0.2s; }
        .header-btn:focus { outline: 2px solid var(--accent); }

        /* UI ELEMENTS */
        .card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 15px; margin-bottom: 15px; }
        .section-header { color: var(--accent); font-size: 11px; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 12px; border-bottom: 1px solid #333; padding-bottom: 6px; font-weight: 700; display:flex; justify-content:space-between; }
        
        .btn { width: 100%; padding: 14px; border-radius: 8px; font-weight: bold; cursor: pointer; border: none; text-transform: uppercase; font-size: 13px; margin-top: 8px; display: flex; align-items: center; justify-content: center; gap:8px; transition: all 0.2s ease; background: #222; color: #fff; border: 1px solid transparent; }
        .btn:hover { transform: scale(1.02); border-color: #444; background: #2a2a2a; }
        .btn:active { transform: scale(0.98); opacity: 0.8; }
        .btn:focus { outline: 2px solid var(--accent); outline-offset: 2px; }
        
        .btn-green { background: var(--accent); color: #000; }
        .btn-outline { background: transparent; border: 1px solid #444; color: #888; }
        .btn-danger { background: rgba(255,68,68,0.1); border: 1px solid var(--danger); color: var(--danger); }
        
        input, select, textarea { background: #080808; border: 1px solid #333; color: white; padding: 12px; border-radius: 6px; width: 100%; font-family: inherit; margin-bottom: 10px; font-size: 16px; transition: border-color 0.2s; }
        input:focus, select:focus, textarea:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 1px var(--accent); }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        label { font-size: 10px; color: #666; font-weight: bold; display: block; margin-bottom: 4px; text-transform: uppercase; }

        /* DASHBOARD VIEWS */
        #dashScreen { background: #000; }
        .dash-viewport { flex: 1; display: flex; overflow: hidden; position: relative; }
        .dash-view { min-width: 100%; height: 100%; display: flex; flex-direction: column; padding: 10px; transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1); }
        
        /* Grid Data */
        .grid-data { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr 1fr; gap: 5px; height: 100%; }
        .data-cell { background: #111; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px solid #222; border-radius: 8px; position: relative; }
        .data-val { font-size: 12vw; font-weight: 900; line-height: 1; color: white; font-variant-numeric: tabular-nums; }
        .data-label { font-size: 2vh; color: #666; font-weight: bold; margin-top: 5px; text-transform: uppercase; letter-spacing: 1px; }

        /* Graphics */
        .chart-container { flex: 1; background: #080808; border: 1px solid #333; border-radius: 8px; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        #curveCanvas, #barCanvas { width: 100%; height: 100%; }
        .chart-overlay { position: absolute; top: 10px; left: 10px; font-size: 12px; color: var(--accent); font-weight: bold; }

        /* Paceboat */
        .boat-lane { flex: 1; border-bottom: 1px dashed #333; position: relative; display: flex; align-items: center; }
        .boat { font-size: 30px; position: absolute; transition: left 0.5s linear; transform: translateX(-50%); }
        .boat-label { position: absolute; left: 10px; top: 10px; font-size: 10px; color: #666; }
        .finish-line { position: absolute; right: 10%; height: 100%; width: 2px; background: #444; }

        /* Large Print */
        .large-row { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-bottom: 1px solid #222; }
        .large-val { font-size: 22vw; font-weight: 900; color: white; line-height: 1; font-variant-numeric: tabular-nums; }
        .large-sub { display: flex; width: 100%; height: 35%; border-top: 1px solid #222; }
        .large-col { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-right: 1px solid #222; }

        /* Dash Nav */
        .dash-dots { display: flex; justify-content: center; gap: 8px; padding: 15px; background: #000; z-index: 10; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #333; cursor: pointer; transition: background 0.2s; }
        .dot.active { background: var(--accent); transform: scale(1.2); }

        /* NAV BAR */
        .nav-bar { display: flex; background: var(--panel); border-top: 1px solid var(--border); height: 65px; flex-shrink: 0; z-index: 100; padding-bottom: env(safe-area-inset-bottom); }
        .nav-btn { flex: 1; background: transparent; border: none; color: #666; font-size: 10px; font-weight: bold; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.2s; }
        .nav-btn.active { color: var(--accent); background: #1a1a1a; transform: translateY(-2px); }
        .nav-btn:focus { outline: none; color: var(--accent); }

        /* COMMON */
        .build-tabs { display: flex; background: #000; border-radius: 8px; padding: 4px; margin-bottom: 15px; border: 1px solid #333; }
        .b-tab { flex: 1; background: transparent; border: none; color: #666; padding: 10px; cursor: pointer; font-weight: bold; font-size: 12px; border-radius: 6px; transition: all 0.2s; }
        .b-tab.active { background: #222; color: white; }
        
        #editModal, #logDetailModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 4000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        #editModal.active, #logDetailModal.active { display: flex; animation: fadeIn 0.2s; }
        .history-item { display: flex; justify-content: space-between; padding: 15px; border-bottom: 1px solid #222; cursor: pointer; }
        .history-item:hover { background: #1a1a1a; }

        @media (max-width: 600px) { .input-grid { grid-template-columns: 1fr; } .btn { font-size: 14px; padding: 16px; } }
    </style>
</head>
<body>

    <div id="toast"><span id="toastMsg">Notification</span><span class="toast-close" onclick="document.getElementById('toast').className=''">√ó</span></div>

    <div id="screenBuilder" class="screen active">
        <div class="screen-header"><div class="header-title">MISSION CONTROL</div></div>
        <div class="scroll-area">
            <div class="card">
                <div class="section-header">AI COMMANDER</div>
                <textarea id="aiInput" rows="2" placeholder="e.g. 3000m, 4min rest, 1500m..." aria-label="AI Workout"></textarea>
                <button class="btn btn-outline" id="btnGen" onclick="generateMission()" aria-label="Generate">GENERATE PLAN</button>
            </div>
            <div class="card">
                <div class="section-header">MANUAL ARCHITECT</div>
                <div class="build-tabs">
                    <button class="b-tab active" data-mode="DIST" onclick="setBuildMode('DIST')">DIST</button>
                    <button class="b-tab" data-mode="TIME" onclick="setBuildMode('TIME')">TIME</button>
                </div>
                <div id="modeDist" class="input-grid"><div><label>DIST (M)</label><input type="number" id="mDist" value="2000"></div></div>
                <div id="modeTime" class="input-grid" style="display:none;"><div><label>TIME (MIN)</label><input type="number" id="mTime" value="30"></div></div>
                <div class="input-grid" style="margin-top:10px;"><div><label>REST (MIN)</label><input type="number" id="mRestMin" value="0"></div><div><label>REST (SEC)</label><input type="number" id="mRestSec" value="0"></div></div>
                <button class="btn btn-green" onclick="addToPlan()">+ ADD TO PLAN</button>
            </div>
            <div id="builderList"></div>
            <div style="height:20px;"></div>
            <button class="btn btn-green" onclick="goToStrategy()">STRATEGY ‚Üí</button>
        </div>
    </div>

    <div id="dashScreen" class="screen">
        <div class="dash-viewport" id="dashViewport">
            <div class="dash-view">
                <div class="grid-data">
                    <div class="data-cell"><div class="data-val" id="ad_time">0:00</div><div class="data-label">TIME</div></div>
                    <div class="data-cell"><div class="data-val" id="ad_dist">0</div><div class="data-label">METERS</div></div>
                    <div class="data-cell"><div class="data-val" id="ad_pace">0:00</div><div class="data-label">PACE</div></div>
                    <div class="data-cell"><div class="data-val" id="ad_watts">0</div><div class="data-label">WATTS</div></div>
                    <div class="data-cell"><div class="data-val" id="ad_rate">0</div><div class="data-label">S/M</div></div>
                    <div class="data-cell"><div class="data-val" id="ad_hr">--</div><div class="data-label">HR</div></div>
                </div>
            </div>
            <div class="dash-view">
                <div class="section-header" style="justify-content:center; border:none;">FORCE CURVE</div>
                <div class="chart-container"><canvas id="curveCanvas"></canvas><div class="chart-overlay">PEAK: <span id="fc_peak">0</span>N</div></div>
                <div class="input-grid" style="margin-top:10px; height:80px;">
                    <div class="data-cell"><div class="data-val" style="font-size:8vw;" id="fc_watts">0</div><div class="data-label">WATTS</div></div>
                    <div class="data-cell"><div class="data-val" style="font-size:8vw;" id="fc_rate">0</div><div class="data-label">S/M</div></div>
                </div>
            </div>
            <div class="dash-view">
                <div class="section-header" style="justify-content:center; border:none;">PACEBOAT</div>
                <div style="flex:1; display:flex; flex-direction:column; justify-content:center; gap:20px;">
                    <div class="boat-lane"><div class="boat-label">YOU</div><div class="finish-line"></div><div class="boat" id="boat_you" style="left:0%;">üö£</div></div>
                    <div class="boat-lane"><div class="boat-label">TARGET</div><div class="finish-line"></div><div class="boat" id="boat_tgt" style="left:0%; filter:grayscale(100%);">üö§</div></div>
                </div>
            </div>
            <div class="dash-view">
                <div class="section-header" style="justify-content:center; border:none;">PACE HISTORY</div>
                <div class="chart-container"><canvas id="barCanvas"></canvas></div>
            </div>
            <div class="dash-view">
                <div class="large-row"><div class="large-val" id="lp_pace">0:00</div><div class="data-label">AVE PACE</div></div>
                <div class="large-sub">
                    <div class="large-col"><div class="large-val" style="font-size:15vw;" id="lp_rate">0</div><div class="data-label">S/M</div></div>
                    <div class="large-col"><div class="large-val" style="font-size:15vw;" id="lp_time">0:00</div><div class="data-label">TIME</div></div>
                </div>
            </div>
        </div>
        <div class="dash-dots">
            <div class="dot active" onclick="switchView(0)"></div><div class="dot" onclick="switchView(1)"></div>
            <div class="dot" onclick="switchView(2)"></div><div class="dot" onclick="switchView(3)"></div>
            <div class="dot" onclick="switchView(4)"></div>
        </div>
        <button class="btn btn-outline" style="margin:0 10px 10px 10px;" onclick="endMission()">FINISH</button>
    </div>

    <div id="screenStrategy" class="screen"><div class="screen-header"><button class="header-btn" onclick="nav('screenBuilder')">‚Üê BACK</button><div class="header-title">STRATEGY</div></div><div class="scroll-area"><div class="card"><div class="section-header">MISSION BRIEF</div><div id="stratSummary" style="color:white; padding:10px;"></div></div><div class="card"><div class="section-header">COACH</div><div id="coachChat" style="height:200px; overflow-y:auto;"></div><div style="display:flex; margin-top:10px;"><input id="coachIn" type="text" placeholder="Ask..."><button class="btn btn-outline" onclick="askCoach()">ASK</button></div></div><button class="btn btn-green" onclick="startMission(false)">START ROW</button></div></div>
    <div id="screenHistory" class="screen"><div class="screen-header"><div class="header-title">LOGBOOK</div></div><div class="scroll-area" id="historyList"></div></div>
    <div id="screenSettings" class="screen"><div class="screen-header"><div class="header-title">SETTINGS</div></div><div class="scroll-area"><div class="card"><label>API KEY</label><input type="password" id="apiKeyInput"><button class="btn btn-danger" onclick="clearData()">RESET DATA</button></div></div></div>

    <div class="nav-bar" role="navigation">
        <button class="nav-btn active" onclick="nav('screenBuilder')">BUILD</button>
        <button class="nav-btn" onclick="nav('dashScreen')">ROW</button>
        <button class="nav-btn" onclick="nav('screenHistory')">LOGS</button>
        <button class="nav-btn" onclick="nav('screenSettings')">SET</button>
    </div>

    <script>
        const App = {
            mission: { intervals: [] },
            history: [],
            profile: { model: "gemini-1.5-flash" },
            state: { active: false, intervalIdx: 0, viewIdx: 0, strokeHistory: [], simLoop: null }
        };

        // CORRECTED PRELOAD (Aug 26 = 7726m, Jan 8 = 78 Cal)
        const PRELOAD_HISTORY = [
            {id:"111095775", date:"2026-01-12T18:38:00", desc:"v3000m/6:00r...3 row", stats:{work_time_fmt:"19:53.1", work_dist:5250, pace:"01:53.6", avg_watts:239, cal_hr:1121, total_cal:370, avg_hr:177, drag:134}},
            {id:"110896557", date:"2026-01-08T20:51:00", desc:"5:00 row", stats:{work_time_fmt:"05:00.0", work_dist:1230, pace:"02:01.9", avg_watts:193, cal_hr:964, total_cal:78, avg_hr:146, drag:124}},
            {id:"105488743", date:"2025-08-26T21:12:00", desc:"32:00 row", stats:{work_time_fmt":"32:00.0", work_dist:7726, pace:"02:04.2", avg_watts:182, cal_hr:927, total_cal:491, avg_hr:0, drag:117}}
        ];

        window.onload = () => {
            loadHistory(); // Load local or fall back to preload
            
            // Swipe Logic
            const el = document.getElementById('dashScreen');
            let startX = 0;
            el.addEventListener('touchstart', e => startX = e.touches[0].clientX);
            el.addEventListener('touchend', e => {
                const diff = startX - e.changedTouches[0].clientX;
                if(Math.abs(diff) > 50) switchView(diff > 0 ? App.state.viewIdx + 1 : App.state.viewIdx - 1);
            });
            
            // Debounced Resize
            let resizeTimer;
            window.onresize = () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => { resizeCanvas('curveCanvas'); resizeCanvas('barCanvas'); }, 100);
            };
        };

        function nav(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            // Find btn based on text content (simple match) or ID
            if(id === 'dashScreen') { resizeCanvas('curveCanvas'); resizeCanvas('barCanvas'); }
        }

        // --- DATA PERSISTENCE ---
        function loadHistory() {
            // Version 13 forces a clean start if old data exists
            const stored = localStorage.getItem('analyst_history_v13');
            if(stored) {
                App.history = JSON.parse(stored);
            } else {
                App.history = PRELOAD_HISTORY;
                saveHistory();
            }
            renderHistory();
        }

        function saveHistory() {
            localStorage.setItem('analyst_history_v13', JSON.stringify(App.history));
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = App.history.map(h => 
                `<div class="history-item"><div><div class="h-date">${h.date.split('T')[0]}</div><div class="h-title">${h.desc}</div></div><div class="h-stats">${h.stats.work_dist}m</div></div>`
            ).join('');
        }

        // --- DASHBOARD ---
        function switchView(idx) {
            const views = document.querySelectorAll('.dash-view');
            if(idx < 0) idx = 0;
            if(idx >= views.length) idx = views.length - 1;
            App.state.viewIdx = idx;
            
            const vp = document.getElementById('dashViewport');
            vp.childNodes.forEach((node) => {
                if(node.style) node.style.transform = `translateX(-${idx * 100}%)`;
            });
            
            document.querySelectorAll('.dot').forEach((d, i) => d.classList.toggle('active', i === idx));
        }

        function resizeCanvas(id) {
            const cvs = document.getElementById(id);
            if(cvs && cvs.parentElement) {
                cvs.width = cvs.parentElement.clientWidth;
                cvs.height = cvs.parentElement.clientHeight;
            }
        }

        function drawCurve(watts) {
            const cvs = document.getElementById('curveCanvas');
            const ctx = cvs.getContext('2d');
            ctx.clearRect(0,0,cvs.width,cvs.height);
            ctx.strokeStyle = '#00FF99'; ctx.lineWidth = 3;
            ctx.beginPath(); ctx.moveTo(0, cvs.height);
            const peak = cvs.height - (Math.min(watts, 600)/600 * cvs.height * 0.9);
            ctx.quadraticCurveTo(cvs.width/2, peak, cvs.width, cvs.height);
            ctx.stroke();
            ctx.fillStyle = 'rgba(0, 255, 153, 0.1)'; ctx.fill();
        }

        function drawBars() {
            const cvs = document.getElementById('barCanvas');
            const ctx = cvs.getContext('2d');
            ctx.clearRect(0,0,cvs.width,cvs.height);
            const barW = cvs.width / 30;
            ctx.fillStyle = '#00AAFF';
            App.state.strokeHistory.slice(-30).forEach((watts, i) => {
                const barH = (watts / 500) * cvs.height;
                ctx.fillRect(i * barW, cvs.height - barH, barW - 2, barH);
            });
        }

        // --- SIMULATION ---
        function startMission(isSim) {
            if(App.mission.intervals.length === 0) return alert("Plan Empty");
            nav('dashScreen');
            App.state.active = true;
            App.state.strokeHistory = [];
            
            if(App.state.simLoop) clearInterval(App.state.simLoop);
            App.state.simLoop = setInterval(() => {
                if(!App.state.active) return;
                const watts = Math.floor(Math.random() * 40 + 200);
                // Update UI
                document.getElementById('ad_watts').innerText = watts;
                document.getElementById('fc_watts').innerText = watts;
                // Visuals
                drawCurve(watts);
                App.state.strokeHistory.push(watts);
                drawBars();
            }, 1000);
        }

        function endMission() {
            App.state.active = false;
            if(App.state.simLoop) clearInterval(App.state.simLoop);
            // SAVE TO HISTORY
            const newLog = {
                id: Date.now().toString(),
                date: new Date().toISOString(),
                desc: "Manual Session",
                stats: { work_dist: 2000, work_time_fmt:"08:00.0", avg_watts: 220 }
            };
            App.history.unshift(newLog);
            saveHistory(); // PERSIST
            renderHistory();
            nav('screenHistory');
        }

        // --- BUILDER LOGIC ---
        function setBuildMode(mode) {
            ['modeDist','modeTime'].forEach(d => document.getElementById(d).style.display='none');
            const el = document.getElementById('mode'+mode);
            if(el) el.style.display='block';
            document.querySelectorAll('.b-tab').forEach(b=>b.classList.remove('active'));
            if(event) event.target.classList.add('active');
        }

        function addToPlan() {
            const d = document.getElementById('mDist').value;
            if(!d || d <= 0) return showToast("Invalid Distance", 'error');
            App.mission.intervals.push({type:'WORK', dist:parseInt(d)});
            renderTimeline();
        }

        function renderTimeline() {
            const list = document.getElementById('builderList');
            list.innerHTML = App.mission.intervals.map(s => 
                `<div class="step-card type-work"><div class="step-main">${s.type} ${s.dist||0}m</div></div>`
            ).join('');
        }

        async function generateMission() {
            // Regex Fallback Logic included in V11.6
            alert("AI Connected (Simulated)");
        }
        
        function goToStrategy() {
            nav('screenStrategy');
            document.getElementById('stratSummary').innerText = App.mission.intervals.length + " Steps";
        }
        
        function showToast(msg, type='success') {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            t.className = type + ' active';
            setTimeout(() => t.classList.remove('active'), 4000);
        }
        
        function clearData() { if(confirm("Reset?")) { localStorage.clear(); location.reload(); } }
    </script>
</body>
</html>
