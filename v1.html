<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Rowing Coach v1.6</title>

```
<!-- Firebase SDK v9+ (Modular) -->
<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
    import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, getDocs, deleteDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
    
    // Your Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyAdwuu17GMfX_jiVyx5SOL_jmvrybq0uuo",
        authDomain: "ai-fitness-app-c5307.firebaseapp.com",
        projectId: "ai-fitness-app-c5307",
        storageBucket: "ai-fitness-app-c5307.firebasestorage.app",
        messagingSenderId: "462148834440",
        appId: "1:462148834440:web:32be31f4ae6f76e144bb3d"
    };
    
    // Initialize Firebase and make available globally
    const app = initializeApp(firebaseConfig);
    window.firebaseApp = app;
    window.firebaseAuth = getAuth(app);
    window.firebaseDb = getFirestore(app);
    window.firebaseModules = {
        signInAnonymously,
        onAuthStateChanged,
        doc,
        setDoc,
        getDoc,
        collection,
        query,
        orderBy,
        getDocs,
        deleteDoc,
        serverTimestamp
    };
    
    console.log('‚úì Firebase modules loaded');
</script>

<style>
    :root {
        --bg: #000;
        --text: #e0e0e0;
        --accent: #00FF99;
        --danger: #FF4444;
        --panel: #111;
        --border: #222;
        --card-bg: #0a0a0a;
    }
    
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        -webkit-tap-highlight-color: transparent;
    }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: var(--bg);
        color: var(--text);
        height: 100vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    
    .version-badge {
        position: fixed;
        top: 10px;
        right: 10px;
        background: rgba(0, 255, 153, 0.2);
        border: 1px solid var(--accent);
        color: var(--accent);
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 10px;
        font-weight: 700;
        z-index: 10000;
    }
    
    /* TOP NAVIGATION */
    .top-nav-bar {
        background: var(--panel);
        border-bottom: 1px solid var(--border);
        display: flex;
        height: 70px;
        flex-shrink: 0;
    }
    
    .top-nav-item {
        flex: 1;
        background: transparent;
        border: none;
        color: #666;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 4px;
        transition: all 0.2s;
    }
    
    .top-nav-item.active {
        color: var(--accent);
        background: rgba(0,255,153,0.05);
    }
    
    .top-nav-icon { font-size: 20px; }
    
    .top-nav-label { font-size: 10px; letter-spacing: 0.5px; }
    
    .toast {
        position: fixed;
        top: 70px;
        left: 50%;
        transform: translateX(-50%) translateY(-100px);
        background: var(--panel);
        color: var(--text);
        padding: 12px 24px;
        border-radius: 8px;
        border: 1px solid var(--border);
        z-index: 9999;
        opacity: 0;
        transition: all 0.3s;
        font-size: 14px;
        font-weight: 600;
        max-width: 90%;
    }
    
    .toast.show {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
    }
    
    .toast.success { border-color: var(--accent); color: var(--accent); }
    .toast.error { border-color: var(--danger); color: var(--danger); }
    
    .screen {
        display: none;
        flex-direction: column;
        flex: 1;
        overflow: hidden;
    }
    
    .screen.active { display: flex; }
    
    .screen-header {
        background: var(--panel);
        border-bottom: 1px solid var(--border);
        padding: 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-shrink: 0;
    }
    
    .screen-title {
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 1.5px;
        color: #666;
        text-transform: uppercase;
        flex: 1;
        text-align: center;
    }
    
    .header-btn {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--text);
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 700;
        cursor: pointer;
    }
    
    .scroll-content {
        flex: 1;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding: 16px;
        padding-bottom: 100px;
    }
    
    /* DASHBOARD - SWIPEABLE VIEWS */
    .dashboard-container {
        flex: 1;
        overflow: hidden;
        position: relative;
    }
    
    .dashboard-carousel {
        display: flex;
        height: 100%;
        transition: transform 0.3s ease;
    }
    
    .dashboard-view {
        min-width: 100%;
        height: 100%;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    .dashboard-dots {
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 8px;
        z-index: 100;
    }
    
    .dashboard-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #333;
        transition: all 0.3s;
    }
    
    .dashboard-dot.active {
        background: var(--accent);
        width: 24px;
        border-radius: 4px;
    }
    
    /* AI COACH WIDGET */
    .ai-coach-widget {
        background: linear-gradient(135deg, #0a1a0a, #0a0a0a);
        border: 2px solid var(--accent);
        border-radius: 12px;
        padding: 16px;
        margin: 16px;
        box-shadow: 0 4px 20px rgba(0,255,153,0.1);
    }
    
    .ai-coach-message {
        font-size: 16px;
        line-height: 1.5;
        color: var(--text);
        font-weight: 600;
    }
    
    /* HR ZONE BAR */
    .hr-zone-sidebar {
        position: fixed;
        right: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 60px;
        height: 300px;
        background: rgba(0,0,0,0.8);
        border: 1px solid var(--border);
        border-radius: 12px 0 0 12px;
        display: flex;
        flex-direction: column;
        padding: 8px;
        z-index: 50;
    }
    
    .hr-zone-segment {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: 700;
        opacity: 0.3;
        transition: all 0.3s;
        border-radius: 6px;
        margin: 2px 0;
    }
    
    .hr-zone-segment.active {
        opacity: 1;
        transform: scale(1.1);
    }
    
    /* METRICS GRID */
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1px;
        background: #222;
        margin: 16px;
    }
    
    .metric-item {
        background: #0a0a0a;
        padding: 20px 16px;
        text-align: center;
    }
    
    .metric-label {
        font-size: 10px;
        color: #666;
        font-weight: 700;
        margin-bottom: 6px;
    }
    
    .metric-value {
        font-size: 28px;
        font-weight: 900;
        color: var(--text);
        font-variant-numeric: tabular-nums;
    }
    
    .metric-value.accent {
        color: var(--accent);
    }
    
    /* LARGE PRINT VIEW */
    .large-print-container {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100%;
        padding: 20px;
    }
    
    .large-print-metric {
        text-align: center;
        margin-bottom: 32px;
    }
    
    .large-print-label {
        font-size: 14px;
        color: #666;
        margin-bottom: 8px;
    }
    
    .large-print-value {
        font-size: 72px;
        font-weight: 900;
        line-height: 1;
        color: var(--accent);
    }
    
    /* BUILDER */
    .builder-mode-selector {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-bottom: 20px;
    }
    
    .builder-mode-btn {
        padding: 16px;
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text);
        font-size: 13px;
        font-weight: 700;
        text-align: center;
        cursor: pointer;
    }
    
    .builder-mode-btn.active {
        background: var(--accent);
        color: #000;
    }
    
    .builder-section {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 16px;
    }
    
    .builder-section-title {
        font-size: 11px;
        font-weight: 700;
        color: var(--accent);
        text-transform: uppercase;
        margin-bottom: 16px;
    }
    
    .builder-input-group {
        margin-bottom: 16px;
    }
    
    .builder-label {
        font-size: 12px;
        color: #666;
        margin-bottom: 6px;
        font-weight: 700;
    }
    
    .builder-input {
        width: 100%;
        background: #000;
        border: 1px solid var(--border);
        color: var(--text);
        padding: 12px;
        border-radius: 6px;
        font-size: 15px;
    }
    
    .builder-time-picker {
        display: flex;
        gap: 8px;
        align-items: center;
    }
    
    .builder-time-input {
        flex: 1;
        background: #000;
        border: 1px solid var(--border);
        color: var(--text);
        padding: 12px;
        border-radius: 6px;
        font-size: 18px;
        text-align: center;
        font-weight: 700;
    }
    
    .builder-toggle {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: #050505;
        border-radius: 6px;
        cursor: pointer;
        margin-bottom: 8px;
    }
    
    .builder-checkbox {
        width: 20px;
        height: 20px;
        border: 2px solid var(--border);
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #000;
    }
    
    .builder-checkbox.checked {
        background: var(--accent);
        border-color: var(--accent);
        color: #000;
    }
    
    .builder-interval-list {
        margin-top: 16px;
    }
    
    .builder-interval-item {
        background: #050505;
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 8px;
    }
    
    .builder-interval-item.editable {
        border-color: var(--accent);
        background: #0a0a0a;
    }
    
    .builder-interval-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .builder-interval-title {
        font-size: 13px;
        font-weight: 700;
    }
    
    .builder-interval-actions {
        display: flex;
        gap: 8px;
    }
    
    .builder-icon-btn {
        width: 32px;
        height: 32px;
        background: transparent;
        border: 1px solid var(--border);
        border-radius: 4px;
        color: var(--text);
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .builder-interval-edit {
        display: none;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid var(--border);
    }
    
    .builder-interval-item.editable .builder-interval-edit {
        display: block;
    }
    
    /* REVIEW SCREEN */
    .review-workout-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--accent);
        margin: 16px;
        text-align: center;
    }
    
    .review-interval {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 16px;
        margin: 12px 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .review-interval-info {
        flex: 1;
    }
    
    .review-interval-title {
        font-size: 15px;
        font-weight: 700;
        margin-bottom: 4px;
    }
    
    .review-interval-desc {
        font-size: 12px;
        color: #666;
    }
    
    .review-actions {
        padding: 16px;
        display: flex;
        gap: 12px;
    }
    
    .btn {
        width: 100%;
        padding: 16px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 700;
        text-transform: uppercase;
        cursor: pointer;
    }
    
    .btn-primary { background: var(--accent); color: #000; }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
    
    /* CARDS */
    .card {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 16px;
    }
    
    .card-header {
        font-size: 11px;
        font-weight: 700;
        color: var(--accent);
        text-transform: uppercase;
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border);
    }
    
    .editable-field {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-bottom: 12px;
    }
    
    .editable-label {
        font-size: 12px;
        color: #666;
        width: 80px;
    }
    
    .editable-input {
        flex: 1;
        background: #000;
        border: 1px solid var(--border);
        color: var(--text);
        padding: 10px;
        border-radius: 6px;
        font-size: 15px;
    }
    
    /* HISTORY */
    .history-item {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
        position: relative;
    }
    
    .history-delete {
        position: absolute;
        top: 12px;
        right: 12px;
        background: transparent;
        border: 1px solid var(--border);
        color: var(--danger);
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 700;
        cursor: pointer;
    }
    
    .history-date {
        font-size: 11px;
        color: #666;
        font-weight: 700;
        margin-bottom: 4px;
    }
    
    .history-title {
        font-size: 14px;
        font-weight: 700;
        color: var(--text);
        margin-bottom: 8px;
        padding-right: 60px;
    }
    
    .history-stats {
        display: flex;
        gap: 16px;
        font-size: 12px;
        color: var(--accent);
        font-family: monospace;
        flex-wrap: wrap;
    }
    
    /* STATS */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        margin-bottom: 16px;
    }
    
    .stat-item {
        background: #050505;
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 12px;
        text-align: center;
    }
    
    .stat-item-value {
        font-size: 20px;
        font-weight: 900;
        color: var(--accent);
    }
    
    .stat-item-label {
        font-size: 10px;
        color: #666;
        margin-top: 4px;
        text-transform: uppercase;
    }
    
    /* NAVIGATION */
    .nav-bar {
        background: var(--panel);
        border-top: 1px solid var(--border);
        display: flex;
        height: 70px;
        flex-shrink: 0;
    }
    
    .nav-item {
        flex: 1;
        background: transparent;
        border: none;
        color: #666;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 4px;
    }
    
    .nav-item.active {
        color: var(--accent);
        background: rgba(0,255,153,0.05);
    }
    
    .nav-icon { font-size: 20px; }
    
    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #666;
    }
    
    .empty-state-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
    }
    
    /* TRAINING PLAN */
    .plan-week {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 16px;
    }
    
    .plan-week-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }
    
    .plan-week-title {
        font-size: 14px;
        font-weight: 700;
        color: var(--accent);
    }
    
    .plan-week-focus {
        font-size: 11px;
        color: #666;
        text-transform: uppercase;
    }
    
    .plan-day {
        background: #050505;
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .plan-day-info {
        flex: 1;
    }
    
    .plan-day-title {
        font-size: 13px;
        font-weight: 700;
        color: var(--text);
        margin-bottom: 4px;
    }
    
    .plan-day-desc {
        font-size: 11px;
        color: #666;
    }
    
    .plan-day-status {
        font-size: 10px;
        padding: 4px 8px;
        border-radius: 12px;
        background: #222;
        color: #666;
    }
    
    .plan-day-status.completed {
        background: rgba(0,255,153,0.1);
        color: var(--accent);
    }
    
    /* CHAT MESSAGES */
    .chat-message {
        max-width: 85%;
        padding: 14px 18px;
        border-radius: 16px;
        line-height: 1.5;
        font-size: 15px;
        margin-bottom: 12px;
        animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .chat-message.user {
        background: #0d3a2e;
        border: 1px solid #1a4a3e;
        margin-left: auto;
        border-radius: 16px 16px 4px 16px;
    }
    
    .chat-message.ai {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-left: 3px solid var(--accent);
        border-radius: 16px 16px 16px 4px;
    }
    
    .chat-header {
        font-size: 11px;
        font-weight: 700;
        margin-bottom: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--accent);
    }
    
    .chat-message.user .chat-header {
        color: #00AAFF;
    }
    
    .quick-replies {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 12px;
    }
    
    .quick-reply-btn {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--text);
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
    }
    
    @keyframes typing {
        0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
        30% { transform: translateY(-10px); opacity: 1; }
    }
    
    /* MOBILE RESPONSIVE */
    @media (max-width: 768px) {
        .metrics-grid {
            gap: 2px;
            margin: 8px;
        }
        
        .metric-item {
            padding: 16px 12px;
        }
        
        .metric-value {
            font-size: 24px;
        }
        
        .large-print-value {
            font-size: 56px;
        }
        
        .ai-coach-widget {
            margin: 8px;
            padding: 12px;
        }
        
        .ai-coach-message {
            font-size: 14px;
        }
        
        .scroll-content {
            padding: 8px;
        }
        
        .card {
            padding: 16px;
        }
    }
</style>
```

</head>
<body>
    <div class="version-badge">v1.6 PRODUCTION</div>
    <div id="toast" class="toast"></div>

```
<!-- TOP NAVIGATION BAR -->
<nav class="top-nav-bar">
    <button class="top-nav-item" onclick="app.navigate('screenSettings')">
        <span class="top-nav-icon">‚öôÔ∏è</span>
        <span class="top-nav-label">Settings</span>
    </button>
    <button class="top-nav-item" onclick="app.navigate('screenHRM')">
        <span class="top-nav-icon">‚ù§Ô∏è</span>
        <span class="top-nav-label">HR Mon</span>
    </button>
    <button class="top-nav-item" style="opacity:0.3; cursor:not-allowed;">
        <span class="top-nav-icon">üìç</span>
        <span class="top-nav-label">TBD</span>
    </button>
    <button class="top-nav-item" style="opacity:0.3; cursor:not-allowed;">
        <span class="top-nav-icon">üìç</span>
        <span class="top-nav-label">TBD</span>
    </button>
</nav>

<!-- DASHBOARD SCREEN (SWIPEABLE) -->
<div id="screenDashboard" class="screen active">
    <div class="screen-header">
        <button class="header-btn" onclick="app.endWorkout()">End</button>
        <div class="screen-title">Rowing</div>
        <button class="header-btn" id="manualStartBtn" style="display:none; background:var(--accent); color:#000;" onclick="app.onFirstStroke()">Start</button>
    </div>
    
    <div class="dashboard-container" id="dashboardContainer">
        <div class="dashboard-carousel" id="dashboardCarousel">
            
            <!-- View 1: All Data -->
            <div class="dashboard-view">
                <div class="ai-coach-widget">
                    <div class="ai-coach-message" id="coachMessage">Start rowing to receive coaching!</div>
                </div>
                
                <div class="metrics-grid">
                    <div class="metric-item" style="grid-column:1/-1;">
                        <div class="metric-label">CURRENT PACE</div>
                        <div class="metric-value" id="pace1" style="font-size:48px;">0:00</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">TIME</div>
                        <div class="metric-value" id="time1">0:00</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">DISTANCE</div>
                        <div class="metric-value" id="dist1">0</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">WATTS</div>
                        <div class="metric-value accent" id="watts1">0</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">S/M</div>
                        <div class="metric-value accent" id="rate1">0</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">HEART RATE</div>
                        <div class="metric-value" style="color:#ff6b6b;" id="hr1">--</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">AVG PACE</div>
                        <div class="metric-value" id="avgPace1">0:00</div>
                    </div>
                </div>
            </div>
            
            <!-- View 2: Force Curve -->
            <div class="dashboard-view">
                <div style="padding:20px;">
                    <div style="font-size:12px; color:#666; text-align:center; margin-bottom:16px;">FORCE CURVE</div>
                    <canvas id="forceCanvas" style="width:100%; height:300px; background:#000; border-radius:8px;"></canvas>
                </div>
            </div>
            
            <!-- View 3: Paceboat -->
            <div class="dashboard-view">
                <div style="padding:20px;">
                    <div style="font-size:12px; color:#666; text-align:center; margin-bottom:16px;">PACEBOAT</div>
                    <canvas id="paceboatCanvas" style="width:100%; height:400px; background:#000; border-radius:8px;"></canvas>
                </div>
            </div>
            
            <!-- View 4: Bar Chart -->
            <div class="dashboard-view">
                <div style="padding:20px;">
                    <div style="font-size:12px; color:#666; text-align:center; margin-bottom:16px;">PACE OVER TIME</div>
                    <canvas id="barCanvas" style="width:100%; height:300px; background:#000; border-radius:8px;"></canvas>
                </div>
            </div>
            
            <!-- View 5: Large Print -->
            <div class="dashboard-view">
                <div class="large-print-container">
                    <div class="large-print-metric">
                        <div class="large-print-label">PACE</div>
                        <div class="large-print-value" id="paceLP">0:00</div>
                    </div>
                    <div class="large-print-metric">
                        <div class="large-print-label">DISTANCE</div>
                        <div class="large-print-value" id="distLP">0m</div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
    
    <!-- HR Zone Sidebar -->
    <div class="hr-zone-sidebar" id="hrSidebar" style="display:none;">
        <div class="hr-zone-segment" id="hrZ5" style="background:#dc143c;">Z5</div>
        <div class="hr-zone-segment" id="hrZ4" style="background:#ff6347;">Z4</div>
        <div class="hr-zone-segment" id="hrZ3" style="background:#ffa500;">Z3</div>
        <div class="hr-zone-segment" id="hrZ2" style="background:#50c878;">Z2</div>
        <div class="hr-zone-segment" id="hrZ1" style="background:#4a90e2;">Z1</div>
    </div>
    
    <div class="dashboard-dots">
        <div class="dashboard-dot active"></div>
        <div class="dashboard-dot"></div>
        <div class="dashboard-dot"></div>
        <div class="dashboard-dot"></div>
        <div class="dashboard-dot"></div>
    </div>
</div>

<!-- AI CHAT SCREEN -->
<div id="screenChat" class="screen">
    <div class="screen-header">
        <div class="screen-title">AI Coach</div>
    </div>
    <div style="display:flex; flex-direction:column; height:100%;">
        <div class="scroll-content" id="chatMessages" style="flex:1; padding-bottom:20px;">
            <!-- Chat messages will appear here -->
        </div>
        <div class="typing-indicator" id="typingIndicator" style="display:none; padding:16px;">
            <div style="display:flex; gap:4px;">
                <div style="width:8px; height:8px; background:var(--accent); border-radius:50%; animation:typing 1.4s infinite;"></div>
                <div style="width:8px; height:8px; background:var(--accent); border-radius:50%; animation:typing 1.4s infinite 0.2s;"></div>
                <div style="width:8px; height:8px; background:var(--accent); border-radius:50%; animation:typing 1.4s infinite 0.4s;"></div>
            </div>
        </div>
        <div style="position:sticky; bottom:0; border-top:1px solid var(--border); background:var(--panel); padding:12px; display:flex; gap:12px; align-items:flex-end;">
            <textarea 
                id="chatInput" 
                placeholder="Type your message..."
                style="flex:1; background:#0a0a0a; border:1px solid var(--border); color:var(--text); padding:12px; border-radius:20px; font-size:15px; font-family:inherit; resize:none; max-height:120px; min-height:44px;"
                onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault();app.sendMessage();}"
            ></textarea>
            <button onclick="app.sendMessage()" style="background:var(--accent); color:#000; border:none; width:44px; height:44px; border-radius:50%; font-size:20px; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0;">‚Üë</button>
        </div>
    </div>
</div>

<!-- BUILDER SCREEN -->
<div id="screenBuilder" class="screen">
    <div class="screen-header">
        <div class="screen-title">Manual Builder</div>
    </div>
    <div class="scroll-content">
        <div class="builder-mode-selector">
            <div class="builder-mode-btn active" onclick="app.selectBuilderMode('single-distance')">Single Distance</div>
            <div class="builder-mode-btn" onclick="app.selectBuilderMode('single-time')">Single Time</div>
            <div class="builder-mode-btn" onclick="app.selectBuilderMode('single-calorie')">Single Calorie</div>
            <div class="builder-mode-btn" onclick="app.selectBuilderMode('fixed-intervals')">Fixed Intervals</div>
            <div class="builder-mode-btn" onclick="app.selectBuilderMode('variable-intervals')">Variable Intervals</div>
        </div>
        
        <div class="builder-section">
            <div class="builder-section-title">Global Targets (Optional)</div>
            
            <div class="builder-toggle" onclick="app.toggleBuilderTarget('splitPace')">
                <div class="builder-checkbox" id="splitPaceCheckbox"></div>
                <div style="flex:1; font-size:13px; font-weight:700;">Target Split /500m</div>
            </div>
            <div id="splitPaceInputs" style="display:none; margin-left:32px; margin-bottom:16px;">
                <div class="builder-label">Split Pace (e.g., 1:55.0)</div>
                <input type="text" class="builder-input" placeholder="1:55.0" id="splitPaceValue">
            </div>
            
            <div class="builder-toggle" onclick="app.toggleBuilderTarget('pacer')">
                <div class="builder-checkbox" id="pacerCheckbox"></div>
                <div style="flex:1; font-size:13px; font-weight:700;">Show Pacer</div>
            </div>
            <div id="pacerInputs" style="display:none; margin-left:32px; margin-bottom:16px;">
                <select class="builder-input" style="margin-bottom:8px;" id="pacerMetric">
                    <option value="pace">Pace /500m</option>
                    <option value="watts">Watts</option>
                    <option value="calhr">Cal/hr</option>
                </select>
                <input type="text" class="builder-input" placeholder="Target value" id="pacerValue">
            </div>
            
            <div class="builder-toggle" onclick="app.toggleBuilderTarget('strokeRate')">
                <div class="builder-checkbox" id="strokeRateCheckbox"></div>
                <div style="flex:1; font-size:13px; font-weight:700;">Target Stroke Rate</div>
            </div>
            <div id="strokeRateInputs" style="display:none; margin-left:32px; margin-bottom:16px;">
                <input type="number" class="builder-input" placeholder="s/m (e.g., 26)" id="strokeRateValue">
            </div>
            
            <div class="builder-toggle" onclick="app.toggleBuilderTarget('heartRate')">
                <div class="builder-checkbox" id="heartRateCheckbox"></div>
                <div style="flex:1; font-size:13px; font-weight:700;">Target Heart Rate Zone</div>
            </div>
            <div id="heartRateInputs" style="display:none; margin-left:32px; margin-bottom:16px;">
                <select class="builder-input" id="heartRateZone">
                    <option value="1">Zone 1 (Recovery)</option>
                    <option value="2">Zone 2 (Endurance)</option>
                    <option value="3">Zone 3 (Tempo)</option>
                    <option value="4">Zone 4 (Threshold)</option>
                    <option value="5">Zone 5 (Max)</option>
                </select>
            </div>
        </div>
        
        <div id="builderModeContent"></div>
        
        <button class="btn btn-primary" onclick="app.saveManualWorkout()">Review Workout</button>
    </div>
</div>

<!-- REVIEW SCREEN -->
<div id="screenReview" class="screen">
    <div class="screen-header">
        <button class="header-btn" onclick="app.navigate('screenBuilder')">‚Üê Back</button>
        <div class="screen-title">Review Workout</div>
    </div>
    <div class="scroll-content">
        <div class="review-workout-title" id="reviewTitle">Your Workout</div>
        <div id="reviewIntervals"></div>
        <div class="review-actions">
            <button class="btn btn-outline" onclick="app.navigate('screenBuilder')" style="flex:1;">‚Üê Back</button>
            <button class="btn btn-primary" onclick="app.startWorkout()" style="flex:2;">üö£ Start Row</button>
        </div>
    </div>
</div>

<!-- HEART RATE MONITOR SCREEN -->
<div id="screenHRM" class="screen">
    <div class="screen-header">
        <div class="screen-title">Heart Rate Monitor</div>
    </div>
    <div class="scroll-content">
        <!-- Connection Card -->
        <div style="background:linear-gradient(135deg, #1a0a0a 0%, #0a0a0a 100%); border:2px solid #ff6b6b; border-radius:12px; padding:20px; margin-bottom:20px;">
            <div style="display:flex; align-items:center; gap:12px; margin-bottom:16px;">
                <div style="font-size:32px;">‚ù§Ô∏è</div>
                <div style="flex:1;">
                    <div style="font-size:14px; font-weight:700; color:#ff6b6b;" id="hrmStatusText">Not Connected</div>
                    <div style="font-size:12px; color:#666; margin-top:4px;" id="hrmStatusDesc">Connect your Polar/Garmin/Wahoo HRM</div>
                </div>
            </div>
            <button class="btn btn-primary" style="background:#ff6b6b;" id="hrmConnectButton" onclick="app.connectHRMDirect()">
                Connect Heart Rate Monitor
            </button>
        </div>

        <!-- Live Display (Hidden until connected) -->
        <div id="hrmLiveDisplay" style="display:none; background:var(--card-bg); border:2px solid #ff6b6b; border-radius:12px; padding:20px; text-align:center; margin-bottom:20px;">
            <div style="font-size:72px; font-weight:900; color:#ff6b6b; line-height:1; margin-bottom:8px; font-variant-numeric:tabular-nums;" id="hrmCurrentBPM">--</div>
            <div style="font-size:11px; color:#666; text-transform:uppercase; letter-spacing:1px;">BEATS PER MINUTE</div>
            
            <div style="margin-top:16px; padding:12px; background:#050505; border-radius:8px;">
                <div style="font-size:10px; color:#666; text-transform:uppercase; margin-bottom:6px;">TRAINING ZONE</div>
                <div style="display:flex; height:40px; border-radius:8px; overflow:hidden;">
                    <div id="hrZone1Display" style="flex:1; background:#4a90e2; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700; opacity:0.3; transition:all 0.3s;">Z1</div>
                    <div id="hrZone2Display" style="flex:1; background:#50c878; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700; opacity:0.3; transition:all 0.3s;">Z2</div>
                    <div id="hrZone3Display" style="flex:1; background:#ffa500; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700; opacity:0.3; transition:all 0.3s;">Z3</div>
                    <div id="hrZone4Display" style="flex:1; background:#ff6347; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700; opacity:0.3; transition:all 0.3s;">Z4</div>
                    <div id="hrZone5Display" style="flex:1; background:#dc143c; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700; opacity:0.3; transition:all 0.3s;">Z5</div>
                </div>
            </div>
        </div>

        <!-- Graph -->
        <div id="hrmGraphContainer" style="display:none; background:var(--card-bg); border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:20px;">
            <div style="font-size:11px; color:#666; text-transform:uppercase; margin-bottom:12px; text-align:center;">Heart Rate Over Time</div>
            <canvas id="hrmCanvas" style="width:100%; height:200px; background:#000; border-radius:8px;"></canvas>
            
            <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:12px; margin-top:16px;">
                <div style="text-align:center;">
                    <div style="font-size:20px; font-weight:900; color:#ff6b6b;" id="hrmAvg">--</div>
                    <div style="font-size:9px; color:#666; text-transform:uppercase; margin-top:4px;">Average</div>
                </div>
                <div style="text-align:center;">
                    <div style="font-size:20px; font-weight:900; color:#ff6b6b;" id="hrmMax">--</div>
                    <div style="font-size:9px; color:#666; text-transform:uppercase; margin-top:4px;">Max</div>
                </div>
                <div style="text-align:center;">
                    <div style="font-size:20px; font-weight:900; color:#ff6b6b;" id="hrmMin">--</div>
                    <div style="font-size:9px; color:#666; text-transform:uppercase; margin-top:4px;">Min</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- TRAINING PLAN SCREEN -->
<div id="screenPlan" class="screen">
    <div class="screen-header">
        <div class="screen-title">Training Plan</div>
        <button class="header-btn" onclick="app.generateNewPlan()">+ New Plan</button>
    </div>
    <div class="scroll-content" id="planContent">
        <div class="empty-state">
            <div class="empty-state-icon">üìÖ</div>
            <div style="font-size:14px; line-height:1.6;">
                No training plan yet.<br>
                Chat with AI to create a 4-week plan.
            </div>
        </div>
    </div>
</div>

<!-- HISTORY SCREEN -->
<div id="screenHistory" class="screen">
    <div class="screen-header">
        <div class="screen-title">History (<span id="historyCount">0</span>)</div>
    </div>
    <div class="scroll-content">
        <div class="card">
            <div class="card-header">Database Summary</div>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-item-value" id="totalWorkouts">0</div>
                    <div class="stat-item-label">Workouts</div>
                </div>
                <div class="stat-item">
                    <div class="stat-item-value" id="totalDistance">0</div>
                    <div class="stat-item-label">Total Meters</div>
                </div>
            </div>
        </div>
        <div id="historyList"></div>
    </div>
</div>

<!-- SETTINGS SCREEN -->
<div id="screenSettings" class="screen">
    <div class="screen-header">
        <div class="screen-title">Settings</div>
    </div>
    <div class="scroll-content">
        <div class="card">
            <div class="card-header">User Profile</div>
            
            <div class="editable-field">
                <div class="editable-label">Name</div>
                <input type="text" class="editable-input" id="editName" placeholder="Your name">
            </div>
            
            <div class="editable-field">
                <div class="editable-label">Age</div>
                <input type="number" class="editable-input" id="editAge" placeholder="30">
            </div>
            
            <div class="editable-field">
                <div class="editable-label">Weight (kg)</div>
                <input type="number" class="editable-input" id="editWeight" placeholder="75">
            </div>
            
            <div style="display:flex; gap:12px; margin-top:16px;">
                <button class="btn btn-primary" onclick="app.saveProfile()">Save Profile</button>
                <button class="btn btn-outline" onclick="app.loadProfile()">Cancel</button>
            </div>
        </div>

        <div class="card">
            <div class="card-header">Heart Rate Zones</div>
            <div style="font-size:12px; color:#888; margin-bottom:16px;">Configure your training zones based on max HR</div>
            
            <div class="editable-field">
                <div class="editable-label">Max Heart Rate</div>
                <input type="number" class="editable-input" id="editMaxHR" placeholder="190">
            </div>
            
            <div style="margin-top:16px; padding:16px; background:#050505; border-radius:8px;">
                <div style="font-size:11px; color:#666; text-transform:uppercase; margin-bottom:12px;">Zones Preview</div>
                <div style="display:flex; flex-direction:column; gap:8px;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <div style="width:40px; height:30px; background:#4a90e2; border-radius:4px; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700;">Z1</div>
                        <div style="flex:1; font-size:12px;">
                            <div style="color:#e0e0e0;">Recovery (50-60%)</div>
                            <div style="color:#666; font-size:11px;" id="zone1Range">95-114 bpm</div>
                        </div>
                    </div>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <div style="width:40px; height:30px; background:#50c878; border-radius:4px; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700;">Z2</div>
                        <div style="flex:1; font-size:12px;">
                            <div style="color:#e0e0e0;">Aerobic (60-70%)</div>
                            <div style="color:#666; font-size:11px;" id="zone2Range">114-133 bpm</div>
                        </div>
                    </div>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <div style="width:40px; height:30px; background:#ffa500; border-radius:4px; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700;">Z3</div>
                        <div style="flex:1; font-size:12px;">
                            <div style="color:#e0e0e0;">Tempo (70-80%)</div>
                            <div style="color:#666; font-size:11px;" id="zone3Range">133-152 bpm</div>
                        </div>
                    </div>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <div style="width:40px; height:30px; background:#ff6347; border-radius:4px; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700;">Z4</div>
                        <div style="flex:1; font-size:12px;">
                            <div style="color:#e0e0e0;">Threshold (80-90%)</div>
                            <div style="color:#666; font-size:11px;" id="zone4Range">152-171 bpm</div>
                        </div>
                    </div>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <div style="width:40px; height:30px; background:#dc143c; border-radius:4px; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700;">Z5</div>
                        <div style="flex:1; font-size:12px;">
                            <div style="color:#e0e0e0;">Max (90-100%)</div>
                            <div style="color:#666; font-size:11px;" id="zone5Range">171-190 bpm</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="display:flex; gap:12px; margin-top:16px;">
                <button class="btn btn-primary" onclick="app.saveHRZones()">Save Zones</button>
                <button class="btn btn-outline" onclick="app.loadHRZones()">Reset</button>
            </div>
        </div>

        <div class="card">
            <div class="card-header">Firebase Cloud Storage</div>
            <div style="margin-bottom:12px;">
                <div style="font-size:12px; color:#666; margin-bottom:4px;">User ID</div>
                <div style="color:#e0e0e0; font-size:14px; font-family:monospace; word-break:break-all;" id="firebaseUserId">Loading...</div>
            </div>
            <div style="margin-bottom:12px;">
                <div style="font-size:12px; color:#666; margin-bottom:4px;">Status</div>
                <div style="color:#e0e0e0; font-size:14px;" id="firebaseStatus">Checking...</div>
            </div>
            <button class="btn btn-outline" onclick="app.testFirebaseSync()">
                Test Cloud Sync
            </button>
            <div style="margin-top:12px; padding:12px; background:rgba(0,255,153,0.05); border:1px solid var(--accent); border-radius:8px; font-size:11px; color:#ccc;">
                üí° <strong>Test without clearing cache:</strong> Click "Test Cloud Sync" to verify your data is saving to Firebase. Check console (F12) for detailed logs.
            </div>
        </div>

        <div class="card">
            <div class="card-header">Connect Devices</div>
            <div style="font-size:12px; color:#888; margin-bottom:16px;">Connect PM5 and Heart Rate Monitor via Bluetooth</div>
            
            <!-- PM5 Connection -->
            <div style="background:#050505; border:1px solid var(--border); border-radius:8px; padding:16px; margin-bottom:16px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <div>
                        <div style="font-size:14px; font-weight:700; margin-bottom:4px;">Concept2 PM5</div>
                        <div style="font-size:12px; color:#666;" id="pm5StatusSettings">Not connected</div>
                    </div>
                    <div style="width:12px; height:12px; border-radius:50%; background:#666;" id="pm5IndicatorSettings"></div>
                </div>
                <button class="btn btn-primary" onclick="app.connectPM5()" id="pm5ConnectBtnSettings">Connect PM5</button>
            </div>
            
            <!-- HRM Connection -->
            <div style="background:#050505; border:1px solid var(--border); border-radius:8px; padding:16px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <div>
                        <div style="font-size:14px; font-weight:700; margin-bottom:4px;">Heart Rate Monitor</div>
                        <div style="font-size:12px; color:#666;" id="hrmStatusSettings">Not connected</div>
                    </div>
                    <div style="width:12px; height:12px; border-radius:50%; background:#666;" id="hrmIndicatorSettings"></div>
                </div>
                <button class="btn btn-outline" onclick="app.connectHRM()" id="hrmConnectBtnSettings">Connect HRM</button>
            </div>
            
            <div style="margin-top:16px; padding:12px; background:rgba(0,255,153,0.05); border:1px solid var(--accent); border-radius:8px; font-size:11px; color:#ccc;">
                üí° <strong>Tip:</strong> Connect PM5 first for rowing data, then connect HRM for heart rate monitoring.
            </div>
        </div>

        <div class="card">
            <div class="card-header">Import Data</div>
            <label for="csvUpload" style="display:block; width:100%; padding:16px; border:2px dashed #222; border-radius:8px; text-align:center; cursor:pointer; color:#888;">
                üìÅ Import CSV
            </label>
            <input type="file" id="csvUpload" accept=".csv" style="display:none;" onchange="app.importCSV(event)">
        </div>
    </div>
</div>

<!-- Navigation -->
<nav class="nav-bar">
    <button class="nav-item" onclick="app.navigate('screenChat')">
        <span class="nav-icon">ü§ñ</span>
        AI Chat
    </button>
    <button class="nav-item active" onclick="app.navigate('screenDashboard')">
        <span class="nav-icon">üö£</span>
        Row
    </button>
    <button class="nav-item" onclick="app.navigate('screenBuilder')">
        <span class="nav-icon">üîß</span>
        Builder
    </button>
    <button class="nav-item" onclick="app.navigate('screenPlan')">
        <span class="nav-icon">üìÖ</span>
        Plan
    </button>
    <button class="nav-item" onclick="app.navigate('screenHistory')">
        <span class="nav-icon">üìä</span>
        History
    </button>
</nav>

<!-- DEVICES MODAL -->
<div id="devicesModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:10000; padding:20px;">
    <div style="max-width:500px; margin:80px auto; background:var(--card-bg); border:1px solid var(--border); border-radius:12px; padding:20px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="font-size:18px; font-weight:700; color:var(--accent);">Connect Devices</h2>
            <button onclick="app.closeDevicesModal()" style="background:transparent; border:none; color:#666; font-size:24px; cursor:pointer;">√ó</button>
        </div>
        
        <!-- PM5 Connection -->
        <div style="background:#050505; border:1px solid var(--border); border-radius:8px; padding:16px; margin-bottom:16px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <div>
                    <div style="font-size:15px; font-weight:700; margin-bottom:4px;">Concept2 PM5</div>
                    <div style="font-size:12px; color:#666;" id="pm5Status">Not connected</div>
                </div>
                <div style="width:12px; height:12px; border-radius:50%; background:#666;" id="pm5Indicator"></div>
            </div>
            <button class="btn btn-primary" onclick="app.connectPM5()" id="pm5ConnectBtn">Connect PM5</button>
        </div>
        
        <!-- HRM Connection -->
        <div style="background:#050505; border:1px solid var(--border); border-radius:8px; padding:16px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <div>
                    <div style="font-size:15px; font-weight:700; margin-bottom:4px;">Heart Rate Monitor</div>
                    <div style="font-size:12px; color:#666;" id="hrmStatus">Not connected</div>
                </div>
                <div style="width:12px; height:12px; border-radius:50%; background:#666;" id="hrmIndicator"></div>
            </div>
            <button class="btn btn-outline" onclick="app.connectHRM()" id="hrmConnectBtn">Connect HRM</button>
        </div>
        
        <div style="margin-top:20px; padding:12px; background:rgba(0,255,153,0.05); border:1px solid var(--accent); border-radius:8px; font-size:12px; color:#ccc;">
            üí° <strong>Tip:</strong> Connect PM5 first, then connect your chest strap HRM if you want separate HR monitoring.
        </div>
    </div>
</div>

<script>
    // ========================================================================
    // FIREBASE CONFIGURATION
    // ========================================================================
    
    // Set to true to enable Firebase cloud storage
    const FIREBASE_ENABLED = true;
    
    // ========================================================================
    // STORAGE ABSTRACTION LAYER
    // ========================================================================
    
    class DataStore {
        constructor() {
            this.userId = null;
            this.isFirebase = FIREBASE_ENABLED;
        }
        
        async init() {
            if (this.isFirebase) {
                // Wait for Firebase modules to load
                await new Promise(resolve => {
                    const checkInterval = setInterval(() => {
                        if (window.firebaseAuth && window.firebaseDb && window.firebaseModules) {
                            clearInterval(checkInterval);
                            resolve();
                        }
                    }, 100);
                });
                
                // Initialize Firebase
                try {
                    const { signInAnonymously, onAuthStateChanged } = window.firebaseModules;
                    const auth = window.firebaseAuth;
                    
                    // Sign in anonymously
                    const result = await signInAnonymously(auth);
                    this.userId = result.user.uid;
                    
                    console.log('‚úì Firebase initialized. User ID:', this.userId);
                    
                    // Listen for auth state changes
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            this.userId = user.uid;
                            console.log('‚úì User authenticated:', this.userId);
                        }
                    });
                } catch (error) {
                    console.error('‚ùå Firebase init error:', error);
                    this.isFirebase = false; // Fallback to localStorage
                }
            } else {
                // localStorage fallback
                this.userId = localStorage.getItem('anonymous_user_id');
                if (!this.userId) {
                    this.userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('anonymous_user_id', this.userId);
                }
                console.log('‚úì localStorage mode. User ID:', this.userId);
            }
        }
        
        async saveProfile(profile) {
            if (this.isFirebase) {
                const { doc, setDoc, serverTimestamp } = window.firebaseModules;
                const db = window.firebaseDb;
                
                await setDoc(doc(db, 'users', this.userId), {
                    profile: profile,
                    updatedAt: serverTimestamp()
                }, { merge: true });
                
                console.log('‚úì Profile saved to Firebase');
            } else {
                localStorage.setItem('rowing_coach_profile_v1', JSON.stringify(profile));
            }
        }
        
        async loadProfile() {
            if (this.isFirebase) {
                const { doc, getDoc } = window.firebaseModules;
                const db = window.firebaseDb;
                
                const docSnap = await getDoc(doc(db, 'users', this.userId));
                return docSnap.exists() ? docSnap.data().profile : null;
            } else {
                const data = localStorage.getItem('rowing_coach_profile_v1');
                return data ? JSON.parse(data) : null;
            }
        }
        
        async saveWorkout(workout) {
            if (this.isFirebase) {
                const { doc, setDoc } = window.firebaseModules;
                const db = window.firebaseDb;
                
                await setDoc(doc(db, 'users', this.userId, 'workouts', workout.id), workout);
                console.log('‚úì Workout saved to Firebase:', workout.id);
            } else {
                const workouts = await this.loadWorkouts();
                const existing = workouts.findIndex(w => w.id === workout.id);
                if (existing >= 0) {
                    workouts[existing] = workout;
                } else {
                    workouts.push(workout);
                }
                localStorage.setItem('rowing_coach_workouts_v1', JSON.stringify(workouts));
            }
        }
        
        async loadWorkouts() {
            if (this.isFirebase) {
                const { collection, query, orderBy, getDocs } = window.firebaseModules;
                const db = window.firebaseDb;
                
                const q = query(
                    collection(db, 'users', this.userId, 'workouts'),
                    orderBy('date', 'desc')
                );
                
                const snapshot = await getDocs(q);
                const workouts = snapshot.docs.map(doc => doc.data());
                
                console.log(`‚úì Loaded ${workouts.length} workouts from Firebase`);
                return workouts;
            } else {
                const data = localStorage.getItem('rowing_coach_workouts_v1');
                return data ? JSON.parse(data) : [];
            }
        }
        
        async deleteWorkout(workoutId) {
            if (this.isFirebase) {
                const { doc, deleteDoc } = window.firebaseModules;
                const db = window.firebaseDb;
                
                await deleteDoc(doc(db, 'users', this.userId, 'workouts', workoutId));
                console.log('‚úì Workout deleted from Firebase:', workoutId);
            } else {
                const workouts = await this.loadWorkouts();
                const filtered = workouts.filter(w => w.id !== workoutId);
                localStorage.setItem('rowing_coach_workouts_v1', JSON.stringify(filtered));
            }
        }
        
        async saveChat(messages) {
            if (this.isFirebase) {
                const { doc, setDoc, serverTimestamp } = window.firebaseModules;
                const db = window.firebaseDb;
                
                await setDoc(doc(db, 'users', this.userId), {
                    chatHistory: messages,
                    chatUpdatedAt: serverTimestamp()
                }, { merge: true });
            } else {
                localStorage.setItem('rowing_coach_chat_v1', JSON.stringify(messages));
            }
        }
        
        async loadChat() {
            if (this.isFirebase) {
                const { doc, getDoc } = window.firebaseModules;
                const db = window.firebaseDb;
                
                const docSnap = await getDoc(doc(db, 'users', this.userId));
                return docSnap.exists() ? (docSnap.data().chatHistory || []) : [];
            } else {
                const data = localStorage.getItem('rowing_coach_chat_v1');
                return data ? JSON.parse(data) : [];
            }
        }
    }
    
    const STORAGE_KEYS = {
        PROFILE: 'rowing_coach_profile_v1',
        WORKOUTS: 'rowing_coach_workouts_v1'
    };

    // PM5 Bluetooth Services (Concept2 specific)
    // Primary service for rowing data
    const PM5_SERVICE_UUID = '00001826-0000-1000-8000-00805f9b34fb'; // Fitness Machine Service
    const PM5_ROWING_SERVICE = 'ce060030-43e5-11e4-916c-0800200c9a66'; // Concept2 PM Service
    const PM5_CHARACTERISTIC_UUID = '00002ad2-0000-1000-8000-00805f9b34fb'; // Rowing Data
    const PM5_DEVICE_INFO = '0000180a-0000-1000-8000-00805f9b34fb'; // Device Info

    class AIRowingCoach {
        constructor() {
            this.dataStore = new DataStore();
            this.profile = null;
            this.workouts = [];
            this.chatHistory = [];
            this.trainingPlan = null;
            this.currentView = 0;
            this.builderMode = 'single-distance';
            this.builderTargets = { splitPace: false, pacer: false, strokeRate: false, heartRate: false };
            this.builderIntervals = [];
            this.editingInterval = -1;
            this.reviewWorkout = null;
            this.activeWorkout = null;
            this.workoutTimer = null;
            this.isCountingDown = false;
            this.waitingForFirstStroke = false;
            this.workoutTimeRemaining = 0;
            this.workoutTimeTotal = 0;
            
            // Rowing data
            this.liveData = { time: 0, dist: 0, pace: 0, watts: 0, rate: 0, hr: 0 };
            this.paceHistory = [];
            
            // PM5 & HRM
            this.pm5Device = null;
            this.pm5Characteristic = null;
            this.hrmDevice = null;
            this.hrmCharacteristic = null;
            
            this.init();
        }

        async init() {
            // Initialize storage (Firebase or localStorage)
            await this.dataStore.init();
            
            await this.loadData();
            this.loadProfile();
            this.setupDashboardSwipe();
            this.renderBuilderMode();
            this.renderHistory();
            this.updateStats();
            this.renderChat();
            
            // Chat input auto-resize
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('input', () => {
                    chatInput.style.height = 'auto';
                    chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
                });
            }
            
            // Welcome message if no chat history
            if (this.chatHistory.length === 0) {
                this.addChatMessage('ai', 'Hey! ü§ñ I\'m Coach, your AI rowing assistant.\n\nI can help you:\n‚Ä¢ Create custom workouts\n‚Ä¢ Build training plans\n‚Ä¢ Analyze your performance\n‚Ä¢ Answer rowing questions\n\nWhat would you like to do?', ['Create workout', 'Build 4-week plan', 'Analyze my data']);
            }
        }

        async loadData() {
            try {
                this.profile = await this.dataStore.loadProfile();
                this.workouts = await this.dataStore.loadWorkouts();
                this.chatHistory = await this.dataStore.loadChat();
                
                console.log(`‚úì Loaded ${this.workouts.length} workouts`);
            } catch (error) {
                console.error('Load error:', error);
            }
        }

        async saveData() {
            try {
                if (this.profile) {
                    await this.dataStore.saveProfile(this.profile);
                }
                await this.dataStore.saveChat(this.chatHistory);
                // Note: Workouts saved individually via saveWorkout()
            } catch (error) {
                console.error('Save error:', error);
            }
        }

        // ========================================================================
        // CHAT FUNCTIONALITY
        // ========================================================================

        async sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            this.addChatMessage('user', message);
            input.value = '';
            input.style.height = 'auto';

            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.style.display = 'flex';
            }

            await this.sleep(800);

            if (typingIndicator) {
                typingIndicator.style.display = 'none';
            }

            this.processMessage(message);
        }

        processMessage(message) {
            const lower = message.toLowerCase();
            
            // Workout creation
            if (lower.includes('workout') || lower.includes('interval') || lower.includes('create')) {
                this.addChatMessage('ai', 'I can help you create a workout! You have two options:\n\n1. **Tell me what you want** (e.g., "6x500m with 2min rest")\n2. **Use the Manual Builder** for precise control\n\nWhat would you like?', ['Use Manual Builder', '6x500m intervals', '30min steady']);
                return;
            }
            
            // Training plan
            if (lower.includes('plan') || lower.includes('4-week') || lower.includes('training')) {
                this.generateTrainingPlan();
                this.addChatMessage('ai', 'Perfect! I\'ve created a personalized 4-week training plan tailored to your goals.\n\nCheck the **Plan** tab to see your full schedule.\n\nThis is a progressive program:\n‚Ä¢ Week 1: Base building\n‚Ä¢ Week 2: Intensity increase\n‚Ä¢ Week 3: Peak volume\n‚Ä¢ Week 4: Taper & test', ['View Plan']);
                return;
            }
            
            // Data analysis
            if (lower.includes('analyze') || lower.includes('performance') || lower.includes('progress')) {
                const totalWorkouts = this.workouts.length;
                const totalDist = this.workouts.reduce((sum, w) => sum + (w.distance || 0), 0);
                
                this.addChatMessage('ai', `Here's your training summary:\n\nüìä **Total Workouts:** ${totalWorkouts}\nüìè **Total Distance:** ${Math.floor(totalDist/1000)}km\n\n${totalWorkouts > 0 ? 'You\'re making great progress! Keep it up! üí™' : 'Import your CSV to see detailed analysis.'}`, ['Import CSV', 'View History']);
                return;
            }
            
            // Builder redirect
            if (lower.includes('builder') || lower.includes('manual')) {
                this.addChatMessage('ai', 'Taking you to the Manual Builder...', null);
                setTimeout(() => this.navigate('screenBuilder'), 500);
                return;
            }
            
            // Profile updates
            if (lower.includes('weight') && (lower.includes('change') || lower.includes('update'))) {
                const match = message.match(/(\d+)\s*kg/i);
                if (match) {
                    const newWeight = parseInt(match[1]);
                    if (this.profile) {
                        this.profile.weight = newWeight;
                        this.saveData();
                        this.loadProfile();
                        this.addChatMessage('ai', `‚úì Updated your weight to ${newWeight}kg!`, null);
                        return;
                    }
                }
            }
            
            // Default helpful response
            this.addChatMessage('ai', 'I can help with:\n\nüèãÔ∏è **Create Workouts** - Custom intervals or steady state\nüìÖ **Training Plans** - 4-week periodized programs\nüìä **Performance Analysis** - Track your progress\n‚öôÔ∏è **Settings** - Update your profile\n\nWhat would you like to do?', ['Create workout', 'Build plan', 'View history']);
        }

        addChatMessage(sender, text, quickReplies = null) {
            const msg = {
                sender: sender,
                text: text,
                quickReplies: quickReplies,
                timestamp: new Date().toISOString()
            };

            this.chatHistory.push(msg);
            this.saveData();
            this.renderChat();
        }

        renderChat() {
            const container = document.getElementById('chatMessages');
            if (!container) return;
            
            const html = this.chatHistory.map((msg) => {
                const isUser = msg.sender === 'user';
                
                let quickRepliesHtml = '';
                if (msg.quickReplies && msg.quickReplies.length > 0) {
                    quickRepliesHtml = `
                        <div class="quick-replies">
                            ${msg.quickReplies.map(reply => {
                                let onclick = `app.handleQuickReply('${reply.replace(/'/g, "\\'")}')`;
                                
                                if (reply === 'Use Manual Builder') onclick = `app.navigate('screenBuilder')`;
                                if (reply === 'Import CSV') onclick = `app.navigate('screenSettings')`;
                                if (reply === 'View History') onclick = `app.navigate('screenHistory')`;
                                
                                return `<button class="quick-reply-btn" onclick="${onclick}">${reply}</button>`;
                            }).join('')}
                        </div>
                    `;
                }
                
                const formattedText = msg.text
                    .replace(/\n/g, '<br>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/‚Ä¢ /g, '‚Ä¢ ');
                
                return `
                    <div class="chat-message ${isUser ? 'user' : 'ai'}">
                        <div class="chat-header">
                            ${isUser ? 'üë§ You' : 'ü§ñ Coach'}
                        </div>
                        ${formattedText}
                        ${quickRepliesHtml}
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
            
            // Scroll to bottom
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }

        handleQuickReply(text) {
            const input = document.getElementById('chatInput');
            if (input) {
                // Special navigation handlers
                if (text === 'View Plan') {
                    this.navigate('screenPlan');
                    return;
                }
                if (text === 'Use Manual Builder') {
                    this.navigate('screenBuilder');
                    return;
                }
                if (text === 'Import CSV') {
                    this.navigate('screenSettings');
                    return;
                }
                if (text === 'View History') {
                    this.navigate('screenHistory');
                    return;
                }
                
                // Default: type and send
                input.value = text;
                this.sendMessage();
            }
        }

        sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ========================================================================
        // DEVICES MODAL
        // ========================================================================

        openDevicesModal() {
            document.getElementById('devicesModal').style.display = 'block';
        }

        closeDevicesModal() {
            document.getElementById('devicesModal').style.display = 'none';
        }

        // ========================================================================
        // PM5 CONNECTION
        // ========================================================================

        async connectPM5() {
            const btn = document.getElementById('pm5ConnectBtn');
            const status = document.getElementById('pm5Status');
            const indicator = document.getElementById('pm5Indicator');
            
            // Also update Settings card elements
            const btnSettings = document.getElementById('pm5ConnectBtnSettings');
            const statusSettings = document.getElementById('pm5StatusSettings');
            const indicatorSettings = document.getElementById('pm5IndicatorSettings');
            
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Connecting...';
            }
            if (btnSettings) {
                btnSettings.disabled = true;
                btnSettings.textContent = 'Connecting...';
            }
            if (status) status.textContent = 'Searching for PM5...';
            if (statusSettings) statusSettings.textContent = 'Searching for PM5...';
            
            try {
                console.log('üîç Requesting PM5 device...');
                console.log('üí° Make sure PM5 is on and showing "Ready" or "Waiting"');
                
                // Try to find PM5 - use acceptAllDevices with optionalServices as fallback
                let deviceOptions;
                try {
                    // First try: Look for Concept2 PM service
                    deviceOptions = {
                        filters: [{ services: [PM5_ROWING_SERVICE] }],
                        optionalServices: [PM5_SERVICE_UUID, PM5_DEVICE_INFO]
                    };
                    this.pm5Device = await navigator.bluetooth.requestDevice(deviceOptions);
                } catch (e) {
                    console.log('‚ö†Ô∏è Concept2 service not advertised, trying standard Fitness Machine...');
                    // Second try: Standard Fitness Machine service
                    deviceOptions = {
                        filters: [{ services: [PM5_SERVICE_UUID] }],
                        optionalServices: [PM5_ROWING_SERVICE, PM5_DEVICE_INFO]
                    };
                    this.pm5Device = await navigator.bluetooth.requestDevice(deviceOptions);
                }
                
                console.log(`‚úì Found device: ${this.pm5Device.name}`);
                if (status) status.textContent = `Connecting to ${this.pm5Device.name}...`;
                if (statusSettings) statusSettings.textContent = `Connecting to ${this.pm5Device.name}...`;
                
                const server = await this.pm5Device.gatt.connect();
                console.log('‚úì GATT connected');
                
                // Try Concept2 service first
                let service;
                try {
                    service = await server.getPrimaryService(PM5_ROWING_SERVICE);
                    console.log('‚úì Using Concept2 PM service');
                } catch (e) {
                    console.log('‚ö†Ô∏è Concept2 service not found, trying Fitness Machine service...');
                    service = await server.getPrimaryService(PM5_SERVICE_UUID);
                    console.log('‚úì Using Fitness Machine service');
                }
                
                this.pm5Characteristic = await service.getCharacteristic(PM5_CHARACTERISTIC_UUID);
                console.log('‚úì Characteristic found');
                
                await this.pm5Characteristic.startNotifications();
                this.pm5Characteristic.addEventListener('characteristicvaluechanged', (e) => {
                    this.handlePM5Data(e.target.value);
                });
                
                console.log('‚úì PM5 connected and streaming data');
                
                if (status) status.textContent = `Connected: ${this.pm5Device.name}`;
                if (statusSettings) statusSettings.textContent = `Connected: ${this.pm5Device.name}`;
                if (indicator) indicator.style.background = '#00FF99';
                if (indicatorSettings) indicatorSettings.style.background = '#00FF99';
                
                if (btn) {
                    btn.textContent = 'Disconnect';
                    btn.disabled = false;
                    btn.onclick = () => this.disconnectPM5();
                }
                if (btnSettings) {
                    btnSettings.textContent = 'Disconnect';
                    btnSettings.disabled = false;
                    btnSettings.onclick = () => this.disconnectPM5();
                }
                
                this.showToast('PM5 connected!', 'success');
            } catch (error) {
                console.error('‚ùå PM5 connection error:', error);
                
                let errorMsg = 'Connection failed';
                if (error.message.includes('User cancelled')) {
                    errorMsg = 'Connection cancelled';
                } else if (error.message.includes('device not found')) {
                    errorMsg = 'PM5 not found - is it on?';
                } else if (error.message.includes('GATT')) {
                    errorMsg = 'Cannot connect - restart PM5';
                } else if (error.message.includes('Service')) {
                    errorMsg = 'Service error - PM5 firmware issue?';
                } else {
                    errorMsg = `Error: ${error.message.substring(0, 50)}`;
                }
                
                if (status) status.textContent = errorMsg;
                if (statusSettings) statusSettings.textContent = errorMsg;
                if (indicator) indicator.style.background = '#FF4444';
                if (indicatorSettings) indicatorSettings.style.background = '#FF4444';
                
                if (btn) {
                    btn.textContent = 'Retry';
                    btn.disabled = false;
                }
                if (btnSettings) {
                    btnSettings.textContent = 'Retry';
                    btnSettings.disabled = false;
                }
                
                this.showToast(`PM5: ${errorMsg}`, 'error');
                
                // Show troubleshooting in console
                console.log('üîß Troubleshooting:');
                console.log('1. Make sure PM5 is on (not in sleep mode)');
                console.log('2. PM5 should show "Ready" or "Waiting" screen');
                console.log('3. Try turning PM5 off and back on');
                console.log('4. Make sure Bluetooth is enabled on your device');
                console.log('5. Try moving closer to the PM5');
            }
        }

        disconnectPM5() {
            if (this.pm5Device && this.pm5Device.gatt.connected) {
                this.pm5Device.gatt.disconnect();
            }
            
            const status = document.getElementById('pm5Status');
            const indicator = document.getElementById('pm5Indicator');
            const btn = document.getElementById('pm5ConnectBtn');
            const statusSettings = document.getElementById('pm5StatusSettings');
            const indicatorSettings = document.getElementById('pm5IndicatorSettings');
            const btnSettings = document.getElementById('pm5ConnectBtnSettings');
            
            if (status) status.textContent = 'Not connected';
            if (statusSettings) statusSettings.textContent = 'Not connected';
            if (indicator) indicator.style.background = '#666';
            if (indicatorSettings) indicatorSettings.style.background = '#666';
            
            if (btn) {
                btn.textContent = 'Connect PM5';
                btn.onclick = () => this.connectPM5();
            }
            if (btnSettings) {
                btnSettings.textContent = 'Connect PM5';
                btnSettings.onclick = () => this.connectPM5();
            }
            
            this.showToast('PM5 disconnected', 'success');
        }

        handlePM5Data(value) {
            // Parse PM5 data and update dashboard
            console.log('PM5 data:', value);
            
            // Check if this is the first stroke
            if (this.waitingForFirstStroke) {
                // Any PM5 data means user started rowing
                this.onFirstStroke();
            }
            
            // TODO: Implement full PM5 data parsing based on Concept2 spec
            // For now, update basic metrics when data arrives
            // This will be replaced with proper parsing of the PM5 protocol
        }

        // ========================================================================
        // HRM CONNECTION
        // ========================================================================

        async connectHRM() {
            const HRM_SERVICE = 0x180D;
            const HRM_CHARACTERISTIC = 0x2A37;
            
            const btn = document.getElementById('hrmConnectBtn');
            const status = document.getElementById('hrmStatus');
            const indicator = document.getElementById('hrmIndicator');
            
            // Also update Settings card elements
            const btnSettings = document.getElementById('hrmConnectBtnSettings');
            const statusSettings = document.getElementById('hrmStatusSettings');
            const indicatorSettings = document.getElementById('hrmIndicatorSettings');
            
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Connecting...';
            }
            if (btnSettings) {
                btnSettings.disabled = true;
                btnSettings.textContent = 'Connecting...';
            }
            if (status) status.textContent = 'Connecting...';
            if (statusSettings) statusSettings.textContent = 'Connecting...';
            
            try {
                console.log('üîç Requesting HRM...');
                
                this.hrmDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [HRM_SERVICE] }]
                });
                
                console.log(`‚úì Device: ${this.hrmDevice.name}`);
                if (status) status.textContent = `Connecting to ${this.hrmDevice.name}...`;
                if (statusSettings) statusSettings.textContent = `Connecting to ${this.hrmDevice.name}...`;
                
                const server = await this.hrmDevice.gatt.connect();
                const service = await server.getPrimaryService(HRM_SERVICE);
                this.hrmCharacteristic = await service.getCharacteristic(HRM_CHARACTERISTIC);
                
                await this.hrmCharacteristic.startNotifications();
                this.hrmCharacteristic.addEventListener('characteristicvaluechanged', (e) => {
                    this.handleHRMData(e.target.value);
                });
                
                console.log('‚úì HRM connected');
                
                if (status) status.textContent = `Connected: ${this.hrmDevice.name}`;
                if (statusSettings) statusSettings.textContent = `Connected: ${this.hrmDevice.name}`;
                if (indicator) indicator.style.background = '#ff6b6b';
                if (indicatorSettings) indicatorSettings.style.background = '#ff6b6b';
                
                if (btn) {
                    btn.textContent = 'Disconnect';
                    btn.disabled = false;
                    btn.onclick = () => this.disconnectHRM();
                }
                if (btnSettings) {
                    btnSettings.textContent = 'Disconnect';
                    btnSettings.disabled = false;
                    btnSettings.onclick = () => this.disconnectHRM();
                }
                
                this.showToast('HRM connected!', 'success');
            } catch (error) {
                console.error('‚ùå HRM error:', error);
                if (status) status.textContent = 'Connection failed';
                if (statusSettings) statusSettings.textContent = 'Connection failed';
                if (indicator) indicator.style.background = '#FF4444';
                if (indicatorSettings) indicatorSettings.style.background = '#FF4444';
                
                if (btn) {
                    btn.textContent = 'Retry';
                    btn.disabled = false;
                }
                if (btnSettings) {
                    btnSettings.textContent = 'Retry';
                    btnSettings.disabled = false;
                }
                
                this.showToast('HRM connection failed: ' + error.message, 'error');
            }
        }

        disconnectHRM() {
            if (this.hrmDevice && this.hrmDevice.gatt.connected) {
                this.hrmDevice.gatt.disconnect();
            }
            
            const status = document.getElementById('hrmStatus');
            const indicator = document.getElementById('hrmIndicator');
            const btn = document.getElementById('hrmConnectBtn');
            const statusSettings = document.getElementById('hrmStatusSettings');
            const indicatorSettings = document.getElementById('hrmIndicatorSettings');
            const btnSettings = document.getElementById('hrmConnectBtnSettings');
            
            if (status) status.textContent = 'Not connected';
            if (statusSettings) statusSettings.textContent = 'Not connected';
            if (indicator) indicator.style.background = '#666';
            if (indicatorSettings) indicatorSettings.style.background = '#666';
            
            if (btn) {
                btn.textContent = 'Connect HRM';
                btn.onclick = () => this.connectHRM();
            }
            if (btnSettings) {
                btnSettings.textContent = 'Connect HRM';
                btnSettings.onclick = () => this.connectHRM();
            }
            
            this.showToast('HRM disconnected', 'success');
        }

        handleHRMData(value) {
            const flags = value.getUint8(0);
            const hrValueFormat = flags & 0x01;
            
            let hr;
            if (hrValueFormat === 0) {
                hr = value.getUint8(1);
            } else {
                hr = value.getUint16(1, true);
            }
            
            this.liveData.hr = hr;
            this.updateHRZone();
        }

        // ========================================================================
        // HRM CONNECTION (DIRECT - FROM HRM SCREEN)
        // ========================================================================

        async connectHRMDirect() {
            const HRM_SERVICE = 0x180D;
            const HRM_CHARACTERISTIC = 0x2A37;
            
            const btn = document.getElementById('hrmConnectButton');
            const statusText = document.getElementById('hrmStatusText');
            const statusDesc = document.getElementById('hrmStatusDesc');
            
            btn.disabled = true;
            btn.textContent = 'Connecting...';
            statusText.textContent = 'Connecting...';
            
            try {
                console.log('üîç Requesting HRM...');
                
                this.hrmDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [HRM_SERVICE] }]
                });
                
                console.log(`‚úì Device: ${this.hrmDevice.name}`);
                statusDesc.textContent = `Connecting to ${this.hrmDevice.name}...`;
                
                const server = await this.hrmDevice.gatt.connect();
                const service = await server.getPrimaryService(HRM_SERVICE);
                this.hrmCharacteristic = await service.getCharacteristic(HRM_CHARACTERISTIC);
                
                await this.hrmCharacteristic.startNotifications();
                this.hrmCharacteristic.addEventListener('characteristicvaluechanged', (e) => {
                    this.handleHRMDataDirect(e.target.value);
                });
                
                console.log('‚úì HRM connected');
                
                statusText.textContent = `Connected: ${this.hrmDevice.name}`;
                statusDesc.textContent = 'Receiving heart rate data';
                btn.textContent = 'Disconnect';
                btn.disabled = false;
                btn.onclick = () => this.disconnectHRMDirect();
                
                // Show live display and graph
                document.getElementById('hrmLiveDisplay').style.display = 'block';
                document.getElementById('hrmGraphContainer').style.display = 'block';
                
                // Initialize canvas
                this.initHRMCanvas();
                
                this.showToast('HRM connected!', 'success');
            } catch (error) {
                console.error('‚ùå HRM error:', error);
                statusText.textContent = 'Connection Failed';
                statusDesc.textContent = error.message;
                btn.textContent = 'Retry';
                btn.disabled = false;
                
                this.showToast('HRM connection failed: ' + error.message, 'error');
            }
        }

        disconnectHRMDirect() {
            if (this.hrmDevice && this.hrmDevice.gatt.connected) {
                this.hrmDevice.gatt.disconnect();
            }
            
            this.hrmDevice = null;
            this.hrmCharacteristic = null;
            this.hrHistory = [];
            this.currentHR = 0;
            
            document.getElementById('hrmStatusText').textContent = 'Not Connected';
            document.getElementById('hrmStatusDesc').textContent = 'Connect your Polar/Garmin/Wahoo HRM';
            document.getElementById('hrmLiveDisplay').style.display = 'none';
            document.getElementById('hrmGraphContainer').style.display = 'none';
            
            const btn = document.getElementById('hrmConnectButton');
            btn.textContent = 'Connect Heart Rate Monitor';
            btn.onclick = () => this.connectHRMDirect();
            
            this.showToast('HRM disconnected', 'success');
        }

        initHRMCanvas() {
            this.hrCanvas = document.getElementById('hrmCanvas');
            if (this.hrCanvas) {
                this.hrCtx = this.hrCanvas.getContext('2d');
                this.hrCanvas.width = this.hrCanvas.offsetWidth;
                this.hrCanvas.height = 200;
            }
            this.hrHistory = [];
            this.currentHR = 0;
        }

        handleHRMDataDirect(value) {
            const flags = value.getUint8(0);
            const hrValueFormat = flags & 0x01;
            
            let hr;
            if (hrValueFormat === 0) {
                hr = value.getUint8(1);
            } else {
                hr = value.getUint16(1, true);
            }
            
            this.currentHR = hr;
            this.hrHistory.push(hr);
            
            // Keep last 60 readings
            if (this.hrHistory.length > 60) {
                this.hrHistory.shift();
            }
            
            this.updateHRMDisplay();
            this.updateHRMGraph();
        }

        updateHRMDisplay() {
            const bpmElem = document.getElementById('hrmCurrentBPM');
            if (bpmElem) {
                bpmElem.textContent = this.currentHR;
            }
            
            // Update zone visualization
            const zone = this.calculateHRZone(this.currentHR);
            for (let i = 1; i <= 5; i++) {
                const zoneElem = document.getElementById(`hrZone${i}Display`);
                if (zoneElem) {
                    if (i === zone) {
                        zoneElem.style.opacity = '1';
                        zoneElem.style.transform = 'scale(1.1)';
                    } else {
                        zoneElem.style.opacity = '0.3';
                        zoneElem.style.transform = 'scale(1)';
                    }
                }
            }
        }

        calculateHRZone(hr) {
            // Default zones (can be customized in settings)
            if (hr < 120) return 1;
            if (hr < 140) return 2;
            if (hr < 160) return 3;
            if (hr < 180) return 4;
            return 5;
        }

        updateHRMGraph() {
            if (!this.hrCtx || this.hrHistory.length < 2) return;
            
            const ctx = this.hrCtx;
            const canvas = this.hrCanvas;
            const width = canvas.width;
            const height = canvas.height;
            
            // Clear
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, width, height);
            
            // Calculate stats
            const avg = Math.round(this.hrHistory.reduce((a, b) => a + b, 0) / this.hrHistory.length);
            const max = Math.max(...this.hrHistory);
            const min = Math.min(...this.hrHistory);
            
            // Update stats display
            document.getElementById('hrmAvg').textContent = avg;
            document.getElementById('hrmMax').textContent = max;
            document.getElementById('hrmMin').textContent = min;
            
            // Draw grid
            ctx.strokeStyle = '#222';
            ctx.lineWidth = 1;
            for (let i = 0; i < 5; i++) {
                const y = (height / 5) * i;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }
            
            // Draw HR line
            const minHR = Math.max(min - 10, 0);
            const maxHR = max + 10;
            const hrRange = maxHR - minHR;
            
            ctx.strokeStyle = '#ff6b6b';
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            this.hrHistory.forEach((hr, i) => {
                const x = (width / 60) * i;
                const y = height - ((hr - minHR) / hrRange) * height;
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.stroke();
        }

        // ========================================================================
        // DASHBOARD - SWIPEABLE
        // ========================================================================

        setupDashboardSwipe() {
            const container = document.getElementById('dashboardContainer');
            const carousel = document.getElementById('dashboardCarousel');
            
            let startX = 0;
            let currentX = 0;
            let isDragging = false;
            
            container.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                isDragging = true;
            });
            
            container.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                currentX = e.touches[0].clientX;
                const diff = currentX - startX;
                const offset = -this.currentView * 100;
                carousel.style.transform = `translateX(calc(${offset}% + ${diff}px))`;
            });
            
            container.addEventListener('touchend', (e) => {
                if (!isDragging) return;
                isDragging = false;
                
                const diff = currentX - startX;
                if (Math.abs(diff) > 50) {
                    if (diff > 0 && this.currentView > 0) {
                        this.currentView--;
                    } else if (diff < 0 && this.currentView < 4) {
                        this.currentView++;
                    }
                }
                
                this.updateDashboardView();
            });
        }

        updateDashboardView() {
            const carousel = document.getElementById('dashboardCarousel');
            carousel.style.transform = `translateX(-${this.currentView * 100}%)`;
            
            document.querySelectorAll('.dashboard-dot').forEach((dot, i) => {
                if (i === this.currentView) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });
        }

        updateDashboardMetrics() {
            const mins = Math.floor(this.liveData.pace / 60);
            const secs = Math.floor(this.liveData.pace % 60);
            const paceStr = `${mins}:${secs.toString().padStart(2, '0')}`;
            
            const timeMins = Math.floor(this.liveData.time / 60);
            const timeSecs = Math.floor(this.liveData.time % 60);
            const timeStr = `${timeMins}:${timeSecs.toString().padStart(2, '0')}`;
            
            // All Data view
            document.getElementById('pace1').textContent = paceStr;
            document.getElementById('time1').textContent = timeStr;
            document.getElementById('dist1').textContent = this.liveData.dist + 'm';
            document.getElementById('watts1').textContent = Math.floor(this.liveData.watts);
            document.getElementById('rate1').textContent = this.liveData.rate;
            document.getElementById('hr1').textContent = this.liveData.hr || '--';
            document.getElementById('avgPace1').textContent = paceStr;
            
            // Large Print view
            document.getElementById('paceLP').textContent = paceStr;
            document.getElementById('distLP').textContent = this.liveData.dist + 'm';
        }

        updateCoachMessage() {
            const msg = document.getElementById('coachMessage');
            if (this.liveData.pace > 125) {
                msg.textContent = '‚ö†Ô∏è Power dropping! Focus on leg drive!';
            } else if (this.liveData.pace < 110 && this.liveData.time < 60) {
                msg.textContent = '‚ö†Ô∏è Too fast! Settle into rhythm.';
            } else if (this.liveData.pace > 110 && this.liveData.pace < 120) {
                msg.textContent = 'üí™ Perfect pace! Keep this rhythm.';
            } else {
                msg.textContent = 'Looking good. Stay focused.';
            }
        }

        updateHRZone() {
            if (!this.liveData.hr || !this.profile) return;
            
            const sidebar = document.getElementById('hrSidebar');
            sidebar.style.display = 'flex';
            
            let zone = 1;
            if (this.liveData.hr > 180) zone = 5;
            else if (this.liveData.hr > 160) zone = 4;
            else if (this.liveData.hr > 140) zone = 3;
            else if (this.liveData.hr > 120) zone = 2;
            
            for (let i = 1; i <= 5; i++) {
                const elem = document.getElementById(`hrZ${i}`);
                if (i === zone) {
                    elem.classList.add('active');
                } else {
                    elem.classList.remove('active');
                }
            }
        }

        drawForceC() {
            const canvas = document.getElementById('forceCanvas');
            if (!canvas) return;
            canvas.width = canvas.offsetWidth;
            canvas.height = 300;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.strokeStyle = '#00FF99';
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            for (let i = 0; i < 50; i++) {
                const x = (canvas.width / 50) * i;
                const y = canvas.height - Math.sin(i * 0.2) * (this.liveData.watts / 2) - 50;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();
        }

        drawPaceboat() {
            const canvas = document.getElementById('paceboatCanvas');
            if (!canvas) return;
            canvas.width = canvas.offsetWidth;
            canvas.height = 400;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // User boat
            ctx.fillStyle = '#00FF99';
            ctx.fillRect(50, 150, 60, 30);
            ctx.fillText('YOU', 60, 140);
            
            // Target boat
            ctx.fillStyle = '#FF6B6B';
            ctx.fillRect(150, 150, 60, 30);
            ctx.fillText('TARGET', 160, 140);
        }

        drawBarChart() {
            const canvas = document.getElementById('barCanvas');
            if (!canvas) return;
            canvas.width = canvas.offsetWidth;
            canvas.height = 300;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const barWidth = canvas.width / 20;
            this.paceHistory.forEach((pace, i) => {
                const height = (pace / 150) * canvas.height;
                ctx.fillStyle = '#00FF99';
                ctx.fillRect(i * barWidth, canvas.height - height, barWidth - 2, height);
            });
        }

        // ========================================================================
        // PM5 CONNECTION
        // ========================================================================

        async connectPM5() {
            try {
                console.log('üîç Requesting PM5...');
                
                this.pm5Device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [PM5_SERVICE_UUID] }]
                });
                
                console.log(`‚úì Device: ${this.pm5Device.name}`);
                
                const server = await this.pm5Device.gatt.connect();
                const service = await server.getPrimaryService(PM5_SERVICE_UUID);
                this.pm5Characteristic = await service.getCharacteristic(PM5_CHARACTERISTIC_UUID);
                
                await this.pm5Characteristic.startNotifications();
                this.pm5Characteristic.addEventListener('characteristicvaluechanged', (e) => {
                    this.handlePM5Data(e.target.value);
                });
                
                console.log('‚úì PM5 connected');
                this.showToast('PM5 connected!', 'success');
            } catch (error) {
                console.error('‚ùå PM5 error:', error);
                this.showToast('PM5 connection failed', 'error');
            }
        }

        handlePM5Data(value) {
            // Parse PM5 data
            console.log('PM5 data:', value);
        }

        // ========================================================================
        // BUILDER
        // ========================================================================

        selectBuilderMode(mode) {
            this.builderMode = mode;
            document.querySelectorAll('.builder-mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            this.renderBuilderMode();
        }

        renderBuilderMode() {
            const container = document.getElementById('builderModeContent');
            if (!container) return;
            
            let html = '<div class="builder-section"><div class="builder-section-title">Workout Details</div>';
            
            if (this.builderMode === 'single-distance') {
                html += `
                    <div class="builder-input-group">
                        <div class="builder-label">Total Distance (meters)</div>
                        <input type="number" class="builder-input" id="totalDistance" placeholder="5000">
                    </div>
                    <div class="builder-input-group">
                        <div class="builder-label">Split Length (meters)</div>
                        <input type="number" class="builder-input" id="splitDistance" placeholder="1000">
                    </div>
                `;
            } else if (this.builderMode === 'single-time') {
                html += `
                    <div class="builder-input-group">
                        <div class="builder-label">Total Time</div>
                        <div class="builder-time-picker">
                            <input type="number" class="builder-time-input" id="totalMins" placeholder="30" min="0">
                            <span style="color:#666;">:</span>
                            <input type="number" class="builder-time-input" id="totalSecs" placeholder="00" min="0" max="59">
                        </div>
                    </div>
                    <div class="builder-input-group">
                        <div class="builder-label">Split Time</div>
                        <div class="builder-time-picker">
                            <input type="number" class="builder-time-input" id="splitMins" placeholder="5" min="0">
                            <span style="color:#666;">:</span>
                            <input type="number" class="builder-time-input" id="splitSecs" placeholder="00" min="0" max="59">
                        </div>
                    </div>
                `;
            } else if (this.builderMode === 'fixed-intervals') {
                html += `
                    <div class="builder-input-group">
                        <div class="builder-label">Work Type</div>
                        <select class="builder-input" id="workType">
                            <option value="distance">Distance</option>
                            <option value="time">Time</option>
                        </select>
                    </div>
                    <div class="builder-input-group">
                        <div class="builder-label">Work Value</div>
                        <input type="number" class="builder-input" id="workValue" placeholder="500">
                    </div>
                    <div class="builder-input-group">
                        <div class="builder-label">Number of Intervals</div>
                        <input type="number" class="builder-input" id="numSets" placeholder="6">
                    </div>
                    <div class="builder-input-group">
                        <div class="builder-label">Rest Time</div>
                        <div class="builder-time-picker">
                            <input type="number" class="builder-time-input" id="restMins" placeholder="1" min="0">
                            <span style="color:#666;">:</span>
                            <input type="number" class="builder-time-input" id="restSecs" placeholder="00" min="0" max="59">
                        </div>
                    </div>
                `;
            } else if (this.builderMode === 'variable-intervals') {
                html += `
                    <div class="builder-input-group">
                        <div class="builder-label">Work Value (meters)</div>
                        <input type="number" class="builder-input" id="varWorkValue" placeholder="500">
                    </div>
                    <div class="builder-input-group">
                        <div class="builder-label">Rest Time</div>
                        <div class="builder-time-picker">
                            <input type="number" class="builder-time-input" id="varRestMins" placeholder="1" min="0">
                            <span style="color:#666;">:</span>
                            <input type="number" class="builder-time-input" id="varRestSecs" placeholder="00" min="0" max="59">
                        </div>
                    </div>
                    <button class="btn btn-outline" onclick="app.addVariableInterval()">Add Interval</button>
                    
                    <div class="builder-interval-list">
                        ${this.builderIntervals.map((interval, i) => `
                            <div class="builder-interval-item ${i === this.editingInterval ? 'editable' : ''}" onclick="app.editInterval(${i})">
                                <div class="builder-interval-header">
                                    <div class="builder-interval-title">${i + 1}. ${interval.workValue}m / ${interval.restTime}s rest</div>
                                    <div class="builder-interval-actions">
                                        <button class="builder-icon-btn" onclick="event.stopPropagation(); app.copyInterval(${i})">üìã</button>
                                        <button class="builder-icon-btn" onclick="event.stopPropagation(); app.deleteInterval(${i})">üóëÔ∏è</button>
                                    </div>
                                </div>
                                <div class="builder-interval-edit">
                                    <div class="builder-input-group">
                                        <div class="builder-label">Work Value (meters)</div>
                                        <input type="number" class="builder-input" value="${interval.workValue}" onchange="app.updateInterval(${i}, 'workValue', this.value)">
                                    </div>
                                    <div class="builder-input-group">
                                        <div class="builder-label">Rest Time (seconds)</div>
                                        <input type="number" class="builder-input" value="${interval.restTime}" onchange="app.updateInterval(${i}, 'restTime', this.value)">
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        toggleBuilderTarget(target) {
            this.builderTargets[target] = !this.builderTargets[target];
            
            const checkbox = document.getElementById(`${target}Checkbox`);
            const inputs = document.getElementById(`${target}Inputs`);
            
            if (this.builderTargets[target]) {
                checkbox.classList.add('checked');
                checkbox.textContent = '‚úì';
                inputs.style.display = 'block';
            } else {
                checkbox.classList.remove('checked');
                checkbox.textContent = '';
                inputs.style.display = 'none';
            }
        }

        addVariableInterval() {
            const workValue = document.getElementById('varWorkValue').value;
            const restMins = parseInt(document.getElementById('varRestMins').value) || 0;
            const restSecs = parseInt(document.getElementById('varRestSecs').value) || 0;
            
            if (!workValue) {
                this.showToast('Enter work value', 'error');
                return;
            }
            
            this.builderIntervals.push({
                workValue: parseInt(workValue),
                restTime: restMins * 60 + restSecs
            });
            
            this.renderBuilderMode();
        }

        editInterval(index) {
            this.editingInterval = this.editingInterval === index ? -1 : index;
            this.renderBuilderMode();
        }

        updateInterval(index, field, value) {
            this.builderIntervals[index][field] = parseInt(value);
        }

        copyInterval(index) {
            const interval = {...this.builderIntervals[index]};
            this.builderIntervals.push(interval);
            this.renderBuilderMode();
        }

        deleteInterval(index) {
            this.builderIntervals.splice(index, 1);
            this.renderBuilderMode();
        }

        saveManualWorkout() {
            this.reviewWorkout = {
                mode: this.builderMode,
                intervals: []
            };
            
            // Handle different workout modes
            if (this.builderMode === 'single-distance') {
                const total = parseInt(document.getElementById('totalDistance').value);
                const split = parseInt(document.getElementById('splitDistance').value);
                
                if (!total) {
                    this.showToast('Enter total distance', 'error');
                    return;
                }
                
                this.reviewWorkout.intervals = [{ type: 'distance', value: total, split: split || total }];
                
            } else if (this.builderMode === 'single-time') {
                const mins = parseInt(document.getElementById('totalMins').value) || 0;
                const secs = parseInt(document.getElementById('totalSecs').value) || 0;
                const splitMins = parseInt(document.getElementById('splitMins').value) || 0;
                const splitSecs = parseInt(document.getElementById('splitSecs').value) || 0;
                
                const totalTime = mins * 60 + secs;
                const splitTime = splitMins * 60 + splitSecs;
                
                if (totalTime === 0) {
                    this.showToast('Enter total time', 'error');
                    return;
                }
                
                this.reviewWorkout.intervals = [{ 
                    type: 'time', 
                    value: totalTime, 
                    split: splitTime || totalTime,
                    displayValue: `${mins}:${secs.toString().padStart(2, '0')}`
                }];
                
            } else if (this.builderMode === 'fixed-intervals') {
                const workType = document.getElementById('workType').value;
                const workValue = parseInt(document.getElementById('workValue').value);
                const numSets = parseInt(document.getElementById('numSets').value);
                const restMins = parseInt(document.getElementById('restMins').value) || 0;
                const restSecs = parseInt(document.getElementById('restSecs').value) || 0;
                
                if (!workValue || !numSets) {
                    this.showToast('Enter work value and number of sets', 'error');
                    return;
                }
                
                const restTime = restMins * 60 + restSecs;
                
                for (let i = 0; i < numSets; i++) {
                    this.reviewWorkout.intervals.push({
                        type: workType,
                        workValue: workValue,
                        restTime: restTime
                    });
                }
                
            } else if (this.builderMode === 'variable-intervals') {
                if (this.builderIntervals.length === 0) {
                    this.showToast('Add at least one interval', 'error');
                    return;
                }
                this.reviewWorkout.intervals = this.builderIntervals;
            }
            
            // Capture global targets
            if (document.getElementById('splitPaceCheckbox').classList.contains('checked')) {
                this.reviewWorkout.targetSplit = document.getElementById('splitPaceValue').value;
            }
            if (document.getElementById('heartRateCheckbox').classList.contains('checked')) {
                this.reviewWorkout.targetHRZone = document.getElementById('heartRateZone').value;
            }
            if (document.getElementById('strokeRateCheckbox').classList.contains('checked')) {
                this.reviewWorkout.targetStrokeRate = document.getElementById('strokeRateValue').value;
            }
            
            this.renderReview();
            this.navigate('screenReview');
        }

        renderReview() {
            const titleElem = document.getElementById('reviewTitle');
            const intervalsElem = document.getElementById('reviewIntervals');
            
            titleElem.textContent = 'Review Your Workout';
            
            let html = '';
            
            if (!this.reviewWorkout || !this.reviewWorkout.intervals || this.reviewWorkout.intervals.length === 0) {
                html = `
                    <div style="text-align:center; padding:40px 20px; color:#666;">
                        <div style="font-size:48px; margin-bottom:12px;">üìã</div>
                        <div style="font-size:14px;">No workout data to review</div>
                    </div>
                `;
            } else {
                // Workout Summary Card
                html += `
                    <div style="background:var(--card-bg); border:1px solid var(--border); border-radius:12px; padding:20px; margin-bottom:16px;">
                        <div style="font-size:12px; color:#666; text-transform:uppercase; margin-bottom:12px;">Workout Summary</div>
                `;
                
                // Mode
                const modeNames = {
                    'single-time': 'Time-Based',
                    'single-distance': 'Distance-Based',
                    'fixed-intervals': 'Fixed Intervals',
                    'variable-intervals': 'Variable Intervals',
                    'just-row': 'Just Row'
                };
                html += `
                    <div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid #222;">
                        <div style="color:#888;">Mode</div>
                        <div style="font-weight:700; color:var(--accent);">${modeNames[this.builderMode] || this.builderMode}</div>
                    </div>
                `;
                
                // Calculate totals
                let totalWork = 0;
                let totalRest = 0;
                let intervalCount = this.reviewWorkout.intervals.length;
                let isTimeMode = false;
                
                this.reviewWorkout.intervals.forEach(interval => {
                    if (interval.type === 'time') {
                        isTimeMode = true;
                    }
                    if (interval.workValue) totalWork += parseInt(interval.workValue);
                    if (interval.value) totalWork += parseInt(interval.value);
                    if (interval.restTime) totalRest += parseInt(interval.restTime);
                });
                
                // Total Work - display based on type
                if (isTimeMode || this.builderMode === 'single-time') {
                    const mins = Math.floor(totalWork / 60);
                    const secs = totalWork % 60;
                    html += `
                        <div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid #222;">
                            <div style="color:#888;">Total Time</div>
                            <div style="font-weight:700; font-size:20px; color:var(--accent);">${mins}:${secs.toString().padStart(2, '0')}</div>
                        </div>
                    `;
                } else {
                    html += `
                        <div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid #222;">
                            <div style="color:#888;">Total Distance</div>
                            <div style="font-weight:700; font-size:20px; color:var(--accent);">${totalWork}m</div>
                        </div>
                    `;
                }
                
                // Intervals
                if (intervalCount > 1) {
                    html += `
                        <div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid #222;">
                            <div style="color:#888;">Intervals</div>
                            <div style="font-weight:700;">${intervalCount} sets</div>
                        </div>
                    `;
                }
                
                // Total Rest
                if (totalRest > 0) {
                    html += `
                        <div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid #222;">
                            <div style="color:#888;">Total Rest</div>
                            <div style="font-weight:700;">${totalRest}s (${Math.round(totalRest/60)}min)</div>
                        </div>
                    `;
                }
                
                // Global Targets
                if (this.reviewWorkout.targetSplit) {
                    html += `
                        <div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid #222;">
                            <div style="color:#888;">Target Split</div>
                            <div style="font-weight:700; color:#4a90e2;">${this.reviewWorkout.targetSplit}/500m</div>
                        </div>
                    `;
                }
                
                if (this.reviewWorkout.targetHRZone) {
                    html += `
                        <div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid #222;">
                            <div style="color:#888;">Target HR Zone</div>
                            <div style="font-weight:700; color:#ff6b6b;">Zone ${this.reviewWorkout.targetHRZone}</div>
                        </div>
                    `;
                }
                
                if (this.reviewWorkout.targetStrokeRate) {
                    html += `
                        <div style="display:flex; justify-content:space-between; padding:12px 0;">
                            <div style="color:#888;">Target Stroke Rate</div>
                            <div style="font-weight:700;">${this.reviewWorkout.targetStrokeRate} s/m</div>
                        </div>
                    `;
                }
                
                html += `</div>`;
                
                // Intervals Breakdown (if multiple intervals)
                if (intervalCount > 1) {
                    html += `
                        <div style="background:var(--card-bg); border:1px solid var(--border); border-radius:12px; padding:20px;">
                            <div style="font-size:12px; color:#666; text-transform:uppercase; margin-bottom:12px;">Intervals Breakdown</div>
                    `;
                    
                    this.reviewWorkout.intervals.forEach((interval, i) => {
                        const workValue = interval.workValue || interval.value;
                        const workUnit = (interval.type === 'time') ? 's' : 'm';
                        const restValue = interval.restTime || 0;
                        
                        // Format time display if needed
                        let displayValue = workValue;
                        if (interval.type === 'time') {
                            const mins = Math.floor(workValue / 60);
                            const secs = workValue % 60;
                            displayValue = `${mins}:${secs.toString().padStart(2, '0')}`;
                        }
                        
                        html += `
                            <div style="background:#050505; border:1px solid #222; border-radius:8px; padding:16px; margin-bottom:12px;">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                    <div style="font-weight:700; font-size:14px;">Set ${i + 1}</div>
                                    <div style="font-size:18px; font-weight:900; color:var(--accent);">${displayValue}${workUnit === 's' ? '' : workUnit}</div>
                                </div>
                                ${restValue > 0 ? `
                                    <div style="display:flex; justify-content:space-between; font-size:12px; color:#888;">
                                        <div>Rest</div>
                                        <div>${restValue}s</div>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });
                    
                    html += `</div>`;
                }
            }
            
            intervalsElem.innerHTML = html;
        }

        startWorkout() {
            if (!this.reviewWorkout || !this.reviewWorkout.intervals || this.reviewWorkout.intervals.length === 0) {
                this.showToast('No workout to start', 'error');
                return;
            }
            
            // Set up active workout
            this.activeWorkout = {
                ...this.reviewWorkout,
                startTime: null, // Will be set on first stroke
                currentInterval: 0,
                isResting: false
            };
            
            // Get first interval
            const firstInterval = this.reviewWorkout.intervals[0];
            
            // Initialize countdown for time-based workouts (but don't start yet)
            if (firstInterval.type === 'time' || this.builderMode === 'single-time') {
                this.workoutTimeRemaining = firstInterval.value; // seconds remaining
                this.workoutTimeTotal = firstInterval.value; // total seconds for progress
                this.isCountingDown = false; // Wait for first stroke
                this.waitingForFirstStroke = true;
            } else {
                this.isCountingDown = false;
                this.waitingForFirstStroke = true;
                this.workoutTimeRemaining = 0;
            }
            
            // Display ready state
            this.updateDashboardReadyState();
            
            this.showToast('Ready! Pull first stroke to begin.', 'success');
            setTimeout(() => {
                this.navigate('screenDashboard');
            }, 500);
        }
        
        updateDashboardReadyState() {
            // Show initial time without starting countdown
            if (this.workoutTimeRemaining > 0) {
                const mins = Math.floor(this.workoutTimeRemaining / 60);
                const secs = this.workoutTimeRemaining % 60;
                const timeStr = `${mins}:${secs.toString().padStart(2, '0')}`;
                document.getElementById('time1').textContent = timeStr;
            }
            
            const coachMsg = document.getElementById('coachMessage');
            if (coachMsg) {
                coachMsg.textContent = `üö£ Ready to row! Pull first stroke to start timer.`;
            }
            
            // Show manual start button for testing (hidden when PM5 is connected)
            const startBtn = document.getElementById('manualStartBtn');
            if (startBtn) {
                startBtn.style.display = 'block';
            }
        }
        
        onFirstStroke() {
            // Called when PM5 detects first stroke or user starts rowing
            if (this.waitingForFirstStroke) {
                this.waitingForFirstStroke = false;
                this.activeWorkout.startTime = Date.now();
                
                // Hide manual start button
                const startBtn = document.getElementById('manualStartBtn');
                if (startBtn) {
                    startBtn.style.display = 'none';
                }
                
                // Start countdown if time-based workout
                if (this.workoutTimeRemaining > 0) {
                    this.isCountingDown = true;
                    this.startWorkoutTimer();
                }
                
                this.showToast('Workout started!', 'success');
            }
        }
        
        startWorkoutTimer() {
            // Clear any existing timer
            if (this.workoutTimer) {
                clearInterval(this.workoutTimer);
            }
            
            // Update every second
            this.workoutTimer = setInterval(() => {
                if (this.isCountingDown && this.workoutTimeRemaining > 0) {
                    this.workoutTimeRemaining--;
                    this.updateDashboardWorkoutDisplay();
                    
                    // Workout complete
                    if (this.workoutTimeRemaining === 0) {
                        this.completeWorkout();
                    }
                }
            }, 1000);
        }
        
        updateDashboardWorkoutDisplay() {
            if (!this.isCountingDown) return;
            
            const mins = Math.floor(this.workoutTimeRemaining / 60);
            const secs = this.workoutTimeRemaining % 60;
            const timeStr = `${mins}:${secs.toString().padStart(2, '0')}`;
            
            // Update all time displays
            document.getElementById('time1').textContent = timeStr;
            
            // Update coach message with progress
            const progress = Math.round((1 - this.workoutTimeRemaining / this.workoutTimeTotal) * 100);
            const coachMsg = document.getElementById('coachMessage');
            if (coachMsg) {
                if (this.workoutTimeRemaining <= 60) {
                    coachMsg.textContent = `üî• Final minute! Push hard!`;
                } else if (this.workoutTimeRemaining <= 120) {
                    coachMsg.textContent = `üí™ ${mins} minutes left - stay strong!`;
                } else {
                    coachMsg.textContent = `‚è±Ô∏è ${mins}:${secs.toString().padStart(2, '0')} remaining (${progress}% complete)`;
                }
            }
        }
        
        completeWorkout() {
            clearInterval(this.workoutTimer);
            
            // Check if there are more intervals
            if (this.activeWorkout && this.activeWorkout.intervals && 
                this.activeWorkout.currentInterval < this.activeWorkout.intervals.length - 1) {
                
                // Move to rest period if there's rest time
                const currentInterval = this.activeWorkout.intervals[this.activeWorkout.currentInterval];
                if (currentInterval.restTime && currentInterval.restTime > 0) {
                    this.startRestPeriod(currentInterval.restTime);
                } else {
                    // No rest, move to next interval immediately
                    this.startNextInterval();
                }
            } else {
                // All intervals complete - finish workout
                this.finishWorkout();
            }
        }
        
        startRestPeriod(restSeconds) {
            this.activeWorkout.isResting = true;
            this.isCountingDown = true;
            this.workoutTimeRemaining = restSeconds;
            
            const coachMsg = document.getElementById('coachMessage');
            if (coachMsg) {
                coachMsg.textContent = `üí§ Rest period - ${restSeconds}s`;
            }
            
            // Countdown rest time
            this.workoutTimer = setInterval(() => {
                if (this.workoutTimeRemaining > 0) {
                    this.workoutTimeRemaining--;
                    
                    // Update display
                    const mins = Math.floor(this.workoutTimeRemaining / 60);
                    const secs = this.workoutTimeRemaining % 60;
                    document.getElementById('time1').textContent = `REST ${mins}:${secs.toString().padStart(2, '0')}`;
                    
                    if (coachMsg) {
                        coachMsg.textContent = `üí§ Rest: ${this.workoutTimeRemaining}s remaining`;
                    }
                } else {
                    // Rest complete - start next interval
                    this.startNextInterval();
                }
            }, 1000);
        }
        
        startNextInterval() {
            clearInterval(this.workoutTimer);
            this.activeWorkout.currentInterval++;
            this.activeWorkout.isResting = false;
            this.waitingForFirstStroke = true;
            
            const nextInterval = this.activeWorkout.intervals[this.activeWorkout.currentInterval];
            
            if (nextInterval.type === 'time' || nextInterval.workValue) {
                this.workoutTimeRemaining = nextInterval.value || nextInterval.workValue;
                this.workoutTimeTotal = this.workoutTimeRemaining;
            }
            
            this.showToast(`Next interval - pull to start!`, 'success');
            this.updateDashboardReadyState();
        }
        
        finishWorkout() {
            this.isCountingDown = false;
            this.showToast('üéâ Workout complete!', 'success');
            
            // Save workout to history
            const workout = {
                id: Date.now().toString(),
                date: new Date().toISOString(),
                type: this.activeWorkout.mode || 'manual',
                duration: Math.round((Date.now() - this.activeWorkout.startTime) / 1000),
                distance: this.liveData.dist || 0,
                avgPace: this.liveData.pace || 0,
                avgHR: this.liveData.hr || 0,
                completed: true
            };
            
            this.workouts.push(workout);
            this.dataStore.saveWorkouts(this.workouts);
            this.renderHistory();
            this.updateStats();
            
            this.activeWorkout = null;
            
            const coachMsg = document.getElementById('coachMessage');
            if (coachMsg) {
                coachMsg.textContent = `üéâ Great work! Workout complete.`;
            }
        }

        endWorkout() {
            if (!this.activeWorkout) {
                this.showToast('No active workout', 'error');
                return;
            }
            
            if (confirm('End workout early?')) {
                clearInterval(this.workoutTimer);
                this.isCountingDown = false;
                
                // Save partial workout
                const workout = {
                    id: Date.now().toString(),
                    date: new Date().toISOString(),
                    type: this.activeWorkout.mode || 'manual',
                    duration: Math.round((Date.now() - this.activeWorkout.startTime) / 1000),
                    distance: this.liveData.dist || 0,
                    avgPace: this.liveData.pace || 0,
                    avgHR: this.liveData.hr || 0,
                    completed: false
                };
                
                this.workouts.push(workout);
                this.dataStore.saveWorkouts(this.workouts);
                this.renderHistory();
                this.updateStats();
                
                this.activeWorkout = null;
                this.showToast('Workout ended and saved', 'success');
            }
        }

        // ========================================================================
        // CSV IMPORT - FIXED
        // ========================================================================

        importCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n');
                    
                    console.log(`üìÑ Lines: ${lines.length}`);
                    
                    // SKIP HEADER (line 0)
                    const headers = lines[0].split(',').map(h => h.trim());
                    console.log(`üìã Headers: ${headers.join(', ')}`);
                    
                    let imported = 0;
                    const existingIds = new Set(this.workouts.map(w => w.id));
                    
                    // START FROM LINE 1
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        const values = line.split(',');
                        if (values.length < headers.length) continue;
                        
                        const row = {};
                        headers.forEach((header, idx) => {
                            row[header] = values[idx]?.trim();
                        });
                        
                        // Parse DD/M/YYYY HH:MM
                        const dateStr = row['Date'];
                        if (!dateStr || dateStr === 'Date') continue;
                        
                        let parsedDate = new Date().toISOString();
                        try {
                            const parts = dateStr.split(' ');
                            if (parts.length >= 1) {
                                const [day, month, year] = parts[0].split('/');
                                const d = new Date(year, month - 1, day);
                                if (!isNaN(d.getTime())) {
                                    parsedDate = d.toISOString();
                                }
                            }
                        } catch (e) {
                            console.warn('Date parse:', dateStr);
                        }
                        
                        const id = row['Log ID'] || String(Date.now() + Math.random());
                        
                        if (!existingIds.has(id)) {
                            this.workouts.push({
                                id: id,
                                date: parsedDate,
                                description: row['Description'] || '',
                                distance: parseInt(row['Work Distance']) || 0,
                                pace: row['Pace'] || '',
                                avgWatts: parseInt(row['Avg Watts']) || 0,
                                avgHR: parseInt(row['Avg Heart Rate']) || 0
                            });
                            imported++;
                            existingIds.add(id);
                        }
                    }
                    
                    console.log(`‚úÖ Imported ${imported} workouts`);
                    console.log(`üìä Total: ${this.workouts.length}`);
                    
                    this.workouts.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    this.saveData();
                    this.renderHistory();
                    this.updateStats();
                    
                    this.showToast(`‚úì Imported ${imported} workouts!`, 'success');
                    
                    event.target.value = '';
                } catch (error) {
                    console.error('‚ùå CSV Error:', error);
                    this.showToast('Import failed: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(file);
        }

        // ========================================================================
        // HISTORY
        // ========================================================================

        renderHistory() {
            const container = document.getElementById('historyList');
            if (!container) return;

            if (this.workouts.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìä</div><div>No workouts yet</div></div>';
                return;
            }

            const html = this.workouts.map((workout, idx) => {
                let dateStr = 'Invalid Date';
                try {
                    const d = new Date(workout.date);
                    if (!isNaN(d.getTime())) {
                        dateStr = d.toLocaleDateString();
                    }
                } catch (e) {
                    console.warn('Date error:', workout.date);
                }
                
                return `
                    <div class="history-item">
                        <button class="history-delete" onclick="app.deleteWorkout(${idx})">Delete</button>
                        <div class="history-date">${dateStr}</div>
                        <div class="history-title">${workout.description || 'Workout'}</div>
                        <div class="history-stats">
                            <span>${workout.distance}m</span>
                            <span>${workout.pace || '--'}</span>
                            <span>${workout.avgWatts || '--'}W</span>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        async deleteWorkout(index) {
            if (confirm('Delete this workout?')) {
                const workout = this.workouts[index];
                await this.dataStore.deleteWorkout(workout.id);
                
                this.workouts.splice(index, 1);
                this.renderHistory();
                this.updateStats();
                this.showToast('Workout deleted', 'success');
            }
        }

        updateStats() {
            document.getElementById('totalWorkouts').textContent = this.workouts.length;
            document.getElementById('historyCount').textContent = this.workouts.length;
            
            const totalDist = this.workouts.reduce((sum, w) => sum + (w.distance || 0), 0);
            document.getElementById('totalDistance').textContent = Math.floor(totalDist / 1000) + 'k';
        }

        // ========================================================================
        // SETTINGS
        // ========================================================================

        loadProfile() {
            if (!this.profile) return;
            document.getElementById('editName').value = this.profile.name || '';
            document.getElementById('editAge').value = this.profile.age || '';
            document.getElementById('editWeight').value = this.profile.weight || '';
            
            this.loadHRZones();
        }
        
        loadHRZones() {
            const maxHR = this.profile?.maxHR || 190;
            document.getElementById('editMaxHR').value = maxHR;
            
            // Update zone ranges
            document.getElementById('zone1Range').textContent = `${Math.round(maxHR * 0.5)}-${Math.round(maxHR * 0.6)} bpm`;
            document.getElementById('zone2Range').textContent = `${Math.round(maxHR * 0.6)}-${Math.round(maxHR * 0.7)} bpm`;
            document.getElementById('zone3Range').textContent = `${Math.round(maxHR * 0.7)}-${Math.round(maxHR * 0.8)} bpm`;
            document.getElementById('zone4Range').textContent = `${Math.round(maxHR * 0.8)}-${Math.round(maxHR * 0.9)} bpm`;
            document.getElementById('zone5Range').textContent = `${Math.round(maxHR * 0.9)}-${maxHR} bpm`;
        }
        
        async saveHRZones() {
            const maxHR = parseInt(document.getElementById('editMaxHR').value);
            
            if (!maxHR || maxHR < 100 || maxHR > 220) {
                this.showToast('Enter valid max HR (100-220)', 'error');
                return;
            }
            
            this.profile = this.profile || {};
            this.profile.maxHR = maxHR;
            await this.dataStore.saveProfile(this.profile);
            
            this.loadHRZones();
            this.showToast('HR zones saved!', 'success');
        }

        async saveProfile() {
            const name = document.getElementById('editName').value;
            const age = parseInt(document.getElementById('editAge').value);
            const weight = parseInt(document.getElementById('editWeight').value);
            
            if (!name || !age || !weight) {
                this.showToast('Fill all fields', 'error');
                return;
            }
            
            this.profile = { name, age, weight, maxHR: 220 - age };
            await this.dataStore.saveProfile(this.profile);
            
            this.showToast('Profile saved!', 'success');
        }

        async testFirebaseSync() {
            console.log('üîç Testing Firebase sync...');
            
            try {
                // Save a test value
                const testData = {
                    testTimestamp: new Date().toISOString(),
                    testMessage: 'Firebase sync working!'
                };
                
                await this.dataStore.saveProfile({ ...this.profile, ...testData });
                console.log('‚úì Test data saved to Firebase');
                
                // Read it back
                const retrieved = await this.dataStore.loadProfile();
                console.log('‚úì Test data retrieved:', retrieved);
                
                if (retrieved && retrieved.testTimestamp === testData.testTimestamp) {
                    this.showToast('‚úì Firebase sync working! Check console for details.', 'success');
                    document.getElementById('firebaseStatus').textContent = '‚úì Connected & Syncing';
                    document.getElementById('firebaseStatus').style.color = '#00FF99';
                } else {
                    throw new Error('Data mismatch');
                }
            } catch (error) {
                console.error('‚ùå Firebase sync test failed:', error);
                this.showToast('Firebase sync failed. Check console.', 'error');
                document.getElementById('firebaseStatus').textContent = '‚úó Sync Failed';
                document.getElementById('firebaseStatus').style.color = '#FF4444';
            }
        }

        updateFirebaseStatus() {
            const userIdElem = document.getElementById('firebaseUserId');
            const statusElem = document.getElementById('firebaseStatus');
            
            if (userIdElem && this.dataStore) {
                userIdElem.textContent = this.dataStore.userId || 'Not initialized';
            }
            
            if (statusElem && this.dataStore) {
                if (this.dataStore.isFirebase) {
                    statusElem.textContent = '‚úì Firebase Enabled';
                    statusElem.style.color = '#00FF99';
                } else {
                    statusElem.textContent = 'localStorage (offline)';
                    statusElem.style.color = '#FFA500';
                }
            }
        }

        // ========================================================================
        // TRAINING PLAN GENERATION
        // ========================================================================

        generateTrainingPlan() {
            this.trainingPlan = {
                weeks: [
                    {
                        number: 1,
                        focus: 'Base Building',
                        days: [
                            { day: 'Monday', title: '30min Steady State', desc: 'Easy pace, build aerobic base', status: 'pending' },
                            { day: 'Tuesday', title: 'Rest', desc: 'Recovery day', status: 'pending' },
                            { day: 'Wednesday', title: '4x1500m', desc: 'Intervals @ 2:00 pace, 3min rest', status: 'pending' },
                            { day: 'Thursday', title: 'Rest', desc: 'Recovery day', status: 'pending' },
                            { day: 'Friday', title: '40min Steady State', desc: 'Zone 2 training', status: 'pending' },
                            { day: 'Saturday', title: '6x500m', desc: 'Speed work @ 1:50, 2min rest', status: 'pending' },
                            { day: 'Sunday', title: 'Rest or light 20min', desc: 'Active recovery', status: 'pending' }
                        ]
                    },
                    {
                        number: 2,
                        focus: 'Intensity Increase',
                        days: [
                            { day: 'Monday', title: '35min Steady State', desc: 'Controlled pace', status: 'pending' },
                            { day: 'Tuesday', title: 'Rest', desc: 'Recovery day', status: 'pending' },
                            { day: 'Wednesday', title: '5x1500m', desc: 'Intervals @ 1:58, 2:30 rest', status: 'pending' },
                            { day: 'Thursday', title: 'Rest', desc: 'Recovery day', status: 'pending' },
                            { day: 'Friday', title: '45min Steady State', desc: 'Build endurance', status: 'pending' },
                            { day: 'Saturday', title: '8x500m', desc: 'Speed @ 1:48, 90s rest', status: 'pending' },
                            { day: 'Sunday', title: '25min Easy', desc: 'Active recovery', status: 'pending' }
                        ]
                    },
                    {
                        number: 3,
                        focus: 'Peak Volume',
                        days: [
                            { day: 'Monday', title: '40min Progressive', desc: 'Start easy, finish strong', status: 'pending' },
                            { day: 'Tuesday', title: 'Rest', desc: 'Recovery day', status: 'pending' },
                            { day: 'Wednesday', title: '6x1500m', desc: 'Intervals @ 1:56, 2min rest', status: 'pending' },
                            { day: 'Thursday', title: 'Rest', desc: 'Recovery day', status: 'pending' },
                            { day: 'Friday', title: '50min Steady State', desc: 'Peak aerobic volume', status: 'pending' },
                            { day: 'Saturday', title: '3x2000m', desc: 'Race pace @ 1:52, 4min rest', status: 'pending' },
                            { day: 'Sunday', title: '30min Easy', desc: 'Recovery', status: 'pending' }
                        ]
                    },
                    {
                        number: 4,
                        focus: 'Taper & Test',
                        days: [
                            { day: 'Monday', title: '30min Easy', desc: 'Reduce volume', status: 'pending' },
                            { day: 'Tuesday', title: 'Rest', desc: 'Recovery', status: 'pending' },
                            { day: 'Wednesday', title: '3x1000m', desc: 'Sharpening @ 1:50, full rest', status: 'pending' },
                            { day: 'Thursday', title: 'Rest', desc: 'Pre-test recovery', status: 'pending' },
                            { day: 'Friday', title: 'Rest', desc: 'Final prep', status: 'pending' },
                            { day: 'Saturday', title: '2000m TIME TRIAL', desc: 'Test day - all out!', status: 'pending' },
                            { day: 'Sunday', title: 'Celebrate!', desc: 'Recovery & reflection', status: 'pending' }
                        ]
                    }
                ],
                created: new Date().toISOString()
            };
            
            this.renderTrainingPlan();
        }

        renderTrainingPlan() {
            const container = document.getElementById('planContent');
            if (!container || !this.trainingPlan) return;
            
            // Plan Overview
            let html = `
                <div style="background:linear-gradient(135deg, rgba(0,255,153,0.1) 0%, rgba(0,255,153,0.02) 100%); border:2px solid var(--accent); border-radius:12px; padding:20px; margin-bottom:20px;">
                    <div style="font-size:16px; font-weight:700; color:var(--accent); margin-bottom:12px;">üéØ Your 4-Week Training Plan</div>
                    <div style="font-size:13px; line-height:1.6; color:#ccc; margin-bottom:16px;">
                        This progressive program is designed to build your aerobic base, increase training intensity, reach peak volume, and then taper for a final test. Each week builds on the previous one, gradually preparing you for peak performance.
                    </div>
                    <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:12px;">
                        <div style="background:rgba(0,0,0,0.3); border-radius:8px; padding:12px;">
                            <div style="font-size:11px; color:#888; text-transform:uppercase; margin-bottom:4px;">Objective</div>
                            <div style="font-size:13px; font-weight:700;">2000m Time Trial</div>
                        </div>
                        <div style="background:rgba(0,0,0,0.3); border-radius:8px; padding:12px;">
                            <div style="font-size:11px; color:#888; text-transform:uppercase; margin-bottom:4px;">Duration</div>
                            <div style="font-size:13px; font-weight:700;">4 Weeks</div>
                        </div>
                    </div>
                    <div style="margin-top:16px; padding-top:16px; border-top:1px solid rgba(0,255,153,0.2); font-size:12px; color:#888;">
                        üí° <strong>Tip:</strong> Click any workout to view details or make adjustments
                    </div>
                </div>
            `;
            
            // Weekly Breakdown
            html += this.trainingPlan.weeks.map(week => `
                <div class="plan-week">
                    <div class="plan-week-header">
                        <div class="plan-week-title">Week ${week.number}</div>
                        <div class="plan-week-focus">${week.focus}</div>
                    </div>
                    ${week.days.map((day, dayIndex) => `
                        <div class="plan-day" onclick="app.viewPlanDay(${week.number}, ${dayIndex})" style="cursor:pointer;">
                            <div class="plan-day-info">
                                <div class="plan-day-title">${day.day}: ${day.title}</div>
                                <div class="plan-day-desc">${day.desc}</div>
                            </div>
                            <div class="plan-day-status ${day.status}">${day.status === 'completed' ? '‚úì' : '‚óã'}</div>
                        </div>
                    `).join('')}
                </div>
            `).join('');
            
            container.innerHTML = html;
        }
        
        viewPlanDay(weekNum, dayIndex) {
            const week = this.trainingPlan.weeks.find(w => w.number === weekNum);
            if (!week) return;
            
            const day = week.days[dayIndex];
            if (!day) return;
            
            const message = `
```

<strong>${day.day} - Week ${weekNum}</strong>

<strong>Workout:</strong> ${day.title}
<strong>Details:</strong> ${day.desc}
<strong>Status:</strong> ${day.status === ‚Äòcompleted‚Äô ? ‚Äò‚úì Completed‚Äô : ‚Äò‚óã Pending‚Äô}

Would you like to:
‚Ä¢ View detailed strategy for this workout
‚Ä¢ Adjust the workout parameters
‚Ä¢ Mark as completed
‚Ä¢ Get AI coaching tips
`.trim();

```
            alert(message);
            // Future: Open a modal with edit options
        }

        generateNewPlan() {
            if (!confirm('Create a new 4-week training plan? This will replace your current plan.')) return;
            
            this.generateTrainingPlan();
            this.showToast('New training plan created!', 'success');
        }

        // ========================================================================
        // NAVIGATION
        // ========================================================================

        navigate(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');

            // Update BOTTOM navigation
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            
            const screenMap = {
                'screenChat': 0,
                'screenDashboard': 1,
                'screenBuilder': 2,
                'screenPlan': 3,
                'screenHistory': 4
            };
            
            const index = screenMap[screenId];
            if (index !== undefined && navItems[index]) {
                navItems[index].classList.add('active');
            }
            
            // Update TOP navigation
            const topNavItems = document.querySelectorAll('.top-nav-item');
            topNavItems.forEach(item => item.classList.remove('active'));
            
            const topScreenMap = {
                'screenSettings': 0,
                'screenHRM': 1
            };
            
            const topIndex = topScreenMap[screenId];
            if (topIndex !== undefined && topNavItems[topIndex]) {
                topNavItems[topIndex].classList.add('active');
            }
            
            // Update Firebase status when opening settings
            if (screenId === 'screenSettings') {
                this.updateFirebaseStatus();
            }
        }

        showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    }

    const app = new AIRowingCoach();
</script>
```

</body>
</html>