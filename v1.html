<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ANALYST V7.0 (STRATEGIST)</title>
    <style>
        :root { --bg: #050505; --text: #e0e0e0; --accent: #00FF99; --warn: #FFD700; --danger: #FF4444; --rest: #00AAFF; --panel: #111; --border: #222; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); font-family: 'Roboto', -apple-system, sans-serif; margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }

        /* TOAST */
        #toast { position: fixed; top: -60px; left: 50%; transform: translateX(-50%); background: #222; color: #fff; border: 1px solid #444; padding: 12px 24px; border-radius: 30px; z-index: 2000; font-size: 13px; font-weight: bold; transition: top 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); box-shadow: 0 10px 30px rgba(0,0,0,0.5); display:flex; align-items:center; gap:10px; }
        #toast.active { top: 20px; }
        #toast.success { border-color: var(--accent); color: var(--accent); }
        #toast.error { border-color: var(--danger); color: var(--danger); }

        /* SCREENS */
        .screen { display: none; flex-grow: 1; flex-direction: column; overflow: hidden; height: 100%; }
        .screen.active { display: flex; }
        .scroll-area { flex-grow: 1; overflow-y: auto; padding: 20px; padding-bottom: 90px; }
        .screen-header { display: flex; align-items: center; padding: 15px 20px; background: var(--panel); border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .header-title { flex-grow: 1; text-align: center; font-weight: 700; font-size: 14px; letter-spacing: 1px; color: #888; text-transform: uppercase; }
        .header-btn { background: transparent; border: none; color: var(--accent); font-weight: bold; font-size: 12px; cursor: pointer; padding: 10px; }

        /* CARDS */
        .card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .section-header { color: var(--accent); font-size: 11px; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 12px; border-bottom: 1px solid #333; padding-bottom: 6px; font-weight: 700; display:flex; justify-content:space-between; }
        
        /* INPUTS & BUTTONS */
        .btn { width: 100%; padding: 14px; border-radius: 8px; font-weight: bold; cursor: pointer; border: none; text-transform: uppercase; font-size: 13px; margin-top: 8px; transition: transform 0.1s, filter 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:active { transform: scale(0.98); }
        .btn-green { background: var(--accent); color: #000; }
        .btn-outline { background: transparent; border: 1px solid #444; color: #888; }
        .btn-outline:hover { border-color: #666; color: #fff; background: #1a1a1a; }
        .btn-danger { background: rgba(255,68,68,0.1); border: 1px solid var(--danger); color: var(--danger); }
        .btn-blue { background: var(--rest); color: white; }

        input, textarea, select { background: #080808; border: 1px solid #333; color: white; padding: 12px; border-radius: 6px; width: 100%; font-family: inherit; margin-bottom: 10px; font-size: 16px; transition: border 0.2s; }
        input:focus, textarea:focus { border-color: var(--accent); }

        /* BUILDER TIMELINE */
        #builderList { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
        .step-card { background: #151515; border: 1px solid #333; border-radius: 8px; padding: 12px; display: grid; grid-template-columns: 40px 1fr auto; align-items: center; gap: 12px; }
        .step-icon { font-size: 18px; text-align: center; }
        .step-main { font-weight: bold; font-size: 14px; color: #fff; }
        .step-sub { font-size: 11px; color: #888; margin-top: 2px; }
        .type-work { color: var(--accent); }
        .type-rest { color: var(--rest); }

        /* STRATEGY ROOM (NEW) */
        .strategy-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .stat-badge { background: #222; padding: 10px; border-radius: 6px; border: 1px solid #333; text-align: center; }
        .stat-val { font-size: 18px; font-weight: bold; color: #fff; }
        .stat-lbl { font-size: 10px; color: #666; margin-top: 2px; }
        .chat-box { background: #080808; border: 1px solid #333; border-radius: 8px; height: 150px; overflow-y: auto; padding: 10px; font-size: 13px; line-height: 1.4; color: #ccc; margin-bottom: 10px; white-space: pre-wrap; }
        .chat-input-area { display: flex; gap: 10px; }

        /* DASHBOARD */
        .main-deck { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px 0; }
        .metric-huge { font-size: 14vh; font-weight: 900; line-height: 0.9; letter-spacing: -3px; font-variant-numeric: tabular-nums; }
        .metric-sub { font-size: 4vh; color: #888; font-weight: 700; margin-top: 10px; font-variant-numeric: tabular-nums; }
        .lower-deck { display: grid; grid-template-columns: 1fr 1fr; background: var(--panel); border-top: 1px solid var(--border); }
        .stat-box { display: flex; flex-direction: column; align-items: center; justify-content: center; border-right: 1px solid var(--border); padding: 20px; }
        .hr-bar-container { width: 100%; height: 6px; background: #222; margin-top: 8px; border-radius: 3px; display: flex; overflow: hidden; }
        .hr-zone { height: 100%; opacity: 0.2; flex-grow: 1; margin: 0 1px; transition: opacity 0.3s; }
        .hr-zone.active { opacity: 1; box-shadow: 0 0 10px currentColor; }
        .z1 { background: #666; } .z2 { background: #0088FF; } .z3 { background: #00FF00; } .z4 { background: #FFAA00; } .z5 { background: #FF0000; } 

        /* LOGS */
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #222; cursor: pointer; background: #151515; margin-bottom: 1px; transition: background 0.2s; }
        .history-item:hover { background: #222; }
        .h-date { font-size: 10px; color: #666; text-transform: uppercase; letter-spacing: 1px; }
        .h-desc { font-weight: bold; font-size: 14px; margin-top: 4px; color: #eee; }
        .h-stat { font-family: monospace; color: var(--accent); font-size: 14px; font-weight: bold; }

        /* NAV BAR */
        .nav-bar { display: flex; background: var(--panel); border-top: 1px solid var(--border); height: 65px; flex-shrink: 0; z-index: 100; padding-bottom: env(safe-area-inset-bottom); }
        .nav-btn { flex: 1; background: transparent; border: none; color: #666; font-size: 10px; font-weight: bold; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.2s; }
        .nav-btn.active { color: var(--accent); background: #1a1a1a; }
        .nav-icon { font-size: 20px; margin-bottom: 4px; }

        @media (max-width: 600px) { .metric-huge { font-size: 18vw; } .metric-sub { font-size: 5vh; } }
    </style>
</head>
<body>

    <div id="toast"><span>Notification</span></div>

    <div id="screenBuilder" class="screen active">
        <div class="screen-header">
            <div class="header-title">MISSION CONTROL</div>
            <button class="header-btn" onclick="connectBluetooth()" id="btConnectBtn">CONNECT PM5</button>
        </div>
        <div class="scroll-area">
            <div class="card">
                <div class="section-header">AI COMMANDER</div>
                <textarea id="aiInput" rows="2" placeholder="e.g. 3 x 2000m, 4min rest"></textarea>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-blue" id="btnGen" style="flex:2" onclick="generateMission()">GENERATE PLAN</button>
                    <button class="btn btn-green" style="flex:1" onclick="launchJustRow()">ROW NOW</button>
                </div>
            </div>

            <div class="section-header" style="margin: 0 5px 10px 5px;">MISSION PLAN</div>
            <div id="builderList"></div>
            <button class="btn btn-outline" onclick="addManualStep()">+ ADD STEP</button>

            <div style="height:30px;"></div>
            <button class="btn btn-green" onclick="goToStrategy()">ANALYZE & STRATEGIZE ‚Üí</button>
        </div>
    </div>

    <div id="screenStrategy" class="screen">
        <div class="screen-header">
            <button class="header-btn" onclick="nav('screenBuilder')">‚Üê EDIT</button>
            <div class="header-title">STRATEGY ROOM</div>
            <div style="width:40px;"></div>
        </div>
        <div class="scroll-area">
            <div class="card">
                <div class="section-header">MISSION BRIEF</div>
                <div id="stratSummary" style="font-size:16px; font-weight:bold; color:white; margin-bottom:10px;"></div>
                <div class="strategy-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="stat-badge"><div class="stat-val" id="stratEstTime">--</div><div class="stat-lbl">EST TIME</div></div>
                    <div class="stat-badge"><div class="stat-val" id="stratEstDist">--</div><div class="stat-lbl">EST DIST</div></div>
                </div>
            </div>

            <div class="card" id="historyMatchCard">
                <div class="section-header">HISTORICAL CONTEXT</div>
                <div id="historyMatchContent" style="font-size:13px; color:#ccc; line-height:1.5;">Searching memory...</div>
            </div>

            <div class="card">
                <div class="section-header">ANALYST ADVICE</div>
                <div class="chat-box" id="coachChat">Waiting for mission data...</div>
                <div class="chat-input-area">
                    <input type="text" id="coachInput" placeholder="Ask for strategy...">
                    <button class="btn btn-outline" style="width:auto; margin:0;" onclick="askCoach()">ASK</button>
                </div>
            </div>

            <button class="btn btn-green" onclick="startMission(false)">ACCEPT PLAN & ROW</button>
        </div>
    </div>

    <div id="dashScreen" class="screen">
        <div class="comms-bar" style="border-bottom:1px solid #333; padding:10px 20px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:10px; color:#666;">LIVE TELEMETRY</span>
                <span id="phaseBadge" style="background:#222; padding:4px 8px; border-radius:4px; font-size:10px; font-weight:bold; color:#888;">IDLE</span>
            </div>
            <div id="intervalInfo" style="font-size:14px; color:#fff; font-weight:bold;">--</div>
        </div>

        <div class="main-deck">
            <div class="metric-huge" id="dispPace">0:00</div>
            <div class="metric-sub">
                <span id="dispWatts">0</span>W <span style="font-size:12px; color:var(--accent); display:none;" id="tgtWatts"></span> 
                <span style="color:#444">|</span> 
                <span id="dispDist">0</span>m
            </div>
        </div>

        <div class="lower-deck">
            <div class="stat-box">
                <div class="metric-sub" id="dispRate" style="color:white; margin:0;">--</div>
                <div style="font-size:10px; color:#666;">RATE <span id="tgtRate" style="color:var(--accent)"></span></div>
            </div>
            <div class="stat-box" style="padding: 0 15px;">
                <div class="metric-sub" id="dispHR" style="color:white; margin:0;">--</div>
                <div style="font-size:10px; color:#666;">HEART RATE</div>
                <div class="hr-bar-container">
                    <div class="hr-zone z1" id="z1"></div>
                    <div class="hr-zone z2" id="z2"></div>
                    <div class="hr-zone z3" id="z3"></div>
                    <div class="hr-zone z4" id="z4"></div>
                    <div class="hr-zone z5" id="z5"></div>
                </div>
            </div>
        </div>
        
        <div style="background:#111; padding:10px; display:flex; justify-content:center; align-items:center;">
            <button class="btn btn-outline" style="width:auto; padding:10px 30px;" onclick="endMission()">FINISH & SAVE</button>
        </div>
    </div>

    <div id="screenHistory" class="screen">
        <div class="screen-header">
            <div class="header-title">MISSION LOGS</div>
            <button class="header-btn" onclick="exportHistory()">EXPORT CSV</button>
        </div>
        <div class="scroll-area" id="historyList"></div>
    </div>

    <div id="screenSettings" class="screen">
        <div class="screen-header"><div class="header-title">SETTINGS</div></div>
        <div class="scroll-area">
            <div class="card">
                <div class="section-header">SYSTEM</div>
                <input type="password" id="apiKeyInput" placeholder="Paste Gemini Key...">
                <select id="modelSelect" style="margin-top:10px;"><option value="" disabled>Scan to load models</option></select>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
                    <button class="btn btn-outline" onclick="scanModels()">SCAN</button>
                    <button class="btn btn-green" onclick="saveSettings()">SAVE</button>
                </div>
            </div>
            
            <div class="card">
                <div class="section-header">MEMORY BANK</div>
                <label style="font-size:10px; color:#666;">UPLOAD CSV TO UPDATE MEMORY</label>
                <input type="file" id="csvInput" accept=".csv" style="margin-top:5px;">
                <button class="btn btn-outline" onclick="processCSV()">IMPORT HISTORY</button>
            </div>

            <button class="btn btn-danger" onclick="clearData()">FACTORY RESET</button>
        </div>
    </div>

    <div class="nav-bar">
        <button class="nav-btn active" onclick="nav('screenBuilder')" id="navBuild"><span class="nav-icon">‚ö°</span>BUILD</button>
        <button class="nav-btn" onclick="nav('dashScreen')" id="navDash"><span class="nav-icon">‚è±</span>ROW</button>
        <button class="nav-btn" onclick="nav('screenHistory')" id="navHist"><span class="nav-icon">‚ò∞</span>LOGS</button>
        <button class="nav-btn" onclick="nav('screenSettings')" id="navSet"><span class="nav-icon">‚öô</span>SET</button>
    </div>

    <script>
        const PM5_SERVICE = 'ce060030-43e5-11e4-916c-0800200c9a66';
        const PM5_CHAR_32 = 'ce060032-43e5-11e4-916c-0800200c9a66'; 
        
        let MISSION = { description: "", intervals: [] };
        let STATE = { active: false, intervalIdx: 0, timeLeft: 0, distLeft: 0, log: [], simLoop: null, connected: false };
        let HISTORY = [];
        let PROFILE = { hrZones: { z1: 108, z5: 180 }, model: "gemini-1.5-flash" };

        // PRE-LOADED HISTORY (Your Data)
        const SEED_DATA = [
            {id: 110986164, date: "2026-01-10T09:47:00", desc: "3 x 2000m / 4:00r", stats: {avgWatts: 228, dist: 6000, avgRate: 27, avgHR: 174, pace: "1:55.3"}},
            {id: 110898284, date: "2026-01-08T21:25:00", desc: "8 x 1:00 / 1:00r (Power)", stats: {avgWatts: 227, dist: 2077, avgRate: 21, avgHR: 152, pace: "1:55.5"}},
            {id: 110897422, date: "2026-01-05T18:46:00", desc: "4 x 1500m / 4:00r", stats: {avgWatts: 233, dist: 6000, avgRate: 27, avgHR: 176, pace: "1:54.4"}},
            {id: 106289732, date: "2025-12-08T18:10:00", desc: "2000m Test", stats: {avgWatts: 256, dist: 2000, avgRate: 27, avgHR: 0, pace: "1:51.0"}}
        ];

        window.onload = () => {
            loadData();
            // Load seed data if empty
            if(HISTORY.length === 0) {
                HISTORY = SEED_DATA;
                localStorage.setItem('analyst_history', JSON.stringify(HISTORY));
            }
            renderHistory();
            renderBuilderList();
        };

        // --- NAVIGATION ---
        function nav(id) {
            document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
            if(id==='screenBuilder') document.getElementById('navBuild').classList.add('active');
            else if(id==='dashScreen') document.getElementById('navDash').classList.add('active');
            else if(id==='screenHistory') document.getElementById('navHist').classList.add('active');
            else if(id==='screenSettings') document.getElementById('navSet').classList.add('active');
        }

        // --- STRATEGY ROOM ---
        function goToStrategy() {
            if(MISSION.intervals.length === 0) return showToast("Build a mission first", 'error');
            
            nav('screenStrategy');
            
            // 1. Populate Summary
            const workInts = MISSION.intervals.filter(i=>i.type==='WORK');
            const totalWorkTime = workInts.reduce((a,b) => a + (b.duration||0), 0);
            const totalWorkDist = workInts.reduce((a,b) => a + (b.dist||0), 0);
            
            let summary = MISSION.description;
            if(!summary) {
                if(totalWorkDist > 0) summary = `${workInts.length} Intervals (${totalWorkDist}m Total)`;
                else summary = `${workInts.length} Intervals (${Math.floor(totalWorkTime/60)} min Total)`;
            }
            document.getElementById('stratSummary').innerText = summary;
            document.getElementById('stratEstDist').innerText = totalWorkDist > 0 ? totalWorkDist + "m" : "N/A";
            document.getElementById('stratEstTime').innerText = totalWorkTime > 0 ? Math.floor(totalWorkTime/60) + "m" : "N/A";

            // 2. Find Match in History
            findSimilarSession();

            // 3. Auto-Ask Coach
            askCoach(true);
        }

        function findSimilarSession() {
            // Simple logic: look for similar distance or matching string in description
            const currentDesc = MISSION.description.toLowerCase();
            let match = null;
            
            // Try to find matching description keywords
            match = HISTORY.find(h => currentDesc.includes("2000") && h.desc.includes("2000"));
            if(!match) match = HISTORY.find(h => currentDesc.includes("500") && h.desc.includes("500"));
            
            const div = document.getElementById('historyMatchContent');
            if(match) {
                div.innerHTML = `
                    <div style="color:var(--accent); font-weight:bold;">MATCH FOUND: ${new Date(match.date).toLocaleDateString()}</div>
                    <div>${match.desc}</div>
                    <div style="margin-top:5px; font-family:monospace;">
                        Avg Pace: ${match.stats.pace || "N/A"} <br>
                        Avg Watts: ${match.stats.avgWatts}W <br>
                        Avg Rate: ${match.stats.avgRate} s/m
                    </div>
                `;
            } else {
                div.innerHTML = "No direct match found in memory. Analyzing general capacity...";
            }
        }

        async function askCoach(isAuto = false) {
            const key = localStorage.getItem('gemini_api_key');
            if(!key) { document.getElementById('coachChat').innerText = "Please set API Key in Settings."; return; }
            
            const chat = document.getElementById('coachChat');
            const userQ = isAuto ? "Analyze this workout based on my history." : document.getElementById('coachInput').value;
            
            if(!isAuto) chat.innerText += `\n\nYOU: ${userQ}`;
            chat.innerText += `\n\nANALYST: Thinking...`;
            chat.scrollTop = chat.scrollHeight;

            // Context Construction
            const historyContext = HISTORY.slice(0, 5).map(h => `${h.date.split('T')[0]}: ${h.desc} (Avg ${h.stats.avgWatts}W)`).join('\n');
            const workoutContext = JSON.stringify(MISSION.intervals);
            
            const PROMPT = `
            Act as an elite rowing coach. 
            User Workout: ${MISSION.description || "Custom Interval"}.
            Structure: ${workoutContext}.
            User History (Last 5):
            ${historyContext}
            
            User Question: ${userQ}
            
            Provide a concise, strategic answer. Suggest a specific split/pace target based on history.
            `;

            try {
                const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${PROFILE.model}:generateContent?key=${key}`, {
                    method: "POST", headers: {"Content-Type":"application/json"},
                    body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: PROMPT }] }] })
                });
                const d = await r.json();
                const reply = d.candidates[0].content.parts[0].text;
                
                chat.innerText = chat.innerText.replace("Thinking...", "");
                chat.innerText += reply;
                chat.scrollTop = chat.scrollHeight;
            } catch(e) {
                chat.innerText += "\n[Connection Error]";
            }
        }

        // --- BUILDER ---
        async function generateMission() {
            const key = document.getElementById('apiKeyInput').value || localStorage.getItem('gemini_api_key');
            if(!key) return showToast("API Key Required", 'error');
            const input = document.getElementById('aiInput').value;
            const btn = document.getElementById('btnGen');
            btn.innerText = "THINKING...";
            
            const PROMPT = `Parse workout: "${input}". Return JSON: { "description": "txt", "intervals": [{ "type": "WORK"|"REST", "dist": 0, "duration": 0, "watts": 0, "rate": 0, "pace_target": 0 }] }. RULES: 1. "1:45" pace = 105s pace_target. 2. Time in seconds.`;

            try {
                const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${PROFILE.model}:generateContent?key=${key}`, {
                    method: "POST", headers: {"Content-Type":"application/json"},
                    body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: PROMPT }] }] })
                });
                const d = await r.json();
                const jsonText = d.candidates[0].content.parts[0].text.replace(/```json/g,'').replace(/```/g,'');
                const result = JSON.parse(jsonText.substring(jsonText.indexOf('{'), jsonText.lastIndexOf('}')+1));
                MISSION.intervals = result.intervals;
                MISSION.description = result.description;
                renderBuilderList();
                showToast("Plan Generated", 'success');
            } catch(e) { showToast("AI Error: " + e.message, 'error'); }
            btn.innerText = "GENERATE PLAN";
        }

        function renderBuilderList() {
            const list = document.getElementById('builderList');
            list.innerHTML = "";
            MISSION.intervals.forEach((step, idx) => {
                let div = document.createElement('div');
                div.className = 'step-card';
                let typeClass = step.type === 'WORK' ? 'type-work' : 'type-rest';
                let mainText = step.dist > 0 ? `${step.dist}m` : formatTime(step.duration);
                let sub = [];
                if(step.pace_target) sub.push(`@ ${formatTime(step.pace_target)}`);
                if(step.watts) sub.push(`@ ${step.watts}W`);
                div.innerHTML = `<div class="step-icon ${typeClass}">${step.type==='WORK'?'‚ö°':'üí§'}</div><div class="step-details"><div class="step-main">${step.type} ${mainText}</div><div class="step-sub">${sub.join(' ')}</div></div><div class="step-del" onclick="MISSION.intervals.splice(${idx},1);renderBuilderList()">√ó</div>`;
                list.appendChild(div);
            });
        }

        // --- DASHBOARD ---
        function startMission(isSim) {
            nav('dashScreen');
            STATE = { active: true, intervalIdx: 0, timeLeft: 0, distLeft: 0, log: [], simLoop: null, connected: STATE.connected };
            setupNextInterval();
            if(isSim) STATE.simLoop = setInterval(() => processTelemetry(2.5, 26, 150, 220), 500);
            else if(!STATE.connected) connectBluetooth();
        }

        function setupNextInterval() {
            if(STATE.intervalIdx >= MISSION.intervals.length) { endMission(); return; }
            const int = MISSION.intervals[STATE.intervalIdx];
            STATE.timeLeft = int.duration > 0 ? int.duration : 99999;
            STATE.distLeft = int.dist > 0 ? int.dist : 0;
            document.getElementById('phaseBadge').innerText = int.type;
            document.getElementById('phaseBadge').style.background = int.type==='WORK'?'var(--accent)':'var(--rest)';
            document.getElementById('intervalInfo').innerText = `${int.type} ${STATE.intervalIdx+1}/${MISSION.intervals.length}`;
            
            const tgtW = document.getElementById('tgtWatts');
            if(int.pace_target > 0) { tgtW.innerText = `TGT: ${formatTime(int.pace_target)}`; tgtW.style.display="inline"; }
            else if(int.watts > 0) { tgtW.innerText = `TGT: ${int.watts}W`; tgtW.style.display="inline"; }
            else tgtW.style.display="none";
        }

        function processTelemetry(speed, rate, hr, watts) {
            if(watts > 0 && !STATE.active && !document.getElementById('dashScreen').classList.contains('active')) { launchJustRow(); return; }
            if(!STATE.active) return;
            const int = MISSION.intervals[STATE.intervalIdx];
            STATE.timeLeft -= 0.5;
            if(speed > 0.1 && STATE.distLeft > 0) STATE.distLeft -= (speed * 0.5);
            if((int.dist > 0 && STATE.distLeft <= 0) || (int.duration > 0 && int.duration < 99999 && STATE.timeLeft <= 0)) {
                STATE.intervalIdx++; setupNextInterval(); return;
            }
            let paceSec = speed > 0.1 ? 500/speed : 0;
            document.getElementById('dispPace').innerText = formatTime(paceSec);
            document.getElementById('dispWatts').innerText = watts;
            document.getElementById('dispRate').innerText = rate;
            document.getElementById('dispHR').innerText = hr < 255 ? hr : "--";
            document.getElementById('dispDist').innerText = Math.floor(STATE.distLeft > 0 ? STATE.distLeft : 0);
            
            const z = PROFILE.hrZones;
            document.querySelectorAll('.hr-zone').forEach(el=>el.classList.remove('active'));
            if(hr > z.z4) document.getElementById('z5').classList.add('active');
            else if(hr > z.z3) document.getElementById('z4').classList.add('active');
            else if(hr > z.z2) document.getElementById('z3').classList.add('active');
            else if(hr > z.z1) document.getElementById('z2').classList.add('active');
            else if(hr > 0) document.getElementById('z1').classList.add('active');

            if(int.type === 'WORK') STATE.log.push({ t: new Date().toISOString(), w:watts, h:hr, r:rate, p:paceSec });
        }

        function endMission() {
            STATE.active = false; if(STATE.simLoop) clearInterval(STATE.simLoop); showToast("Mission Complete", 'success');
            let sumW=0, count=0; STATE.log.forEach(l=>{sumW+=l.w; count++;});
            const session = { id: Date.now(), date: new Date().toISOString(), desc: MISSION.description || "Row", stats: { avgWatts: count?Math.round(sumW/count):0, dist: 0, time: count*0.5, avgRate: 0, avgHR: 0, pace: "2:00" } };
            HISTORY.unshift(session); localStorage.setItem('analyst_history', JSON.stringify(HISTORY));
            renderHistory(); nav('screenHistory');
        }

        // --- UTILS ---
        function formatTime(sec) {
            if(sec >= 99999) return "OPEN";
            let m = Math.floor(sec/60); let s = Math.floor(sec%60);
            return `${m}:${s.toString().padStart(2,'0')}`;
        }
        function addManualStep() { MISSION.intervals.push({ type: 'WORK', dist: 500, duration: 0 }); renderBuilderList(); }
        function launchJustRow() { MISSION.intervals = [{ type:'WORK', duration:999999, dist:0 }]; startMission(false); }
        function showToast(msg, type='success') { const t = document.getElementById('toast'); t.innerText = (type==='success'?'‚úî ':'‚ö† ') + msg; t.className = type + ' active'; setTimeout(()=>t.className='', 3000); }
        function saveSettings() { const key = document.getElementById('apiKeyInput').value; if(key) localStorage.setItem('gemini_api_key', key); PROFILE.model = document.getElementById('modelSelect').value; localStorage.setItem('analyst_profile', JSON.stringify(PROFILE)); showToast("Saved"); }
        function loadData() { 
            const h = localStorage.getItem('analyst_history'); if(h) HISTORY = JSON.parse(h);
            const k = localStorage.getItem('gemini_api_key'); if(k) document.getElementById('apiKeyInput').value = k;
            if(PROFILE.model) addModelOption(PROFILE.model, true);
        }
        function renderHistory() {
            const list = document.getElementById('historyList'); list.innerHTML = "";
            HISTORY.forEach(h => {
                let d = document.createElement('div'); d.className = 'history-item';
                d.innerHTML = `<div><div class="h-date">${new Date(h.date).toLocaleDateString()}</div><div class="h-desc">${h.desc}</div></div><div class="h-stat">${h.stats.avgWatts}W</div>`;
                list.appendChild(d);
            });
        }
        function exportHistory() {
            let csv = "Log ID,Date,Description,Avg Watts\n";
            HISTORY.forEach(h => { csv += `${h.id},${h.date},"${h.desc}",${h.stats.avgWatts}\n`; });
            const blob = new Blob([csv], { type: 'text/csv' }); const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'analyst_export.csv'; a.click();
        }
        function clearData() { if(confirm("Reset?")) { localStorage.clear(); location.reload(); } }
        async function scanModels() {
            const key = document.getElementById('apiKeyInput').value; if(!key) return showToast("No Key", 'error');
            try {
                const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                const data = await r.json();
                document.getElementById('modelSelect').innerHTML = "";
                data.models.forEach(m => { if(m.supportedGenerationMethods?.includes("generateContent")) addModelOption(m.name.replace("models/", ""), false); });
                showToast("Models Found");
            } catch(e) { showToast("Error", 'error'); }
        }
        function addModelOption(name, s) { const o = document.createElement('option'); o.value=name; o.innerText=name; if(s) o.selected=true; document.getElementById('modelSelect').appendChild(o); }
        async function connectBluetooth() { try { await navigator.bluetooth.requestDevice({filters:[{namePrefix:'PM5'}],optionalServices:[PM5_SERVICE]}); STATE.connected=true; document.getElementById('btConnectBtn').innerText="LINKED"; document.getElementById('btConnectBtn').style.color="#00FF00"; } catch(e){showToast("BT Error",'error');} }
    </script>
</body>
</html>
