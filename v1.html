<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ANALYST V2.5 (WATCHDOG)</title>
    <style>
        :root { --bg: #000; --text: #fff; --accent: #00FF00; --warn: #FFAA00; --alert: #FF0000; --dim: #222; }
        body { background: var(--bg); color: var(--text); font-family: 'Roboto', sans-serif; margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }

        .hidden { display: none !important; }
        .btn { padding: 12px; border-radius: 4px; font-weight: bold; cursor: pointer; text-transform: uppercase; border: none; font-size:12px; }
        .btn-green { background: var(--accent); color: black; }
        .btn-sim { background: #333; color: #aaa; border: 1px solid #555; }

        /* SETUP */
        #setupScreen { display: flex; flex-direction: column; height: 100%; padding: 20px; box-sizing: border-box; justify-content: center; gap: 15px; }
        .setup-card { background: #111; border: 1px solid #333; padding: 20px; border-radius: 8px; }
        .input-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .config-input { background: #000; border: 1px solid #444; color: white; padding: 8px; width: 80px; text-align: center; font-size: 16px; border-radius: 4px; }
        
        #apiKeyInput { width: 100%; background: #000; border: 1px solid #444; color: white; padding: 10px; margin-bottom: 10px; border-radius: 4px; box-sizing: border-box; }
        
        /* CONTEXT SELECTOR */
        .context-btn { flex:1; background:#222; border:1px solid #444; color:#666; padding:8px; margin:2px; cursor:pointer; font-size:10px; }
        .context-btn.active { background: #333; border-color: var(--accent); color: var(--accent); }

        /* DASHBOARD */
        #dashScreen { display: none; height: 100%; grid-template-rows: 15% 55% 20% 10%; }
        #dashScreen.active { display: grid; }

        /* COACHING DISPLAY */
        .comms-bar { background: #111; border-bottom: 1px solid #333; padding: 0 20px; display: flex; flex-direction: column; justify-content: center; position: relative; }
        .comms-label { font-size: 10px; color: #666; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 4px; }
        
        /* THE AI VOICE */
        .comms-text { font-size: 18px; color: var(--accent); font-family: monospace; font-weight: bold; line-height: 1.2; height: auto; min-height:40px; white-space: pre-wrap; transition: color 0.3s; }
        
        .trigger-tag { position: absolute; right: 20px; top: 15px; font-size: 10px; padding: 2px 6px; background: #333; border-radius: 4px; color: #888; display:none; }
        .trigger-tag.active { display:block; animation: flashRed 1s infinite; background: #500; color:#f99; }

        /* METRICS */
        .main-deck { display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .primary-stat { font-size: 18vh; font-weight: 900; line-height: 0.9; letter-spacing: -2px; }
        .sub-stat { font-size: 6vh; color: #888; font-weight: 700; margin-top: 5px; }
        
        /* LOWER DECK */
        .lower-deck { display: grid; grid-template-columns: 1fr 1fr; border-top: 1px solid #222; }
        .stat-box { display: flex; flex-direction: column; justify-content: center; align-items: center; border-right: 1px solid #111; }
        .stat-val { font-size: 6vh; font-weight: bold; }
        .stat-lbl { font-size: 1.5vh; color: #666; }

        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        @keyframes flashRed { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .ai-thinking { color: var(--warn) !important; animation: pulse 1s infinite; }

    </style>
</head>
<body>

    <div id="setupScreen">
        <h2 style="color:var(--accent); margin:0;">WATCHDOG SETUP</h2>
        
        <div class="setup-card">
            <div style="font-size:12px; color:#888; margin-bottom:5px;">API KEY</div>
            <input type="password" id="apiKeyInput" placeholder="Paste Gemini Key here...">
        </div>

        <div class="setup-card">
            <div style="font-size:12px; color:#888; margin-bottom:10px;">USER CONTEXT (SELECT ONE)</div>
            <div style="display:flex;">
                <button class="context-btn active" onclick="setContext('FRESH')" id="ctxFresh">FRESH / READY</button>
                <button class="context-btn" onclick="setContext('TIRED')" id="ctxTired">TIRED / STRESSED</button>
                <button class="context-btn" onclick="setContext('HANGOVER')" id="ctxHang">HANGOVER / ROUGH</button>
            </div>
            
            <div style="margin-top:15px;" class="input-row">
                <label>TARGET PACE</label>
                <input type="text" id="cfgPace" class="config-input" value="1:54">
            </div>
        </div>

        <button class="btn btn-green" onclick="initMission(false)">CONNECT PM5</button>
        <button class="btn btn-sim" onclick="initMission(true)">SIMULATE ROW (TEST)</button>
    </div>

    <div id="dashScreen">
        <div class="comms-bar">
            <div class="comms-label">ANALYST AI <span id="aiStatus">‚óè</span></div>
            <div class="comms-text" id="coachMsg">WATCHDOG ACTIVE. SILENT.</div>
            <div class="trigger-tag" id="triggerBadge">ANOMALY DETECTED</div>
        </div>

        <div class="main-deck">
            <div style="font-size:2vh; color:#888; margin-bottom:5px;">SET 1</div>
            <div style="font-size:2vh; color:#444;">SPLIT / 500M</div>
            <div class="primary-stat" id="splitDisplay">0:00</div>
            <div class="sub-stat"><span id="wattsDisplay">0</span> W</div>
        </div>

        <div class="lower-deck">
            <div class="stat-box">
                <div class="stat-val" id="rateDisplay">--</div>
                <div class="stat-lbl">RATE</div>
            </div>
            <div class="stat-box" style="border:none;">
                <div class="stat-val" id="hrDisplay" style="color:white">--</div>
                <div class="stat-lbl">HEART RATE</div>
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const PM5_SERVICE = 'ce060030-43e5-11e4-916c-0800200c9a66';
        const PM5_CHAR_32 = 'ce060032-43e5-11e4-916c-0800200c9a66'; 
        const MODEL = "gemini-2.5-flash";

        // --- STATE ---
        let CFG = { targetPaceSec: 114, context: "FRESH", apiKey: "" };
        let STATE = { 
            phase: 'IDLE', 
            history: [], // Buffer for anomaly detection
            lastAiCall: 0,
            coachingCooldown: false
        };

        // --- SETUP ---
        window.onload = () => {
            if(localStorage.getItem("gemini_api_key")) 
                document.getElementById("apiKeyInput").value = localStorage.getItem("gemini_api_key");
        };

        function setContext(ctx) {
            CFG.context = ctx;
            document.querySelectorAll('.context-btn').forEach(b => b.classList.remove('active'));
            if(ctx === 'FRESH') document.getElementById('ctxFresh').classList.add('active');
            if(ctx === 'TIRED') document.getElementById('ctxTired').classList.add('active');
            if(ctx === 'HANGOVER') document.getElementById('ctxHang').classList.add('active');
        }

        async function initMission(simMode) {
            CFG.apiKey = document.getElementById("apiKeyInput").value.trim();
            if(CFG.apiKey) localStorage.setItem("gemini_api_key", CFG.apiKey);

            let p = document.getElementById('cfgPace').value.split(':');
            CFG.targetPaceSec = (parseInt(p[0])*60) + parseInt(p[1]);

            document.getElementById('setupScreen').style.display = 'none';
            document.getElementById('dashScreen').classList.add('active');

            if(simMode) startSimulation();
            else connectBluetooth();
            
            // Initial Check-in
            triggerAI("SESSION_START", "Workout initialized. My physical state is: " + CFG.context);
        }

        // --- WATCHDOG ENGINE (The Local Brain) ---
        function analyzeTelemetry(speedMS, rate, hr, watts) {
            if (speedMS < 0.1) return; // Stopped

            const now = Date.now();
            let currentPaceSec = 500 / speedMS;
            let delta = currentPaceSec - CFG.targetPaceSec; // +ve = SLOW, -ve = FAST

            // Add to history buffer (last 5 seconds)
            STATE.history.push({ t: now, p: currentPaceSec, r: rate, w: watts });
            if(STATE.history.length > 10) STATE.history.shift();

            // COOLDOWN CHECK (Don't nag the user)
            if(STATE.coachingCooldown) {
                if(now - STATE.lastAiCall > 20000) STATE.coachingCooldown = false; // 20s silence after speaking
                return;
            }

            // 1. DETECTION: THE BONK (Slow by >4s for 5 samples)
            if (delta > 4 && STATE.history.every(h => (h.p - CFG.targetPaceSec) > 4)) {
                triggerAI("ANOMALY_BONK", `User has slowed significantly (+${delta.toFixed(1)}s) below target.`);
                return;
            }

            // 2. DETECTION: FLY AND DIE (Fast by >6s)
            if (delta < -6 && STATE.history.every(h => (h.p - CFG.targetPaceSec) < -6)) {
                triggerAI("ANOMALY_TOO_FAST", `User is sprinting too hard (${delta.toFixed(1)}s faster than target). Risk of burnout.`);
                return;
            }

            // 3. DETECTION: INEFFICIENCY (Rate up, Watts down)
            // (Advanced logic would go here, simplified for demo)
            if (rate > 32 && delta > 0) {
                 triggerAI("ANOMALY_FLAILING", "Stroke rate is very high (32+) but pace is slow. Inefficient.");
                 return;
            }
        }

        // --- AI UPLINK ---
        async function triggerAI(triggerType, telemetryDescription) {
            if (!CFG.apiKey) return;

            // LOCKOUT
            STATE.lastAiCall = Date.now();
            STATE.coachingCooldown = true;

            // UI UPDATES
            const msgBox = document.getElementById('coachMsg');
            const tag = document.getElementById('triggerBadge');
            msgBox.classList.add("ai-thinking");
            tag.innerText = triggerType.replace("ANOMALY_", "");
            tag.classList.add("active");

            // NUANCED PROMPT
            const PROMPT = `
            You are an elite Rowing Coach watching a user in real-time.
            
            CONTEXT:
            - User Status: ${CFG.context} (Important!)
            - Target Pace: ${document.getElementById('cfgPace').value}
            
            EVENT TRIGGERED: ${triggerType}
            TELEMETRY: ${telemetryDescription}

            INSTRUCTIONS:
            - Provide ONE sentence of spoken coaching guidance.
            - If User is FRESH: Be demanding. "Get back on it!"
            - If User is HANGOVER/TIRED: Be supportive but firm. "I know it hurts, just hold the form."
            - If TOO FAST: "Patience. Too hot."
            - Max 15 words. No fluff.
            `;

            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${CFG.apiKey}`;
                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: PROMPT }] }] })
                });

                const data = await response.json();
                const advice = data.candidates?.[0]?.content?.parts?.[0]?.text || "SYSTEM ERROR";

                // DISPLAY
                msgBox.innerText = advice.toUpperCase();
                msgBox.classList.remove("ai-thinking");
                msgBox.style.color = "#FFAA00";
                setTimeout(() => msgBox.style.color = "#00FF00", 3000);

            } catch (e) {
                console.error(e);
                msgBox.innerText = "OFFLINE";
            }
        }

        // --- SIMULATOR (SCRIPTED CRASH) ---
        function startSimulation() {
            let simPace = CFG.targetPaceSec; 
            let simRate = 26;
            let simWatts = 250;
            let time = 0;

            setInterval(() => {
                time++;
                
                // PHASE 1: START FAST (0-20s)
                if(time < 20) {
                    simPace = CFG.targetPaceSec - 8; // Flying!
                    simRate = 30;
                } 
                // PHASE 2: SETTLE (20-40s)
                else if (time < 40) {
                    simPace = CFG.targetPaceSec - 1; // Good
                    simRate = 28;
                }
                // PHASE 3: THE CRASH (40s+)
                else {
                    simPace = CFG.targetPaceSec + 6; // Bonk!
                    simRate = 24;
                }

                // Noise
                let jitter = (Math.random() - 0.5) * 2;
                let speedMS = 500 / (simPace + jitter);
                
                // Update UI
                let m = Math.floor((simPace + jitter) / 60);
                let s = Math.floor((simPace + jitter) % 60);
                document.getElementById('splitDisplay').innerText = `${m}:${s.toString().padStart(2, '0')}`;
                document.getElementById('rateDisplay').innerText = simRate;
                
                // Run Watchdog
                analyzeTelemetry(speedMS, simRate, 150, 200);

            }, 1000);
        }

        // --- BLUETOOTH ---
        async function connectBluetooth() {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'PM5' }],
                    optionalServices: [PM5_SERVICE]
                });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(PM5_SERVICE);
                const char = await service.getCharacteristic(PM5_CHAR_32);
                await char.startNotifications();
                char.addEventListener('characteristicvaluechanged', (e) => {
                    let d = e.target.value;
                    if(d.byteLength < 13) return;
                    let speed = (d.getUint8(3) | (d.getUint8(4)<<8)) * 0.001;
                    let rate = d.getUint8(5);
                    let watts = (d.getUint8(11) | (d.getUint8(12)<<8));
                    
                    // Update UI
                    if(speed > 0.1) {
                        let split = 500/speed;
                        let m = Math.floor(split/60);
                        let s = Math.floor(split%60);
                        document.getElementById('splitDisplay').innerText = `${m}:${s.toString().padStart(2,'0')}`;
                        document.getElementById('wattsDisplay').innerText = watts;
                        document.getElementById('rateDisplay').innerText = rate;
                        analyzeTelemetry(speed, rate, 0, watts);
                    }
                });
            } catch(e) { alert(e.message); }
        }
    </script>
</body>
</html>
