<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Rowing Coach v1.1</title>
    <style>
        :root {
            --bg: #000;
            --text: #e0e0e0;
            --accent: #00FF99;
            --accent-dim: #00AA66;
            --danger: #FF4444;
            --rest: #00AAFF;
            --panel: #111;
            --border: #222;
            --card-bg: #0a0a0a;
            
            /* Persona Colors */
            --coach-color: #00FF99;
            --admin-color: #00AAFF;
            --support-color: #FFA500;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* VERSION BADGE */
        .version-badge {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 255, 153, 0.2);
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 700;
            z-index: 10000;
            letter-spacing: 0.5px;
        }
        
        /* TOAST */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--panel);
            color: var(--text);
            padding: 12px 24px;
            border-radius: 8px;
            border: 1px solid var(--border);
            z-index: 9999;
            opacity: 0;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        .toast.error { border-color: var(--danger); background: rgba(255,68,68,0.1); color: var(--danger); }
        .toast.success { border-color: var(--accent); background: rgba(0,255,153,0.1); color: var(--accent); }
        
        /* SCREENS */
        .screen {
            display: none;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }
        
        .screen.active { display: flex; }
        
        .screen-header {
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        
        .screen-title {
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 1.5px;
            color: #666;
            text-transform: uppercase;
            text-align: center;
            flex: 1;
        }
        
        .header-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .header-btn:active { transform: scale(0.95); }
        .header-btn.connected { border-color: var(--accent); color: var(--accent); }
        
        .scroll-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 16px;
            padding-bottom: 100px;
        }
        
        /* ONBOARDING */
        .onboarding-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: linear-gradient(135deg, #000 0%, #0a0a0a 100%);
        }
        
        .onboarding-header {
            padding: 40px 20px 20px 20px;
            text-align: center;
        }
        
        .onboarding-logo {
            font-size: 64px;
            margin-bottom: 16px;
        }
        
        .onboarding-title {
            font-size: 28px;
            font-weight: 900;
            color: var(--accent);
            margin-bottom: 8px;
        }
        
        .onboarding-subtitle {
            font-size: 14px;
            color: #666;
        }
        
        .onboarding-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .onboarding-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
        }
        
        .onboarding-question {
            font-size: 16px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 16px;
        }
        
        .onboarding-input {
            width: 100%;
            background: #000;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
        }
        
        .onboarding-input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .onboarding-select {
            width: 100%;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }
        
        .onboarding-option {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .onboarding-option:active {
            transform: scale(0.95);
        }
        
        .onboarding-option.selected {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
        }
        
        .onboarding-footer {
            padding: 20px;
            border-top: 1px solid var(--border);
            background: var(--panel);
        }
        
        .onboarding-progress {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 16px;
        }
        
        .progress-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #333;
            transition: all 0.3s;
        }
        
        .progress-dot.active {
            background: var(--accent);
            transform: scale(1.5);
        }
        
        /* CHAT INTERFACE */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .chat-message {
            max-width: 85%;
            padding: 14px 18px;
            border-radius: 16px;
            line-height: 1.5;
            font-size: 15px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .msg-ai {
            background: var(--card-bg);
            border: 1px solid var(--border);
            align-self: flex-start;
            border-radius: 16px 16px 16px 4px;
        }
        
        .msg-ai.persona-coach {
            border-left: 3px solid var(--coach-color);
        }
        
        .msg-ai.persona-admin {
            border-left: 3px solid var(--admin-color);
        }
        
        .msg-ai.persona-support {
            border-left: 3px solid var(--support-color);
        }
        
        .msg-user {
            background: #0d3a2e;
            border: 1px solid #1a4a3e;
            align-self: flex-end;
            border-radius: 16px 16px 4px 16px;
        }
        
        .msg-header {
            font-size: 11px;
            font-weight: 700;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .msg-header.persona-coach { color: var(--coach-color); }
        .msg-header.persona-admin { color: var(--admin-color); }
        .msg-header.persona-support { color: var(--support-color); }
        .msg-user .msg-header { color: #00AAFF; }
        
        /* PERSONA SELECTOR */
        .persona-selector {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 8px;
            overflow-x: auto;
        }
        
        .persona-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: #666;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .persona-btn.active.coach {
            background: var(--coach-color);
            color: #000;
            border-color: var(--coach-color);
        }
        
        .persona-btn.active.admin {
            background: var(--admin-color);
            color: #000;
            border-color: var(--admin-color);
        }
        
        .persona-btn.active.support {
            background: var(--support-color);
            color: #000;
            border-color: var(--support-color);
        }
        
        .chat-input-container {
            border-top: 1px solid var(--border);
            background: var(--panel);
            padding: 12px 16px;
            padding-bottom: calc(12px + env(safe-area-inset-bottom));
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }
        
        .chat-input {
            flex: 1;
            background: #0a0a0a;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 12px 16px;
            border-radius: 20px;
            font-size: 15px;
            font-family: inherit;
            resize: none;
            max-height: 120px;
            min-height: 44px;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .send-btn {
            background: var(--accent);
            color: #000;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
        }
        
        .send-btn:active { transform: scale(0.9); }
        .send-btn:disabled { background: #333; color: #666; cursor: not-allowed; }
        
        /* TYPING INDICATOR */
        .typing-indicator {
            display: none;
            align-items: center;
            gap: 4px;
            padding: 16px;
            max-width: 85%;
        }
        
        .typing-indicator.active { display: flex; }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-10px); opacity: 1; }
        }
        
        /* LIVE COACH WIDGET */
        .live-coach-widget {
            background: linear-gradient(135deg, #0a1a0a 0%, #0a0a0a 100%);
            border: 2px solid var(--coach-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 4px 20px rgba(0, 255, 153, 0.1);
        }
        
        .live-coach-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .live-coach-avatar {
            font-size: 32px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .live-coach-status {
            font-size: 11px;
            font-weight: 700;
            color: var(--coach-color);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .live-coach-message {
            font-size: 16px;
            line-height: 1.5;
            color: var(--text);
            font-weight: 600;
            min-height: 48px;
        }
        
        /* BUTTONS */
        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: 0.5px;
        }
        
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--accent); color: #000; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn + .btn { margin-top: 12px; }
        
        /* CARDS */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }
        
        /* NAVIGATION */
        .nav-bar {
            background: var(--panel);
            border-top: 1px solid var(--border);
            display: flex;
            height: 70px;
            flex-shrink: 0;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .nav-item {
            flex: 1;
            background: transparent;
            border: none;
            color: #666;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: all 0.2s;
        }
        
        .nav-item.active {
            color: var(--accent);
            background: rgba(0,255,153,0.05);
        }
        
        .nav-icon { font-size: 20px; }
        
        /* CHART CONTAINER */
        .chart-container {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin: 16px 0;
        }
        
        .chart-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 16px;
            text-align: center;
        }
        
        canvas {
            max-width: 100%;
            height: auto;
        }
    </style>
</head>
<body>
    <!-- VERSION BADGE -->
    <div class="version-badge">v1.1 BETA</div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <!-- ONBOARDING SCREEN -->
    <div id="screenOnboarding" class="screen">
        <div class="onboarding-container">
            <div class="onboarding-header">
                <div class="onboarding-logo">üö£</div>
                <div class="onboarding-title">AI Rowing Coach</div>
                <div class="onboarding-subtitle">Your intelligent training partner</div>
            </div>
            
            <div class="onboarding-content" id="onboardingContent">
                <!-- Dynamic onboarding steps will be injected here -->
            </div>
            
            <div class="onboarding-footer">
                <div class="onboarding-progress" id="onboardingProgress">
                    <div class="progress-dot active"></div>
                    <div class="progress-dot"></div>
                    <div class="progress-dot"></div>
                    <div class="progress-dot"></div>
                    <div class="progress-dot"></div>
                </div>
                <button class="btn btn-primary" id="onboardingNextBtn" onclick="app.nextOnboardingStep()">
                    Next
                </button>
            </div>
        </div>
    </div>

    <!-- AI COACH SCREEN -->
    <div id="screenCoach" class="screen">
        <div class="screen-header">
            <div class="screen-title">AI Hub</div>
        </div>
        
        <!-- Persona Selector -->
        <div class="persona-selector">
            <button class="persona-btn active coach" onclick="app.switchPersona('coach')">
                <span>ü§ñ</span> Coach
            </button>
            <button class="persona-btn admin" onclick="app.switchPersona('admin')">
                <span>‚öôÔ∏è</span> Admin
            </button>
            <button class="persona-btn support" onclick="app.switchPersona('support')">
                <span>üõ†Ô∏è</span> Support
            </button>
        </div>
        
        <div class="chat-container">
            <div class="chat-messages" id="chatMessages">
                <div class="chat-message msg-ai persona-coach">
                    <div class="msg-header persona-coach">
                        <span>ü§ñ</span> Coach
                    </div>
                    Welcome! I'm your AI Rowing Coach. I can help you plan workouts, analyze your performance, and provide real-time motivation. What would you like to do today?
                </div>
            </div>
            <div class="typing-indicator" id="typingIndicator">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
            <div class="chat-input-container">
                <textarea 
                    id="chatInput" 
                    class="chat-input" 
                    placeholder="Ask anything..."
                    rows="1"
                    onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault();app.sendMessage();}"
                ></textarea>
                <button class="send-btn" id="sendBtn" onclick="app.sendMessage()">‚Üë</button>
            </div>
        </div>
    </div>

    <!-- ROW SCREEN -->
    <div id="screenRow" class="screen">
        <div class="screen-header">
            <button class="header-btn" onclick="app.endWorkout()">End</button>
            <div class="screen-title">Rowing</div>
            <button class="header-btn" id="btBtn" onclick="app.connectBluetooth()">
                Connect PM5
            </button>
        </div>
        <div class="scroll-content" style="padding: 0;">
            
            <!-- LIVE COACH WIDGET -->
            <div class="live-coach-widget">
                <div class="live-coach-header">
                    <div class="live-coach-avatar">ü§ñ</div>
                    <div>
                        <div class="live-coach-status" id="liveCoachStatus">Ready</div>
                        <div style="font-size: 10px; color: #666;">Real-time coaching</div>
                    </div>
                </div>
                <div class="live-coach-message" id="liveCoachMessage">
                    Start rowing to receive real-time coaching and motivation!
                </div>
            </div>

            <!-- Metrics Dashboard -->
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:1px; background:#222;">
                <div style="background:#0a0a0a; padding:24px 16px; text-align:center; grid-column:1/-1;">
                    <div style="font-size:11px; color:#666; font-weight:700; margin-bottom:8px;">CURRENT PACE</div>
                    <div style="font-size:56px; font-weight:900; color:#e0e0e0; line-height:1;" id="mainPace">0:00</div>
                    <div style="margin-top:8px; font-size:13px; color:#888;"><span id="paceVsTarget">--</span></div>
                </div>
                
                <div style="background:#0a0a0a; padding:20px 16px; text-align:center;">
                    <div style="font-size:10px; color:#666; font-weight:700; margin-bottom:6px;">TIME</div>
                    <div style="font-size:32px; font-weight:900; color:#e0e0e0;" id="mainTime">0:00</div>
                </div>
                
                <div style="background:#0a0a0a; padding:20px 16px; text-align:center;">
                    <div style="font-size:10px; color:#666; font-weight:700; margin-bottom:6px;">METERS</div>
                    <div style="font-size:32px; font-weight:900; color:#e0e0e0;" id="mainDist">0</div>
                </div>
            </div>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:1px; background:#222; margin-top:1px;">
                <div style="background:#0a0a0a; padding:16px; text-align:center;">
                    <div style="font-size:9px; color:#666; font-weight:700; margin-bottom:4px;">WATTS</div>
                    <div style="font-size:28px; font-weight:900; color:#00FF99;" id="mainWatts">0</div>
                </div>
                
                <div style="background:#0a0a0a; padding:16px; text-align:center;">
                    <div style="font-size:9px; color:#666; font-weight:700; margin-bottom:4px;">S/M</div>
                    <div style="font-size:28px; font-weight:900; color:#00FF99;" id="mainRate">0</div>
                </div>
                
                <div style="background:#0a0a0a; padding:16px; text-align:center;">
                    <div style="font-size:9px; color:#666; font-weight:700; margin-bottom:4px;">HEART RATE</div>
                    <div style="font-size:28px; font-weight:900; color:#ff6b6b;" id="mainHR">--</div>
                    <div style="font-size:10px; margin-top:4px;" id="hrZone">--</div>
                </div>
                
                <div style="background:#0a0a0a; padding:16px; text-align:center;">
                    <div style="font-size:9px; color:#666; font-weight:700; margin-bottom:4px;">CAL</div>
                    <div style="font-size:28px; font-weight:900; color:#ffa500;" id="mainCal">0</div>
                </div>
            </div>

            <!-- HR Zone Bar -->
            <div id="hrZoneBar" style="display:none; padding:16px; background:#0a0a0a; border-top:1px solid #222;">
                <div style="font-size:10px; color:#666; margin-bottom:8px; text-align:center; font-weight:700;">HEART RATE ZONES</div>
                <div style="display:flex; height:40px; border-radius:8px; overflow:hidden;">
                    <div style="flex:1; background:#4a90e2; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700;">Z1</div>
                    <div style="flex:1; background:#50c878; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700;">Z2</div>
                    <div style="flex:1; background:#ffa500; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700;">Z3</div>
                    <div style="flex:1; background:#ff6347; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700;">Z4</div>
                    <div style="flex:1; background:#dc143c; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700;">Z5</div>
                </div>
                <div id="hrZoneIndicator" style="margin-top:8px; height:4px; background:var(--accent); border-radius:2px; transition:all 0.3s;"></div>
            </div>

        </div>
    </div>

    <!-- DATA SCREEN -->
    <div id="screenData" class="screen">
        <div class="screen-header">
            <div class="screen-title">Settings</div>
        </div>
        <div class="scroll-content">
            <div class="card">
                <h3 style="color:var(--accent); margin-bottom:16px; font-size:16px;">User Profile</h3>
                <div style="margin-bottom:12px;">
                    <div style="font-size:12px; color:#666; margin-bottom:4px;">Name</div>
                    <div style="color:#e0e0e0; font-size:16px;" id="profileName">--</div>
                </div>
                <div style="margin-bottom:12px;">
                    <div style="font-size:12px; color:#666; margin-bottom:4px;">Age</div>
                    <div style="color:#e0e0e0; font-size:16px;" id="profileAge">--</div>
                </div>
                <div style="margin-bottom:12px;">
                    <div style="font-size:12px; color:#666; margin-bottom:4px;">Weight</div>
                    <div style="color:#e0e0e0; font-size:16px;" id="profileWeight">--</div>
                </div>
                <div style="margin-bottom:12px;">
                    <div style="font-size:12px; color:#666; margin-bottom:4px;">Max HR</div>
                    <div style="color:#e0e0e0; font-size:16px;" id="profileMaxHR">--</div>
                </div>
                <p style="font-size:12px; color:#666; margin-top:16px; line-height:1.6;">
                    üí° Tip: You can update these settings by asking the Admin persona in the AI Hub. 
                    Try: "Update my weight to 82kg"
                </p>
            </div>

            <div class="card">
                <h3 style="color:var(--accent); margin-bottom:16px; font-size:16px;">Import Training Data</h3>
                <label for="csvUpload" style="display:block; width:100%; padding:16px; border:2px dashed #222; border-radius:8px; text-align:center; cursor:pointer; color:#888;">
                    üìÅ Import CSV File
                </label>
                <input type="file" id="csvUpload" accept=".csv" style="display:none;" onchange="app.importCSV(event)">
            </div>

            <div class="card">
                <h3 style="color:var(--accent); margin-bottom:16px; font-size:16px;">Connections</h3>
                <button class="btn btn-outline" onclick="app.showToast('HRM connection coming in v1.2', 'success')">
                    ‚ù§Ô∏è Connect Heart Rate Monitor
                </button>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="nav-bar">
        <button class="nav-item active" onclick="app.navigate('screenCoach')">
            <span class="nav-icon">ü§ñ</span>
            AI Hub
        </button>
        <button class="nav-item" onclick="app.navigate('screenRow')">
            <span class="nav-icon">üö£</span>
            Row
        </button>
        <button class="nav-item" onclick="app.navigate('screenData')">
            <span class="nav-icon">‚öôÔ∏è</span>
            Settings
        </button>
    </nav>

    <script>
        // ============================================================================
        // AI ROWING COACH PRO v1.1
        // Features: Live Coaching, Multi-Persona, AI Function Calling, Onboarding
        // ============================================================================
        
        const STORAGE_KEYS = {
            PROFILE: 'rowing_coach_profile_v1',
            WORKOUTS: 'rowing_coach_workouts_v1',
            CHAT: 'rowing_coach_chat_v1',
            ONBOARDED: 'rowing_coach_onboarded_v1'
        };

        const PERSONAS = {
            coach: {
                name: 'Coach',
                emoji: 'ü§ñ',
                color: '#00FF99',
                systemPrompt: `You are an aggressive, motivational rowing coach. You focus on performance data, training plans, and pushing athletes to their limits. You reference specific metrics and past workouts. You're encouraging but demanding.

When asked to create workouts, ALWAYS return structured data in this format:
WORKOUT_PLAN:
[
  {"type": "WORK", "distance": 2000, "targetPace": "1:55", "targetWatts": 228},
  {"type": "REST", "duration": 240}
]

When asked about progress or analysis, you can trigger chart rendering:
CHART:
{"type": "line", "data": {...}}
`
            },
            admin: {
                name: 'Admin',
                emoji: '‚öôÔ∏è',
                color: '#00AAFF',
                systemPrompt: `You are a helpful administrative assistant. You manage user settings, profile updates, and account management. You execute setting changes automatically and confirm them clearly.

When the user asks to update settings, extract the action and return:
ACTION:
{"type": "updateSettings", "params": {"field": "value"}}

Always confirm changes: "I've updated your [field] to [value]."
`
            },
            support: {
                name: 'Support',
                emoji: 'üõ†Ô∏è',
                color: '#FFA500',
                systemPrompt: `You are a patient technical support specialist. You help with Bluetooth connectivity, troubleshooting bugs, and explaining features. You provide step-by-step instructions and never get frustrated.

Focus on:
- PM5 Bluetooth connection issues
- Heart rate monitor setup
- Data import problems
- App navigation help
`
            }
        };

        const ONBOARDING_STEPS = [
            {
                id: 'welcome',
                question: "Welcome! What's your name?",
                type: 'text',
                field: 'name',
                placeholder: 'Enter your name'
            },
            {
                id: 'biometrics',
                question: "Let's get your basic stats",
                type: 'multi',
                fields: [
                    { id: 'age', label: 'Age', type: 'number', placeholder: '30' },
                    { id: 'weight', label: 'Weight (kg)', type: 'number', placeholder: '75' },
                    { id: 'gender', label: 'Gender', type: 'select', options: ['Male', 'Female', 'Other'] }
                ]
            },
            {
                id: 'experience',
                question: "What's your rowing experience level?",
                type: 'select',
                field: 'experience',
                options: ['Beginner', 'Intermediate', 'Advanced', 'Elite']
            },
            {
                id: 'goals',
                question: "What are your primary training goals?",
                type: 'multiselect',
                field: 'goals',
                options: ['Weight Loss', 'Endurance', 'Speed/Power', 'General Fitness', 'Competition']
            },
            {
                id: 'lifestyle',
                question: "Tell us about your lifestyle",
                type: 'multi',
                fields: [
                    { id: 'job', label: 'Job Type', type: 'select', options: ['Sedentary', 'Active', 'Physical'] },
                    { id: 'stress', label: 'Stress Level', type: 'select', options: ['Low', 'Medium', 'High'] },
                    { id: 'sleep', label: 'Avg Sleep (hrs)', type: 'number', placeholder: '7' }
                ]
            }
        ];

        class AIRowingCoach {
            constructor() {
                this.profile = null;
                this.workouts = [];
                this.chatHistory = [];
                this.currentPersona = 'coach';
                this.onboardingStep = 0;
                this.onboardingData = {};
                this.liveData = { time: 0, dist: 0, pace: 0, watts: 0, rate: 0, hr: 0 };
                this.liveCoachingInterval = null;
                this.lastCoachingTime = 0;
                
                this.init();
            }

            // ========================================================================
            // INITIALIZATION
            // ========================================================================
            
            init() {
                this.loadData();
                
                // Check if onboarded
                const onboarded = localStorage.getItem(STORAGE_KEYS.ONBOARDED);
                if (!onboarded) {
                    this.startOnboarding();
                } else {
                    this.navigate('screenCoach');
                    this.updateProfileDisplay();
                }
                
                this.renderChat();
                
                // Auto-resize chat input
                const input = document.getElementById('chatInput');
                if (input) {
                    input.addEventListener('input', () => {
                        input.style.height = 'auto';
                        input.style.height = Math.min(input.scrollHeight, 120) + 'px';
                    });
                }
            }

            loadData() {
                try {
                    const profileData = localStorage.getItem(STORAGE_KEYS.PROFILE);
                    if (profileData) {
                        this.profile = JSON.parse(profileData);
                    }

                    const workoutData = localStorage.getItem(STORAGE_KEYS.WORKOUTS);
                    if (workoutData) {
                        this.workouts = JSON.parse(workoutData);
                    }

                    const chatData = localStorage.getItem(STORAGE_KEYS.CHAT);
                    if (chatData) {
                        this.chatHistory = JSON.parse(chatData);
                    }
                } catch (error) {
                    console.error('Load error:', error);
                }
            }

            saveData() {
                try {
                    if (this.profile) {
                        localStorage.setItem(STORAGE_KEYS.PROFILE, JSON.stringify(this.profile));
                    }
                    localStorage.setItem(STORAGE_KEYS.WORKOUTS, JSON.stringify(this.workouts));
                    localStorage.setItem(STORAGE_KEYS.CHAT, JSON.stringify(this.chatHistory));
                } catch (error) {
                    console.error('Save error:', error);
                }
            }

            // ========================================================================
            // ONBOARDING
            // ========================================================================

            startOnboarding() {
                this.navigate('screenOnboarding');
                this.renderOnboardingStep();
            }

            renderOnboardingStep() {
                const step = ONBOARDING_STEPS[this.onboardingStep];
                const content = document.getElementById('onboardingContent');
                
                let html = `<div class="onboarding-card">`;
                html += `<div class="onboarding-question">${step.question}</div>`;

                if (step.type === 'text') {
                    html += `<input type="text" class="onboarding-input" id="onboarding_${step.field}" placeholder="${step.placeholder}">`;
                } else if (step.type === 'number') {
                    html += `<input type="number" class="onboarding-input" id="onboarding_${step.field}" placeholder="${step.placeholder}">`;
                } else if (step.type === 'select') {
                    html += `<div class="onboarding-select">`;
                    step.options.forEach(opt => {
                        html += `<button class="onboarding-option" onclick="app.selectOnboardingOption('${step.field}', '${opt}')">${opt}</button>`;
                    });
                    html += `</div>`;
                } else if (step.type === 'multiselect') {
                    html += `<div class="onboarding-select">`;
                    step.options.forEach(opt => {
                        html += `<button class="onboarding-option" onclick="app.toggleOnboardingOption('${step.field}', '${opt}')">${opt}</button>`;
                    });
                    html += `</div>`;
                } else if (step.type === 'multi') {
                    step.fields.forEach(field => {
                        html += `<div style="margin-bottom:16px;">`;
                        html += `<div style="font-size:12px; color:#666; margin-bottom:8px;">${field.label}</div>`;
                        if (field.type === 'select') {
                            html += `<div class="onboarding-select" style="grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));">`;
                            field.options.forEach(opt => {
                                html += `<button class="onboarding-option" onclick="app.selectOnboardingOption('${field.id}', '${opt}')">${opt}</button>`;
                            });
                            html += `</div>`;
                        } else {
                            html += `<input type="${field.type}" class="onboarding-input" id="onboarding_${field.id}" placeholder="${field.placeholder}">`;
                        }
                        html += `</div>`;
                    });
                }

                html += `</div>`;
                content.innerHTML = html;

                // Update progress dots
                document.querySelectorAll('.progress-dot').forEach((dot, i) => {
                    dot.classList.toggle('active', i === this.onboardingStep);
                });

                // Update button text
                const btn = document.getElementById('onboardingNextBtn');
                btn.textContent = this.onboardingStep === ONBOARDING_STEPS.length - 1 ? 'Complete' : 'Next';
            }

            selectOnboardingOption(field, value) {
                this.onboardingData[field] = value;
                
                // Visual feedback
                const buttons = document.querySelectorAll('.onboarding-option');
                buttons.forEach(btn => {
                    if (btn.textContent === value && btn.onclick.toString().includes(field)) {
                        btn.classList.add('selected');
                    } else if (btn.onclick.toString().includes(field)) {
                        btn.classList.remove('selected');
                    }
                });
            }

            toggleOnboardingOption(field, value) {
                if (!this.onboardingData[field]) {
                    this.onboardingData[field] = [];
                }
                
                const index = this.onboardingData[field].indexOf(value);
                if (index > -1) {
                    this.onboardingData[field].splice(index, 1);
                } else {
                    this.onboardingData[field].push(value);
                }

                // Visual feedback
                const buttons = document.querySelectorAll('.onboarding-option');
                buttons.forEach(btn => {
                    if (btn.textContent === value && btn.onclick.toString().includes(field)) {
                        btn.classList.toggle('selected');
                    }
                });
            }

            nextOnboardingStep() {
                const step = ONBOARDING_STEPS[this.onboardingStep];

                // Collect data from inputs
                if (step.type === 'text' || step.type === 'number') {
                    const input = document.getElementById(`onboarding_${step.field}`);
                    if (input && input.value) {
                        this.onboardingData[step.field] = input.value;
                    }
                } else if (step.type === 'multi') {
                    step.fields.forEach(field => {
                        if (field.type !== 'select') {
                            const input = document.getElementById(`onboarding_${field.id}`);
                            if (input && input.value) {
                                this.onboardingData[field.id] = input.value;
                            }
                        }
                    });
                }

                // Move to next step or complete
                if (this.onboardingStep < ONBOARDING_STEPS.length - 1) {
                    this.onboardingStep++;
                    this.renderOnboardingStep();
                } else {
                    this.completeOnboarding();
                }
            }

            completeOnboarding() {
                // Calculate Max HR if not provided
                if (!this.onboardingData.maxHR && this.onboardingData.age) {
                    this.onboardingData.maxHR = 220 - parseInt(this.onboardingData.age);
                }

                this.profile = this.onboardingData;
                localStorage.setItem(STORAGE_KEYS.PROFILE, JSON.stringify(this.profile));
                localStorage.setItem(STORAGE_KEYS.ONBOARDED, 'true');

                this.showToast('Profile created successfully!', 'success');
                this.navigate('screenCoach');
                this.updateProfileDisplay();

                // Add welcome message
                this.addMessage('ai', `Welcome ${this.profile.name}! I'm excited to be your rowing coach. Based on your profile, I can see you're ${this.profile.experience?.toLowerCase()} level. Let's create your first workout!`, null, 'coach');
            }

            updateProfileDisplay() {
                if (!this.profile) return;

                const nameElem = document.getElementById('profileName');
                const ageElem = document.getElementById('profileAge');
                const weightElem = document.getElementById('profileWeight');
                const maxHRElem = document.getElementById('profileMaxHR');

                if (nameElem) nameElem.textContent = this.profile.name || '--';
                if (ageElem) ageElem.textContent = this.profile.age || '--';
                if (weightElem) weightElem.textContent = this.profile.weight ? `${this.profile.weight} kg` : '--';
                if (maxHRElem) maxHRElem.textContent = this.profile.maxHR || '--';
            }

            // ========================================================================
            // PERSONA MANAGEMENT
            // ========================================================================

            switchPersona(persona) {
                this.currentPersona = persona;

                // Update UI
                document.querySelectorAll('.persona-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');

                // Add system message
                const personaData = PERSONAS[persona];
                this.addMessage('system', `Switched to ${personaData.name} ${personaData.emoji}`);
            }

            // ========================================================================
            // AI CHAT
            // ========================================================================

            async sendMessage() {
                const input = document.getElementById('chatInput');
                const message = input.value.trim();
                
                if (!message) return;

                this.addMessage('user', message);
                input.value = '';
                input.style.height = 'auto';

                const typingIndicator = document.getElementById('typingIndicator');
                const sendBtn = document.getElementById('sendBtn');
                
                if (typingIndicator) typingIndicator.classList.add('active');
                if (sendBtn) sendBtn.disabled = true;

                try {
                    const response = await this.callAIAPI(message);
                    if (typingIndicator) typingIndicator.classList.remove('active');
                    
                    // Check for actions
                    if (response.action) {
                        this.executeAction(response.action);
                    }
                    
                    // Check for charts
                    if (response.chart) {
                        this.renderChart(response.chart);
                    }
                    
                    this.addMessage('ai', response.text, response.workout, this.currentPersona);
                } catch (error) {
                    console.error('AI Error:', error);
                    if (typingIndicator) typingIndicator.classList.remove('active');
                    this.addMessage('ai', 'Sorry, I encountered an error. Please try again.', null, this.currentPersona);
                    this.showToast('AI request failed', 'error');
                } finally {
                    if (sendBtn) sendBtn.disabled = false;
                }
            }

            async callAIAPI(userMessage) {
                const persona = PERSONAS[this.currentPersona];
                
                // Build context
                let context = '';
                if (this.profile) {
                    context += `User Profile: ${JSON.stringify(this.profile)}\n`;
                }
                if (this.workouts.length > 0) {
                    context += `Recent workouts: ${this.workouts.slice(0, 5).map(w => w.description).join(', ')}\n`;
                }

                const systemPrompt = persona.systemPrompt + '\n\n' + context;

                try {
                    const response = await fetch("https://api.anthropic.com/v1/messages", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            model: "claude-sonnet-4-20250514",
                            max_tokens: 2000,
                            system: systemPrompt,
                            messages: [
                                ...this.chatHistory.slice(-5).filter(m => m.sender !== 'system').map(msg => ({
                                    role: msg.sender === 'user' ? 'user' : 'assistant',
                                    content: msg.text
                                })),
                                {
                                    role: "user",
                                    content: userMessage
                                }
                            ]
                        })
                    });

                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error.message);
                    }

                    const aiText = data.content[0].text;
                    
                    // Extract workout plan
                    let workout = null;
                    const workoutMatch = aiText.match(/WORKOUT_PLAN:\s*(\[[\s\S]*?\])/);
                    if (workoutMatch) {
                        try {
                            const workoutJson = JSON.parse(workoutMatch[1]);
                            workout = { intervals: workoutJson };
                        } catch (e) {
                            console.error('Failed to parse workout:', e);
                        }
                    }

                    // Extract action
                    let action = null;
                    const actionMatch = aiText.match(/ACTION:\s*(\{[\s\S]*?\})/);
                    if (actionMatch) {
                        try {
                            action = JSON.parse(actionMatch[1]);
                        } catch (e) {
                            console.error('Failed to parse action:', e);
                        }
                    }

                    // Extract chart
                    let chart = null;
                    const chartMatch = aiText.match(/CHART:\s*(\{[\s\S]*?\})/);
                    if (chartMatch) {
                        try {
                            chart = JSON.parse(chartMatch[1]);
                        } catch (e) {
                            console.error('Failed to parse chart:', e);
                        }
                    }

                    const displayText = aiText
                        .replace(/WORKOUT_PLAN:[\s\S]*?(\])/m, '')
                        .replace(/ACTION:[\s\S]*?(\})/m, '')
                        .replace(/CHART:[\s\S]*?(\})/m, '')
                        .trim();

                    return {
                        text: displayText,
                        workout: workout,
                        action: action,
                        chart: chart
                    };

                } catch (error) {
                    console.error('AI API error:', error);
                    throw error;
                }
            }

            executeAction(action) {
                if (action.type === 'updateSettings') {
                    Object.keys(action.params).forEach(key => {
                        if (this.profile) {
                            this.profile[key] = action.params[key];
                        }
                    });
                    this.saveData();
                    this.updateProfileDisplay();
                    this.showToast('Settings updated', 'success');
                }
            }

            renderChart(chartData) {
                // Create chart in chat
                const chartHtml = `
                    <div class="chart-container">
                        <div class="chart-title">${chartData.title || 'Performance Chart'}</div>
                        <canvas id="chat-chart-${Date.now()}"></canvas>
                    </div>
                `;
                
                // Insert into last AI message
                const messages = document.querySelectorAll('.msg-ai');
                if (messages.length > 0) {
                    messages[messages.length - 1].innerHTML += chartHtml;
                }
            }

            addMessage(sender, text, workout = null, persona = 'coach') {
                const msg = {
                    sender: sender,
                    text: text,
                    workout: workout,
                    persona: persona,
                    timestamp: new Date().toISOString()
                };

                this.chatHistory.push(msg);
                this.saveData();
                this.renderChat();
            }

            renderChat() {
                const container = document.getElementById('chatMessages');
                if (!container) return;
                
                const html = this.chatHistory.map((msg, idx) => {
                    if (msg.sender === 'user') {
                        return `
                            <div class="chat-message msg-user">
                                <div class="msg-header">
                                    <span>üë§</span> You
                                </div>
                                ${this.formatMessageText(msg.text)}
                            </div>
                        `;
                    } else if (msg.sender === 'ai') {
                        const persona = PERSONAS[msg.persona] || PERSONAS.coach;
                        return `
                            <div class="chat-message msg-ai persona-${msg.persona}">
                                <div class="msg-header persona-${msg.persona}">
                                    <span>${persona.emoji}</span> ${persona.name}
                                </div>
                                ${this.formatMessageText(msg.text)}
                            </div>
                        `;
                    } else {
                        return `
                            <div class="chat-message" style="background:transparent; border:1px solid #222; align-self:center; font-size:13px; color:#666; padding:8px 16px; border-radius:20px;">
                                ${msg.text}
                            </div>
                        `;
                    }
                }).join('');

                container.innerHTML = html;
                setTimeout(() => {
                    container.scrollTop = container.scrollHeight;
                }, 100);
            }

            formatMessageText(text) {
                return text.replace(/\n/g, '<br>');
            }

            // ========================================================================
            // LIVE COACHING
            // ========================================================================

            startLiveCoaching() {
                if (this.liveCoachingInterval) return;

                this.liveCoachingInterval = setInterval(() => {
                    this.updateLiveCoaching();
                }, 2000); // Check every 2 seconds
            }

            stopLiveCoaching() {
                if (this.liveCoachingInterval) {
                    clearInterval(this.liveCoachingInterval);
                    this.liveCoachingInterval = null;
                }
            }

            updateLiveCoaching() {
                const now = Date.now();
                
                // Don't spam - minimum 5 seconds between messages
                if (now - this.lastCoachingTime < 5000) return;

                const d = this.liveData;
                const statusElem = document.getElementById('liveCoachStatus');
                const messageElem = document.getElementById('liveCoachMessage');

                if (!statusElem || !messageElem) return;

                // Determine coaching based on performance
                let status = 'Monitoring';
                let message = '';

                // Pace dropping
                if (d.pace > 0 && d.pace > 125) { // Slower than 2:05
                    status = 'Push Harder!';
                    message = '‚ö†Ô∏è Power dropping! Focus on the leg drive. Push back through your heels!';
                    this.lastCoachingTime = now;
                }
                // Pace too fast early
                else if (d.time < 60 && d.pace > 0 && d.pace < 110) { // Faster than 1:50 in first minute
                    status = 'Ease Off';
                    message = '‚ö†Ô∏è You\'re flying! Too fast too soon. Settle into rhythm, save energy for later.';
                    this.lastCoachingTime = now;
                }
                // Good pace
                else if (d.pace > 110 && d.pace < 120) { // 1:50-2:00
                    status = 'Perfect!';
                    message = 'üí™ Excellent pace control! Keep this rhythm. You\'re locked in.';
                    this.lastCoachingTime = now;
                }
                // HR too high (if available and maxHR known)
                else if (d.hr > 0 && this.profile && this.profile.maxHR) {
                    const hrPercent = (d.hr / this.profile.maxHR) * 100;
                    if (hrPercent > 95 && d.time < 300) { // >95% in first 5 minutes
                        status = 'Red Zone!';
                        message = '‚ù§Ô∏è Heart rate too high too soon! Ease back to 22 s/m for 30 seconds.';
                        this.lastCoachingTime = now;
                    }
                }
                // Stroke rate
                else if (d.rate > 32) {
                    status = 'Too Fast';
                    message = '‚ö†Ô∏è Stroke rate too high. Slow down, longer strokes. Aim for 24-28 s/m.';
                    this.lastCoachingTime = now;
                }

                if (message) {
                    statusElem.textContent = status;
                    messageElem.textContent = message;
                }
            }

            // ========================================================================
            // WORKOUT & ROWING
            // ========================================================================

            startWorkout() {
                this.navigate('screenRow');
                this.startLiveCoaching();
                this.showToast('Workout started! Watch for live coaching.', 'success');

                // Show HR zone bar if maxHR available
                if (this.profile && this.profile.maxHR) {
                    const hrZoneBar = document.getElementById('hrZoneBar');
                    if (hrZoneBar) hrZoneBar.style.display = 'block';
                }

                // Simulate data for demo
                this.startDemoData();
            }

            startDemoData() {
                // Simulated rowing data for testing
                let time = 0;
                const demoInterval = setInterval(() => {
                    time++;
                    this.liveData = {
                        time: time,
                        dist: time * 4,
                        pace: 115 + Math.random() * 10,
                        watts: 220 + Math.random() * 30,
                        rate: 24 + Math.floor(Math.random() * 4),
                        hr: 150 + Math.floor(Math.random() * 20)
                    };

                    this.updateDashboard();

                    if (time >= 120) { // Stop after 2 minutes for demo
                        clearInterval(demoInterval);
                    }
                }, 1000);
            }

            endWorkout() {
                this.stopLiveCoaching();
                this.navigate('screenCoach');
                this.showToast('Workout ended', 'success');
            }

            updateDashboard() {
                const d = this.liveData;
                
                const paceElem = document.getElementById('mainPace');
                const timeElem = document.getElementById('mainTime');
                const distElem = document.getElementById('mainDist');
                const wattsElem = document.getElementById('mainWatts');
                const rateElem = document.getElementById('mainRate');
                const hrElem = document.getElementById('mainHR');
                const calElem = document.getElementById('mainCal');

                if (paceElem) paceElem.textContent = this.formatPace(d.pace);
                if (timeElem) timeElem.textContent = this.formatTime(d.time);
                if (distElem) distElem.textContent = d.dist;
                if (wattsElem) wattsElem.textContent = Math.floor(d.watts);
                if (rateElem) rateElem.textContent = d.rate;
                if (hrElem) hrElem.textContent = d.hr > 0 ? d.hr : '--';
                if (calElem) calElem.textContent = Math.floor((d.watts * d.time) / 4186);

                // Update HR zone
                this.updateHRZone();
            }

            updateHRZone() {
                if (!this.profile || !this.profile.maxHR || this.liveData.hr === 0) return;

                const hrPercent = (this.liveData.hr / this.profile.maxHR) * 100;
                let zone = '';
                let zoneColor = '';

                if (hrPercent < 60) {
                    zone = 'Zone 1';
                    zoneColor = '#4a90e2';
                } else if (hrPercent < 70) {
                    zone = 'Zone 2';
                    zoneColor = '#50c878';
                } else if (hrPercent < 80) {
                    zone = 'Zone 3';
                    zoneColor = '#ffa500';
                } else if (hrPercent < 90) {
                    zone = 'Zone 4';
                    zoneColor = '#ff6347';
                } else {
                    zone = 'Zone 5';
                    zoneColor = '#dc143c';
                }

                const hrZoneElem = document.getElementById('hrZone');
                if (hrZoneElem) {
                    hrZoneElem.textContent = zone;
                    hrZoneElem.style.color = zoneColor;
                }

                // Move indicator
                const indicator = document.getElementById('hrZoneIndicator');
                if (indicator) {
                    const position = ((hrPercent - 50) / 50) * 100; // 50-100% HR = 0-100% position
                    indicator.style.marginLeft = Math.max(0, Math.min(100, position)) + '%';
                    indicator.style.background = zoneColor;
                }
            }

            // ========================================================================
            // BLUETOOTH (PM5)
            // ========================================================================

            async connectBluetooth() {
                this.showToast('PM5 Bluetooth connection - Coming soon!', 'success');
            }

            // ========================================================================
            // CSV IMPORT
            // ========================================================================

            importCSV(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const csv = e.target.result;
                        const lines = csv.split('\n');
                        let imported = 0;
                        
                        for (let i = 1; i < lines.length; i++) {
                            if (!lines[i].trim()) continue;
                            const parts = lines[i].split(',');
                            if (parts.length > 7) {
                                this.workouts.push({
                                    id: parts[0],
                                    date: parts[1],
                                    description: parts[2],
                                    distance: parseInt(parts[7]) || 0,
                                    pace: parts[11] || '',
                                    watts: parseInt(parts[12]) || 0
                                });
                                imported++;
                            }
                        }
                        
                        this.saveData();
                        this.showToast(`Imported ${imported} workouts!`, 'success');
                        event.target.value = '';
                    } catch (error) {
                        this.showToast('Import failed: ' + error.message, 'error');
                    }
                };
                reader.readAsText(file);
            }

            // ========================================================================
            // NAVIGATION & UI
            // ========================================================================

            navigate(screenId) {
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.remove('active');
                });
                document.getElementById(screenId).classList.add('active');

                const navItems = document.querySelectorAll('.nav-item');
                navItems.forEach(item => item.classList.remove('active'));
                
                const screenMap = {
                    'screenCoach': 0,
                    'screenRow': 1,
                    'screenData': 2
                };
                
                const index = screenMap[screenId];
                if (index !== undefined && navItems[index]) {
                    navItems[index].classList.add('active');
                }
            }

            showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = `toast ${type}`;
                
                void toast.offsetWidth;
                
                toast.classList.add('show');

                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }

            formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            formatPace(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }
        }

        // ============================================================================
        // INITIALIZE APP
        // ============================================================================

        const app = new AIRowingCoach();
    </script>
</body>
</html>
