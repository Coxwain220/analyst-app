<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Rowing Coach v1.6</title>
    
    <!-- Firebase SDK v9+ (Modular) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, getDocs, deleteDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
        
        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAdwuu17GMfX_jiVyx5SOL_jmvrybq0uuo",
            authDomain: "ai-fitness-app-c5307.firebaseapp.com",
            projectId: "ai-fitness-app-c5307",
            storageBucket: "ai-fitness-app-c5307.firebasestorage.app",
            messagingSenderId: "462148834440",
            appId: "1:462148834440:web:32be31f4ae6f76e144bb3d"
        };
        
        // Initialize Firebase and make available globally
        const app = initializeApp(firebaseConfig);
        window.firebaseApp = app;
        window.firebaseAuth = getAuth(app);
        window.firebaseDb = getFirestore(app);
        window.firebaseModules = {
            signInAnonymously,
            onAuthStateChanged,
            doc,
            setDoc,
            getDoc,
            collection,
            query,
            orderBy,
            getDocs,
            deleteDoc,
            serverTimestamp
        };
        
        console.log('‚úì Firebase modules loaded');
    </script>
    
    <style>
        :root {
            --bg: #000;
            --text: #e0e0e0;
            --accent: #00FF99;
            --danger: #FF4444;
            --panel: #111;
            --border: #222;
            --card-bg: #0a0a0a;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .version-badge {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 255, 153, 0.2);
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 700;
            z-index: 10000;
        }
        
        .settings-cog {
            position: fixed;
            top: 16px;
            left: 16px;
            background: var(--panel);
            border: 1px solid var(--border);
            color: var(--text);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            z-index: 9999;
        }
        
        .toast {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--panel);
            color: var(--text);
            padding: 12px 24px;
            border-radius: 8px;
            border: 1px solid var(--border);
            z-index: 9999;
            opacity: 0;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 600;
            max-width: 90%;
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        .toast.success { border-color: var(--accent); color: var(--accent); }
        .toast.error { border-color: var(--danger); color: var(--danger); }
        
        .screen {
            display: none;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }
        
        .screen.active { display: flex; }
        
        .screen-header {
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        
        .screen-title {
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 1.5px;
            color: #666;
            text-transform: uppercase;
            flex: 1;
            text-align: center;
        }
        
        .header-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
        }
        
        .scroll-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 16px;
            padding-bottom: 100px;
        }
        
        /* DASHBOARD - SWIPEABLE VIEWS */
        .dashboard-container {
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        .dashboard-carousel {
            display: flex;
            height: 100%;
            transition: transform 0.3s ease;
        }
        
        .dashboard-view {
            min-width: 100%;
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .dashboard-dots {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            z-index: 100;
        }
        
        .dashboard-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #333;
            transition: all 0.3s;
        }
        
        .dashboard-dot.active {
            background: var(--accent);
            width: 24px;
            border-radius: 4px;
        }
        
        /* AI COACH WIDGET */
        .ai-coach-widget {
            background: linear-gradient(135deg, #0a1a0a, #0a0a0a);
            border: 2px solid var(--accent);
            border-radius: 12px;
            padding: 16px;
            margin: 16px;
            box-shadow: 0 4px 20px rgba(0,255,153,0.1);
        }
        
        .ai-coach-message {
            font-size: 16px;
            line-height: 1.5;
            color: var(--text);
            font-weight: 600;
        }
        
        /* HR ZONE BAR */
        .hr-zone-sidebar {
            position: fixed;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 60px;
            height: 300px;
            background: rgba(0,0,0,0.8);
            border: 1px solid var(--border);
            border-radius: 12px 0 0 12px;
            display: flex;
            flex-direction: column;
            padding: 8px;
            z-index: 50;
        }
        
        .hr-zone-segment {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700;
            opacity: 0.3;
            transition: all 0.3s;
            border-radius: 6px;
            margin: 2px 0;
        }
        
        .hr-zone-segment.active {
            opacity: 1;
            transform: scale(1.1);
        }
        
        /* METRICS GRID */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1px;
            background: #222;
            margin: 16px;
        }
        
        .metric-item {
            background: #0a0a0a;
            padding: 20px 16px;
            text-align: center;
        }
        
        .metric-label {
            font-size: 10px;
            color: #666;
            font-weight: 700;
            margin-bottom: 6px;
        }
        
        .metric-value {
            font-size: 28px;
            font-weight: 900;
            color: var(--text);
            font-variant-numeric: tabular-nums;
        }
        
        .metric-value.accent {
            color: var(--accent);
        }
        
        /* LARGE PRINT VIEW */
        .large-print-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            padding: 20px;
        }
        
        .large-print-metric {
            text-align: center;
            margin-bottom: 32px;
        }
        
        .large-print-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .large-print-value {
            font-size: 72px;
            font-weight: 900;
            line-height: 1;
            color: var(--accent);
        }
        
        /* BUILDER */
        .builder-mode-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .builder-mode-btn {
            padding: 16px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 13px;
            font-weight: 700;
            text-align: center;
            cursor: pointer;
        }
        
        .builder-mode-btn.active {
            background: var(--accent);
            color: #000;
        }
        
        .builder-section {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }
        
        .builder-section-title {
            font-size: 11px;
            font-weight: 700;
            color: var(--accent);
            text-transform: uppercase;
            margin-bottom: 16px;
        }
        
        .builder-input-group {
            margin-bottom: 16px;
        }
        
        .builder-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 6px;
            font-weight: 700;
        }
        
        .builder-input {
            width: 100%;
            background: #000;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 12px;
            border-radius: 6px;
            font-size: 15px;
        }
        
        .builder-time-picker {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .builder-time-input {
            flex: 1;
            background: #000;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 12px;
            border-radius: 6px;
            font-size: 18px;
            text-align: center;
            font-weight: 700;
        }
        
        .builder-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #050505;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 8px;
        }
        
        .builder-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
        }
        
        .builder-checkbox.checked {
            background: var(--accent);
            border-color: var(--accent);
            color: #000;
        }
        
        .builder-interval-list {
            margin-top: 16px;
        }
        
        .builder-interval-item {
            background: #050505;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
        }
        
        .builder-interval-item.editable {
            border-color: var(--accent);
            background: #0a0a0a;
        }
        
        .builder-interval-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .builder-interval-title {
            font-size: 13px;
            font-weight: 700;
        }
        
        .builder-interval-actions {
            display: flex;
            gap: 8px;
        }
        
        .builder-icon-btn {
            width: 32px;
            height: 32px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text);
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .builder-interval-edit {
            display: none;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }
        
        .builder-interval-item.editable .builder-interval-edit {
            display: block;
        }
        
        /* REVIEW SCREEN */
        .review-workout-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--accent);
            margin: 16px;
            text-align: center;
        }
        
        .review-interval {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            margin: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .review-interval-info {
            flex: 1;
        }
        
        .review-interval-title {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .review-interval-desc {
            font-size: 12px;
            color: #666;
        }
        
        .review-actions {
            padding: 16px;
            display: flex;
            gap: 12px;
        }
        
        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
        }
        
        .btn-primary { background: var(--accent); color: #000; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        
        /* CARDS */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }
        
        .card-header {
            font-size: 11px;
            font-weight: 700;
            color: var(--accent);
            text-transform: uppercase;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }
        
        .editable-field {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .editable-label {
            font-size: 12px;
            color: #666;
            width: 80px;
        }
        
        .editable-input {
            flex: 1;
            background: #000;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 10px;
            border-radius: 6px;
            font-size: 15px;
        }
        
        /* HISTORY */
        .history-item {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            position: relative;
        }
        
        .history-delete {
            position: absolute;
            top: 12px;
            right: 12px;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--danger);
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
        }
        
        .history-date {
            font-size: 11px;
            color: #666;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .history-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 8px;
            padding-right: 60px;
        }
        
        .history-stats {
            display: flex;
            gap: 16px;
            font-size: 12px;
            color: var(--accent);
            font-family: monospace;
            flex-wrap: wrap;
        }
        
        /* STATS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .stat-item {
            background: #050505;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
            text-align: center;
        }
        
        .stat-item-value {
            font-size: 20px;
            font-weight: 900;
            color: var(--accent);
        }
        
        .stat-item-label {
            font-size: 10px;
            color: #666;
            margin-top: 4px;
            text-transform: uppercase;
        }
        
        /* NAVIGATION */
        .nav-bar {
            background: var(--panel);
            border-top: 1px solid var(--border);
            display: flex;
            height: 70px;
            flex-shrink: 0;
        }
        
        .nav-item {
            flex: 1;
            background: transparent;
            border: none;
            color: #666;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .nav-item.active {
            color: var(--accent);
            background: rgba(0,255,153,0.05);
        }
        
        .nav-icon { font-size: 20px; }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        /* CHAT MESSAGES */
        .chat-message {
            max-width: 85%;
            padding: 14px 18px;
            border-radius: 16px;
            line-height: 1.5;
            font-size: 15px;
            margin-bottom: 12px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .chat-message.user {
            background: #0d3a2e;
            border: 1px solid #1a4a3e;
            margin-left: auto;
            border-radius: 16px 16px 4px 16px;
        }
        
        .chat-message.ai {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-left: 3px solid var(--accent);
            border-radius: 16px 16px 16px 4px;
        }
        
        .chat-header {
            font-size: 11px;
            font-weight: 700;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--accent);
        }
        
        .chat-message.user .chat-header {
            color: #00AAFF;
        }
        
        .quick-replies {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }
        
        .quick-reply-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-10px); opacity: 1; }
        }
        
        /* MOBILE RESPONSIVE */
        @media (max-width: 768px) {
            .metrics-grid {
                gap: 2px;
                margin: 8px;
            }
            
            .metric-item {
                padding: 16px 12px;
            }
            
            .metric-value {
                font-size: 24px;
            }
            
            .large-print-value {
                font-size: 56px;
            }
            
            .ai-coach-widget {
                margin: 8px;
                padding: 12px;
            }
            
            .ai-coach-message {
                font-size: 14px;
            }
            
            .scroll-content {
                padding: 8px;
            }
            
            .card {
                padding: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="version-badge">v1.6 PRODUCTION</div>
    <div class="settings-cog" onclick="app.navigate('screenSettings')">‚öôÔ∏è</div>
    <div class="settings-cog" onclick="app.navigate('screenHRM')" style="left:60px;">‚ù§Ô∏è</div>
    <div id="toast" class="toast"></div>

    <!-- DASHBOARD SCREEN (SWIPEABLE) -->
    <div id="screenDashboard" class="screen active">
        <div class="screen-header">
            <button class="header-btn" onclick="app.endWorkout()">End</button>
            <div class="screen-title">Rowing</div>
            <button class="header-btn" onclick="app.openDevicesModal()">üîó Devices</button>
        </div>
        
        <div class="dashboard-container" id="dashboardContainer">
            <div class="dashboard-carousel" id="dashboardCarousel">
                
                <!-- View 1: All Data -->
                <div class="dashboard-view">
                    <div class="ai-coach-widget">
                        <div class="ai-coach-message" id="coachMessage">Start rowing to receive coaching!</div>
                    </div>
                    
                    <div class="metrics-grid">
                        <div class="metric-item" style="grid-column:1/-1;">
                            <div class="metric-label">CURRENT PACE</div>
                            <div class="metric-value" id="pace1" style="font-size:48px;">0:00</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">TIME</div>
                            <div class="metric-value" id="time1">0:00</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">DISTANCE</div>
                            <div class="metric-value" id="dist1">0</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">WATTS</div>
                            <div class="metric-value accent" id="watts1">0</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">S/M</div>
                            <div class="metric-value accent" id="rate1">0</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">HEART RATE</div>
                            <div class="metric-value" style="color:#ff6b6b;" id="hr1">--</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">AVG PACE</div>
                            <div class="metric-value" id="avgPace1">0:00</div>
                        </div>
                    </div>
                </div>
                
                <!-- View 2: Force Curve -->
                <div class="dashboard-view">
                    <div style="padding:20px;">
                        <div style="font-size:12px; color:#666; text-align:center; margin-bottom:16px;">FORCE CURVE</div>
                        <canvas id="forceCanvas" style="width:100%; height:300px; background:#000; border-radius:8px;"></canvas>
                    </div>
                </div>
                
                <!-- View 3: Paceboat -->
                <div class="dashboard-view">
                    <div style="padding:20px;">
                        <div style="font-size:12px; color:#666; text-align:center; margin-bottom:16px;">PACEBOAT</div>
                        <canvas id="paceboatCanvas" style="width:100%; height:400px; background:#000; border-radius:8px;"></canvas>
                    </div>
                </div>
                
                <!-- View 4: Bar Chart -->
                <div class="dashboard-view">
                    <div style="padding:20px;">
                        <div style="font-size:12px; color:#666; text-align:center; margin-bottom:16px;">PACE OVER TIME</div>
                        <canvas id="barCanvas" style="width:100%; height:300px; background:#000; border-radius:8px;"></canvas>
                    </div>
                </div>
                
                <!-- View 5: Large Print -->
                <div class="dashboard-view">
                    <div class="large-print-container">
                        <div class="large-print-metric">
                            <div class="large-print-label">PACE</div>
                            <div class="large-print-value" id="paceLP">0:00</div>
                        </div>
                        <div class="large-print-metric">
                            <div class="large-print-label">DISTANCE</div>
                            <div class="large-print-value" id="distLP">0m</div>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
        
        <!-- HR Zone Sidebar -->
        <div class="hr-zone-sidebar" id="hrSidebar" style="display:none;">
            <div class="hr-zone-segment" id="hrZ5" style="background:#dc143c;">Z5</div>
            <div class="hr-zone-segment" id="hrZ4" style="background:#ff6347;">Z4</div>
            <div class="hr-zone-segment" id="hrZ3" style="background:#ffa500;">Z3</div>
            <div class="hr-zone-segment" id="hrZ2" style="background:#50c878;">Z2</div>
            <div class="hr-zone-segment" id="hrZ1" style="background:#4a90e2;">Z1</div>
        </div>
        
        <div class="dashboard-dots">
            <div class="dashboard-dot active"></div>
            <div class="dashboard-dot"></div>
            <div class="dashboard-dot"></div>
            <div class="dashboard-dot"></div>
            <div class="dashboard-dot"></div>
        </div>
    </div>

    <!-- AI CHAT SCREEN -->
    <div id="screenChat" class="screen">
        <div class="screen-header">
            <div class="screen-title">AI Coach</div>
        </div>
        <div style="display:flex; flex-direction:column; height:100%;">
            <div class="scroll-content" id="chatMessages" style="flex:1; padding-bottom:20px;">
                <!-- Chat messages will appear here -->
            </div>
            <div class="typing-indicator" id="typingIndicator" style="display:none; padding:16px;">
                <div style="display:flex; gap:4px;">
                    <div style="width:8px; height:8px; background:var(--accent); border-radius:50%; animation:typing 1.4s infinite;"></div>
                    <div style="width:8px; height:8px; background:var(--accent); border-radius:50%; animation:typing 1.4s infinite 0.2s;"></div>
                    <div style="width:8px; height:8px; background:var(--accent); border-radius:50%; animation:typing 1.4s infinite 0.4s;"></div>
                </div>
            </div>
            <div style="position:sticky; bottom:0; border-top:1px solid var(--border); background:var(--panel); padding:12px; display:flex; gap:12px; align-items:flex-end;">
                <textarea 
                    id="chatInput" 
                    placeholder="Type your message..."
                    style="flex:1; background:#0a0a0a; border:1px solid var(--border); color:var(--text); padding:12px; border-radius:20px; font-size:15px; font-family:inherit; resize:none; max-height:120px; min-height:44px;"
                    onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault();app.sendMessage();}"
                ></textarea>
                <button onclick="app.sendMessage()" style="background:var(--accent); color:#000; border:none; width:44px; height:44px; border-radius:50%; font-size:20px; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0;">‚Üë</button>
            </div>
        </div>
    </div>

    <!-- BUILDER SCREEN -->
    <div id="screenBuilder" class="screen">
        <div class="screen-header">
            <div class="screen-title">Manual Builder</div>
        </div>
        <div class="scroll-content">
            <div class="builder-mode-selector">
                <div class="builder-mode-btn active" onclick="app.selectBuilderMode('single-distance')">Single Distance</div>
                <div class="builder-mode-btn" onclick="app.selectBuilderMode('single-time')">Single Time</div>
                <div class="builder-mode-btn" onclick="app.selectBuilderMode('single-calorie')">Single Calorie</div>
                <div class="builder-mode-btn" onclick="app.selectBuilderMode('fixed-intervals')">Fixed Intervals</div>
                <div class="builder-mode-btn" onclick="app.selectBuilderMode('variable-intervals')">Variable Intervals</div>
            </div>
            
            <div class="builder-section">
                <div class="builder-section-title">Global Targets (Optional)</div>
                
                <div class="builder-toggle" onclick="app.toggleBuilderTarget('splitPace')">
                    <div class="builder-checkbox" id="splitPaceCheckbox"></div>
                    <div style="flex:1; font-size:13px; font-weight:700;">Target Split /500m</div>
                </div>
                <div id="splitPaceInputs" style="display:none; margin-left:32px; margin-bottom:16px;">
                    <div class="builder-label">Split Pace (e.g., 1:55.0)</div>
                    <input type="text" class="builder-input" placeholder="1:55.0" id="splitPaceValue">
                </div>
                
                <div class="builder-toggle" onclick="app.toggleBuilderTarget('pacer')">
                    <div class="builder-checkbox" id="pacerCheckbox"></div>
                    <div style="flex:1; font-size:13px; font-weight:700;">Show Pacer</div>
                </div>
                <div id="pacerInputs" style="display:none; margin-left:32px; margin-bottom:16px;">
                    <select class="builder-input" style="margin-bottom:8px;" id="pacerMetric">
                        <option value="pace">Pace /500m</option>
                        <option value="watts">Watts</option>
                        <option value="calhr">Cal/hr</option>
                    </select>
                    <input type="text" class="builder-input" placeholder="Target value" id="pacerValue">
                </div>
                
                <div class="builder-toggle" onclick="app.toggleBuilderTarget('strokeRate')">
                    <div class="builder-checkbox" id="strokeRateCheckbox"></div>
                    <div style="flex:1; font-size:13px; font-weight:700;">Target Stroke Rate</div>
                </div>
                <div id="strokeRateInputs" style="display:none; margin-left:32px; margin-bottom:16px;">
                    <input type="number" class="builder-input" placeholder="s/m (e.g., 26)" id="strokeRateValue">
                </div>
                
                <div class="builder-toggle" onclick="app.toggleBuilderTarget('heartRate')">
                    <div class="builder-checkbox" id="heartRateCheckbox"></div>
                    <div style="flex:1; font-size:13px; font-weight:700;">Target Heart Rate Zone</div>
                </div>
                <div id="heartRateInputs" style="display:none; margin-left:32px; margin-bottom:16px;">
                    <select class="builder-input" id="heartRateZone">
                        <option value="1">Zone 1 (Recovery)</option>
                        <option value="2">Zone 2 (Endurance)</option>
                        <option value="3">Zone 3 (Tempo)</option>
                        <option value="4">Zone 4 (Threshold)</option>
                        <option value="5">Zone 5 (Max)</option>
                    </select>
                </div>
            </div>
            
            <div id="builderModeContent"></div>
            
            <button class="btn btn-primary" onclick="app.saveManualWorkout()">Review Workout</button>
        </div>
    </div>

    <!-- REVIEW SCREEN -->
    <div id="screenReview" class="screen">
        <div class="screen-header">
            <button class="header-btn" onclick="app.navigate('screenBuilder')">‚Üê Back</button>
            <div class="screen-title">Review Workout</div>
        </div>
        <div class="scroll-content">
            <div class="review-workout-title" id="reviewTitle">Your Workout</div>
            <div id="reviewIntervals"></div>
            <div class="review-actions">
                <button class="btn btn-outline" onclick="app.restrategize()" style="flex:1;">üîÑ Restrategize</button>
                <button class="btn btn-primary" onclick="app.startWorkout()" style="flex:2;">üö£ Start Row</button>
            </div>
        </div>
    </div>

    <!-- HEART RATE MONITOR SCREEN -->
    <div id="screenHRM" class="screen">
        <div class="screen-header">
            <div class="screen-title">Heart Rate Monitor</div>
        </div>
        <div class="scroll-content">
            <!-- Connection Card -->
            <div style="background:linear-gradient(135deg, #1a0a0a 0%, #0a0a0a 100%); border:2px solid #ff6b6b; border-radius:12px; padding:20px; margin-bottom:20px;">
                <div style="display:flex; align-items:center; gap:12px; margin-bottom:16px;">
                    <div style="font-size:32px;">‚ù§Ô∏è</div>
                    <div style="flex:1;">
                        <div style="font-size:14px; font-weight:700; color:#ff6b6b;" id="hrmStatusText">Not Connected</div>
                        <div style="font-size:12px; color:#666; margin-top:4px;" id="hrmStatusDesc">Connect your Polar/Garmin/Wahoo HRM</div>
                    </div>
                </div>
                <button class="btn btn-primary" style="background:#ff6b6b;" id="hrmConnectButton" onclick="app.connectHRMDirect()">
                    Connect Heart Rate Monitor
                </button>
            </div>

            <!-- Live Display (Hidden until connected) -->
            <div id="hrmLiveDisplay" style="display:none; background:var(--card-bg); border:2px solid #ff6b6b; border-radius:12px; padding:20px; text-align:center; margin-bottom:20px;">
                <div style="font-size:72px; font-weight:900; color:#ff6b6b; line-height:1; margin-bottom:8px; font-variant-numeric:tabular-nums;" id="hrmCurrentBPM">--</div>
                <div style="font-size:11px; color:#666; text-transform:uppercase; letter-spacing:1px;">BEATS PER MINUTE</div>
                
                <div style="margin-top:16px; padding:12px; background:#050505; border-radius:8px;">
                    <div style="font-size:10px; color:#666; text-transform:uppercase; margin-bottom:6px;">TRAINING ZONE</div>
                    <div style="display:flex; height:40px; border-radius:8px; overflow:hidden;">
                        <div id="hrZone1Display" style="flex:1; background:#4a90e2; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700; opacity:0.3; transition:all 0.3s;">Z1</div>
                        <div id="hrZone2Display" style="flex:1; background:#50c878; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700; opacity:0.3; transition:all 0.3s;">Z2</div>
                        <div id="hrZone3Display" style="flex:1; background:#ffa500; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700; opacity:0.3; transition:all 0.3s;">Z3</div>
                        <div id="hrZone4Display" style="flex:1; background:#ff6347; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700; opacity:0.3; transition:all 0.3s;">Z4</div>
                        <div id="hrZone5Display" style="flex:1; background:#dc143c; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700; opacity:0.3; transition:all 0.3s;">Z5</div>
                    </div>
                </div>
            </div>

            <!-- Graph -->
            <div id="hrmGraphContainer" style="display:none; background:var(--card-bg); border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:20px;">
                <div style="font-size:11px; color:#666; text-transform:uppercase; margin-bottom:12px; text-align:center;">Heart Rate Over Time</div>
                <canvas id="hrmCanvas" style="width:100%; height:200px; background:#000; border-radius:8px;"></canvas>
                
                <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:12px; margin-top:16px;">
                    <div style="text-align:center;">
                        <div style="font-size:20px; font-weight:900; color:#ff6b6b;" id="hrmAvg">--</div>
                        <div style="font-size:9px; color:#666; text-transform:uppercase; margin-top:4px;">Average</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:20px; font-weight:900; color:#ff6b6b;" id="hrmMax">--</div>
                        <div style="font-size:9px; color:#666; text-transform:uppercase; margin-top:4px;">Max</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:20px; font-weight:900; color:#ff6b6b;" id="hrmMin">--</div>
                        <div style="font-size:9px; color:#666; text-transform:uppercase; margin-top:4px;">Min</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- HISTORY SCREEN -->
    <div id="screenHistory" class="screen">
        <div class="screen-header">
            <div class="screen-title">History (<span id="historyCount">0</span>)</div>
        </div>
        <div class="scroll-content">
            <div class="card">
                <div class="card-header">Database Summary</div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-item-value" id="totalWorkouts">0</div>
                        <div class="stat-item-label">Workouts</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-item-value" id="totalDistance">0</div>
                        <div class="stat-item-label">Total Meters</div>
                    </div>
                </div>
            </div>
            <div id="historyList"></div>
        </div>
    </div>

    <!-- SETTINGS SCREEN -->
    <div id="screenSettings" class="screen">
        <div class="screen-header">
            <div class="screen-title">Settings</div>
        </div>
        <div class="scroll-content">
            <div class="card">
                <div class="card-header">User Profile</div>
                
                <div class="editable-field">
                    <div class="editable-label">Name</div>
                    <input type="text" class="editable-input" id="editName" placeholder="Your name">
                </div>
                
                <div class="editable-field">
                    <div class="editable-label">Age</div>
                    <input type="number" class="editable-input" id="editAge" placeholder="30">
                </div>
                
                <div class="editable-field">
                    <div class="editable-label">Weight (kg)</div>
                    <input type="number" class="editable-input" id="editWeight" placeholder="75">
                </div>
                
                <div style="display:flex; gap:12px; margin-top:16px;">
                    <button class="btn btn-primary" onclick="app.saveProfile()">Save Profile</button>
                    <button class="btn btn-outline" onclick="app.loadProfile()">Cancel</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Firebase Cloud Storage</div>
                <div style="margin-bottom:12px;">
                    <div style="font-size:12px; color:#666; margin-bottom:4px;">User ID</div>
                    <div style="color:#e0e0e0; font-size:14px; font-family:monospace; word-break:break-all;" id="firebaseUserId">Loading...</div>
                </div>
                <div style="margin-bottom:12px;">
                    <div style="font-size:12px; color:#666; margin-bottom:4px;">Status</div>
                    <div style="color:#e0e0e0; font-size:14px;" id="firebaseStatus">Checking...</div>
                </div>
                <button class="btn btn-outline" onclick="app.testFirebaseSync()">
                    Test Cloud Sync
                </button>
                <div style="margin-top:12px; padding:12px; background:rgba(0,255,153,0.05); border:1px solid var(--accent); border-radius:8px; font-size:11px; color:#ccc;">
                    üí° <strong>Test without clearing cache:</strong> Click "Test Cloud Sync" to verify your data is saving to Firebase. Check console (F12) for detailed logs.
                </div>
            </div>

            <div class="card">
                <div class="card-header">Import Data</div>
                <label for="csvUpload" style="display:block; width:100%; padding:16px; border:2px dashed #222; border-radius:8px; text-align:center; cursor:pointer; color:#888;">
                    üìÅ Import CSV
                </label>
                <input type="file" id="csvUpload" accept=".csv" style="display:none;" onchange="app.importCSV(event)">
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="nav-bar">
        <button class="nav-item" onclick="app.navigate('screenChat')">
            <span class="nav-icon">ü§ñ</span>
            AI Chat
        </button>
        <button class="nav-item active" onclick="app.navigate('screenDashboard')">
            <span class="nav-icon">üö£</span>
            Row
        </button>
        <button class="nav-item" onclick="app.navigate('screenBuilder')">
            <span class="nav-icon">üîß</span>
            Builder
        </button>
        <button class="nav-item" onclick="app.navigate('screenHistory')">
            <span class="nav-icon">üìä</span>
            History
        </button>
    </nav>

    <!-- DEVICES MODAL -->
    <div id="devicesModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:10000; padding:20px;">
        <div style="max-width:500px; margin:80px auto; background:var(--card-bg); border:1px solid var(--border); border-radius:12px; padding:20px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="font-size:18px; font-weight:700; color:var(--accent);">Connect Devices</h2>
                <button onclick="app.closeDevicesModal()" style="background:transparent; border:none; color:#666; font-size:24px; cursor:pointer;">√ó</button>
            </div>
            
            <!-- PM5 Connection -->
            <div style="background:#050505; border:1px solid var(--border); border-radius:8px; padding:16px; margin-bottom:16px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <div>
                        <div style="font-size:15px; font-weight:700; margin-bottom:4px;">Concept2 PM5</div>
                        <div style="font-size:12px; color:#666;" id="pm5Status">Not connected</div>
                    </div>
                    <div style="width:12px; height:12px; border-radius:50%; background:#666;" id="pm5Indicator"></div>
                </div>
                <button class="btn btn-primary" onclick="app.connectPM5()" id="pm5ConnectBtn">Connect PM5</button>
            </div>
            
            <!-- HRM Connection -->
            <div style="background:#050505; border:1px solid var(--border); border-radius:8px; padding:16px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <div>
                        <div style="font-size:15px; font-weight:700; margin-bottom:4px;">Heart Rate Monitor</div>
                        <div style="font-size:12px; color:#666;" id="hrmStatus">Not connected</div>
                    </div>
                    <div style="width:12px; height:12px; border-radius:50%; background:#666;" id="hrmIndicator"></div>
                </div>
                <button class="btn btn-outline" onclick="app.connectHRM()" id="hrmConnectBtn">Connect HRM</button>
            </div>
            
            <div style="margin-top:20px; padding:12px; background:rgba(0,255,153,0.05); border:1px solid var(--accent); border-radius:8px; font-size:12px; color:#ccc;">
                üí° <strong>Tip:</strong> Connect PM5 first, then connect your chest strap HRM if you want separate HR monitoring.
            </div>
        </div>
    </div>

    <script>
        // ========================================================================
        // FIREBASE CONFIGURATION
        // ========================================================================
        
        // Set to true to enable Firebase cloud storage
        const FIREBASE_ENABLED = true;
        
        // ========================================================================
        // STORAGE ABSTRACTION LAYER
        // ========================================================================
        
        class DataStore {
            constructor() {
                this.userId = null;
                this.isFirebase = FIREBASE_ENABLED;
            }
            
            async init() {
                if (this.isFirebase) {
                    // Wait for Firebase modules to load
                    await new Promise(resolve => {
                        const checkInterval = setInterval(() => {
                            if (window.firebaseAuth && window.firebaseDb && window.firebaseModules) {
                                clearInterval(checkInterval);
                                resolve();
                            }
                        }, 100);
                    });
                    
                    // Initialize Firebase
                    try {
                        const { signInAnonymously, onAuthStateChanged } = window.firebaseModules;
                        const auth = window.firebaseAuth;
                        
                        // Sign in anonymously
                        const result = await signInAnonymously(auth);
                        this.userId = result.user.uid;
                        
                        console.log('‚úì Firebase initialized. User ID:', this.userId);
                        
                        // Listen for auth state changes
                        onAuthStateChanged(auth, (user) => {
                            if (user) {
                                this.userId = user.uid;
                                console.log('‚úì User authenticated:', this.userId);
                            }
                        });
                    } catch (error) {
                        console.error('‚ùå Firebase init error:', error);
                        this.isFirebase = false; // Fallback to localStorage
                    }
                } else {
                    // localStorage fallback
                    this.userId = localStorage.getItem('anonymous_user_id');
                    if (!this.userId) {
                        this.userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                        localStorage.setItem('anonymous_user_id', this.userId);
                    }
                    console.log('‚úì localStorage mode. User ID:', this.userId);
                }
            }
            
            async saveProfile(profile) {
                if (this.isFirebase) {
                    const { doc, setDoc, serverTimestamp } = window.firebaseModules;
                    const db = window.firebaseDb;
                    
                    await setDoc(doc(db, 'users', this.userId), {
                        profile: profile,
                        updatedAt: serverTimestamp()
                    }, { merge: true });
                    
                    console.log('‚úì Profile saved to Firebase');
                } else {
                    localStorage.setItem('rowing_coach_profile_v1', JSON.stringify(profile));
                }
            }
            
            async loadProfile() {
                if (this.isFirebase) {
                    const { doc, getDoc } = window.firebaseModules;
                    const db = window.firebaseDb;
                    
                    const docSnap = await getDoc(doc(db, 'users', this.userId));
                    return docSnap.exists() ? docSnap.data().profile : null;
                } else {
                    const data = localStorage.getItem('rowing_coach_profile_v1');
                    return data ? JSON.parse(data) : null;
                }
            }
            
            async saveWorkout(workout) {
                if (this.isFirebase) {
                    const { doc, setDoc } = window.firebaseModules;
                    const db = window.firebaseDb;
                    
                    await setDoc(doc(db, 'users', this.userId, 'workouts', workout.id), workout);
                    console.log('‚úì Workout saved to Firebase:', workout.id);
                } else {
                    const workouts = await this.loadWorkouts();
                    const existing = workouts.findIndex(w => w.id === workout.id);
                    if (existing >= 0) {
                        workouts[existing] = workout;
                    } else {
                        workouts.push(workout);
                    }
                    localStorage.setItem('rowing_coach_workouts_v1', JSON.stringify(workouts));
                }
            }
            
            async loadWorkouts() {
                if (this.isFirebase) {
                    const { collection, query, orderBy, getDocs } = window.firebaseModules;
                    const db = window.firebaseDb;
                    
                    const q = query(
                        collection(db, 'users', this.userId, 'workouts'),
                        orderBy('date', 'desc')
                    );
                    
                    const snapshot = await getDocs(q);
                    const workouts = snapshot.docs.map(doc => doc.data());
                    
                    console.log(`‚úì Loaded ${workouts.length} workouts from Firebase`);
                    return workouts;
                } else {
                    const data = localStorage.getItem('rowing_coach_workouts_v1');
                    return data ? JSON.parse(data) : [];
                }
            }
            
            async deleteWorkout(workoutId) {
                if (this.isFirebase) {
                    const { doc, deleteDoc } = window.firebaseModules;
                    const db = window.firebaseDb;
                    
                    await deleteDoc(doc(db, 'users', this.userId, 'workouts', workoutId));
                    console.log('‚úì Workout deleted from Firebase:', workoutId);
                } else {
                    const workouts = await this.loadWorkouts();
                    const filtered = workouts.filter(w => w.id !== workoutId);
                    localStorage.setItem('rowing_coach_workouts_v1', JSON.stringify(filtered));
                }
            }
            
            async saveChat(messages) {
                if (this.isFirebase) {
                    const { doc, setDoc, serverTimestamp } = window.firebaseModules;
                    const db = window.firebaseDb;
                    
                    await setDoc(doc(db, 'users', this.userId), {
                        chatHistory: messages,
                        chatUpdatedAt: serverTimestamp()
                    }, { merge: true });
                } else {
                    localStorage.setItem('rowing_coach_chat_v1', JSON.stringify(messages));
                }
            }
            
            async loadChat() {
                if (this.isFirebase) {
                    const { doc, getDoc } = window.firebaseModules;
                    const db = window.firebaseDb;
                    
                    const docSnap = await getDoc(doc(db, 'users', this.userId));
                    return docSnap.exists() ? (docSnap.data().chatHistory || []) : [];
                } else {
                    const data = localStorage.getItem('rowing_coach_chat_v1');
                    return data ? JSON.parse(data) : [];
                }
            }
        }
        
        const STORAGE_KEYS = {
            PROFILE: 'rowing_coach_profile_v1',
            WORKOUTS: 'rowing_coach_workouts_v1'
        };

        const PM5_SERVICE_UUID = '00001826-0000-1000-8000-00805f9b34fb';
        const PM5_CHARACTERISTIC_UUID = '00002ad2-0000-1000-8000-00805f9b34fb';

        class AIRowingCoach {
            constructor() {
                this.dataStore = new DataStore();
                this.profile = null;
                this.workouts = [];
                this.chatHistory = [];
                this.currentView = 0;
                this.builderMode = 'single-distance';
                this.builderTargets = { splitPace: false, pacer: false, strokeRate: false, heartRate: false };
                this.builderIntervals = [];
                this.editingInterval = -1;
                this.reviewWorkout = null;
                
                // Rowing data
                this.liveData = { time: 0, dist: 0, pace: 0, watts: 0, rate: 0, hr: 0 };
                this.paceHistory = [];
                
                // PM5 & HRM
                this.pm5Device = null;
                this.pm5Characteristic = null;
                this.hrmDevice = null;
                this.hrmCharacteristic = null;
                
                this.init();
            }

            async init() {
                // Initialize storage (Firebase or localStorage)
                await this.dataStore.init();
                
                await this.loadData();
                this.loadProfile();
                this.setupDashboardSwipe();
                this.renderBuilderMode();
                this.renderHistory();
                this.updateStats();
                this.renderChat();
                
                // Chat input auto-resize
                const chatInput = document.getElementById('chatInput');
                if (chatInput) {
                    chatInput.addEventListener('input', () => {
                        chatInput.style.height = 'auto';
                        chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
                    });
                }
                
                // Demo data
                this.startDemoData();
                
                // Welcome message if no chat history
                if (this.chatHistory.length === 0) {
                    this.addChatMessage('ai', 'Hey! ü§ñ I\'m Coach, your AI rowing assistant.\n\nI can help you:\n‚Ä¢ Create custom workouts\n‚Ä¢ Build training plans\n‚Ä¢ Analyze your performance\n‚Ä¢ Answer rowing questions\n\nWhat would you like to do?', ['Create workout', 'Build 4-week plan', 'Analyze my data']);
                }
            }

            async loadData() {
                try {
                    this.profile = await this.dataStore.loadProfile();
                    this.workouts = await this.dataStore.loadWorkouts();
                    this.chatHistory = await this.dataStore.loadChat();
                    
                    console.log(`‚úì Loaded ${this.workouts.length} workouts`);
                } catch (error) {
                    console.error('Load error:', error);
                }
            }

            async saveData() {
                try {
                    if (this.profile) {
                        await this.dataStore.saveProfile(this.profile);
                    }
                    await this.dataStore.saveChat(this.chatHistory);
                    // Note: Workouts saved individually via saveWorkout()
                } catch (error) {
                    console.error('Save error:', error);
                }
            }

            // ========================================================================
            // CHAT FUNCTIONALITY
            // ========================================================================

            async sendMessage() {
                const input = document.getElementById('chatInput');
                const message = input.value.trim();
                
                if (!message) return;

                this.addChatMessage('user', message);
                input.value = '';
                input.style.height = 'auto';

                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) {
                    typingIndicator.style.display = 'flex';
                }

                await this.sleep(800);

                if (typingIndicator) {
                    typingIndicator.style.display = 'none';
                }

                this.processMessage(message);
            }

            processMessage(message) {
                const lower = message.toLowerCase();
                
                // Workout creation
                if (lower.includes('workout') || lower.includes('interval') || lower.includes('create')) {
                    this.addChatMessage('ai', 'I can help you create a workout! You have two options:\n\n1. **Tell me what you want** (e.g., "6x500m with 2min rest")\n2. **Use the Manual Builder** for precise control\n\nWhat would you like?', ['Use Manual Builder', '6x500m intervals', '30min steady']);
                    return;
                }
                
                // Training plan
                if (lower.includes('plan') || lower.includes('4-week') || lower.includes('training')) {
                    this.addChatMessage('ai', 'Perfect! I can create a personalized 4-week training plan.\n\nWhat\'s your main goal?\n‚Ä¢ Build endurance\n‚Ä¢ Increase speed\n‚Ä¢ Prepare for competition\n‚Ä¢ Weight loss', ['Endurance', 'Speed', 'Competition']);
                    return;
                }
                
                // Data analysis
                if (lower.includes('analyze') || lower.includes('performance') || lower.includes('progress')) {
                    const totalWorkouts = this.workouts.length;
                    const totalDist = this.workouts.reduce((sum, w) => sum + (w.distance || 0), 0);
                    
                    this.addChatMessage('ai', `Here's your training summary:\n\nüìä **Total Workouts:** ${totalWorkouts}\nüìè **Total Distance:** ${Math.floor(totalDist/1000)}km\n\n${totalWorkouts > 0 ? 'You\'re making great progress! Keep it up! üí™' : 'Import your CSV to see detailed analysis.'}`, ['Import CSV', 'View History']);
                    return;
                }
                
                // Builder redirect
                if (lower.includes('builder') || lower.includes('manual')) {
                    this.addChatMessage('ai', 'Taking you to the Manual Builder...', null);
                    setTimeout(() => this.navigate('screenBuilder'), 500);
                    return;
                }
                
                // Profile updates
                if (lower.includes('weight') && (lower.includes('change') || lower.includes('update'))) {
                    const match = message.match(/(\d+)\s*kg/i);
                    if (match) {
                        const newWeight = parseInt(match[1]);
                        if (this.profile) {
                            this.profile.weight = newWeight;
                            this.saveData();
                            this.loadProfile();
                            this.addChatMessage('ai', `‚úì Updated your weight to ${newWeight}kg!`, null);
                            return;
                        }
                    }
                }
                
                // Default helpful response
                this.addChatMessage('ai', 'I can help with:\n\nüèãÔ∏è **Create Workouts** - Custom intervals or steady state\nüìÖ **Training Plans** - 4-week periodized programs\nüìä **Performance Analysis** - Track your progress\n‚öôÔ∏è **Settings** - Update your profile\n\nWhat would you like to do?', ['Create workout', 'Build plan', 'View history']);
            }

            addChatMessage(sender, text, quickReplies = null) {
                const msg = {
                    sender: sender,
                    text: text,
                    quickReplies: quickReplies,
                    timestamp: new Date().toISOString()
                };

                this.chatHistory.push(msg);
                this.saveData();
                this.renderChat();
            }

            renderChat() {
                const container = document.getElementById('chatMessages');
                if (!container) return;
                
                const html = this.chatHistory.map((msg) => {
                    const isUser = msg.sender === 'user';
                    
                    let quickRepliesHtml = '';
                    if (msg.quickReplies && msg.quickReplies.length > 0) {
                        quickRepliesHtml = `
                            <div class="quick-replies">
                                ${msg.quickReplies.map(reply => {
                                    let onclick = `app.handleQuickReply('${reply.replace(/'/g, "\\'")}')`;
                                    
                                    if (reply === 'Use Manual Builder') onclick = `app.navigate('screenBuilder')`;
                                    if (reply === 'Import CSV') onclick = `app.navigate('screenSettings')`;
                                    if (reply === 'View History') onclick = `app.navigate('screenHistory')`;
                                    
                                    return `<button class="quick-reply-btn" onclick="${onclick}">${reply}</button>`;
                                }).join('')}
                            </div>
                        `;
                    }
                    
                    const formattedText = msg.text
                        .replace(/\n/g, '<br>')
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/‚Ä¢ /g, '‚Ä¢ ');
                    
                    return `
                        <div class="chat-message ${isUser ? 'user' : 'ai'}">
                            <div class="chat-header">
                                ${isUser ? 'üë§ You' : 'ü§ñ Coach'}
                            </div>
                            ${formattedText}
                            ${quickRepliesHtml}
                        </div>
                    `;
                }).join('');

                container.innerHTML = html;
                
                // Scroll to bottom
                setTimeout(() => {
                    container.scrollTop = container.scrollHeight;
                }, 100);
            }

            handleQuickReply(text) {
                const input = document.getElementById('chatInput');
                if (input) {
                    input.value = text;
                    this.sendMessage();
                }
            }

            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            // ========================================================================
            // DEVICES MODAL
            // ========================================================================

            openDevicesModal() {
                document.getElementById('devicesModal').style.display = 'block';
            }

            closeDevicesModal() {
                document.getElementById('devicesModal').style.display = 'none';
            }

            // ========================================================================
            // PM5 CONNECTION
            // ========================================================================

            async connectPM5() {
                const btn = document.getElementById('pm5ConnectBtn');
                const status = document.getElementById('pm5Status');
                const indicator = document.getElementById('pm5Indicator');
                
                btn.disabled = true;
                btn.textContent = 'Connecting...';
                status.textContent = 'Connecting...';
                
                try {
                    console.log('üîç Requesting PM5...');
                    
                    this.pm5Device = await navigator.bluetooth.requestDevice({
                        filters: [{ services: [PM5_SERVICE_UUID] }]
                    });
                    
                    console.log(`‚úì Device: ${this.pm5Device.name}`);
                    status.textContent = `Connecting to ${this.pm5Device.name}...`;
                    
                    const server = await this.pm5Device.gatt.connect();
                    const service = await server.getPrimaryService(PM5_SERVICE_UUID);
                    this.pm5Characteristic = await service.getCharacteristic(PM5_CHARACTERISTIC_UUID);
                    
                    await this.pm5Characteristic.startNotifications();
                    this.pm5Characteristic.addEventListener('characteristicvaluechanged', (e) => {
                        this.handlePM5Data(e.target.value);
                    });
                    
                    console.log('‚úì PM5 connected');
                    
                    status.textContent = `Connected: ${this.pm5Device.name}`;
                    indicator.style.background = '#00FF99';
                    btn.textContent = 'Disconnect';
                    btn.disabled = false;
                    btn.onclick = () => this.disconnectPM5();
                    
                    this.showToast('PM5 connected!', 'success');
                } catch (error) {
                    console.error('‚ùå PM5 error:', error);
                    status.textContent = 'Connection failed';
                    indicator.style.background = '#FF4444';
                    btn.textContent = 'Retry';
                    btn.disabled = false;
                    
                    this.showToast('PM5 connection failed: ' + error.message, 'error');
                }
            }

            disconnectPM5() {
                if (this.pm5Device && this.pm5Device.gatt.connected) {
                    this.pm5Device.gatt.disconnect();
                }
                
                document.getElementById('pm5Status').textContent = 'Not connected';
                document.getElementById('pm5Indicator').style.background = '#666';
                
                const btn = document.getElementById('pm5ConnectBtn');
                btn.textContent = 'Connect PM5';
                btn.onclick = () => this.connectPM5();
                
                this.showToast('PM5 disconnected', 'success');
            }

            handlePM5Data(value) {
                // Parse PM5 data and update dashboard
                console.log('PM5 data:', value);
                // TODO: Implement PM5 data parsing based on Concept2 spec
            }

            // ========================================================================
            // HRM CONNECTION
            // ========================================================================

            async connectHRM() {
                const HRM_SERVICE = 0x180D;
                const HRM_CHARACTERISTIC = 0x2A37;
                
                const btn = document.getElementById('hrmConnectBtn');
                const status = document.getElementById('hrmStatus');
                const indicator = document.getElementById('hrmIndicator');
                
                btn.disabled = true;
                btn.textContent = 'Connecting...';
                status.textContent = 'Connecting...';
                
                try {
                    console.log('üîç Requesting HRM...');
                    
                    this.hrmDevice = await navigator.bluetooth.requestDevice({
                        filters: [{ services: [HRM_SERVICE] }]
                    });
                    
                    console.log(`‚úì Device: ${this.hrmDevice.name}`);
                    status.textContent = `Connecting to ${this.hrmDevice.name}...`;
                    
                    const server = await this.hrmDevice.gatt.connect();
                    const service = await server.getPrimaryService(HRM_SERVICE);
                    this.hrmCharacteristic = await service.getCharacteristic(HRM_CHARACTERISTIC);
                    
                    await this.hrmCharacteristic.startNotifications();
                    this.hrmCharacteristic.addEventListener('characteristicvaluechanged', (e) => {
                        this.handleHRMData(e.target.value);
                    });
                    
                    console.log('‚úì HRM connected');
                    
                    status.textContent = `Connected: ${this.hrmDevice.name}`;
                    indicator.style.background = '#ff6b6b';
                    btn.textContent = 'Disconnect';
                    btn.disabled = false;
                    btn.onclick = () => this.disconnectHRM();
                    
                    this.showToast('HRM connected!', 'success');
                } catch (error) {
                    console.error('‚ùå HRM error:', error);
                    status.textContent = 'Connection failed';
                    indicator.style.background = '#FF4444';
                    btn.textContent = 'Retry';
                    btn.disabled = false;
                    
                    this.showToast('HRM connection failed: ' + error.message, 'error');
                }
            }

            disconnectHRM() {
                if (this.hrmDevice && this.hrmDevice.gatt.connected) {
                    this.hrmDevice.gatt.disconnect();
                }
                
                document.getElementById('hrmStatus').textContent = 'Not connected';
                document.getElementById('hrmIndicator').style.background = '#666';
                
                const btn = document.getElementById('hrmConnectBtn');
                btn.textContent = 'Connect HRM';
                btn.onclick = () => this.connectHRM();
                
                this.showToast('HRM disconnected', 'success');
            }

            handleHRMData(value) {
                const flags = value.getUint8(0);
                const hrValueFormat = flags & 0x01;
                
                let hr;
                if (hrValueFormat === 0) {
                    hr = value.getUint8(1);
                } else {
                    hr = value.getUint16(1, true);
                }
                
                this.liveData.hr = hr;
                this.updateHRZone();
            }

            // ========================================================================
            // HRM CONNECTION (DIRECT - FROM HRM SCREEN)
            // ========================================================================

            async connectHRMDirect() {
                const HRM_SERVICE = 0x180D;
                const HRM_CHARACTERISTIC = 0x2A37;
                
                const btn = document.getElementById('hrmConnectButton');
                const statusText = document.getElementById('hrmStatusText');
                const statusDesc = document.getElementById('hrmStatusDesc');
                
                btn.disabled = true;
                btn.textContent = 'Connecting...';
                statusText.textContent = 'Connecting...';
                
                try {
                    console.log('üîç Requesting HRM...');
                    
                    this.hrmDevice = await navigator.bluetooth.requestDevice({
                        filters: [{ services: [HRM_SERVICE] }]
                    });
                    
                    console.log(`‚úì Device: ${this.hrmDevice.name}`);
                    statusDesc.textContent = `Connecting to ${this.hrmDevice.name}...`;
                    
                    const server = await this.hrmDevice.gatt.connect();
                    const service = await server.getPrimaryService(HRM_SERVICE);
                    this.hrmCharacteristic = await service.getCharacteristic(HRM_CHARACTERISTIC);
                    
                    await this.hrmCharacteristic.startNotifications();
                    this.hrmCharacteristic.addEventListener('characteristicvaluechanged', (e) => {
                        this.handleHRMDataDirect(e.target.value);
                    });
                    
                    console.log('‚úì HRM connected');
                    
                    statusText.textContent = `Connected: ${this.hrmDevice.name}`;
                    statusDesc.textContent = 'Receiving heart rate data';
                    btn.textContent = 'Disconnect';
                    btn.disabled = false;
                    btn.onclick = () => this.disconnectHRMDirect();
                    
                    // Show live display and graph
                    document.getElementById('hrmLiveDisplay').style.display = 'block';
                    document.getElementById('hrmGraphContainer').style.display = 'block';
                    
                    // Initialize canvas
                    this.initHRMCanvas();
                    
                    this.showToast('HRM connected!', 'success');
                } catch (error) {
                    console.error('‚ùå HRM error:', error);
                    statusText.textContent = 'Connection Failed';
                    statusDesc.textContent = error.message;
                    btn.textContent = 'Retry';
                    btn.disabled = false;
                    
                    this.showToast('HRM connection failed: ' + error.message, 'error');
                }
            }

            disconnectHRMDirect() {
                if (this.hrmDevice && this.hrmDevice.gatt.connected) {
                    this.hrmDevice.gatt.disconnect();
                }
                
                this.hrmDevice = null;
                this.hrmCharacteristic = null;
                this.hrHistory = [];
                this.currentHR = 0;
                
                document.getElementById('hrmStatusText').textContent = 'Not Connected';
                document.getElementById('hrmStatusDesc').textContent = 'Connect your Polar/Garmin/Wahoo HRM';
                document.getElementById('hrmLiveDisplay').style.display = 'none';
                document.getElementById('hrmGraphContainer').style.display = 'none';
                
                const btn = document.getElementById('hrmConnectButton');
                btn.textContent = 'Connect Heart Rate Monitor';
                btn.onclick = () => this.connectHRMDirect();
                
                this.showToast('HRM disconnected', 'success');
            }

            initHRMCanvas() {
                this.hrCanvas = document.getElementById('hrmCanvas');
                if (this.hrCanvas) {
                    this.hrCtx = this.hrCanvas.getContext('2d');
                    this.hrCanvas.width = this.hrCanvas.offsetWidth;
                    this.hrCanvas.height = 200;
                }
                this.hrHistory = [];
                this.currentHR = 0;
            }

            handleHRMDataDirect(value) {
                const flags = value.getUint8(0);
                const hrValueFormat = flags & 0x01;
                
                let hr;
                if (hrValueFormat === 0) {
                    hr = value.getUint8(1);
                } else {
                    hr = value.getUint16(1, true);
                }
                
                this.currentHR = hr;
                this.hrHistory.push(hr);
                
                // Keep last 60 readings
                if (this.hrHistory.length > 60) {
                    this.hrHistory.shift();
                }
                
                this.updateHRMDisplay();
                this.updateHRMGraph();
            }

            updateHRMDisplay() {
                const bpmElem = document.getElementById('hrmCurrentBPM');
                if (bpmElem) {
                    bpmElem.textContent = this.currentHR;
                }
                
                // Update zone visualization
                const zone = this.calculateHRZone(this.currentHR);
                for (let i = 1; i <= 5; i++) {
                    const zoneElem = document.getElementById(`hrZone${i}Display`);
                    if (zoneElem) {
                        if (i === zone) {
                            zoneElem.style.opacity = '1';
                            zoneElem.style.transform = 'scale(1.1)';
                        } else {
                            zoneElem.style.opacity = '0.3';
                            zoneElem.style.transform = 'scale(1)';
                        }
                    }
                }
            }

            calculateHRZone(hr) {
                // Default zones (can be customized in settings)
                if (hr < 120) return 1;
                if (hr < 140) return 2;
                if (hr < 160) return 3;
                if (hr < 180) return 4;
                return 5;
            }

            updateHRMGraph() {
                if (!this.hrCtx || this.hrHistory.length < 2) return;
                
                const ctx = this.hrCtx;
                const canvas = this.hrCanvas;
                const width = canvas.width;
                const height = canvas.height;
                
                // Clear
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, width, height);
                
                // Calculate stats
                const avg = Math.round(this.hrHistory.reduce((a, b) => a + b, 0) / this.hrHistory.length);
                const max = Math.max(...this.hrHistory);
                const min = Math.min(...this.hrHistory);
                
                // Update stats display
                document.getElementById('hrmAvg').textContent = avg;
                document.getElementById('hrmMax').textContent = max;
                document.getElementById('hrmMin').textContent = min;
                
                // Draw grid
                ctx.strokeStyle = '#222';
                ctx.lineWidth = 1;
                for (let i = 0; i < 5; i++) {
                    const y = (height / 5) * i;
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(width, y);
                    ctx.stroke();
                }
                
                // Draw HR line
                const minHR = Math.max(min - 10, 0);
                const maxHR = max + 10;
                const hrRange = maxHR - minHR;
                
                ctx.strokeStyle = '#ff6b6b';
                ctx.lineWidth = 3;
                ctx.beginPath();
                
                this.hrHistory.forEach((hr, i) => {
                    const x = (width / 60) * i;
                    const y = height - ((hr - minHR) / hrRange) * height;
                    
                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                
                ctx.stroke();
            }

            // ========================================================================
            // DASHBOARD - SWIPEABLE
            // ========================================================================

            setupDashboardSwipe() {
                const container = document.getElementById('dashboardContainer');
                const carousel = document.getElementById('dashboardCarousel');
                
                let startX = 0;
                let currentX = 0;
                let isDragging = false;
                
                container.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].clientX;
                    isDragging = true;
                });
                
                container.addEventListener('touchmove', (e) => {
                    if (!isDragging) return;
                    currentX = e.touches[0].clientX;
                    const diff = currentX - startX;
                    const offset = -this.currentView * 100;
                    carousel.style.transform = `translateX(calc(${offset}% + ${diff}px))`;
                });
                
                container.addEventListener('touchend', (e) => {
                    if (!isDragging) return;
                    isDragging = false;
                    
                    const diff = currentX - startX;
                    if (Math.abs(diff) > 50) {
                        if (diff > 0 && this.currentView > 0) {
                            this.currentView--;
                        } else if (diff < 0 && this.currentView < 4) {
                            this.currentView++;
                        }
                    }
                    
                    this.updateDashboardView();
                });
            }

            updateDashboardView() {
                const carousel = document.getElementById('dashboardCarousel');
                carousel.style.transform = `translateX(-${this.currentView * 100}%)`;
                
                document.querySelectorAll('.dashboard-dot').forEach((dot, i) => {
                    if (i === this.currentView) {
                        dot.classList.add('active');
                    } else {
                        dot.classList.remove('active');
                    }
                });
            }

            startDemoData() {
                setInterval(() => {
                    this.liveData.time++;
                    this.liveData.dist += 4;
                    this.liveData.pace = 115 + Math.random() * 10;
                    this.liveData.watts = 220 + Math.random() * 30;
                    this.liveData.rate = 24 + Math.floor(Math.random() * 4);
                    this.liveData.hr = 150 + Math.floor(Math.random() * 20);
                    
                    this.paceHistory.push(this.liveData.pace);
                    if (this.paceHistory.length > 20) this.paceHistory.shift();
                    
                    this.updateDashboardMetrics();
                    this.updateCoachMessage();
                    this.updateHRZone();
                    this.drawForceC();
                    this.drawPaceboat();
                    this.drawBarChart();
                }, 1000);
            }

            updateDashboardMetrics() {
                const mins = Math.floor(this.liveData.pace / 60);
                const secs = Math.floor(this.liveData.pace % 60);
                const paceStr = `${mins}:${secs.toString().padStart(2, '0')}`;
                
                const timeMins = Math.floor(this.liveData.time / 60);
                const timeSecs = Math.floor(this.liveData.time % 60);
                const timeStr = `${timeMins}:${timeSecs.toString().padStart(2, '0')}`;
                
                // All Data view
                document.getElementById('pace1').textContent = paceStr;
                document.getElementById('time1').textContent = timeStr;
                document.getElementById('dist1').textContent = this.liveData.dist + 'm';
                document.getElementById('watts1').textContent = Math.floor(this.liveData.watts);
                document.getElementById('rate1').textContent = this.liveData.rate;
                document.getElementById('hr1').textContent = this.liveData.hr || '--';
                document.getElementById('avgPace1').textContent = paceStr;
                
                // Large Print view
                document.getElementById('paceLP').textContent = paceStr;
                document.getElementById('distLP').textContent = this.liveData.dist + 'm';
            }

            updateCoachMessage() {
                const msg = document.getElementById('coachMessage');
                if (this.liveData.pace > 125) {
                    msg.textContent = '‚ö†Ô∏è Power dropping! Focus on leg drive!';
                } else if (this.liveData.pace < 110 && this.liveData.time < 60) {
                    msg.textContent = '‚ö†Ô∏è Too fast! Settle into rhythm.';
                } else if (this.liveData.pace > 110 && this.liveData.pace < 120) {
                    msg.textContent = 'üí™ Perfect pace! Keep this rhythm.';
                } else {
                    msg.textContent = 'Looking good. Stay focused.';
                }
            }

            updateHRZone() {
                if (!this.liveData.hr || !this.profile) return;
                
                const sidebar = document.getElementById('hrSidebar');
                sidebar.style.display = 'flex';
                
                let zone = 1;
                if (this.liveData.hr > 180) zone = 5;
                else if (this.liveData.hr > 160) zone = 4;
                else if (this.liveData.hr > 140) zone = 3;
                else if (this.liveData.hr > 120) zone = 2;
                
                for (let i = 1; i <= 5; i++) {
                    const elem = document.getElementById(`hrZ${i}`);
                    if (i === zone) {
                        elem.classList.add('active');
                    } else {
                        elem.classList.remove('active');
                    }
                }
            }

            drawForceC() {
                const canvas = document.getElementById('forceCanvas');
                if (!canvas) return;
                canvas.width = canvas.offsetWidth;
                canvas.height = 300;
                const ctx = canvas.getContext('2d');
                
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.strokeStyle = '#00FF99';
                ctx.lineWidth = 3;
                ctx.beginPath();
                
                for (let i = 0; i < 50; i++) {
                    const x = (canvas.width / 50) * i;
                    const y = canvas.height - Math.sin(i * 0.2) * (this.liveData.watts / 2) - 50;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();
            }

            drawPaceboat() {
                const canvas = document.getElementById('paceboatCanvas');
                if (!canvas) return;
                canvas.width = canvas.offsetWidth;
                canvas.height = 400;
                const ctx = canvas.getContext('2d');
                
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // User boat
                ctx.fillStyle = '#00FF99';
                ctx.fillRect(50, 150, 60, 30);
                ctx.fillText('YOU', 60, 140);
                
                // Target boat
                ctx.fillStyle = '#FF6B6B';
                ctx.fillRect(150, 150, 60, 30);
                ctx.fillText('TARGET', 160, 140);
            }

            drawBarChart() {
                const canvas = document.getElementById('barCanvas');
                if (!canvas) return;
                canvas.width = canvas.offsetWidth;
                canvas.height = 300;
                const ctx = canvas.getContext('2d');
                
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                const barWidth = canvas.width / 20;
                this.paceHistory.forEach((pace, i) => {
                    const height = (pace / 150) * canvas.height;
                    ctx.fillStyle = '#00FF99';
                    ctx.fillRect(i * barWidth, canvas.height - height, barWidth - 2, height);
                });
            }

            // ========================================================================
            // PM5 CONNECTION
            // ========================================================================

            async connectPM5() {
                try {
                    console.log('üîç Requesting PM5...');
                    
                    this.pm5Device = await navigator.bluetooth.requestDevice({
                        filters: [{ services: [PM5_SERVICE_UUID] }]
                    });
                    
                    console.log(`‚úì Device: ${this.pm5Device.name}`);
                    
                    const server = await this.pm5Device.gatt.connect();
                    const service = await server.getPrimaryService(PM5_SERVICE_UUID);
                    this.pm5Characteristic = await service.getCharacteristic(PM5_CHARACTERISTIC_UUID);
                    
                    await this.pm5Characteristic.startNotifications();
                    this.pm5Characteristic.addEventListener('characteristicvaluechanged', (e) => {
                        this.handlePM5Data(e.target.value);
                    });
                    
                    console.log('‚úì PM5 connected');
                    this.showToast('PM5 connected!', 'success');
                } catch (error) {
                    console.error('‚ùå PM5 error:', error);
                    this.showToast('PM5 connection failed', 'error');
                }
            }

            handlePM5Data(value) {
                // Parse PM5 data
                console.log('PM5 data:', value);
            }

            // ========================================================================
            // BUILDER
            // ========================================================================

            selectBuilderMode(mode) {
                this.builderMode = mode;
                document.querySelectorAll('.builder-mode-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
                this.renderBuilderMode();
            }

            renderBuilderMode() {
                const container = document.getElementById('builderModeContent');
                if (!container) return;
                
                let html = '<div class="builder-section"><div class="builder-section-title">Workout Details</div>';
                
                if (this.builderMode === 'single-distance') {
                    html += `
                        <div class="builder-input-group">
                            <div class="builder-label">Total Distance (meters)</div>
                            <input type="number" class="builder-input" id="totalDistance" placeholder="5000">
                        </div>
                        <div class="builder-input-group">
                            <div class="builder-label">Split Length (meters)</div>
                            <input type="number" class="builder-input" id="splitDistance" placeholder="1000">
                        </div>
                    `;
                } else if (this.builderMode === 'single-time') {
                    html += `
                        <div class="builder-input-group">
                            <div class="builder-label">Total Time</div>
                            <div class="builder-time-picker">
                                <input type="number" class="builder-time-input" id="totalMins" placeholder="30" min="0">
                                <span style="color:#666;">:</span>
                                <input type="number" class="builder-time-input" id="totalSecs" placeholder="00" min="0" max="59">
                            </div>
                        </div>
                        <div class="builder-input-group">
                            <div class="builder-label">Split Time</div>
                            <div class="builder-time-picker">
                                <input type="number" class="builder-time-input" id="splitMins" placeholder="5" min="0">
                                <span style="color:#666;">:</span>
                                <input type="number" class="builder-time-input" id="splitSecs" placeholder="00" min="0" max="59">
                            </div>
                        </div>
                    `;
                } else if (this.builderMode === 'fixed-intervals') {
                    html += `
                        <div class="builder-input-group">
                            <div class="builder-label">Work Type</div>
                            <select class="builder-input" id="workType">
                                <option value="distance">Distance</option>
                                <option value="time">Time</option>
                            </select>
                        </div>
                        <div class="builder-input-group">
                            <div class="builder-label">Work Value</div>
                            <input type="number" class="builder-input" id="workValue" placeholder="500">
                        </div>
                        <div class="builder-input-group">
                            <div class="builder-label">Number of Intervals</div>
                            <input type="number" class="builder-input" id="numSets" placeholder="6">
                        </div>
                        <div class="builder-input-group">
                            <div class="builder-label">Rest Time</div>
                            <div class="builder-time-picker">
                                <input type="number" class="builder-time-input" id="restMins" placeholder="1" min="0">
                                <span style="color:#666;">:</span>
                                <input type="number" class="builder-time-input" id="restSecs" placeholder="00" min="0" max="59">
                            </div>
                        </div>
                    `;
                } else if (this.builderMode === 'variable-intervals') {
                    html += `
                        <div class="builder-input-group">
                            <div class="builder-label">Work Value (meters)</div>
                            <input type="number" class="builder-input" id="varWorkValue" placeholder="500">
                        </div>
                        <div class="builder-input-group">
                            <div class="builder-label">Rest Time</div>
                            <div class="builder-time-picker">
                                <input type="number" class="builder-time-input" id="varRestMins" placeholder="1" min="0">
                                <span style="color:#666;">:</span>
                                <input type="number" class="builder-time-input" id="varRestSecs" placeholder="00" min="0" max="59">
                            </div>
                        </div>
                        <button class="btn btn-outline" onclick="app.addVariableInterval()">Add Interval</button>
                        
                        <div class="builder-interval-list">
                            ${this.builderIntervals.map((interval, i) => `
                                <div class="builder-interval-item ${i === this.editingInterval ? 'editable' : ''}" onclick="app.editInterval(${i})">
                                    <div class="builder-interval-header">
                                        <div class="builder-interval-title">${i + 1}. ${interval.workValue}m / ${interval.restTime}s rest</div>
                                        <div class="builder-interval-actions">
                                            <button class="builder-icon-btn" onclick="event.stopPropagation(); app.copyInterval(${i})">üìã</button>
                                            <button class="builder-icon-btn" onclick="event.stopPropagation(); app.deleteInterval(${i})">üóëÔ∏è</button>
                                        </div>
                                    </div>
                                    <div class="builder-interval-edit">
                                        <div class="builder-input-group">
                                            <div class="builder-label">Work Value (meters)</div>
                                            <input type="number" class="builder-input" value="${interval.workValue}" onchange="app.updateInterval(${i}, 'workValue', this.value)">
                                        </div>
                                        <div class="builder-input-group">
                                            <div class="builder-label">Rest Time (seconds)</div>
                                            <input type="number" class="builder-input" value="${interval.restTime}" onchange="app.updateInterval(${i}, 'restTime', this.value)">
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                html += '</div>';
                container.innerHTML = html;
            }

            toggleBuilderTarget(target) {
                this.builderTargets[target] = !this.builderTargets[target];
                
                const checkbox = document.getElementById(`${target}Checkbox`);
                const inputs = document.getElementById(`${target}Inputs`);
                
                if (this.builderTargets[target]) {
                    checkbox.classList.add('checked');
                    checkbox.textContent = '‚úì';
                    inputs.style.display = 'block';
                } else {
                    checkbox.classList.remove('checked');
                    checkbox.textContent = '';
                    inputs.style.display = 'none';
                }
            }

            addVariableInterval() {
                const workValue = document.getElementById('varWorkValue').value;
                const restMins = parseInt(document.getElementById('varRestMins').value) || 0;
                const restSecs = parseInt(document.getElementById('varRestSecs').value) || 0;
                
                if (!workValue) {
                    this.showToast('Enter work value', 'error');
                    return;
                }
                
                this.builderIntervals.push({
                    workValue: parseInt(workValue),
                    restTime: restMins * 60 + restSecs
                });
                
                this.renderBuilderMode();
            }

            editInterval(index) {
                this.editingInterval = this.editingInterval === index ? -1 : index;
                this.renderBuilderMode();
            }

            updateInterval(index, field, value) {
                this.builderIntervals[index][field] = parseInt(value);
            }

            copyInterval(index) {
                const interval = {...this.builderIntervals[index]};
                this.builderIntervals.push(interval);
                this.renderBuilderMode();
            }

            deleteInterval(index) {
                this.builderIntervals.splice(index, 1);
                this.renderBuilderMode();
            }

            saveManualWorkout() {
                this.reviewWorkout = {
                    mode: this.builderMode,
                    intervals: []
                };
                
                if (this.builderMode === 'single-distance') {
                    const total = parseInt(document.getElementById('totalDistance').value);
                    const split = parseInt(document.getElementById('splitDistance').value);
                    this.reviewWorkout.intervals = [{ type: 'distance', value: total, split: split }];
                } else if (this.builderMode === 'variable-intervals') {
                    this.reviewWorkout.intervals = this.builderIntervals;
                }
                
                this.renderReview();
                this.navigate('screenReview');
            }

            renderReview() {
                const titleElem = document.getElementById('reviewTitle');
                const intervalsElem = document.getElementById('reviewIntervals');
                
                titleElem.textContent = 'Review Your Workout';
                
                let html = '';
                if (this.reviewWorkout && this.reviewWorkout.intervals) {
                    this.reviewWorkout.intervals.forEach((interval, i) => {
                        html += `
                            <div class="review-interval">
                                <div class="review-interval-info">
                                    <div class="review-interval-title">${i + 1}. ${interval.workValue || interval.value}m</div>
                                    <div class="review-interval-desc">Rest: ${interval.restTime || 0}s</div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                intervalsElem.innerHTML = html;
            }

            restrategize() {
                this.showToast('AI restrategizing...', 'success');
                setTimeout(() => {
                    this.navigate('screenBuilder');
                }, 1000);
            }

            startWorkout() {
                this.showToast('Starting workout...', 'success');
                setTimeout(() => {
                    this.navigate('screenDashboard');
                }, 500);
            }

            endWorkout() {
                if (confirm('End workout?')) {
                    this.showToast('Workout saved!', 'success');
                }
            }

            // ========================================================================
            // CSV IMPORT - FIXED
            // ========================================================================

            importCSV(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const csv = e.target.result;
                        const lines = csv.split('\n');
                        
                        console.log(`üìÑ Lines: ${lines.length}`);
                        
                        // SKIP HEADER (line 0)
                        const headers = lines[0].split(',').map(h => h.trim());
                        console.log(`üìã Headers: ${headers.join(', ')}`);
                        
                        let imported = 0;
                        const existingIds = new Set(this.workouts.map(w => w.id));
                        
                        // START FROM LINE 1
                        for (let i = 1; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (!line) continue;
                            
                            const values = line.split(',');
                            if (values.length < headers.length) continue;
                            
                            const row = {};
                            headers.forEach((header, idx) => {
                                row[header] = values[idx]?.trim();
                            });
                            
                            // Parse DD/M/YYYY HH:MM
                            const dateStr = row['Date'];
                            if (!dateStr || dateStr === 'Date') continue;
                            
                            let parsedDate = new Date().toISOString();
                            try {
                                const parts = dateStr.split(' ');
                                if (parts.length >= 1) {
                                    const [day, month, year] = parts[0].split('/');
                                    const d = new Date(year, month - 1, day);
                                    if (!isNaN(d.getTime())) {
                                        parsedDate = d.toISOString();
                                    }
                                }
                            } catch (e) {
                                console.warn('Date parse:', dateStr);
                            }
                            
                            const id = row['Log ID'] || String(Date.now() + Math.random());
                            
                            if (!existingIds.has(id)) {
                                this.workouts.push({
                                    id: id,
                                    date: parsedDate,
                                    description: row['Description'] || '',
                                    distance: parseInt(row['Work Distance']) || 0,
                                    pace: row['Pace'] || '',
                                    avgWatts: parseInt(row['Avg Watts']) || 0,
                                    avgHR: parseInt(row['Avg Heart Rate']) || 0
                                });
                                imported++;
                                existingIds.add(id);
                            }
                        }
                        
                        console.log(`‚úÖ Imported ${imported} workouts`);
                        console.log(`üìä Total: ${this.workouts.length}`);
                        
                        this.workouts.sort((a, b) => new Date(b.date) - new Date(a.date));
                        
                        this.saveData();
                        this.renderHistory();
                        this.updateStats();
                        
                        this.showToast(`‚úì Imported ${imported} workouts!`, 'success');
                        
                        event.target.value = '';
                    } catch (error) {
                        console.error('‚ùå CSV Error:', error);
                        this.showToast('Import failed: ' + error.message, 'error');
                    }
                };
                
                reader.readAsText(file);
            }

            // ========================================================================
            // HISTORY
            // ========================================================================

            renderHistory() {
                const container = document.getElementById('historyList');
                if (!container) return;

                if (this.workouts.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìä</div><div>No workouts yet</div></div>';
                    return;
                }

                const html = this.workouts.map((workout, idx) => {
                    let dateStr = 'Invalid Date';
                    try {
                        const d = new Date(workout.date);
                        if (!isNaN(d.getTime())) {
                            dateStr = d.toLocaleDateString();
                        }
                    } catch (e) {
                        console.warn('Date error:', workout.date);
                    }
                    
                    return `
                        <div class="history-item">
                            <button class="history-delete" onclick="app.deleteWorkout(${idx})">Delete</button>
                            <div class="history-date">${dateStr}</div>
                            <div class="history-title">${workout.description || 'Workout'}</div>
                            <div class="history-stats">
                                <span>${workout.distance}m</span>
                                <span>${workout.pace || '--'}</span>
                                <span>${workout.avgWatts || '--'}W</span>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = html;
            }

            async deleteWorkout(index) {
                if (confirm('Delete this workout?')) {
                    const workout = this.workouts[index];
                    await this.dataStore.deleteWorkout(workout.id);
                    
                    this.workouts.splice(index, 1);
                    this.renderHistory();
                    this.updateStats();
                    this.showToast('Workout deleted', 'success');
                }
            }

            updateStats() {
                document.getElementById('totalWorkouts').textContent = this.workouts.length;
                document.getElementById('historyCount').textContent = this.workouts.length;
                
                const totalDist = this.workouts.reduce((sum, w) => sum + (w.distance || 0), 0);
                document.getElementById('totalDistance').textContent = Math.floor(totalDist / 1000) + 'k';
            }

            // ========================================================================
            // SETTINGS
            // ========================================================================

            loadProfile() {
                if (!this.profile) return;
                document.getElementById('editName').value = this.profile.name || '';
                document.getElementById('editAge').value = this.profile.age || '';
                document.getElementById('editWeight').value = this.profile.weight || '';
            }

            async saveProfile() {
                const name = document.getElementById('editName').value;
                const age = parseInt(document.getElementById('editAge').value);
                const weight = parseInt(document.getElementById('editWeight').value);
                
                if (!name || !age || !weight) {
                    this.showToast('Fill all fields', 'error');
                    return;
                }
                
                this.profile = { name, age, weight, maxHR: 220 - age };
                await this.dataStore.saveProfile(this.profile);
                
                this.showToast('Profile saved!', 'success');
            }

            async testFirebaseSync() {
                console.log('üîç Testing Firebase sync...');
                
                try {
                    // Save a test value
                    const testData = {
                        testTimestamp: new Date().toISOString(),
                        testMessage: 'Firebase sync working!'
                    };
                    
                    await this.dataStore.saveProfile({ ...this.profile, ...testData });
                    console.log('‚úì Test data saved to Firebase');
                    
                    // Read it back
                    const retrieved = await this.dataStore.loadProfile();
                    console.log('‚úì Test data retrieved:', retrieved);
                    
                    if (retrieved && retrieved.testTimestamp === testData.testTimestamp) {
                        this.showToast('‚úì Firebase sync working! Check console for details.', 'success');
                        document.getElementById('firebaseStatus').textContent = '‚úì Connected & Syncing';
                        document.getElementById('firebaseStatus').style.color = '#00FF99';
                    } else {
                        throw new Error('Data mismatch');
                    }
                } catch (error) {
                    console.error('‚ùå Firebase sync test failed:', error);
                    this.showToast('Firebase sync failed. Check console.', 'error');
                    document.getElementById('firebaseStatus').textContent = '‚úó Sync Failed';
                    document.getElementById('firebaseStatus').style.color = '#FF4444';
                }
            }

            updateFirebaseStatus() {
                const userIdElem = document.getElementById('firebaseUserId');
                const statusElem = document.getElementById('firebaseStatus');
                
                if (userIdElem && this.dataStore) {
                    userIdElem.textContent = this.dataStore.userId || 'Not initialized';
                }
                
                if (statusElem && this.dataStore) {
                    if (this.dataStore.isFirebase) {
                        statusElem.textContent = '‚úì Firebase Enabled';
                        statusElem.style.color = '#00FF99';
                    } else {
                        statusElem.textContent = 'localStorage (offline)';
                        statusElem.style.color = '#FFA500';
                    }
                }
            }

            // ========================================================================
            // NAVIGATION
            // ========================================================================

            navigate(screenId) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(screenId).classList.add('active');

                const navItems = document.querySelectorAll('.nav-item');
                navItems.forEach(item => item.classList.remove('active'));
                
                const screenMap = {
                    'screenChat': 0,
                    'screenDashboard': 1,
                    'screenBuilder': 2,
                    'screenHistory': 3
                };
                
                const index = screenMap[screenId];
                if (index !== undefined && navItems[index]) {
                    navItems[index].classList.add('active');
                }
                
                // Update Firebase status when opening settings
                if (screenId === 'screenSettings') {
                    this.updateFirebaseStatus();
                }
            }

            showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = `toast ${type}`;
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 3000);
            }
        }

        const app = new AIRowingCoach();
    </script>
</body>
</html>
