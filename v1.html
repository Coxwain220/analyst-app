<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Rowing Coach</title>
    <style>
        :root {
            --bg: #000;
            --text: #e0e0e0;
            --accent: #00FF99;
            --accent-dim: #00AA66;
            --danger: #FF4444;
            --rest: #00AAFF;
            --panel: #111;
            --border: #222;
            --card-bg: #0a0a0a;
            --ai-msg: #1a1a2e;
            --user-msg: #0d3a2e;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* TOAST */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--panel);
            color: var(--text);
            padding: 12px 24px;
            border-radius: 8px;
            border: 1px solid var(--border);
            z-index: 10000;
            opacity: 0;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        .toast.error { border-color: var(--danger); background: rgba(255,68,68,0.1); color: var(--danger); }
        .toast.success { border-color: var(--accent); background: rgba(0,255,153,0.1); color: var(--accent); }
        
        /* SCREENS */
        .screen {
            display: none;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }
        
        .screen.active { display: flex; }
        
        .screen-header {
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        
        .screen-title {
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 1.5px;
            color: #666;
            text-transform: uppercase;
            text-align: center;
            flex: 1;
        }
        
        .header-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .header-btn:active { transform: scale(0.95); }
        .header-btn.connected { border-color: var(--accent); color: var(--accent); }
        
        .scroll-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 16px;
            padding-bottom: 100px;
        }
        
        /* CHAT INTERFACE */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .chat-message {
            max-width: 85%;
            padding: 14px 18px;
            border-radius: 16px;
            line-height: 1.5;
            font-size: 15px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .msg-ai {
            background: var(--ai-msg);
            border: 1px solid #2a2a3e;
            align-self: flex-start;
            border-radius: 16px 16px 16px 4px;
        }
        
        .msg-user {
            background: var(--user-msg);
            border: 1px solid #1a4a3e;
            align-self: flex-end;
            border-radius: 16px 16px 4px 16px;
        }
        
        .msg-system {
            background: transparent;
            border: 1px solid var(--border);
            align-self: center;
            font-size: 13px;
            color: #666;
            padding: 8px 16px;
            border-radius: 20px;
        }
        
        .msg-header {
            font-size: 11px;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .msg-user .msg-header { color: #00AAFF; }
        
        .workout-preview {
            background: #0a0a0a;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
        }
        
        .interval-preview {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            background: #050505;
            border-radius: 6px;
            margin-bottom: 6px;
            font-family: monospace;
            font-size: 13px;
        }
        
        .interval-work { color: var(--accent); }
        .interval-rest { color: var(--rest); }
        
        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .action-btn {
            flex: 1;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid var(--accent);
            background: transparent;
            color: var(--accent);
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .action-btn:active {
            transform: scale(0.95);
            background: rgba(0,255,153,0.1);
        }
        
        .action-btn-primary {
            background: var(--accent);
            color: #000;
        }
        
        /* CHAT INPUT */
        .chat-input-container {
            border-top: 1px solid var(--border);
            background: var(--panel);
            padding: 12px 16px;
            padding-bottom: calc(12px + env(safe-area-inset-bottom));
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }
        
        .chat-input {
            flex: 1;
            background: #0a0a0a;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 12px 16px;
            border-radius: 20px;
            font-size: 15px;
            font-family: inherit;
            resize: none;
            max-height: 120px;
            min-height: 44px;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .send-btn {
            background: var(--accent);
            color: #000;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
        }
        
        .send-btn:active {
            transform: scale(0.9);
        }
        
        .send-btn:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
        }
        
        /* QUICK PROMPTS */
        .quick-prompts {
            padding: 16px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .quick-prompt {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .quick-prompt:active {
            background: rgba(0,255,153,0.1);
            border-color: var(--accent);
        }
        
        /* LOADING INDICATOR */
        .typing-indicator {
            display: none;
            align-items: center;
            gap: 4px;
            padding: 16px;
            max-width: 85%;
        }
        
        .typing-indicator.active {
            display: flex;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-10px); opacity: 1; }
        }
        
        /* CARDS */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }
        
        .card-header {
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 1px;
            color: var(--accent);
            text-transform: uppercase;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }
        
        /* BUTTONS */
        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: 0.5px;
        }
        
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--accent); color: #000; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn + .btn { margin-top: 12px; }
        
        /* DASHBOARD */
        .dash-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .metric {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 36px;
            font-weight: 900;
            color: var(--text);
            line-height: 1;
            font-variant-numeric: tabular-nums;
        }
        
        .metric-label {
            font-size: 11px;
            font-weight: 700;
            color: #666;
            text-transform: uppercase;
            margin-top: 8px;
            letter-spacing: 1px;
        }
        
        /* HISTORY */
        .history-item {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .history-item:active {
            transform: scale(0.98);
            background: var(--panel);
        }
        
        .history-date {
            font-size: 11px;
            color: #666;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .history-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 8px;
        }
        
        .history-stats {
            display: flex;
            gap: 16px;
            font-size: 12px;
            color: var(--accent);
            font-family: monospace;
        }
        
        /* NAVIGATION */
        .nav-bar {
            background: var(--panel);
            border-top: 1px solid var(--border);
            display: flex;
            height: 70px;
            flex-shrink: 0;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .nav-item {
            flex: 1;
            background: transparent;
            border: none;
            color: #666;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: all 0.2s;
        }
        
        .nav-item.active {
            color: var(--accent);
            background: rgba(0,255,153,0.05);
        }
        
        .nav-icon { font-size: 20px; }
        
        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .empty-state-text {
            font-size: 14px;
            line-height: 1.6;
        }
        
        /* MODAL */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 9000;
            display: none;
            flex-direction: column;
        }
        
        .modal.active { display: flex; }
        
        .modal-header {
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .modal-close {
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
        }
        
        .modal-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text);
        }
        
        .modal-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
    </style>
</head>
<body>
    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <!-- AI COACH SCREEN (DEFAULT) -->
    <div id="screenCoach" class="screen active">
        <div class="screen-header">
            <div class="screen-title">AI Coach</div>
        </div>
        <div class="chat-container">
            <div class="chat-messages" id="chatMessages">
                <div class="chat-message msg-system">
                    Welcome! I'm your AI rowing coach. Tell me what you want to train today.
                </div>
            </div>
            <div class="typing-indicator" id="typingIndicator">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
            <div class="quick-prompts" id="quickPrompts">
                <button class="quick-prompt" onclick="app.sendQuickPrompt('I feel fresh today and want a hard 40-minute workout')">üí™ Hard 40min</button>
                <button class="quick-prompt" onclick="app.sendQuickPrompt('Light recovery session today')">üåä Easy Recovery</button>
                <button class="quick-prompt" onclick="app.sendQuickPrompt('Create intervals based on my recent performance')">üìä Smart Intervals</button>
                <button class="quick-prompt" onclick="app.sendQuickPrompt('What should I focus on today?')">üéØ Today\'s Focus</button>
            </div>
            <div class="chat-input-container">
                <textarea 
                    id="chatInput" 
                    class="chat-input" 
                    placeholder="e.g., '3k x 4 intervals, 4min rest'"
                    rows="1"
                    onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault();app.sendMessage();}"
                ></textarea>
                <button class="send-btn" id="sendBtn" onclick="app.sendMessage()">‚Üë</button>
            </div>
        </div>
    </div>

    <!-- ROW SCREEN -->
    <div id="screenRow" class="screen">
        <div class="screen-header">
            <button class="header-btn" onclick="app.endWorkout()">End</button>
            <div class="screen-title">Rowing</div>
            <button class="header-btn" id="btBtn" onclick="app.connectBluetooth()">
                Connect PM5
            </button>
        </div>
        <div class="scroll-content">
            <div class="dash-metrics">
                <div class="metric">
                    <div class="metric-value" id="metricTime">0:00</div>
                    <div class="metric-label">Time</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="metricDist">0</div>
                    <div class="metric-label">Meters</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="metricPace">0:00</div>
                    <div class="metric-label">Pace</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="metricWatts">0</div>
                    <div class="metric-label">Watts</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="metricRate">0</div>
                    <div class="metric-label">S/M</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="metricHR">--</div>
                    <div class="metric-label">HR</div>
                </div>
            </div>

            <div class="card" id="currentInterval" style="display:none;">
                <div class="card-header">Current Interval</div>
                <div style="text-align:center; padding:20px;">
                    <div style="font-size:24px; font-weight:900; color:var(--accent);" id="intervalInfo">Interval 1 of 3</div>
                    <div style="font-size:16px; color:#666; margin-top:8px;" id="intervalTarget">Target: 2000m @ 1:55</div>
                </div>
            </div>
        </div>
    </div>

    <!-- HISTORY SCREEN -->
    <div id="screenHistory" class="screen">
        <div class="screen-header">
            <div class="screen-title">Training Log</div>
        </div>
        <div class="scroll-content" id="historyList"></div>
    </div>

    <!-- Detail Modal -->
    <div id="detailModal" class="modal">
        <div class="modal-header">
            <button class="modal-close" onclick="app.closeModal()">‚Üê</button>
            <div class="modal-title">Workout Details</div>
        </div>
        <div class="modal-content" id="detailContent"></div>
    </div>

    <!-- Navigation -->
    <nav class="nav-bar">
        <button class="nav-item active" onclick="app.navigate('screenCoach')">
            <span class="nav-icon">ü§ñ</span>
            Coach
        </button>
        <button class="nav-item" onclick="app.navigate('screenRow')">
            <span class="nav-icon">üö£</span>
            Row
        </button>
        <button class="nav-item" onclick="app.navigate('screenHistory')">
            <span class="nav-icon">üìä</span>
            History
        </button>
    </nav>

    <script>
        // ============================================================================
        // AI ROWING COACH - CORE APPLICATION
        // ============================================================================
        
        const STORAGE_KEYS = {
            HISTORY: 'ai_rowing_history_v1',
            CHAT: 'ai_rowing_chat_v1',
            PLAN: 'ai_rowing_current_plan'
        };

        const PM5_CONFIG = {
            SERVICE: 'ce060030-43e5-11e4-916c-0800200c9a66',
            CHARACTERISTIC: 'ce060031-43e5-11e4-916c-0800200c9a66'
        };

        class AIRowingCoach {
            constructor() {
                this.history = [];
                this.chatHistory = [];
                this.currentPlan = null;
                this.currentWorkout = null;
                this.liveData = { time: 0, dist: 0, pace: 0, watts: 0, rate: 0, hr: 0 };
                this.bluetoothDevice = null;
                this.bluetoothCharacteristic = null;
                this.isConnected = false;
                
                this.init();
            }

            // ========================================================================
            // INITIALIZATION
            // ========================================================================
            
            async init() {
                this.loadData();
                this.renderHistory();
                this.renderChat();
                
                // Auto-resize chat input
                const input = document.getElementById('chatInput');
                input.addEventListener('input', () => {
                    input.style.height = 'auto';
                    input.style.height = Math.min(input.scrollHeight, 120) + 'px';
                });
            }

            loadData() {
                try {
                    // Load history
                    const historyData = localStorage.getItem(STORAGE_KEYS.HISTORY);
                    if (historyData) {
                        this.history = JSON.parse(historyData);
                    } else {
                        this.history = this.getInitialHistory();
                        this.saveHistory();
                    }

                    // Load chat
                    const chatData = localStorage.getItem(STORAGE_KEYS.CHAT);
                    if (chatData) {
                        this.chatHistory = JSON.parse(chatData);
                    }

                    // Load current plan
                    const planData = localStorage.getItem(STORAGE_KEYS.PLAN);
                    if (planData) {
                        this.currentPlan = JSON.parse(planData);
                    }
                } catch (error) {
                    console.error('Error loading data:', error);
                }
            }

            getInitialHistory() {
                // Your actual training data from the CSV
                return [
                    {
                        id: "111095775",
                        date: "2026-01-12T18:38:00",
                        description: "3x Intervals: 3000m, 1500m, 750m",
                        workTime: "19:53.1",
                        distance: 5250,
                        pace: "01:53.6",
                        watts: 239,
                        avgHR: 177,
                        strokeRate: 26,
                        dragFactor: 134,
                        comments: "first 3k felt it after 2k. Last 750 pretty tough. Second 1500 ok, 750 also ok."
                    },
                    {
                        id: "110986164",
                        date: "2026-01-10T09:47:00",
                        description: "3x 2000m intervals",
                        workTime: "23:04.0",
                        distance: 6000,
                        pace: "01:55.3",
                        watts: 228,
                        avgHR: 174,
                        strokeRate: 27,
                        dragFactor: 135,
                        comments: "first 2k fine, last 500m stretched me. Second 2k a bit harder. Final 2k very tough."
                    },
                    {
                        id: "110710851",
                        date: "2026-01-05T18:46:00",
                        description: "4x 1500m intervals",
                        workTime: "22:53.4",
                        distance: 6000,
                        pace: "01:54.4",
                        watts: 233,
                        avgHR: 176,
                        strokeRate: 27,
                        dragFactor: 146
                    }
                ];
            }

            saveHistory() {
                try {
                    localStorage.setItem(STORAGE_KEYS.HISTORY, JSON.stringify(this.history));
                } catch (error) {
                    console.error('Error saving history:', error);
                }
            }

            saveChat() {
                try {
                    localStorage.setItem(STORAGE_KEYS.CHAT, JSON.stringify(this.chatHistory));
                } catch (error) {
                    console.error('Error saving chat:', error);
                }
            }

            savePlan() {
                try {
                    localStorage.setItem(STORAGE_KEYS.PLAN, JSON.stringify(this.currentPlan));
                } catch (error) {
                    console.error('Error saving plan:', error);
                }
            }

            // ========================================================================
            // AI CHAT INTERFACE
            // ========================================================================

            async sendMessage() {
                const input = document.getElementById('chatInput');
                const message = input.value.trim();
                
                if (!message) return;

                // Add user message
                this.addMessage('user', message);
                input.value = '';
                input.style.height = 'auto';

                // Show typing indicator
                document.getElementById('typingIndicator').classList.add('active');
                document.getElementById('sendBtn').disabled = true;

                try {
                    // Call Claude API
                    const response = await this.callClaudeAPI(message);
                    
                    // Hide typing indicator
                    document.getElementById('typingIndicator').classList.remove('active');
                    
                    // Add AI response
                    this.addMessage('ai', response.text, response.workout);
                    
                } catch (error) {
                    console.error('AI Error:', error);
                    document.getElementById('typingIndicator').classList.remove('active');
                    this.addMessage('ai', 'Sorry, I encountered an error. Please try again.');
                    this.showToast('AI request failed', 'error');
                } finally {
                    document.getElementById('sendBtn').disabled = false;
                }
            }

            sendQuickPrompt(prompt) {
                document.getElementById('chatInput').value = prompt;
                this.sendMessage();
            }

            addMessage(sender, text, workout = null) {
                const msg = {
                    sender: sender,
                    text: text,
                    workout: workout,
                    timestamp: new Date().toISOString()
                };

                this.chatHistory.push(msg);
                this.saveChat();
                this.renderChat();
            }

            renderChat() {
                const container = document.getElementById('chatMessages');
                
                const html = this.chatHistory.map((msg, idx) => {
                    if (msg.sender === 'user') {
                        return `
                            <div class="chat-message msg-user">
                                <div class="msg-header">You</div>
                                ${this.formatMessageText(msg.text)}
                            </div>
                        `;
                    } else if (msg.sender === 'ai') {
                        let workoutHtml = '';
                        if (msg.workout) {
                            workoutHtml = `
                                <div class="workout-preview">
                                    ${msg.workout.intervals.map(interval => `
                                        <div class="interval-preview">
                                            <span class="${interval.type === 'WORK' ? 'interval-work' : 'interval-rest'}">
                                                ${interval.type === 'WORK' ? 'üö£ ' + interval.distance + 'm' : '‚è∏Ô∏è ' + this.formatTime(interval.duration) + ' rest'}
                                            </span>
                                            ${interval.targetPace ? `<span style="color:#888">@ ${interval.targetPace}</span>` : ''}
                                        </div>
                                    `).join('')}
                                    <div class="action-buttons">
                                        <button class="action-btn action-btn-primary" onclick="app.acceptWorkout(${idx})">Start Workout</button>
                                        <button class="action-btn" onclick="app.modifyWorkout(${idx})">Modify</button>
                                    </div>
                                </div>
                            `;
                        }
                        
                        return `
                            <div class="chat-message msg-ai">
                                <div class="msg-header">AI Coach</div>
                                ${this.formatMessageText(msg.text)}
                                ${workoutHtml}
                            </div>
                        `;
                    }
                }).join('');

                container.innerHTML = html;
                
                // Scroll to bottom
                setTimeout(() => {
                    container.scrollTop = container.scrollHeight;
                }, 100);
            }

            formatMessageText(text) {
                // Convert newlines to <br> and preserve formatting
                return text.replace(/\n/g, '<br>');
            }

            // ========================================================================
            // CLAUDE API INTEGRATION
            // ========================================================================

            async callClaudeAPI(userMessage) {
                // Prepare training history context
                const historyContext = this.history.slice(0, 10).map(w => 
                    `${w.date.split('T')[0]}: ${w.description} - ${w.distance}m, ${w.pace} pace, ${w.watts}W avg, HR ${w.avgHR || 'N/A'}`
                ).join('\n');

                const systemPrompt = `You are an expert rowing coach AI assistant. You help athletes plan their rowing training sessions on a Concept2 rowing machine.

TRAINING HISTORY (Recent 10 workouts):
${historyContext}

CAPABILITIES:
1. Parse natural language workout requests (e.g., "3k x 4 intervals, 4min rest")
2. Create personalized training plans based on athlete's history and current state
3. Provide coaching advice on pacing, effort, and technique
4. Adjust workouts based on athlete feedback

WORKOUT FORMAT:
When creating a workout plan, you MUST include a structured workout in your response using this exact format at the end:

WORKOUT_PLAN:
[
  {"type": "WORK", "distance": 3000, "targetPace": "1:55", "targetWatts": 225},
  {"type": "REST", "duration": 240},
  {"type": "WORK", "distance": 3000, "targetPace": "1:54", "targetWatts": 230},
  {"type": "REST", "duration": 240},
  {"type": "WORK", "distance": 3000, "targetPace": "1:52", "targetWatts": 240}
]

RULES:
- targetPace format: "M:SS" (e.g., "1:55" for 1 minute 55 seconds per 500m)
- duration is in seconds
- Provide coaching context BEFORE the workout plan
- Base recommendations on training history
- Consider athlete's stated energy level and time available
- Explain the purpose of each interval

USER STATES TO CONSIDER:
- "fresh/strong" ‚Üí harder intervals, faster paces
- "tired/recovery" ‚Üí easier steady state or lighter intervals
- Time constraints ‚Üí adjust total volume accordingly

Be conversational, encouraging, and specific with your coaching advice.`;

                try {
                    const response = await fetch("https://api.anthropic.com/v1/messages", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            model: "claude-sonnet-4-20250514",
                            max_tokens: 2000,
                            system: systemPrompt,
                            messages: [
                                ...this.chatHistory.slice(-5).map(msg => ({
                                    role: msg.sender === 'user' ? 'user' : 'assistant',
                                    content: msg.text
                                })),
                                {
                                    role: "user",
                                    content: userMessage
                                }
                            ]
                        })
                    });

                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error.message);
                    }

                    const aiText = data.content[0].text;
                    
                    // Parse workout plan if present
                    let workout = null;
                    const workoutMatch = aiText.match(/WORKOUT_PLAN:\s*(\[[\s\S]*?\])/);
                    
                    if (workoutMatch) {
                        try {
                            const workoutJson = JSON.parse(workoutMatch[1]);
                            workout = { intervals: workoutJson };
                        } catch (e) {
                            console.error('Failed to parse workout:', e);
                        }
                    }

                    // Remove the WORKOUT_PLAN section from display text
                    const displayText = aiText.replace(/WORKOUT_PLAN:[\s\S]*$/, '').trim();

                    return {
                        text: displayText,
                        workout: workout
                    };

                } catch (error) {
                    console.error('Claude API error:', error);
                    throw error;
                }
            }

            // ========================================================================
            // WORKOUT MANAGEMENT
            // ========================================================================

            acceptWorkout(messageIndex) {
                const msg = this.chatHistory[messageIndex];
                if (msg && msg.workout) {
                    this.currentPlan = msg.workout;
                    this.savePlan();
                    this.showToast('Workout plan accepted!', 'success');
                    this.navigate('screenRow');
                    this.startWorkout();
                }
            }

            modifyWorkout(messageIndex) {
                const msg = this.chatHistory[messageIndex];
                if (msg && msg.workout) {
                    document.getElementById('chatInput').value = 
                        "Can you modify this workout by ";
                    document.getElementById('chatInput').focus();
                }
            }

            startWorkout() {
                if (!this.currentPlan) {
                    this.showToast('No workout plan selected', 'error');
                    return;
                }

                this.currentWorkout = new Workout(this.currentPlan);
                document.getElementById('currentInterval').style.display = 'block';
                this.updateIntervalInfo();
                this.showToast('Workout started!', 'success');
            }

            updateIntervalInfo() {
                if (!this.currentWorkout) return;

                const current = this.currentWorkout.currentInterval;
                const total = this.currentPlan.intervals.length;
                const interval = this.currentPlan.intervals[current];

                if (interval) {
                    document.getElementById('intervalInfo').textContent = 
                        `Interval ${current + 1} of ${total}`;
                    
                    if (interval.type === 'WORK') {
                        let target = `Target: ${interval.distance}m`;
                        if (interval.targetPace) {
                            target += ` @ ${interval.targetPace}`;
                        }
                        document.getElementById('intervalTarget').textContent = target;
                    } else {
                        document.getElementById('intervalTarget').textContent = 
                            `Rest: ${this.formatTime(interval.duration)}`;
                    }
                }
            }

            endWorkout() {
                if (!this.currentWorkout) {
                    this.navigate('screenCoach');
                    return;
                }

                if (!confirm('End workout and save?')) return;

                const workout = {
                    id: Date.now().toString(),
                    date: new Date().toISOString(),
                    description: this.currentWorkout.getDescription(),
                    workTime: this.formatTime(this.liveData.time),
                    distance: this.liveData.dist,
                    pace: this.formatPace(this.liveData.pace),
                    watts: this.liveData.watts,
                    avgHR: this.liveData.hr,
                    strokeRate: this.liveData.rate,
                    dragFactor: 0,
                    intervals: this.currentPlan.intervals
                };

                this.history.unshift(workout);
                this.saveHistory();
                this.renderHistory();

                this.currentWorkout = null;
                this.currentPlan = null;
                document.getElementById('currentInterval').style.display = 'none';
                
                this.liveData = { time: 0, dist: 0, pace: 0, watts: 0, rate: 0, hr: 0 };
                this.updateDashboard();

                this.showToast('Workout saved!', 'success');
                this.navigate('screenHistory');
            }

            // ========================================================================
            // BLUETOOTH CONNECTION
            // ========================================================================

            async connectBluetooth() {
                if (this.isConnected) {
                    this.showToast('Already connected', 'success');
                    return;
                }

                try {
                    this.bluetoothDevice = await navigator.bluetooth.requestDevice({
                        filters: [{ namePrefix: 'PM5' }],
                        optionalServices: [PM5_CONFIG.SERVICE]
                    });

                    this.bluetoothDevice.addEventListener('gattserverdisconnected', () => {
                        this.handleDisconnect();
                    });

                    const server = await this.bluetoothDevice.gatt.connect();
                    const service = await server.getPrimaryService(PM5_CONFIG.SERVICE);
                    this.bluetoothCharacteristic = await service.getCharacteristic(PM5_CONFIG.CHARACTERISTIC);
                    
                    await this.bluetoothCharacteristic.startNotifications();
                    this.bluetoothCharacteristic.addEventListener('characteristicvaluechanged', 
                        (event) => this.handlePM5Data(event));

                    this.isConnected = true;
                    this.updateConnectionUI(true);
                    this.showToast('Connected to PM5', 'success');

                } catch (error) {
                    console.error('Bluetooth error:', error);
                    this.showToast(`Connection failed: ${error.message}`, 'error');
                    this.isConnected = false;
                    this.updateConnectionUI(false);
                }
            }

            handlePM5Data(event) {
                try {
                    const value = event.target.value;
                    
                    if (value.byteLength < 20) return;

                    const timeCenti = value.getUint8(0) | (value.getUint8(1) << 8) | (value.getUint8(2) << 16);
                    const time = timeCenti / 100;

                    const distDeci = value.getUint8(3) | (value.getUint8(4) << 8) | (value.getUint8(5) << 16);
                    const dist = distDeci / 10;

                    const rate = value.getUint8(10);
                    const watts = value.getUint16(13, true);
                    const pace = watts > 0 ? (2.8 / Math.pow(watts, 1/3)) : 0;
                    const hr = value.getUint8(11) || 0;

                    this.liveData = {
                        time: time,
                        dist: Math.floor(dist),
                        pace: pace * 500,
                        watts: watts,
                        rate: rate,
                        hr: hr
                    };

                    this.updateDashboard();

                    if (this.currentWorkout) {
                        this.currentWorkout.recordDataPoint(this.liveData);
                    }

                } catch (error) {
                    console.error('Error parsing PM5 data:', error);
                }
            }

            handleDisconnect() {
                this.isConnected = false;
                this.updateConnectionUI(false);
                this.showToast('PM5 disconnected', 'error');
            }

            updateConnectionUI(connected) {
                const btn = document.getElementById('btBtn');
                if (connected) {
                    btn.classList.add('connected');
                    btn.textContent = 'Connected ‚úì';
                } else {
                    btn.classList.remove('connected');
                    btn.textContent = 'Connect PM5';
                }
            }

            updateDashboard() {
                document.getElementById('metricTime').textContent = this.formatTime(this.liveData.time);
                document.getElementById('metricDist').textContent = this.liveData.dist;
                document.getElementById('metricPace').textContent = this.formatPace(this.liveData.pace);
                document.getElementById('metricWatts').textContent = this.liveData.watts;
                document.getElementById('metricRate').textContent = this.liveData.rate;
                document.getElementById('metricHR').textContent = this.liveData.hr > 0 ? this.liveData.hr : '--';
            }

            // ========================================================================
            // HISTORY
            // ========================================================================

            renderHistory() {
                const container = document.getElementById('historyList');

                if (this.history.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìä</div>
                            <div class="empty-state-text">No workouts yet.<br>Complete your first AI-planned workout!</div>
                        </div>
                    `;
                    return;
                }

                const html = this.history.map((workout, index) => {
                    const date = new Date(workout.date);
                    const dateStr = date.toLocaleDateString('en-US', { 
                        month: 'short', 
                        day: 'numeric',
                        year: 'numeric'
                    });

                    return `
                        <div class="history-item" onclick="app.showWorkoutDetail(${index})">
                            <div class="history-date">${dateStr}</div>
                            <div class="history-title">${workout.description}</div>
                            <div class="history-stats">
                                <span>${workout.distance}m</span>
                                <span>${workout.pace}</span>
                                <span>${workout.watts}W</span>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = html;
            }

            showWorkoutDetail(index) {
                const workout = this.history[index];
                const date = new Date(workout.date);
                const dateStr = date.toLocaleDateString('en-US', { 
                    weekday: 'long',
                    month: 'long', 
                    day: 'numeric',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                let html = `
                    <div class="card">
                        <div style="color:#666; font-size:12px; margin-bottom:12px;">${dateStr}</div>
                        <h2 style="color:var(--text); margin:0 0 24px 0; font-size:20px;">${workout.description}</h2>
                        
                        <div class="dash-metrics" style="margin-bottom:0;">
                            <div class="metric">
                                <div class="metric-value" style="font-size:28px;">${workout.workTime}</div>
                                <div class="metric-label">Time</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value" style="font-size:28px;">${workout.distance}</div>
                                <div class="metric-label">Meters</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value" style="font-size:28px;">${workout.pace}</div>
                                <div class="metric-label">Pace</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value" style="font-size:28px;">${workout.watts}</div>
                                <div class="metric-label">Watts</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value" style="font-size:28px;">${workout.avgHR || '--'}</div>
                                <div class="metric-label">Avg HR</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value" style="font-size:28px;">${workout.strokeRate || '--'}</div>
                                <div class="metric-label">S/M</div>
                            </div>
                        </div>
                    </div>
                `;

                if (workout.comments) {
                    html += `
                        <div class="card">
                            <div class="card-header">Notes</div>
                            <div style="color:#ccc; line-height:1.6;">${workout.comments}</div>
                        </div>
                    `;
                }

                document.getElementById('detailContent').innerHTML = html;
                document.getElementById('detailModal').classList.add('active');
            }

            closeModal() {
                document.getElementById('detailModal').classList.remove('active');
            }

            // ========================================================================
            // NAVIGATION & UI
            // ========================================================================

            navigate(screenId) {
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.remove('active');
                });
                document.getElementById(screenId).classList.add('active');

                const navItems = document.querySelectorAll('.nav-item');
                navItems.forEach(item => item.classList.remove('active'));
                
                const screenMap = {
                    'screenCoach': 0,
                    'screenRow': 1,
                    'screenHistory': 2
                };
                
                const index = screenMap[screenId];
                if (index !== undefined) {
                    navItems[index].classList.add('active');
                }
            }

            showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = `toast ${type}`;
                
                void toast.offsetWidth;
                
                toast.classList.add('show');

                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }

            formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            formatPace(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }
        }

        // ============================================================================
        // WORKOUT CLASS
        // ============================================================================

        class Workout {
            constructor(plan) {
                this.intervals = plan.intervals;
                this.currentInterval = 0;
                this.startTime = Date.now();
                this.dataPoints = [];
            }

            recordDataPoint(data) {
                this.dataPoints.push({
                    timestamp: Date.now() - this.startTime,
                    ...data
                });
            }

            getDescription() {
                const workIntervals = this.intervals.filter(i => i.type === 'WORK');
                if (workIntervals.length === 1) {
                    return `${workIntervals[0].distance}m`;
                }
                return `${workIntervals.length}x intervals`;
            }
        }

        // ============================================================================
        // INITIALIZE APP
        // ============================================================================

        const app = new AIRowingCoach();
    </script>
</body>
</html>
