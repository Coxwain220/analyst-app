<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ANALYST V4.0 (PLATFORM)</title>
    <style>
        :root { --bg: #000; --text: #fff; --accent: #00FF00; --warn: #FFAA00; --danger: #FF0000; --rest: #0088FF; --panel: #111; --border: #333; }
        * { box-sizing: border-box; }
        body { background: var(--bg); color: var(--text); font-family: 'Roboto', sans-serif; margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }

        /* --- NAVIGATION --- */
        .nav-bar { display: flex; background: var(--panel); border-top: 1px solid var(--border); height: 60px; }
        .nav-btn { flex: 1; background: transparent; border: none; color: #666; font-size: 10px; font-weight: bold; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .nav-btn.active { color: var(--accent); background: #1a1a1a; }
        .nav-icon { font-size: 18px; margin-bottom: 4px; }

        /* --- SCREENS --- */
        .screen { display: none; flex-grow: 1; flex-direction: column; overflow: hidden; }
        .screen.active { display: flex; }
        .scroll-area { flex-grow: 1; overflow-y: auto; padding: 20px; }

        /* --- UI ELEMENTS --- */
        .card { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .section-header { color: var(--accent); font-size: 11px; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        
        .btn { width: 100%; padding: 14px; border-radius: 6px; font-weight: bold; cursor: pointer; border: none; text-transform: uppercase; font-size: 14px; margin-top: 5px; }
        .btn-green { background: var(--accent); color: black; }
        .btn-outline { background: transparent; border: 1px solid #555; color: #888; }
        .btn-danger { background: #300; border: 1px solid #500; color: #f88; }

        input, textarea, select { background: #000; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 4px; width: 100%; font-family: inherit; margin-bottom: 10px; }
        textarea { resize: none; }

        /* --- DASHBOARD --- */
        #dashScreen { display: none; height: 100%; grid-template-rows: 60px 1fr 120px; }
        #dashScreen.active { display: grid; }

        .comms-bar { background: var(--panel); padding: 0 20px; display: flex; flex-direction: column; justify-content: center; border-bottom: 1px solid var(--border); position: relative; }
        .coach-text { font-family: monospace; color: var(--accent); font-size: 14px; font-weight: bold; white-space: pre-wrap; }
        
        .main-deck { display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .metric-huge { font-size: 14vh; font-weight: 900; line-height: 0.9; letter-spacing: -2px; }
        .metric-sub { font-size: 4vh; color: #888; font-weight: 700; margin-top: 10px; }

        .lower-deck { display: grid; grid-template-columns: 1fr 1fr; background: var(--panel); border-top: 1px solid var(--border); }
        .stat-box { display: flex; flex-direction: column; align-items: center; justify-content: center; border-right: 1px solid var(--border); position: relative; }
        
        /* --- HR ZONE BAR --- */
        .hr-bar-container { width: 100%; height: 6px; background: #222; margin-top: 5px; border-radius: 3px; overflow: hidden; display: flex; }
        .hr-zone { height: 100%; opacity: 0.3; transition: opacity 0.2s; }
        .hr-zone.active { opacity: 1; box-shadow: 0 0 10px currentColor; }
        .z1 { background: #666; width: 50%; } /* Warmup */
        .z2 { background: #0088FF; width: 10%; } /* Aerobic */
        .z3 { background: #00FF00; width: 10%; } /* Tempo */
        .z4 { background: #FFAA00; width: 10%; } /* Threshold */
        .z5 { background: #FF0000; width: 20%; } /* Max */

        /* --- HISTORY LIST --- */
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #222; cursor: pointer; }
        .history-item:hover { background: #111; }
        .h-date { font-size: 12px; color: #666; }
        .h-desc { font-weight: bold; font-size: 14px; margin-top: 2px; }
        .h-stat { font-family: monospace; color: var(--accent); font-size: 12px; }

        /* --- SEGMENT BUILDER --- */
        .seg-list { margin-top: 10px; }
        .seg-item { background: #1a1a1a; padding: 8px; margin-bottom: 5px; border-left: 3px solid var(--accent); font-size: 12px; display: flex; justify-content: space-between; }

        .ai-pulse { animation: pulse 1s infinite; color: var(--warn); }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div id="screenBuilder" class="screen active">
        <div class="scroll-area">
            <div class="card">
                <div class="section-header">NATURAL LANGUAGE MISSION BUILDER</div>
                <label style="font-size:10px; color:#666;">TYPE OR SPEAK YOUR PLAN</label>
                <textarea id="aiInput" rows="3" placeholder="e.g. 4 x 6min. 2 mins 20sr, 2 mins 24sr, 2 mins 30sr..."></textarea>
                <button class="btn btn-green" onclick="generateMission()">GENERATE MISSION</button>
            </div>

            <div id="missionPreview" class="card hidden">
                <div class="section-header">MISSION PARAMETERS</div>
                <div id="missionDetails" style="font-size:12px; color:#ccc; margin-bottom:10px; white-space: pre-wrap;"></div>
                <div class="seg-list" id="segmentList"></div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px;">
                    <button class="btn btn-outline" onclick="startMission(true)">SIMULATE</button>
                    <button class="btn btn-green" onclick="startMission(false)">CONNECT PM5</button>
                </div>
            </div>

            <div class="card">
                <div class="section-header">MANUAL OVERRIDE</div>
                <button class="btn btn-outline" style="font-size:12px;" onclick="nav('screenSettings')">EDIT HR ZONES</button>
            </div>
        </div>
    </div>

    <div id="dashScreen">
        <div class="comms-bar">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:10px; color:#666;">ANALYST AI</span>
                <span id="aiStatus" style="color:#333;">●</span>
            </div>
            <div class="coach-text" id="coachMsg">READY.</div>
            <div style="position:absolute; right:10px; top:10px; background:#222; padding:4px 8px; border-radius:4px; font-size:10px; font-weight:bold; color:#888;" id="phaseBadge">IDLE</div>
        </div>

        <div class="main-deck">
            <div id="intervalInfo" style="font-size:14px; color:#666; margin-bottom:5px;">--</div>
            <div class="metric-huge" id="dispPace">0:00</div>
            <div class="metric-sub">
                <span id="dispWatts">0</span>W <span style="color:#444">|</span> <span id="dispDist">0</span>m
            </div>
        </div>

        <div class="lower-deck">
            <div class="stat-box">
                <div class="metric-sub" id="dispRate" style="color:white; margin:0;">--</div>
                <div style="font-size:10px; color:#666;">RATE</div>
                <div style="font-size:10px; color:var(--accent); margin-top:2px;">TGT: <span id="tgtRate">--</span></div>
            </div>
            <div class="stat-box" style="padding: 0 15px;">
                <div class="metric-sub" id="dispHR" style="color:white; margin:0;">--</div>
                <div style="font-size:10px; color:#666;">HEART RATE</div>
                <div class="hr-bar-container" id="hrBar">
                    <div class="hr-zone z1" id="z1"></div>
                    <div class="hr-zone z2" id="z2"></div>
                    <div class="hr-zone z3" id="z3"></div>
                    <div class="hr-zone z4" id="z4"></div>
                    <div class="hr-zone z5" id="z5"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="screenHistory" class="screen">
        <div class="scroll-area" id="historyList">
            </div>
        <div style="padding:15px; border-top:1px solid #333; background:var(--panel);">
            <button class="btn btn-outline" onclick="exportHistory()">EXPORT ALL (CSV)</button>
        </div>
    </div>

    <div id="screenSettings" class="screen">
        <div class="scroll-area">
            <div class="card">
                <div class="section-header">HEART RATE ZONES</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div><label>Z5 MAX</label><input type="number" id="hrZ5" value="180"></div>
                    <div><label>Z4 MAX</label><input type="number" id="hrZ4" value="162"></div>
                    <div><label>Z3 MAX</label><input type="number" id="hrZ3" value="144"></div>
                    <div><label>Z2 MAX</label><input type="number" id="hrZ2" value="125"></div>
                    <div><label>Z1 MAX</label><input type="number" id="hrZ1" value="108"></div>
                </div>
                <button class="btn btn-green" onclick="saveSettings()">SAVE PROFILE</button>
            </div>
            
            <div class="card">
                <div class="section-header">SYSTEM</div>
                <label>API KEY</label>
                <input type="password" id="apiKeyInput">
                <button class="btn btn-danger" onclick="clearData()">RESET DATA</button>
            </div>
        </div>
    </div>

    <div class="nav-bar">
        <button class="nav-btn active" onclick="nav('screenBuilder')" id="navBuild">
            <span class="nav-icon">⚡</span>BUILD
        </button>
        <button class="nav-btn" onclick="nav('dashScreen')" id="navDash">
            <span class="nav-icon">⏱</span>ROW
        </button>
        <button class="nav-btn" onclick="nav('screenHistory')" id="navHist">
            <span class="nav-icon">☰</span>LOGS
        </button>
        <button class="nav-btn" onclick="nav('screenSettings')" id="navSet">
            <span class="nav-icon">⚙</span>SET
        </button>
    </div>

    <script>
        // --- CONSTANTS ---
        const PM5_SERVICE = 'ce060030-43e5-11e4-916c-0800200c9a66';
        const PM5_CHAR_32 = 'ce060032-43e5-11e4-916c-0800200c9a66'; 
        const MODEL = "gemini-2.5-flash";

        // --- DATA STORE ---
        let PROFILE = {
            hrZones: { z1: 108, z2: 125, z3: 144, z4: 162, z5: 180 },
            apiKey: ""
        };
        let HISTORY = [];
        
        let MISSION = {
            description: "",
            intervals: [], // Array of { type:'WORK'|'REST', duration:sec, segments:[{duration, rate, pace}] }
            totalTime: 0
        };

        let STATE = {
            active: false,
            intervalIdx: 0,
            segmentIdx: 0,
            timeLeft: 0,
            elapsedInterval: 0,
            log: [], // High res log
            simLoop: null,
            lastAi: 0
        };

        // --- INIT ---
        window.onload = () => {
            loadData();
            renderHistory();
        };

        function nav(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if(screenId === 'screenBuilder') document.getElementById('navBuild').classList.add('active');
            if(screenId === 'dashScreen') document.getElementById('navDash').classList.add('active');
            if(screenId === 'screenHistory') document.getElementById('navHist').classList.add('active');
            if(screenId === 'screenSettings') document.getElementById('navSet').classList.add('active');
        }

        function loadData() {
            const p = localStorage.getItem('analyst_profile');
            if(p) PROFILE = JSON.parse(p);
            
            // Populate Settings inputs
            document.getElementById('hrZ5').value = PROFILE.hrZones.z5;
            document.getElementById('hrZ4').value = PROFILE.hrZones.z4;
            document.getElementById('hrZ3').value = PROFILE.hrZones.z3;
            document.getElementById('hrZ2').value = PROFILE.hrZones.z2;
            document.getElementById('hrZ1').value = PROFILE.hrZones.z1;
            if(localStorage.getItem('gemini_api_key')) document.getElementById('apiKeyInput').value = localStorage.getItem('gemini_api_key');

            const h = localStorage.getItem('analyst_history');
            if(h) HISTORY = JSON.parse(h);
        }

        function saveSettings() {
            PROFILE.hrZones.z5 = parseInt(document.getElementById('hrZ5').value);
            PROFILE.hrZones.z4 = parseInt(document.getElementById('hrZ4').value);
            PROFILE.hrZones.z3 = parseInt(document.getElementById('hrZ3').value);
            PROFILE.hrZones.z2 = parseInt(document.getElementById('hrZ2').value);
            PROFILE.hrZones.z1 = parseInt(document.getElementById('hrZ1').value);
            
            const key = document.getElementById('apiKeyInput').value.trim();
            if(key) localStorage.setItem('gemini_api_key', key);
            PROFILE.apiKey = key;

            localStorage.setItem('analyst_profile', JSON.stringify(PROFILE));
            alert("Settings Saved");
        }

        // --- AI MISSION GENERATOR ---
        async function generateMission() {
            const input = document.getElementById('aiInput').value;
            const key = document.getElementById('apiKeyInput').value || localStorage.getItem('gemini_api_key');
            
            if(!input || !key) return alert("Input and API Key required.");
            
            document.getElementById('missionDetails').innerText = "AI GENERATING TRAINING PLAN...";
            document.getElementById('missionPreview').classList.remove('hidden');

            const PROMPT = `
            Parse this rowing workout text into a JSON structure.
            Text: "${input}"
            
            Return JSON object:
            {
                "description": "Short summary",
                "intervals": [
                    {
                        "type": "WORK", (or REST)
                        "duration": 0, (seconds)
                        "dist": 0, (meters, 0 if time-based)
                        "segments": [
                            { "duration": 0, "rate": 0, "pace_desc": "..." } 
                        ]
                    }
                ]
            }
            Example: "4x6min, 2min rest" -> 4 work intervals (360s), 3 rest intervals (120s) in between.
            IMPORTANT: If the user specifies sub-segments (e.g. "2 mins 20sr, 2 mins 24sr"), break the WORK interval into segments.
            `;

            try {
                const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${key}`, {
                    method: "POST", headers: {"Content-Type":"application/json"},
                    body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: PROMPT }] }] })
                });
                const d = await r.json();
                const jsonText = d.candidates?.[0]?.content?.parts?.[0]?.text.replace(/```json/g,'').replace(/```/g,'');
                const plan = JSON.parse(jsonText);
                
                MISSION = plan;
                renderMissionPreview();

            } catch(e) {
                alert("AI Generation Failed: " + e.message);
            }
        }

        function renderMissionPreview() {
            document.getElementById('missionDetails').innerText = MISSION.description;
            const list = document.getElementById('segmentList');
            list.innerHTML = "";
            
            MISSION.intervals.forEach((int, i) => {
                let div = document.createElement('div');
                div.className = 'seg-item';
                div.style.borderLeftColor = int.type === 'WORK' ? 'var(--accent)' : 'var(--rest)';
                div.innerHTML = `<span>${int.type} (${int.duration}s)</span> <span>${int.segments ? int.segments.length + ' Segments' : ''}</span>`;
                list.appendChild(div);
            });
        }

        // --- DASHBOARD ENGINE ---
        function startMission(isSim) {
            nav('dashScreen');
            STATE = {
                active: true,
                intervalIdx: 0,
                segmentIdx: 0,
                timeLeft: MISSION.intervals[0].duration,
                elapsedInterval: 0,
                log: [],
                lastAi: 0
            };
            
            updateDashboardPhase();

            if(isSim) {
                STATE.simLoop = setInterval(() => {
                    if(!STATE.active) return;
                    // Sim data
                    let currentInt = MISSION.intervals[STATE.intervalIdx];
                    let currentSeg = currentInt.segments ? currentInt.segments[STATE.segmentIdx] : null;
                    let tgtRate = currentSeg ? currentSeg.rate : 22;
                    
                    processTelemetry(2.5, tgtRate, 145, 200);
                }, 500);
            } else {
                connectBluetooth();
            }
        }

        function updateDashboardPhase() {
            if(STATE.intervalIdx >= MISSION.intervals.length) {
                endMission();
                return;
            }
            
            const int = MISSION.intervals[STATE.intervalIdx];
            document.getElementById('phaseBadge').innerText = int.type;
            document.getElementById('phaseBadge').style.backgroundColor = int.type === 'WORK' ? 'var(--accent)' : 'var(--rest)';
            document.getElementById('phaseBadge').style.color = int.type === 'WORK' ? 'black' : 'white';
            
            STATE.timeLeft = int.duration;
            STATE.segmentIdx = 0;
            STATE.elapsedInterval = 0;
            
            document.getElementById('intervalInfo').innerText = `${int.type} ${STATE.intervalIdx+1}/${MISSION.intervals.length}`;
        }

        function processTelemetry(speedMS, rate, hr, watts) {
            if(!STATE.active) return;
            
            // Time Management
            // Assuming 0.5s tick or using real time delta. For simplicity V4 uses 0.5s ticks
            const dt = 0.5;
            STATE.timeLeft -= dt;
            STATE.elapsedInterval += dt;

            // Segment Logic
            const int = MISSION.intervals[STATE.intervalIdx];
            let currentSeg = null;
            
            if(int.segments && int.segments.length > 0) {
                // Find which segment we are in
                let t = 0;
                for(let s of int.segments) {
                    if(STATE.elapsedInterval >= t && STATE.elapsedInterval < t + s.duration) {
                        currentSeg = s;
                        break;
                    }
                    t += s.duration;
                }
            }

            // Next Interval Check
            if(STATE.timeLeft <= 0) {
                STATE.intervalIdx++;
                updateDashboardPhase();
                return;
            }

            // UI Update
            let paceSec = speedMS > 0.1 ? 500/speedMS : 0;
            let m = Math.floor(paceSec / 60);
            let s = Math.floor(paceSec % 60);
            document.getElementById('dispPace').innerText = speedMS > 0.1 ? `${m}:${s.toString().padStart(2,'0')}` : "0:00";
            document.getElementById('dispWatts').innerText = watts;
            document.getElementById('dispRate').innerText = rate;
            document.getElementById('dispHR').innerText = hr < 255 ? hr : "--";
            
            // Target Rate Display
            document.getElementById('tgtRate').innerText = currentSeg ? currentSeg.rate : "--";

            // HR Zone Bar
            updateHRBar(hr);
            
            // Log
            if(int.type === 'WORK') {
                STATE.log.push({
                    time: new Date().toISOString(),
                    watts: watts,
                    hr: hr,
                    rate: rate,
                    pace: document.getElementById('dispPace').innerText,
                    dist: 0 // Calculate if needed
                });
            }
        }

        function updateHRBar(hr) {
            document.querySelectorAll('.hr-zone').forEach(z => z.classList.remove('active'));
            if(hr > PROFILE.hrZones.z4) document.getElementById('z5').classList.add('active');
            else if(hr > PROFILE.hrZones.z3) document.getElementById('z4').classList.add('active');
            else if(hr > PROFILE.hrZones.z2) document.getElementById('z3').classList.add('active');
            else if(hr > PROFILE.hrZones.z1) document.getElementById('z2').classList.add('active');
            else if(hr > 0) document.getElementById('z1').classList.add('active');
        }

        function endMission() {
            STATE.active = false;
            if(STATE.simLoop) clearInterval(STATE.simLoop);
            alert("Mission Complete. Saving Data.");
            
            // Save to History
            const session = {
                id: Date.now(),
                date: new Date().toISOString(),
                desc: MISSION.description || "Custom Workout",
                stats: calculateStats(STATE.log),
                raw: STATE.log
            };
            HISTORY.unshift(session);
            localStorage.setItem('analyst_history', JSON.stringify(HISTORY));
            renderHistory();
            nav('screenHistory');
        }

        function calculateStats(log) {
            if(log.length === 0) return { avgWatts:0, dist:0 };
            let sumWatts = 0;
            log.forEach(l => sumWatts += l.watts);
            return {
                avgWatts: Math.round(sumWatts / log.length),
                dist: log.length * (500 / (log[0].paceSec || 120)) // Approx
            };
        }

        // --- HISTORY & EXPORT ---
        function renderHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = "";
            HISTORY.forEach(h => {
                let div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `
                    <div>
                        <div class="h-date">${new Date(h.date).toLocaleDateString()} ${new Date(h.date).toLocaleTimeString()}</div>
                        <div class="h-desc">${h.desc}</div>
                    </div>
                    <div class="h-stat">${h.stats.avgWatts}W</div>
                `;
                div.onclick = () => alert(JSON.stringify(h.stats, null, 2));
                list.appendChild(div);
            });
        }

        function exportHistory() {
            // ErgData Header Format
            let csv = "Log ID,Date,Description,Work Time (Formatted),Work Time (Seconds),Rest Time (Formatted),Rest Time (Seconds),Work Distance,Rest Distance,Stroke Rate/Cadence,Stroke Count,Pace,Avg Watts,Cal/Hour,Total Cal,Avg Heart Rate,Drag Factor,Age,Weight,Type,Ranked,Comments,Date Entered\n";
            
            HISTORY.forEach(h => {
                // We flatten the log. For "All Data" export, usually ErgData exports summary rows.
                // Here we will export SUMMARY rows for the history.
                // If user wants row-by-row, we'd need a separate button.
                
                // Let's emulate the row-by-row for the LATEST session or just summary lines?
                // The prompt asked for specific headers. Let's do Summary Lines for all history.
                
                csv += `${h.id},${h.date},${h.desc},00:00,0,00:00,0,0,0,0,0,0:00,${h.stats.avgWatts},0,0,0,0,0,0,RowErg,No,,${h.date}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'analyst_export.csv';
            a.click();
        }
        
        function clearData() {
            if(confirm("Delete all history?")) {
                localStorage.removeItem('analyst_history');
                HISTORY = [];
                renderHistory();
            }
        }

        // --- BLUETOOTH ---
        async function connectBluetooth() {
            try {
                const device = await navigator.bluetooth.requestDevice({ filters: [{ namePrefix: 'PM5' }], optionalServices: [PM5_SERVICE] });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(PM5_SERVICE);
                const char = await service.getCharacteristic(PM5_CHAR_32);
                await char.startNotifications();
                char.addEventListener('characteristicvaluechanged', (e) => {
                    let d = e.target.value;
                    if(d.byteLength < 13) return;
                    let speed = (d.getUint8(3) | (d.getUint8(4)<<8)) * 0.001;
                    processTelemetry(speed, d.getUint8(5), d.getUint8(6), (d.getUint8(11)|(d.getUint8(12)<<8)));
                });
            } catch(e) { alert("BT Error: " + e.message); }
        }

    </script>
</body>
</html>
