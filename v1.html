<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rowing Analyst Pro</title>
    <style>
        :root {
            --bg: #000;
            --text: #e0e0e0;
            --accent: #00FF99;
            --accent-dim: #00AA66;
            --danger: #FF4444;
            --rest: #00AAFF;
            --panel: #111;
            --border: #222;
            --card-bg: #0a0a0a;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* TOAST NOTIFICATIONS */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--panel);
            color: var(--text);
            padding: 12px 24px;
            border-radius: 8px;
            border: 1px solid var(--border);
            z-index: 10000;
            opacity: 0;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        .toast.error {
            border-color: var(--danger);
            background: rgba(255,68,68,0.1);
            color: var(--danger);
        }
        
        .toast.success {
            border-color: var(--accent);
            background: rgba(0,255,153,0.1);
            color: var(--accent);
        }
        
        /* SCREENS */
        .screen {
            display: none;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }
        
        .screen.active {
            display: flex;
        }
        
        .screen-header {
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        
        .screen-title {
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 1.5px;
            color: #666;
            text-transform: uppercase;
            text-align: center;
            flex: 1;
        }
        
        .header-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .header-btn:active {
            transform: scale(0.95);
        }
        
        .header-btn.connected {
            border-color: var(--accent);
            color: var(--accent);
        }
        
        .scroll-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 16px;
            padding-bottom: 100px;
        }
        
        /* CARDS */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }
        
        .card-header {
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 1px;
            color: var(--accent);
            text-transform: uppercase;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }
        
        /* BUTTONS */
        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: 0.5px;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-primary {
            background: var(--accent);
            color: #000;
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }
        
        .btn-danger {
            background: rgba(255,68,68,0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
        }
        
        .btn + .btn {
            margin-top: 12px;
        }
        
        /* INPUTS */
        input, textarea, select {
            width: 100%;
            background: #080808;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 14px;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            transition: border-color 0.2s;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        label {
            display: block;
            font-size: 11px;
            font-weight: 700;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }
        
        .input-group {
            margin-bottom: 16px;
        }
        
        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        /* DASHBOARD */
        .dash-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .metric {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 36px;
            font-weight: 900;
            color: var(--text);
            line-height: 1;
            font-variant-numeric: tabular-nums;
        }
        
        .metric-label {
            font-size: 11px;
            font-weight: 700;
            color: #666;
            text-transform: uppercase;
            margin-top: 8px;
            letter-spacing: 1px;
        }
        
        /* WORKOUT PLAN */
        .interval-item {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .interval-type {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--accent);
        }
        
        .interval-work {
            color: var(--accent);
        }
        
        .interval-rest {
            color: var(--rest);
        }
        
        .interval-detail {
            font-size: 16px;
            font-weight: 700;
            color: var(--text);
        }
        
        .interval-remove {
            background: transparent;
            border: none;
            color: var(--danger);
            font-size: 20px;
            cursor: pointer;
            padding: 4px 8px;
        }
        
        /* HISTORY */
        .history-item {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .history-item:active {
            transform: scale(0.98);
            background: var(--panel);
        }
        
        .history-date {
            font-size: 11px;
            color: #666;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .history-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 8px;
        }
        
        .history-stats {
            display: flex;
            gap: 16px;
            font-size: 12px;
            color: var(--accent);
            font-family: monospace;
        }
        
        /* NAVIGATION */
        .nav-bar {
            background: var(--panel);
            border-top: 1px solid var(--border);
            display: flex;
            height: 70px;
            flex-shrink: 0;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .nav-item {
            flex: 1;
            background: transparent;
            border: none;
            color: #666;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: all 0.2s;
        }
        
        .nav-item.active {
            color: var(--accent);
            background: rgba(0,255,153,0.05);
        }
        
        .nav-icon {
            font-size: 20px;
        }
        
        /* MODAL */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 9000;
            display: none;
            flex-direction: column;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-header {
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .modal-close {
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
        }
        
        .modal-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text);
        }
        
        .modal-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        /* STATUS INDICATOR */
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-connected {
            background: var(--accent);
            box-shadow: 0 0 8px var(--accent);
        }
        
        .status-disconnected {
            background: #666;
        }
        
        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .empty-state-text {
            font-size: 14px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- BUILD SCREEN -->
    <div id="screenBuild" class="screen active">
        <div class="screen-header">
            <div class="screen-title">Build Workout</div>
        </div>
        <div class="scroll-content">
            <!-- Quick Add -->
            <div class="card">
                <div class="card-header">Quick Add Interval</div>
                <div class="input-group">
                    <label>Distance (meters)</label>
                    <input type="number" id="quickDist" placeholder="e.g. 2000" value="2000">
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label>Rest Min</label>
                        <input type="number" id="quickRestMin" placeholder="0" value="0">
                    </div>
                    <div class="input-group">
                        <label>Rest Sec</label>
                        <input type="number" id="quickRestSec" placeholder="0" value="0">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="app.addInterval()">Add Interval</button>
            </div>

            <!-- Current Plan -->
            <div class="card">
                <div class="card-header">Workout Plan</div>
                <div id="planList">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <div class="empty-state-text">No intervals added yet.<br>Add your first interval above.</div>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <button class="btn btn-primary" onclick="app.startWorkout()" id="btnStart" disabled>Start Workout</button>
            <button class="btn btn-outline" onclick="app.clearPlan()">Clear Plan</button>
        </div>
    </div>

    <!-- ROW SCREEN -->
    <div id="screenRow" class="screen">
        <div class="screen-header">
            <button class="header-btn" onclick="app.endWorkout()">End</button>
            <div class="screen-title">Rowing</div>
            <button class="header-btn" id="btBtn" onclick="app.connectBluetooth()">
                <span class="status-indicator status-disconnected" id="btStatus"></span>
                Connect
            </button>
        </div>
        <div class="scroll-content">
            <div class="dash-metrics">
                <div class="metric">
                    <div class="metric-value" id="metricTime">0:00</div>
                    <div class="metric-label">Time</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="metricDist">0</div>
                    <div class="metric-label">Meters</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="metricPace">0:00</div>
                    <div class="metric-label">Pace</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="metricWatts">0</div>
                    <div class="metric-label">Watts</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="metricRate">0</div>
                    <div class="metric-label">S/M</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="metricHR">--</div>
                    <div class="metric-label">HR</div>
                </div>
            </div>

            <!-- Current Interval Info -->
            <div class="card" id="currentInterval" style="display:none;">
                <div class="card-header">Current Interval</div>
                <div style="text-align:center; padding:20px;">
                    <div style="font-size:24px; font-weight:900; color:var(--accent);" id="intervalInfo">Interval 1 of 3</div>
                    <div style="font-size:16px; color:#666; margin-top:8px;" id="intervalTarget">Target: 2000m</div>
                </div>
            </div>
        </div>
    </div>

    <!-- HISTORY SCREEN -->
    <div id="screenHistory" class="screen">
        <div class="screen-header">
            <div class="screen-title">Workout History</div>
        </div>
        <div class="scroll-content" id="historyList">
            <div class="empty-state">
                <div class="empty-state-icon">üìä</div>
                <div class="empty-state-text">No workouts recorded yet.<br>Complete your first workout to see it here.</div>
            </div>
        </div>
    </div>

    <!-- SETTINGS SCREEN -->
    <div id="screenSettings" class="screen">
        <div class="screen-header">
            <div class="screen-title">Settings</div>
        </div>
        <div class="scroll-content">
            <div class="card">
                <div class="card-header">Profile</div>
                <div class="input-row">
                    <div class="input-group">
                        <label>Age</label>
                        <input type="number" id="settingAge" placeholder="25">
                    </div>
                    <div class="input-group">
                        <label>Weight (kg)</label>
                        <input type="number" id="settingWeight" placeholder="75">
                    </div>
                </div>
                <div class="input-group">
                    <label>Max Heart Rate</label>
                    <input type="number" id="settingMaxHR" placeholder="190">
                </div>
            </div>

            <div class="card">
                <div class="card-header">Data</div>
                <button class="btn btn-outline" onclick="app.exportData()">Export History</button>
                <button class="btn btn-danger" onclick="app.resetData()">Reset All Data</button>
            </div>

            <div class="card">
                <div class="card-header">About</div>
                <div style="color:#666; font-size:13px; line-height:1.6;">
                    <strong>Rowing Analyst Pro</strong><br>
                    Version 1.0<br>
                    Designed for PM5 monitors via Web Bluetooth
                </div>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detailModal" class="modal">
        <div class="modal-header">
            <button class="modal-close" onclick="app.closeModal()">‚Üê</button>
            <div class="modal-title">Workout Details</div>
        </div>
        <div class="modal-content" id="detailContent"></div>
    </div>

    <!-- Navigation -->
    <nav class="nav-bar">
        <button class="nav-item active" onclick="app.navigate('screenBuild')">
            <span class="nav-icon">üèóÔ∏è</span>
            Build
        </button>
        <button class="nav-item" onclick="app.navigate('screenRow')">
            <span class="nav-icon">üö£</span>
            Row
        </button>
        <button class="nav-item" onclick="app.navigate('screenHistory')">
            <span class="nav-icon">üìä</span>
            History
        </button>
        <button class="nav-item" onclick="app.navigate('screenSettings')">
            <span class="nav-icon">‚öôÔ∏è</span>
            Settings
        </button>
    </nav>

    <script>
        // ============================================================================
        // ROWING ANALYST PRO - CORE APPLICATION
        // ============================================================================
        
        const STORAGE_KEYS = {
            HISTORY: 'rowing_analyst_history_v1',
            SETTINGS: 'rowing_analyst_settings_v1',
            PLAN: 'rowing_analyst_current_plan'
        };

        const PM5_CONFIG = {
            SERVICE: 'ce060030-43e5-11e4-916c-0800200c9a66',
            CHARACTERISTIC: 'ce060031-43e5-11e4-916c-0800200c9a66'
        };

        class RowingApp {
            constructor() {
                this.history = [];
                this.settings = {};
                this.currentPlan = [];
                this.currentWorkout = null;
                this.liveData = { time: 0, dist: 0, pace: 0, watts: 0, rate: 0, hr: 0 };
                this.bluetoothDevice = null;
                this.bluetoothCharacteristic = null;
                this.isConnected = false;
                this.animationFrame = null;
                
                this.init();
            }

            // ========================================================================
            // INITIALIZATION
            // ========================================================================
            
            init() {
                this.loadData();
                this.renderHistory();
                this.renderPlan();
                this.loadSettings();
            }

            loadData() {
                // Load history - NEVER overwrite existing data
                try {
                    const historyData = localStorage.getItem(STORAGE_KEYS.HISTORY);
                    if (historyData) {
                        this.history = JSON.parse(historyData);
                        console.log(`Loaded ${this.history.length} workout(s) from storage`);
                    } else {
                        // Only use demo data if no existing data
                        this.history = this.getDemoHistory();
                        this.saveHistory();
                        console.log('Initialized with demo data');
                    }
                } catch (error) {
                    console.error('Error loading history:', error);
                    this.showToast('Error loading history', 'error');
                    this.history = [];
                }

                // Load current plan
                try {
                    const planData = localStorage.getItem(STORAGE_KEYS.PLAN);
                    if (planData) {
                        this.currentPlan = JSON.parse(planData);
                    }
                } catch (error) {
                    console.error('Error loading plan:', error);
                    this.currentPlan = [];
                }

                // Load settings
                try {
                    const settingsData = localStorage.getItem(STORAGE_KEYS.SETTINGS);
                    if (settingsData) {
                        this.settings = JSON.parse(settingsData);
                    }
                } catch (error) {
                    console.error('Error loading settings:', error);
                    this.settings = {};
                }
            }

            getDemoHistory() {
                return [
                    {
                        id: "111095775",
                        date: "2026-01-12T18:38:00",
                        description: "3x Intervals: 3000m, 1500m, 750m",
                        workTime: "19:53.1",
                        distance: 5250,
                        pace: "01:53.6",
                        watts: 239,
                        avgHR: 177,
                        dragFactor: 134,
                        splits: [
                            { dist: 3000, pace: "01:54.8" },
                            { dist: 1500, pace: "01:53.4" },
                            { dist: 750, pace: "01:49.4" }
                        ]
                    },
                    {
                        id: "110986164",
                        date: "2026-01-10T09:47:00",
                        description: "3x 2000m intervals",
                        workTime: "23:04.0",
                        distance: 6000,
                        pace: "01:55.3",
                        watts: 228,
                        avgHR: 174,
                        dragFactor: 135
                    },
                    {
                        id: "105488743",
                        date: "2025-08-26T21:12:00",
                        description: "32:00 steady state",
                        workTime: "32:00.0",
                        distance: 7726,
                        pace: "02:04.2",
                        watts: 182,
                        avgHR: 0,
                        dragFactor: 117
                    }
                ];
            }

            saveHistory() {
                try {
                    localStorage.setItem(STORAGE_KEYS.HISTORY, JSON.stringify(this.history));
                    console.log('History saved successfully');
                } catch (error) {
                    console.error('Error saving history:', error);
                    this.showToast('Error saving workout', 'error');
                }
            }

            savePlan() {
                try {
                    localStorage.setItem(STORAGE_KEYS.PLAN, JSON.stringify(this.currentPlan));
                } catch (error) {
                    console.error('Error saving plan:', error);
                }
            }

            saveSettings() {
                try {
                    this.settings = {
                        age: document.getElementById('settingAge').value,
                        weight: document.getElementById('settingWeight').value,
                        maxHR: document.getElementById('settingMaxHR').value
                    };
                    localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify(this.settings));
                    this.showToast('Settings saved', 'success');
                } catch (error) {
                    console.error('Error saving settings:', error);
                    this.showToast('Error saving settings', 'error');
                }
            }

            loadSettings() {
                if (this.settings.age) document.getElementById('settingAge').value = this.settings.age;
                if (this.settings.weight) document.getElementById('settingWeight').value = this.settings.weight;
                if (this.settings.maxHR) document.getElementById('settingMaxHR').value = this.settings.maxHR;
            }

            // ========================================================================
            // BLUETOOTH CONNECTION
            // ========================================================================

            async connectBluetooth() {
                if (this.isConnected) {
                    this.showToast('Already connected', 'success');
                    return;
                }

                try {
                    console.log('Requesting Bluetooth device...');
                    
                    // Request device
                    this.bluetoothDevice = await navigator.bluetooth.requestDevice({
                        filters: [{ namePrefix: 'PM5' }],
                        optionalServices: [PM5_CONFIG.SERVICE]
                    });

                    console.log('Device found:', this.bluetoothDevice.name);

                    // Add disconnect handler
                    this.bluetoothDevice.addEventListener('gattserverdisconnected', () => {
                        this.handleDisconnect();
                    });

                    // Connect to GATT server
                    console.log('Connecting to GATT server...');
                    const server = await this.bluetoothDevice.gatt.connect();
                    
                    // Get service
                    console.log('Getting PM5 service...');
                    const service = await server.getPrimaryService(PM5_CONFIG.SERVICE);
                    
                    // Get characteristic
                    console.log('Getting characteristic...');
                    this.bluetoothCharacteristic = await service.getCharacteristic(PM5_CONFIG.CHARACTERISTIC);
                    
                    // Start notifications
                    console.log('Starting notifications...');
                    await this.bluetoothCharacteristic.startNotifications();
                    
                    // Add event listener
                    this.bluetoothCharacteristic.addEventListener('characteristicvaluechanged', 
                        (event) => this.handlePM5Data(event));

                    this.isConnected = true;
                    this.updateConnectionUI(true);
                    this.showToast('Connected to PM5', 'success');
                    console.log('Successfully connected to PM5');

                } catch (error) {
                    console.error('Bluetooth error:', error);
                    this.showToast(`Connection failed: ${error.message}`, 'error');
                    this.isConnected = false;
                    this.updateConnectionUI(false);
                }
            }

            handlePM5Data(event) {
                try {
                    const value = event.target.value;
                    
                    // Validate packet size
                    if (value.byteLength < 20) {
                        console.warn('Packet too small:', value.byteLength);
                        return;
                    }

                    // Parse data (Little Endian)
                    // Time: bytes 0-2 (centiseconds)
                    const timeCenti = value.getUint8(0) | (value.getUint8(1) << 8) | (value.getUint8(2) << 16);
                    const time = timeCenti / 100;

                    // Distance: bytes 3-5 (decimeters)
                    const distDeci = value.getUint8(3) | (value.getUint8(4) << 8) | (value.getUint8(5) << 16);
                    const dist = distDeci / 10;

                    // Stroke rate: byte 10
                    const rate = value.getUint8(10);

                    // Watts: bytes 13-14 (Little Endian)
                    const watts = value.getUint16(13, true);

                    // Calculate pace from watts
                    const pace = watts > 0 ? (2.8 / Math.pow(watts, 1/3)) : 0;

                    // Heart rate: byte 11 (if available)
                    const hr = value.getUint8(11) || 0;

                    // Update live data
                    this.liveData = {
                        time: time,
                        dist: Math.floor(dist),
                        pace: pace * 500, // Convert to per-500m
                        watts: watts,
                        rate: rate,
                        hr: hr
                    };

                    // Update UI
                    this.updateDashboard();

                    // Record data if workout is active
                    if (this.currentWorkout) {
                        this.currentWorkout.recordDataPoint(this.liveData);
                    }

                } catch (error) {
                    console.error('Error parsing PM5 data:', error);
                }
            }

            handleDisconnect() {
                console.log('PM5 disconnected');
                this.isConnected = false;
                this.updateConnectionUI(false);
                this.showToast('PM5 disconnected', 'error');
            }

            updateConnectionUI(connected) {
                const btn = document.getElementById('btBtn');
                const status = document.getElementById('btStatus');
                
                if (connected) {
                    btn.classList.add('connected');
                    btn.innerHTML = '<span class="status-indicator status-connected"></span>Connected';
                    status.classList.remove('status-disconnected');
                    status.classList.add('status-connected');
                } else {
                    btn.classList.remove('connected');
                    btn.innerHTML = '<span class="status-indicator status-disconnected"></span>Connect';
                    status.classList.remove('status-connected');
                    status.classList.add('status-disconnected');
                }
            }

            updateDashboard() {
                const formatTime = (seconds) => {
                    const mins = Math.floor(seconds / 60);
                    const secs = Math.floor(seconds % 60);
                    return `${mins}:${secs.toString().padStart(2, '0')}`;
                };

                const formatPace = (seconds) => {
                    const mins = Math.floor(seconds / 60);
                    const secs = Math.floor(seconds % 60);
                    return `${mins}:${secs.toString().padStart(2, '0')}`;
                };

                document.getElementById('metricTime').textContent = formatTime(this.liveData.time);
                document.getElementById('metricDist').textContent = this.liveData.dist;
                document.getElementById('metricPace').textContent = formatPace(this.liveData.pace);
                document.getElementById('metricWatts').textContent = this.liveData.watts;
                document.getElementById('metricRate').textContent = this.liveData.rate;
                document.getElementById('metricHR').textContent = this.liveData.hr > 0 ? this.liveData.hr : '--';
            }

            // ========================================================================
            // WORKOUT PLANNING
            // ========================================================================

            addInterval() {
                const dist = parseInt(document.getElementById('quickDist').value);
                const restMin = parseInt(document.getElementById('quickRestMin').value) || 0;
                const restSec = parseInt(document.getElementById('quickRestSec').value) || 0;

                if (!dist || dist <= 0) {
                    this.showToast('Please enter valid distance', 'error');
                    return;
                }

                // Add work interval
                this.currentPlan.push({
                    type: 'WORK',
                    distance: dist
                });

                // Add rest interval if specified
                const totalRest = (restMin * 60) + restSec;
                if (totalRest > 0) {
                    this.currentPlan.push({
                        type: 'REST',
                        duration: totalRest
                    });
                }

                this.savePlan();
                this.renderPlan();
                this.showToast('Interval added', 'success');

                // Reset rest inputs
                document.getElementById('quickRestMin').value = '0';
                document.getElementById('quickRestSec').value = '0';
            }

            removeInterval(index) {
                this.currentPlan.splice(index, 1);
                this.savePlan();
                this.renderPlan();
            }

            clearPlan() {
                if (confirm('Clear all intervals?')) {
                    this.currentPlan = [];
                    this.savePlan();
                    this.renderPlan();
                    this.showToast('Plan cleared', 'success');
                }
            }

            renderPlan() {
                const container = document.getElementById('planList');
                const startBtn = document.getElementById('btnStart');

                if (this.currentPlan.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìã</div>
                            <div class="empty-state-text">No intervals added yet.<br>Add your first interval above.</div>
                        </div>
                    `;
                    startBtn.disabled = true;
                    return;
                }

                startBtn.disabled = false;

                const html = this.currentPlan.map((interval, index) => {
                    const formatTime = (secs) => {
                        const mins = Math.floor(secs / 60);
                        const seconds = secs % 60;
                        if (mins > 0) {
                            return `${mins}:${seconds.toString().padStart(2, '0')}`;
                        }
                        return `${seconds}s`;
                    };

                    if (interval.type === 'WORK') {
                        return `
                            <div class="interval-item">
                                <div>
                                    <div class="interval-type interval-work">Work</div>
                                    <div class="interval-detail">${interval.distance}m</div>
                                </div>
                                <button class="interval-remove" onclick="app.removeInterval(${index})">√ó</button>
                            </div>
                        `;
                    } else {
                        return `
                            <div class="interval-item">
                                <div>
                                    <div class="interval-type interval-rest">Rest</div>
                                    <div class="interval-detail">${formatTime(interval.duration)}</div>
                                </div>
                                <button class="interval-remove" onclick="app.removeInterval(${index})">√ó</button>
                            </div>
                        `;
                    }
                }).join('');

                container.innerHTML = html;
            }

            // ========================================================================
            // WORKOUT EXECUTION
            // ========================================================================

            startWorkout() {
                if (this.currentPlan.length === 0) {
                    this.showToast('No workout plan', 'error');
                    return;
                }

                this.currentWorkout = new Workout(this.currentPlan);
                this.navigate('screenRow');
                this.showToast('Workout started', 'success');
                
                // Show current interval info
                document.getElementById('currentInterval').style.display = 'block';
                this.updateIntervalInfo();
            }

            updateIntervalInfo() {
                if (!this.currentWorkout) return;

                const current = this.currentWorkout.currentInterval;
                const total = this.currentWorkout.intervals.length;
                const interval = this.currentWorkout.intervals[current];

                if (interval) {
                    document.getElementById('intervalInfo').textContent = 
                        `Interval ${current + 1} of ${total}`;
                    
                    if (interval.type === 'WORK') {
                        document.getElementById('intervalTarget').textContent = 
                            `Target: ${interval.distance}m`;
                    } else {
                        const formatTime = (secs) => {
                            const mins = Math.floor(secs / 60);
                            const seconds = secs % 60;
                            return `${mins}:${seconds.toString().padStart(2, '0')}`;
                        };
                        document.getElementById('intervalTarget').textContent = 
                            `Rest: ${formatTime(interval.duration)}`;
                    }
                }
            }

            endWorkout() {
                if (!this.currentWorkout) {
                    this.navigate('screenBuild');
                    return;
                }

                if (!confirm('End workout and save?')) return;

                // Create workout summary
                const workout = {
                    id: Date.now().toString(),
                    date: new Date().toISOString(),
                    description: this.currentWorkout.getDescription(),
                    workTime: this.formatTime(this.liveData.time),
                    distance: this.liveData.dist,
                    pace: this.formatPace(this.liveData.pace),
                    watts: this.liveData.watts,
                    avgHR: this.liveData.hr,
                    dragFactor: 0,
                    intervals: this.currentPlan
                };

                // Add to history
                this.history.unshift(workout);
                this.saveHistory();
                this.renderHistory();

                // Clean up
                this.currentWorkout = null;
                document.getElementById('currentInterval').style.display = 'none';
                
                // Reset live data
                this.liveData = { time: 0, dist: 0, pace: 0, watts: 0, rate: 0, hr: 0 };
                this.updateDashboard();

                this.showToast('Workout saved', 'success');
                this.navigate('screenHistory');
            }

            // ========================================================================
            // HISTORY
            // ========================================================================

            renderHistory() {
                const container = document.getElementById('historyList');

                if (this.history.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìä</div>
                            <div class="empty-state-text">No workouts recorded yet.<br>Complete your first workout to see it here.</div>
                        </div>
                    `;
                    return;
                }

                const html = this.history.map((workout, index) => {
                    const date = new Date(workout.date);
                    const dateStr = date.toLocaleDateString('en-US', { 
                        month: 'short', 
                        day: 'numeric',
                        year: 'numeric'
                    });

                    return `
                        <div class="history-item" onclick="app.showWorkoutDetail(${index})">
                            <div class="history-date">${dateStr}</div>
                            <div class="history-title">${workout.description}</div>
                            <div class="history-stats">
                                <span>${workout.distance}m</span>
                                <span>${workout.pace}</span>
                                <span>${workout.watts}W</span>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = html;
            }

            showWorkoutDetail(index) {
                const workout = this.history[index];
                const date = new Date(workout.date);
                const dateStr = date.toLocaleDateString('en-US', { 
                    weekday: 'long',
                    month: 'long', 
                    day: 'numeric',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                let html = `
                    <div class="card">
                        <div style="color:#666; font-size:12px; margin-bottom:12px;">${dateStr}</div>
                        <h2 style="color:var(--text); margin:0 0 24px 0; font-size:20px;">${workout.description}</h2>
                        
                        <div class="dash-metrics" style="margin-bottom:0;">
                            <div class="metric">
                                <div class="metric-value" style="font-size:28px;">${workout.workTime}</div>
                                <div class="metric-label">Time</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value" style="font-size:28px;">${workout.distance}</div>
                                <div class="metric-label">Meters</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value" style="font-size:28px;">${workout.pace}</div>
                                <div class="metric-label">Pace</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value" style="font-size:28px;">${workout.watts}</div>
                                <div class="metric-label">Watts</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value" style="font-size:28px;">${workout.avgHR || '--'}</div>
                                <div class="metric-label">Avg HR</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value" style="font-size:28px;">${workout.dragFactor || '--'}</div>
                                <div class="metric-label">Drag</div>
                            </div>
                        </div>
                    </div>
                `;

                // Add splits if available
                if (workout.splits && workout.splits.length > 0) {
                    html += `
                        <div class="card">
                            <div class="card-header">Splits</div>
                            ${workout.splits.map(split => `
                                <div class="interval-item">
                                    <div class="interval-detail">${split.dist}m</div>
                                    <div class="interval-type">${split.pace}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                document.getElementById('detailContent').innerHTML = html;
                document.getElementById('detailModal').classList.add('active');
            }

            closeModal() {
                document.getElementById('detailModal').classList.remove('active');
            }

            // ========================================================================
            // DATA MANAGEMENT
            // ========================================================================

            exportData() {
                const data = {
                    history: this.history,
                    settings: this.settings,
                    exportDate: new Date().toISOString()
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `rowing-data-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);

                this.showToast('Data exported', 'success');
            }

            resetData() {
                if (!confirm('This will delete ALL workout history and settings. Are you sure?')) {
                    return;
                }

                if (!confirm('This cannot be undone. Really delete everything?')) {
                    return;
                }

                localStorage.clear();
                this.history = [];
                this.settings = {};
                this.currentPlan = [];
                
                this.renderHistory();
                this.renderPlan();
                this.loadSettings();

                this.showToast('All data cleared', 'success');
            }

            // ========================================================================
            // NAVIGATION & UI
            // ========================================================================

            navigate(screenId) {
                // Update screens
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.remove('active');
                });
                document.getElementById(screenId).classList.add('active');

                // Update nav buttons
                const navItems = document.querySelectorAll('.nav-item');
                navItems.forEach(item => item.classList.remove('active'));
                
                const screenMap = {
                    'screenBuild': 0,
                    'screenRow': 1,
                    'screenHistory': 2,
                    'screenSettings': 3
                };
                
                const index = screenMap[screenId];
                if (index !== undefined) {
                    navItems[index].classList.add('active');
                }

                // Save settings when leaving settings screen
                if (screenId !== 'screenSettings' && this.lastScreen === 'screenSettings') {
                    this.saveSettings();
                }

                this.lastScreen = screenId;
            }

            showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = `toast ${type}`;
                
                // Trigger reflow
                void toast.offsetWidth;
                
                toast.classList.add('show');

                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }

            // ========================================================================
            // UTILITIES
            // ========================================================================

            formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            formatPace(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }
        }

        // ============================================================================
        // WORKOUT CLASS
        // ============================================================================

        class Workout {
            constructor(plan) {
                this.intervals = plan;
                this.currentInterval = 0;
                this.startTime = Date.now();
                this.dataPoints = [];
            }

            recordDataPoint(data) {
                this.dataPoints.push({
                    timestamp: Date.now() - this.startTime,
                    ...data
                });
            }

            getDescription() {
                const workIntervals = this.intervals.filter(i => i.type === 'WORK');
                if (workIntervals.length === 1) {
                    return `${workIntervals[0].distance}m`;
                }
                return `${workIntervals.length}x intervals`;
            }
        }

        // ============================================================================
        // INITIALIZE APP
        // ============================================================================

        const app = new RowingApp();
    </script>
</body>
</html>
