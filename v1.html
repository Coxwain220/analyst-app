<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ANALYST V11.1 (FINAL POLISH)</title>
    <style>
        :root { --bg: #050505; --text: #e0e0e0; --accent: #00FF99; --warn: #FFD700; --danger: #FF4444; --rest: #00AAFF; --panel: #121212; --border: #2a2a2a; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden; background: var(--bg); color: var(--text); font-family: 'Roboto', system-ui, sans-serif; }
        body { display: flex; flex-direction: column; }

        /* ANIMATIONS */
        @keyframes slideDown { from { transform: translate(-50%, -100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        @keyframes slideUpModal { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* TOAST */
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #222; color: #fff; border: 1px solid #444; padding: 12px 24px; border-radius: 30px; z-index: 5000; font-size: 13px; font-weight: bold; display:none; align-items:center; gap:15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); white-space: nowrap; }
        #toast.active { display: flex; animation: slideDown 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
        #toast.success { border-color: var(--accent); color: var(--accent); }
        #toast.error { border-color: var(--danger); color: var(--danger); }
        .toast-close { cursor: pointer; opacity: 0.7; font-size: 16px; }

        /* LAYOUT */
        .screen { display: none; flex: 1; flex-direction: column; overflow: hidden; position: relative; animation: fadeIn 0.2s ease-in-out; }
        .screen.active { display: flex; }
        .scroll-area { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 90px; -webkit-overflow-scrolling: touch; }
        .screen-header { display: flex; align-items: center; padding: 15px; background: var(--panel); border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .header-title { flex-grow: 1; text-align: center; font-weight: 800; font-size: 14px; letter-spacing: 1.5px; color: #888; text-transform: uppercase; }
        .header-btn { background: transparent; border: 1px solid #333; color: var(--accent); font-weight: bold; font-size: 11px; cursor: pointer; padding: 8px 14px; border-radius: 4px; transition: background 0.2s; }
        
        /* UI ELEMENTS */
        .card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 15px; margin-bottom: 15px; }
        .section-header { color: var(--accent); font-size: 11px; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 12px; border-bottom: 1px solid #333; padding-bottom: 6px; font-weight: 700; display:flex; justify-content:space-between; }
        
        /* ACCESSIBLE BUTTONS */
        .btn { width: 100%; padding: 14px; border-radius: 8px; font-weight: bold; cursor: pointer; border: none; text-transform: uppercase; font-size: 13px; margin-top: 8px; display: flex; align-items: center; justify-content: center; gap:8px; transition: all 0.2s ease; background: #222; color: #fff; border: 1px solid transparent; }
        .btn:hover { transform: scale(1.02); border-color: #444; background: #2a2a2a; }
        .btn:active { transform: scale(0.98); opacity: 0.8; }
        .btn:focus { outline: 2px solid var(--accent); outline-offset: 2px; }
        
        .btn-green { background: var(--accent); color: #000; }
        .btn-green:hover { background: #00cc7a; border-color: transparent; }
        .btn-outline { background: transparent; border: 1px solid #444; color: #888; }
        .btn-outline:hover { border-color: var(--accent); color: var(--accent); }
        .btn-blue { background: var(--rest); color: white; }
        .btn-danger { background: rgba(255,68,68,0.1); border: 1px solid var(--danger); color: var(--danger); }

        input, select, textarea { background: #080808; border: 1px solid #333; color: white; padding: 12px; border-radius: 6px; width: 100%; font-family: inherit; margin-bottom: 10px; font-size: 16px; transition: border-color 0.2s; }
        input:focus, select:focus, textarea:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 1px var(--accent); }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        label { font-size: 10px; color: #666; font-weight: bold; display: block; margin-bottom: 4px; text-transform: uppercase; }

        /* BUILDER COMPONENTS */
        .build-tabs { display: flex; background: #000; border-radius: 8px; padding: 4px; margin-bottom: 15px; border: 1px solid #333; }
        .b-tab { flex: 1; background: transparent; border: none; color: #666; padding: 10px; cursor: pointer; font-weight: bold; font-size: 12px; border-radius: 6px; transition: all 0.2s; }
        .b-tab.active { background: #222; color: white; }
        .toggle-section { border: 1px solid #333; border-radius: 8px; padding: 10px; margin-bottom: 10px; background: #0a0a0a; transition: background 0.2s; }
        .toggle-head { display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-size: 12px; font-weight: bold; color: #aaa; }
        .toggle-body { display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid #222; }
        .toggle-body.open { display: block; animation: fadeIn 0.3s; }

        .step-card { background: #151515; border: 1px solid #333; border-left: 4px solid #444; border-radius: 6px; padding: 12px; display: grid; grid-template-columns: 30px 1fr auto; align-items: center; gap: 12px; margin-bottom: 8px; cursor: pointer; transition: transform 0.1s; }
        .step-card:active { transform: scale(0.99); }
        .type-work { border-left-color: var(--accent); }
        .type-rest { border-left-color: var(--rest); }
        .step-main { font-weight: bold; font-size: 15px; color: #fff; }
        .step-tags { display: flex; gap: 5px; margin-top: 4px; flex-wrap: wrap; }
        .tag { font-size: 9px; background: #222; padding: 2px 6px; border-radius: 4px; color: #aaa; border: 1px solid #333; }

        /* LOGS */
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 16px; border-bottom: 1px solid #222; cursor: pointer; background: #111; transition: background 0.2s; }
        .history-item:hover { background: #1a1a1a; }
        .h-date { font-size: 10px; color: #666; font-weight: bold; margin-bottom: 2px; }
        .h-title { font-size: 14px; font-weight: bold; color: #fff; }
        .h-stats { font-family: monospace; color: var(--accent); font-size: 13px; }

        /* SETTINGS MENU */
        .settings-menu-btn { width: 100%; text-align: left; padding: 18px 10px; border-bottom: 1px solid #222; background: transparent; color: white; font-size:14px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; }
        .settings-menu-btn:hover { background: #1a1a1a; }
        .settings-section { display: none; height: 100%; }
        .settings-section.active { display: block; animation: fadeIn 0.2s; }

        /* DASHBOARD */
        .metric-huge { font-size: 18vw; font-weight: 900; line-height: 0.9; letter-spacing: -4px; color:white; text-align: center; font-variant-numeric: tabular-nums; }
        .metric-sub { font-size: 5vh; color: #888; font-weight: 700; margin-top: 10px; text-align: center; font-variant-numeric: tabular-nums; }
        .stat-box { display: flex; flex-direction: column; align-items: center; justify-content: center; background: #111; border: 1px solid #222; margin: 5px; border-radius: 12px; padding: 15px; }

        /* NAV BAR */
        .nav-bar { display: flex; background: var(--panel); border-top: 1px solid var(--border); height: 65px; flex-shrink: 0; z-index: 100; padding-bottom: env(safe-area-inset-bottom); }
        .nav-btn { flex: 1; background: transparent; border: none; color: #666; font-size: 10px; font-weight: bold; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.2s; }
        .nav-btn.active { color: var(--accent); background: #1a1a1a; transform: translateY(-2px); }
        .nav-btn:focus { outline: none; color: var(--accent); }
        .nav-icon { font-size: 20px; margin-bottom: 4px; }

        /* MODAL */
        #editModal, #logDetailModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index: 4000; display: none; flex-direction: column; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; }
        #editModal.active, #logDetailModal.active { display: flex; opacity: 1; }
        .modal-content { background: #111; padding: 20px; border-radius: 12px; border: 1px solid #333; width: 90%; max-width: 400px; transform: translateY(20px); transition: transform 0.3s; animation: slideUpModal 0.3s forwards; }
        #logDetailModal .modal-content { height: 80%; display: flex; flex-direction: column; padding: 0; overflow: hidden; }
        .modal-header { display: flex; align-items: center; padding: 15px; background: var(--panel); border-bottom: 1px solid var(--border); }
        .detail-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #222; }
        .detail-lbl { color: #666; font-size: 13px; }
        .detail-val { color: white; font-weight: bold; font-size: 14px; font-family: monospace; }

        /* CHAT */
        .chat-msg { background: #1a1a1a; padding: 10px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #333; font-size: 13px; color: #ddd; line-height: 1.4; white-space: pre-wrap; }
        .chat-msg.system { border-color: var(--accent); background: rgba(0, 255, 153, 0.05); }
        .plan-preview { background:#111; padding:10px; border-radius:6px; margin:10px 0; border:1px solid #444; }

        /* RESPONSIVE */
        @media (max-width: 600px) { .input-grid { grid-template-columns: 1fr; } .metric-huge { font-size: 20vw; } .btn { font-size: 14px; padding: 16px; } }
    </style>
</head>
<body>

    <div id="toast"><span id="toastMsg">Notification</span><span class="toast-close" onclick="hideToast()">√ó</span></div>

    <div id="screenBuilder" class="screen active">
        <div class="screen-header"><div class="header-title">MISSION CONTROL</div></div>
        <div class="scroll-area">
            
            <div class="card" id="aiCard">
                <div class="section-header">AI COMMANDER</div>
                <textarea id="aiInput" rows="2" placeholder="e.g. 4x500m @ 1:45, 2min rest..." aria-label="AI Workout Description"></textarea>
                <button class="btn btn-outline" id="btnGen" onclick="generateMission()" aria-label="Generate Plan">GENERATE PLAN</button>
            </div>

            <div class="card" id="manualCard">
                <div class="section-header">MANUAL ARCHITECT</div>
                <div class="build-tabs">
                    <button class="b-tab active" data-mode="DIST" onclick="setBuildMode('DIST')" aria-label="Distance Mode">DIST</button>
                    <button class="b-tab" data-mode="TIME" onclick="setBuildMode('TIME')" aria-label="Time Mode">TIME</button>
                    <button class="b-tab" data-mode="CAL" onclick="setBuildMode('CAL')" aria-label="Calories Mode">CAL</button>
                    <button class="b-tab" data-mode="INT" onclick="setBuildMode('INT')" aria-label="Interval Mode">INT</button>
                </div>
                <div id="inputArea">
                    <div id="modeDist"><div class="input-grid"><div><label>DISTANCE (M)</label><input type="number" id="mDist" value="2000"></div><div><label>SPLIT (M)</label><input type="number" id="mSplitDist" value="500"></div></div></div>
                    <div id="modeTime" style="display:none;"><div class="input-grid"><div><label>TIME (MIN)</label><input type="number" id="mTime" value="30"></div><div><label>SPLIT (MIN)</label><input type="number" id="mSplitTime" value="5"></div></div></div>
                    <div id="modeCal" style="display:none;"><div class="input-grid"><div><label>CALORIES</label><input type="number" id="mCal" value="300"></div><div><label>SPLIT CAL</label><input type="number" id="mSplitCal" value="50"></div></div></div>
                    <div id="modeInt" style="display:none;"><div class="input-grid"><div id="intValBox"><label>WORK DIST (M)</label><input type="number" id="mIntVal" value="500"></div><div><label>REPEATS</label><input type="number" id="mIntReps" value="4"></div></div></div>
                </div>
                <div style="margin-top:10px; border-top:1px solid #333; padding-top:10px;">
                    <label>REST PERIOD</label>
                    <div class="input-grid"><div><label>MIN</label><input type="number" id="mRestMin" value="0"></div><div><label>SEC</label><input type="number" id="mRestSec" value="0"></div></div>
                </div>
                <div class="toggle-section" style="margin-top:10px;">
                    <div class="toggle-head" onclick="toggleAdv('advTgt')"><span>+ TARGETS</span> <span id="lblTgt">OFF</span></div>
                    <div class="toggle-body" id="advTgt">
                        <div class="input-grid"><div><label>PACE</label><input type="text" id="mTgtPace" placeholder="1:55"></div><div><label>WATTS</label><input type="number" id="mTgtWatts" placeholder="200"></div><div><label>RATE</label><input type="number" id="mTgtRate" placeholder="26"></div><div><label>HR ZONE</label><input type="number" id="mTgtHR" placeholder="3" max="5"></div></div>
                    </div>
                </div>
                <button class="btn btn-green" onclick="addToPlan()" aria-label="Add to Plan">+ ADD TO PLAN</button>
            </div>

            <div class="section-header">FLIGHT PLAN</div>
            <div id="builderList"></div>
            
            <div style="height:20px;"></div>
            <button class="btn btn-green" onclick="goToStrategy()">ANALYZE & STRATEGIZE ‚Üí</button>
        </div>
    </div>

    <div id="screenHistory" class="screen">
        <div class="screen-header">
            <div class="header-title">LOGBOOK</div>
            <button class="header-btn" onclick="exportHistory()" aria-label="Export CSV">EXPORT CSV</button>
        </div>
        <div class="scroll-area" id="historyList"></div>
    </div>

    <div id="screenStrategy" class="screen">
        <div class="screen-header"><button class="header-btn" onclick="nav('screenBuilder')" aria-label="Back">‚Üê BACK</button><div class="header-title">STRATEGY</div><div style="width:40px;"></div></div>
        <div class="scroll-area">
            <div class="card"><div class="section-header">MISSION BRIEF</div><div id="stratSummary" style="font-size:16px; color:white;"></div></div>
            <div class="card">
                <div class="section-header">COACH</div>
                <div id="coachChat" style="max-height:300px; overflow-y:auto; margin-bottom:10px;"></div>
                <div style="display:flex; gap:10px;"><input type="text" id="coachIn" placeholder="Ask..."><button class="btn btn-outline" onclick="askCoach()" aria-label="Ask AI">ASK</button></div>
            </div>
            <button class="btn btn-green" onclick="startMission(false)" aria-label="Start">START ROW</button>
        </div>
    </div>

    <div id="dashScreen" class="screen">
        <div class="main-deck">
            <div style="font-size:14px; color:#888; font-weight:bold; letter-spacing:1px;" id="phaseBadge">WARMUP</div>
            <div class="metric-huge" id="dispPace">0:00</div>
            <div class="metric-sub"><span id="dispWatts">0</span>W <span style="color:#444">|</span> <span id="dispDist">0</span>m</div>
            <div style="color:var(--accent); font-size:14px; margin-top:5px; text-align: center;" id="tgtDisplay"></div>
        </div>
        <div class="lower-deck">
            <div class="stat-box"><div style="font-size:40px; color:white;" id="dispRate">0</div><div style="font-size:10px; color:#666;">s/m</div></div>
            <div class="stat-box"><div style="font-size:40px; color:white;" id="dispHR">--</div><div style="font-size:10px; color:#666;">HR</div></div>
        </div>
        <button class="btn btn-outline" style="margin:20px;" onclick="endMission()" aria-label="Finish">FINISH</button>
    </div>

    <div id="screenSettings" class="screen">
        <div class="screen-header"><div class="header-title">SETTINGS</div></div>
        <div class="scroll-area">
            <div id="settingsMenu">
                <button class="settings-menu-btn" onclick="openSetting('setAccount')"><span>üë§ PROFILE</span></button>
                <button class="settings-menu-btn" onclick="openSetting('setZones')"><span>‚ù§Ô∏è TRAINING ZONES</span></button>
                <button class="settings-menu-btn" onclick="openSetting('setData')"><span>üíæ SYSTEM & DATA</span></button>
            </div>

            <div id="setAccount" class="settings-section">
                <div class="card"><div class="section-header">BIO-DATA</div><div class="input-grid"><div><label>AGE</label><input type="number" id="bioAge"></div><div><label>WEIGHT (KG)</label><input type="number" id="bioWeight"></div></div></div>
                <button class="btn btn-outline" onclick="closeSetting()">BACK</button>
            </div>

            <div id="setZones" class="settings-section">
                <div class="card">
                    <div class="section-header">HEART RATE ZONES</div>
                    <div class="input-grid"><div><label>Z5 (MAX)</label><input type="number" id="hrZ5"></div><div><label>Z4</label><input type="number" id="hrZ4"></div><div><label>Z3</label><input type="number" id="hrZ3"></div><div><label>Z2</label><input type="number" id="hrZ2"></div><div><label>Z1 (RECOV)</label><input type="number" id="hrZ1"></div></div>
                </div>
                <button class="btn btn-green" onclick="saveSettings()">SAVE</button>
                <button class="btn btn-outline" onclick="closeSetting()">BACK</button>
            </div>

            <div id="setData" class="settings-section">
                <div class="card"><div class="section-header">SYSTEM</div><label>API KEY</label><input type="password" id="apiKeyInput" placeholder="Paste Key..."><select id="modelSelect" style="margin-top:10px;"><option value="gemini-1.5-flash">Default</option></select><div class="input-grid" style="margin-top:10px;"><button class="btn btn-outline" onclick="scanModels()">SCAN</button><button class="btn btn-green" onclick="testConnection()">TEST</button></div></div>
                <button class="btn btn-danger" onclick="clearData()">FACTORY RESET</button>
                <button class="btn btn-outline" onclick="closeSetting()">BACK</button>
            </div>
        </div>
    </div>

    <div id="logDetailModal">
        <div class="modal-content">
            <div class="modal-header"><button class="header-btn" onclick="document.getElementById('logDetailModal').classList.remove('active')" aria-label="Close Modal">‚Üê BACK</button><div class="header-title" style="flex-grow:1;text-align:center;">SESSION ANALYSIS</div></div>
            <div class="scroll-area" style="background:#000;"><div class="card" id="logDetailContent" style="border:none;"></div></div>
        </div>
    </div>

    <div id="editModal">
        <div class="modal-content">
            <div class="section-header">EDIT STEP</div>
            <label>TYPE</label><select id="editType"><option value="WORK">WORK</option><option value="REST">REST</option></select>
            <div class="input-grid"><div><label>DIST</label><input type="number" id="editDist"></div><div><label>TIME</label><input type="number" id="editTime"></div></div>
            <div style="border-top:1px solid #333; margin:10px 0; padding-top:10px;">
                <label style="color:var(--accent);">TARGETS</label>
                <div class="input-grid"><div><label>PACE</label><input type="text" id="editPace" placeholder="1:50"></div><div><label>RATE</label><input type="number" id="editRate" placeholder="26"></div></div>
                <label>WATTS</label><input type="number" id="editWatts" placeholder="200">
            </div>
            <div class="input-grid" style="margin-top:10px;"><button class="btn btn-outline" onclick="document.getElementById('editModal').classList.remove('active')">CANCEL</button><button class="btn btn-green" onclick="saveEditStep()">SAVE</button></div>
        </div>
    </div>

    <div class="nav-bar" role="navigation">
        <button class="nav-btn active" onclick="nav('screenBuilder')" id="navBuild" aria-label="Builder">BUILD</button>
        <button class="nav-btn" onclick="nav('dashScreen')" id="navDash" aria-label="Rowing Dashboard">ROW</button>
        <button class="nav-btn" onclick="nav('screenHistory')" id="navHist" aria-label="Logbook">LOGS</button>
        <button class="nav-btn" onclick="nav('screenSettings')" id="navSet" aria-label="Settings">SET</button>
    </div>

    <script>
        const PM5_SERVICE = 'ce060030-43e5-11e4-916c-0800200c9a66';
        const PM5_CHAR_32 = 'ce060032-43e5-11e4-916c-0800200c9a66'; 
        
        const App = {
            mission: { intervals: [] },
            history: [],
            profile: { hrZones: { z1: 108, z5: 180 }, model: "gemini-1.5-flash", bio: { age: 41, weight: 85 } },
            state: { active: false, intervalIdx: 0, timeLeft: 0, distLeft: 0, log: [], simLoop: null },
            pendingPlan: null
        };

        const PRELOAD_HISTORY = [{"id":"110986164","date":"2026-01-10T09:47:00","desc":"v2000m/4:00r...3 row","stats":{"work_time_fmt":"23:04.0","work_time_sec":1384.0,"rest_time_fmt":"12:00.0","rest_time_sec":720.0,"work_dist":6000,"rest_dist":143,"avg_rate":27,"stroke_count":645,"pace":"01:55.3","avg_watts":228,"cal_hr":1085,"total_cal":416,"avg_hr":174,"drag":135,"age":41,"weight":"Hwt","type":"RowErg","ranked":"No","comments":"first 2k fine..."}},{"id":"110898284","date":"2026-01-08T21:25:00","desc":"v1:00/1:00r...8 row","stats":{"work_time_fmt":"08:00.0","work_time_sec":480.0,"rest_time_fmt":"08:00.0","rest_time_sec":480.0,"work_dist":2077,"rest_dist":142,"avg_rate":21,"stroke_count":173,"pace":"01:55.5","avg_watts":227,"cal_hr":1080,"total_cal":141,"avg_hr":152,"drag":124,"age":41,"weight":"Hwt","type":"RowErg","ranked":"No","comments":""}},{"id":"110897422","date":"2026-01-08T21:06:00","desc":"5:00 row","stats":{"work_time_fmt":"05:00.0","work_time_sec":300.0,"rest_time_fmt":"","rest_time_sec":null,"work_dist":1162,"rest_dist":0,"avg_rate":25,"stroke_count":127,"pace":"02:09.0","avg_watts":163,"cal_hr":859,"total_cal":71,"avg_hr":142,"drag":124,"age":41,"weight":"Hwt","type":"RowErg","ranked":"No","comments":"Focussing on s/r only..."}},{"id":"110896911","date":"2026-01-08T20:59:00","desc":"5:00 row","stats":{"work_time_fmt":"05:00.0","work_time_sec":300.0,"rest_time_fmt":"nan","rest_time_sec":null,"work_dist":1200,"rest_dist":0,"avg_rate":25,"stroke_count":126,"pace":"02:05.0","avg_watts":179,"cal_hr":916,"total_cal":75,"avg_hr":143,"drag":124,"age":41,"weight":"Hwt","type":"RowErg","ranked":"No","comments":""}},{"id":"110896557","date":"2026-01-08T20:51:00","desc":"5:00 row","stats":{"work_time_fmt":"05:00.0","work_time_sec":300.0,"rest_time_fmt":"nan","rest_time_sec":null,"work_dist":1230,"rest_dist":0,"avg_rate":25,"stroke_count":128,"pace":"02:01.9","avg_watts":193,"cal_hr":964,"total_cal":78,"avg_hr":146,"drag":124,"age":41,"weight":"Hwt","type":"RowErg","ranked":"No","comments":""}},{"id":"110896149","date":"2026-01-08T20:43:00","desc":"5:00 row","stats":{"work_time_fmt":"05:00.0","work_time_sec":300.0,"rest_time_fmt":"","rest_time_sec":null,"work_dist":1234,"rest_dist":0,"avg_rate":25,"stroke_count":127,"pace":"02:01.5","avg_watts":195,"cal_hr":970,"total_cal":78,"avg_hr":139,"drag":124,"age":41,"weight":"Hwt","type":"RowErg","ranked":"No","comments":""}},{"id":"110710851","date":"2026-01-05T18:46:00","desc":"v1500m/4:00r...4 row","stats":{"work_time_fmt":"22:53.4","work_time_sec":1373.4,"rest_time_fmt":"16:00.0","rest_time_sec":960.0,"work_dist":6000,"rest_dist":169,"avg_rate":27,"stroke_count":647,"pace":"01:54.4","avg_watts":233,"cal_hr":1103,"total_cal":418,"avg_hr":176,"drag":146,"age":41,"weight":"Hwt","type":"RowErg","ranked":"No","comments":""}},{"id":"110604360","date":"2026-01-03T09:52:00","desc":"v1500m/4:00r...4 row","stats":{"work_time_fmt":"23:04.7","work_time_sec":1384.7,"rest_time_fmt":"16:00.0","rest_time_sec":960.0,"work_dist":6000,"rest_dist":184,"avg_rate":26,"stroke_count":636,"pace":"01:55.3","avg_watts":228,"cal_hr":1083,"total_cal":415,"avg_hr":174,"drag":143,"age":41,"weight":"Hwt","type":"RowErg","ranked":"No","comments":""}},{"id":"110394222","date":"2025-12-29T18:31:00","desc":"v1250m/4:00r...4 row","stats":{"work_time_fmt":"19:20.8","work_time_sec":1160.8,"rest_time_fmt":"16:00.0","rest_time_sec":960.0,"work_dist":5000,"rest_dist":160,"avg_rate":26,"stroke_count":524,"pace":"01:56.0","avg_watts":224,"cal_hr":1070,"total_cal":342,"avg_hr":0,"drag":137,"age":41,"weight":"Hwt","type":"RowErg","ranked":"No","comments":""}},{"id":"110319537","date":"2025-12-27T09:58:00","desc":"v800m/5:00r...6 row","stats":{"work_time_fmt":"18:13.1","work_time_sec":1093.1,"rest_time_fmt":"30:00.0","rest_time_sec":1800.0,"work_dist":4800,"rest_dist":196,"avg_rate":27,"stroke_count":513,"pace":"01:53.8","avg_watts":237,"cal_hr":1115,"total_cal":341,"avg_hr":0,"drag":124,"age":41,"weight":"Hwt","type":"RowErg","ranked":"No","comments":""}},{"id":"109804644","date":"2025-12-15T18:44:00","desc":"v3:00/r...3 row","stats":{"work_time_fmt":"06:00.0","work_time_sec":360.0,"rest_time_fmt":"","rest_time_sec":null,"work_dist":1482,"rest_dist":0,"avg_rate":28,"stroke_count":168,"pace":"02:01.4","avg_watts":195,"cal_hr":972,"total_cal":97,"avg_hr":0,"drag":133,"age":41,"weight":"Hwt","type":"RowErg","ranked":"No","comments":""}},{"id":"109804359","date":"2025-12-15T18:33:00","desc":"v3:00/r...3 row","stats":{"work_time_fmt":"06:00.0","work_time_sec":360.0,"rest_time_fmt":"","rest_time_sec":null,"work_dist":1465,"rest_dist":0,"avg_rate":25,"stroke_count":153,"pace":"02:02.8","avg_watts":189,"cal_hr":949,"total_cal":94,"avg_hr":0,"drag":133,"age":41,"weight":"Hwt","type":"RowErg","ranked":"No","comments":""}},{"id":"109804091","date":"2025-12-15T18:24:00","desc":"v3:00/r...3 row","stats":{"work_time_fmt":"06:00.0","work_time_sec":360.0,"rest_time_fmt":"","rest_time_sec":null,"work_dist":1456,"rest_dist":0,"avg_rate":23,"stroke_count":140,"pace":"02:03.6","avg_watts":185,"cal_hr":937,"total_cal":93,"avg_hr":0,"drag":133,"age":41,"weight":"Hwt","type":"RowErg","ranked":"No","comments":""}},{"id":"109803869","date":"2025-12-15T18:15:00","desc":"v3:00/r...3 row","stats":{"work_time_fmt":"06:00.0","work_time_sec":360.0,"rest_time_fmt":"","rest_time_sec":null,"work_dist":1471,"rest_dist":0,"avg_rate":21,"stroke_count":129,"pace":"02:02.3","avg_watts":191,"cal_hr":957,"total_cal":95,"avg_hr":0,"drag":133,"age":41,"weight":"Hwt","type":"RowErg","ranked":"No","comments":""}},{"id":"109803625","date":"2025-12-15T18:04:00","desc":"5:40 row","stats":{"work_time_fmt":"05:40.2","work_time_sec":340.2,"rest_time_fmt":"","rest_time_sec":null,"work_dist":1319,"rest_dist":0,"avg_rate":19,"stroke_count":109,"pace":"02:08.9","avg_watts":163,"cal_hr":861,"total_cal":81,"avg_hr":0,"drag":133,"age":41,"weight":"Hwt","type":"RowErg","ranked":"No","comments":""}},{"id":"109803877","date":"2025-12-15T17:56:00","desc":"4:21 row","stats":{"work_time_fmt":"04:21.1","work_time_sec":261.1,"rest_time_fmt":"","rest_time_sec":null,"work_dist":884,"rest_dist":0,"avg_rate":21,"stroke_count":90,"pace":"02:27.6","avg_watts":109,"cal_hr":673,"total_cal":48,"avg_hr":0,"drag":122,"age":41,"weight":"Hwt","type":"RowErg","ranked":"No","comments":""}},{"id":"109713405","date":"2025-12-13T12:35:00","desc":"40:00 row","stats":{"work_time_fmt":"40:00.0","work_time_sec":2400.0,"rest_time_fmt":"","rest_time_sec":null,"work_dist":9483,"rest_dist":0,"avg_rate":23,"stroke_count":921,"pace":"02:06.5","avg_watts":173,"cal_hr":894,"total_cal":592,"avg_hr":0,"drag":129,"age":41,"weight":"Hwt","type":"RowErg","ranked":"No","comments":"DF 129"}},{"id":"109526930","date":"2025-12-09T21:22:00","desc":"40:00 row","stats":{"work_time_fmt":"40:00.0","work_time_sec":2400.0,"rest_time_fmt":"","rest_time_sec":null,"work_dist":9292,"rest_dist":0,"avg_rate":23,"stroke_count":929,"pace":"02:09.1","avg_watts":162,"cal_hr":859,"total_cal":569,"avg_hr":0,"drag":135,"age":41,"weight":"Hwt","type":"RowErg","ranked":"No","comments":""}},{"id":"109462925","date":"2025-12-08T18:10:00","desc":"2000m row","stats":{"work_time_fmt":"07:24.2","work_time_sec":444.2,"rest_time_fmt":"","rest_time_sec":null,"work_dist":2000,"rest_dist":0,"avg_rate":27,"stroke_count":202,"pace":"01:51.0","avg_watts":256,"cal_hr":1179,"total_cal":143,"avg_hr":0,"drag":143,"age":41,"weight":"Hwt","type":"RowErg","ranked":"Yes","comments":""}},{"id":"105488743","date":"2025-08-26T21:12:00","desc":"32:00 row","stats":{"work_time_fmt":"32:00.0","work_time_sec":1920.0,"rest_time_fmt":"","rest_time_sec":0.0,"work_dist":7726,"rest_dist":0,"avg_rate":25,"stroke_count":807,"pace":"02:04.2","avg_watts":182,"cal_hr":927,"total_cal":491,"avg_hr":0,"drag":117,"age":40,"weight":"Hwt","type":"RowErg","ranked":"No","comments":""}}];

        window.onload = () => {
            loadData();
            // FORCE REFRESH HISTORY TO V11.1 DATA
            App.history = PRELOAD_HISTORY;
            localStorage.setItem('analyst_history', JSON.stringify(App.history));
            renderHistory();
            renderTimeline();
        };

        function nav(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if(id==='screenBuilder') document.getElementById('navBuild').classList.add('active');
            else if(id==='dashScreen') document.getElementById('navDash').classList.add('active');
            else if(id==='screenHistory') document.getElementById('navHist').classList.add('active');
            else if(id==='screenSettings') document.getElementById('navSet').classList.add('active');
        }

        function showToast(msg, type='success') {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            t.className = type + ' active';
            setTimeout(() => t.classList.remove('active'), 4000);
        }

        function validateApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (!key && !localStorage.getItem('gemini_api_key')) {
                showToast("API Key Required", 'error');
                return false;
            }
            return true;
        }

        function openSetting(id) {
            document.getElementById('settingsMenu').style.display = 'none';
            document.getElementById(id).classList.add('active');
        }
        function closeSetting() {
            document.querySelectorAll('.settings-section').forEach(s => s.classList.remove('active'));
            document.getElementById('settingsMenu').style.display = 'block';
        }

        let BUILD_MODE = 'DIST';
        function setBuildMode(mode) {
            BUILD_MODE = mode;
            document.querySelectorAll('.b-tab').forEach(b => b.classList.remove('active'));
            const targetTab = document.querySelector(`[data-mode=${mode}]`);
            if (targetTab) targetTab.classList.add('active');
            ['modeDist','modeTime','modeCal','modeInt'].forEach(d => document.getElementById(d).style.display = 'none');
            document.getElementById(`mode${mode}`).style.display = 'block';
        }

        function toggleAdv(id) {
            const el = document.getElementById(id);
            el.classList.toggle('open');
            const isOn = el.classList.contains('open');
            document.getElementById(id==='advPacer'?'lblPacer':'lblTgt').innerText = isOn ? "ON" : "OFF";
            document.getElementById(id==='advPacer'?'lblPacer':'lblTgt').style.color = isOn ? "var(--accent)" : "#666";
        }

        function updateIntInput() {
            const type = document.getElementById('mIntType').value;
            document.getElementById('intValBox').innerHTML = type==='DIST' ? 
                `<label>WORK DIST (M)</label><input type="number" id="mIntVal" value="500">` : 
                `<label>WORK TIME (MIN)</label><input type="number" id="mIntVal" value="1">`;
        }

        function addToPlan() {
            let steps = [];
            let targets = {};
            if(document.getElementById('advTgt').classList.contains('open')) {
                const pace = document.getElementById('mTgtPace').value;
                if(pace) targets.pace = paceToSec(pace);
                targets.watts = parseInt(document.getElementById('mTgtWatts').value) || 0;
                targets.rate = parseInt(document.getElementById('mTgtRate').value) || 0;
                targets.hr = parseInt(document.getElementById('mTgtHR').value) || 0;
            }
            const restMin = parseInt(document.getElementById('mRestMin').value) || 0;
            const restSec = parseInt(document.getElementById('mRestSec').value) || 0;
            const totalRest = (restMin * 60) + restSec;
            const createWork = (d, t) => ({ type:'WORK', dist:d||0, duration:t||0, targets: {...targets} });
            
            if(BUILD_MODE === 'DIST') {
                const d = parseInt(document.getElementById('mDist').value);
                steps.push(createWork(d, 0));
            } 
            else if(BUILD_MODE === 'TIME') {
                const t = parseFloat(document.getElementById('mTime').value) * 60;
                steps.push(createWork(0, t));
            }
            else if(BUILD_MODE === 'INT') {
                const reps = parseInt(document.getElementById('mIntReps').value);
                const val = parseInt(document.getElementById('mIntVal').value);
                for(let i=0; i<reps; i++) {
                    steps.push(createWork(val, 0));
                    if(i < reps-1 && totalRest > 0) steps.push({ type:'REST', duration:totalRest });
                }
            }
            if(BUILD_MODE !== 'INT' && totalRest > 0) steps.push({ type:'REST', duration:totalRest });
            App.mission.intervals.push(...steps);
            renderTimeline();
            showToast("Added to Plan", 'success');
        }

        function paceToSec(p) {
            if(!p.includes(':')) return 0;
            const parts = p.split(':');
            return parseInt(parts[0])*60 + parseInt(parts[1]);
        }

        function renderTimeline() {
            const list = document.getElementById('builderList');
            const frag = document.createDocumentFragment();
            list.innerHTML = "";
            if(App.mission.intervals.length === 0) { list.innerHTML = `<div style="text-align:center;color:#666;font-size:12px;padding:20px;border:1px dashed #333;">PLAN EMPTY</div>`; return; }
            App.mission.intervals.forEach((s, i) => {
                let div = document.createElement('div');
                div.className = `step-card ${s.type==='WORK'?'type-work':'type-rest'}`;
                let desc = s.type;
                if(s.dist) desc += ` ${s.dist}m`;
                else if(s.duration) desc += ` ${formatTime(s.duration)}`;
                let tags = "";
                if(s.targets?.pace) tags += `<span class="tag">Pace: ${formatTime(s.targets.pace)}</span>`;
                if(s.targets?.rate) tags += `<span class="tag">SR${s.targets.rate}</span>`;
                div.innerHTML = `<div class="step-main">${desc}</div><div class="step-tags">${tags}</div><div style="text-align:right;color:#666;" onclick="App.mission.intervals.splice(${i},1);renderTimeline()">√ó</div>`;
                div.onclick = (e) => { if(e.target.innerText !== '√ó') editStep(i); };
                frag.appendChild(div);
            });
            list.appendChild(frag);
        }

        function renderHistory() {
            const list = document.getElementById('historyList'); 
            const frag = document.createDocumentFragment();
            list.innerHTML = "";
            App.history.forEach(h => {
                let d = document.createElement('div'); d.className = 'history-item';
                d.innerHTML = `<div><div class="h-date">${h.date.split('T')[0]}</div><div class="h-title">${h.desc}</div></div><div class="h-stats">${h.stats.avg_watts}W</div>`;
                d.onclick = () => showLogDetail(h);
                frag.appendChild(d);
            });
            list.appendChild(frag);
        }

        function showLogDetail(h) {
            const d = document.getElementById('logDetailContent');
            const s = h.stats;
            d.innerHTML = `
                <div class="section-header">${new Date(h.date).toLocaleDateString()}</div>
                <div style="font-size:18px; font-weight:bold; color:white; margin-bottom:20px;">${h.desc}</div>
                <div class="detail-row"><span class="detail-lbl">WORK TIME</span><span class="detail-val">${s.work_time_fmt}</span></div>
                <div class="detail-row"><span class="detail-lbl">DISTANCE</span><span class="detail-val">${s.work_dist}m</span></div>
                <div class="detail-row"><span class="detail-lbl">PACE</span><span class="detail-val">${s.pace}</span></div>
                <div class="detail-row"><span class="detail-lbl">WATTS</span><span class="detail-val">${s.avg_watts}</span></div>
                <div class="detail-row"><span class="detail-lbl">STROKE RATE</span><span class="detail-val">${s.avg_rate}</span></div>
                <div class="detail-row"><span class="detail-lbl">HEART RATE</span><span class="detail-val">${s.avg_hr}</span></div>
                <div class="detail-row"><span class="detail-lbl">STROKES</span><span class="detail-val">${s.stroke_count}</span></div>
                <div class="detail-row"><span class="detail-lbl">CALORIES</span><span class="detail-val">${s.total_cal}</span></div>
                <div class="detail-row"><span class="detail-lbl">DRAG FACTOR</span><span class="detail-val">${s.drag}</span></div>
                <div style="margin-top:20px; color:#888; font-size:12px; font-style:italic;">${s.comments}</div>
            `;
            document.getElementById('logDetailModal').classList.add('active');
        }

        function launchJustRow() { App.mission.intervals = [{ type:'WORK', duration:999999, dist:0 }]; startMission(false); }
        function startMission(isSim) {
            if(App.mission.intervals.length === 0) return showToast("Plan Empty", 'error');
            nav('dashScreen');
            App.state = { active: true, intervalIdx: 0, timeLeft: 0, distLeft: 0, log: [], simLoop: null, connected: App.state.connected };
            setupNextInterval();
            if(isSim) App.state.simLoop = setInterval(() => processTelemetry(2.5, 26, 150, 220), 500);
            else if(!App.state.connected) connectBluetooth();
        }
        function setupNextInterval() {
            if(App.state.intervalIdx >= App.mission.intervals.length) { endMission(); return; }
            const int = App.mission.intervals[App.state.intervalIdx];
            App.state.timeLeft = int.duration > 0 ? int.duration : 99999;
            App.state.distLeft = int.dist > 0 ? int.dist : 0;
            document.getElementById('phaseBadge').innerText = int.type;
            let tgt = "";
            if(int.targets?.pace) tgt = `TGT: ${formatTime(int.targets.pace)}`;
            else if(int.targets?.watts) tgt = `TGT: ${int.targets.watts}W`;
            document.getElementById('tgtDisplay').innerText = tgt;
        }
        function processTelemetry(speed, rate, hr, watts) {
            if(!App.state.active) return;
            const int = App.mission.intervals[App.state.intervalIdx];
            App.state.timeLeft -= 0.5;
            if(speed > 0.1 && App.state.distLeft > 0) App.state.distLeft -= (speed*0.5);
            if((int.dist > 0 && App.state.distLeft <= 0) || (int.duration > 0 && int.duration < 99999 && App.state.timeLeft <= 0)) {
                App.state.intervalIdx++; setupNextInterval(); return;
            }
            let pace = speed>0.1 ? 500/speed : 0;
            document.getElementById('dispPace').innerText = formatTime(pace);
            document.getElementById('dispWatts').innerText = watts;
            document.getElementById('dispRate').innerText = rate;
            document.getElementById('dispHR').innerText = hr < 255 ? hr : "--";
            document.getElementById('dispDist').innerText = Math.floor(App.state.distLeft > 0 ? App.state.distLeft : 0);
            if(int.type === 'WORK') App.state.log.push({ t: new Date().toISOString(), w:watts, h:hr, r:rate });
        }
        function endMission() {
            App.state.active = false; if(App.state.simLoop) clearInterval(App.state.simLoop);
            let sumW=0, c=0; App.state.log.forEach(l=>{sumW+=l.w;c++});
            const sess = {
                id: Date.now(), date: new Date().toISOString(), desc: "Rowing Session",
                stats: { avg_watts: c?Math.round(sumW/c):0, avg_rate: 0, avg_hr: 0, pace: "0:00", work_time_fmt: "00:00" }
            };
            App.history.unshift(sess);
            localStorage.setItem('analyst_history', JSON.stringify(App.history));
            showToast("Saved"); nav('screenHistory'); renderHistory();
        }

        function formatTime(sec) {
            if(sec >= 99999) return "OPEN";
            let m = Math.floor(sec/60); let s = Math.floor(sec%60);
            return `${m}:${s.toString().padStart(2,'0')}`;
        }
        function saveSettings() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if(key) localStorage.setItem('gemini_api_key', key);
            App.profile.hrZones = { z5: document.getElementById('hrZ5').value, z1: document.getElementById('hrZ1').value };
            localStorage.setItem('analyst_profile', JSON.stringify(App.profile)); showToast("Saved");
        }
        function loadData() {
            const h = localStorage.getItem('analyst_history'); if(h) App.history = JSON.parse(h);
            const p = localStorage.getItem('analyst_profile');
            if(p) { App.profile = JSON.parse(p); document.getElementById('hrZ5').value = App.profile.hrZones.z5; document.getElementById('hrZ1').value = App.profile.hrZones.z1; }
            if(localStorage.getItem('gemini_api_key')) document.getElementById('apiKeyInput').value = localStorage.getItem('gemini_api_key');
        }
        
        let EDIT_INDEX = -1;
        function editStep(idx) {
            EDIT_INDEX = idx;
            const step = App.mission.intervals[idx];
            document.getElementById('editType').value = step.type;
            document.getElementById('editDist').value = step.dist || "";
            document.getElementById('editTime').value = step.duration || "";
            document.getElementById('editPace').value = step.targets?.pace ? formatTime(step.targets.pace) : "";
            document.getElementById('editRate').value = step.targets?.rate || "";
            document.getElementById('editWatts').value = step.targets?.watts || "";
            document.getElementById('editModal').classList.add('active');
        }
        function closeEditModal() { document.getElementById('editModal').classList.remove('active'); }
        function saveEditStep() {
            const step = App.mission.intervals[EDIT_INDEX];
            step.type = document.getElementById('editType').value;
            step.dist = parseInt(document.getElementById('editDist').value) || 0;
            step.duration = parseInt(document.getElementById('editTime').value) || 0;
            const paceStr = document.getElementById('editPace').value;
            let paceSec = 0;
            if(paceStr.includes(':')) { const p = paceStr.split(':'); paceSec = parseInt(p[0])*60 + parseInt(p[1]); }
            step.targets = {
                pace: paceSec,
                rate: parseInt(document.getElementById('editRate').value) || 0,
                watts: parseInt(document.getElementById('editWatts').value) || 0
            };
            if(step.dist > 0) step.duration = 0;
            closeEditModal();
            renderTimeline();
        }
        
        // --- IMPROVED AI CLEANER ---
        function cleanJson(text) {
            // Locate JSON array by finding first [ and last ]
            const start = text.indexOf('[');
            const end = text.lastIndexOf(']') + 1;
            if (start === -1 || end === 0) return text; 
            
            let json = text.substring(start, end);
            // Regex to quote unquoted keys (e.g., type: "WORK" -> "type": "WORK")
            json = json.replace(/(\w+)(?=\s*:)/g, '"$1"');
            return json;
        }

        async function generateMission() {
            if(!validateApiKey()) return;
            const key = document.getElementById('apiKeyInput').value || localStorage.getItem('gemini_api_key');
            const input = document.getElementById('aiInput').value;
            const btn = document.getElementById('btnGen');
            
            // FIX: Force default model if missing
            const model = App.profile.model || "gemini-1.5-flash";
            
            btn.innerText = "...";
            const PROMPT = `Parse workout: "${input}". Return JSON ARRAY: [{ "type": "WORK"|"REST", "dist": 0, "duration": 0, "targets": { "pace": 0, "watts": 0, "rate": 0 } }]. RULES: Pace "1:45"->105s. STRICT JSON ONLY. NO COMMENTS.`;
            
            try {
                const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
                    method: "POST", headers: {"Content-Type":"application/json"},
                    body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: PROMPT }] }] })
                });
                const d = await r.json();
                
                if(d.error) throw new Error(d.error.message);
                
                let txt = d.candidates[0].content.parts[0].text;
                txt = cleanJson(txt); // Run sanitizer
                
                App.mission.intervals = JSON.parse(txt);
                renderTimeline();
                showToast("Plan Generated", 'success');
            } catch(e) { showToast("AI Error: " + e.message, 'error'); }
            btn.innerText = "GENERATE PLAN";
        }
        
        async function askCoach(auto) {
            if(!validateApiKey()) return;
            const key = localStorage.getItem('gemini_api_key');
            if(!key) return;
            const chat = document.getElementById('coachChat');
            const q = auto ? "Tactical advice?" : document.getElementById('coachIn').value;
            if(!auto) chat.innerHTML += `<div class='chat-msg'>${q}</div>`;
            chat.innerHTML += `<div class='chat-msg system'>Thinking...</div>`;
            
            const model = App.profile.model || "gemini-1.5-flash";
            const prompt = `Coach me for: ${JSON.stringify(App.mission.intervals)}. Last session: ${JSON.stringify(App.history[0])}. Q: ${q}. Answer with <<<PLAN>>>JSON if changes needed.`;
            try {
                const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
                    method: "POST", headers: {"Content-Type":"application/json"},
                    body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: prompt }] }] })
                });
                const d = await r.json();
                const reply = d.candidates[0].content.parts[0].text;
                const parts = reply.split("<<<PLAN>>>");
                chat.lastElementChild.innerText = parts[0]; 
                
                if(parts.length > 1) {
                    try {
                        const jsonStr = cleanJson(parts[1]); // Sanitize
                        App.pendingPlan = JSON.parse(jsonStr);
                        
                        // Mission Brief Update Logic
                        let summary = App.pendingPlan.map(s => {
                           if(s.type === 'REST') return `${formatTime(s.duration)}r`;
                           return s.dist ? `${s.dist}m` : `${formatTime(s.duration)}`;
                        }).join(' + ');
                        document.getElementById('stratSummary').innerText = summary;

                        chat.innerHTML += `<div style='text-align:center;margin-top:10px;'><button class='btn btn-green' onclick='applyPendingPlan()'>APPLY PLAN TO BUILDER</button></div>`;
                    } catch(err) { console.log("JSON Parse Failed"); }
                }
            } catch(e) { chat.lastElementChild.innerText = "Error: " + e.message; }
        }

        function applyPendingPlan() {
            if(App.pendingPlan) {
                App.mission.intervals = App.pendingPlan;
                renderTimeline();
                nav('screenBuilder');
                showToast("Plan Updated", 'success');
            }
        }
        
        function goToStrategy() {
            if(App.mission.intervals.length === 0) return showToast("Empty Plan", 'error');
            nav('screenStrategy');
            let summary = App.mission.intervals.map(s => {
               if(s.type === 'REST') return `${formatTime(s.duration)}r`;
               return s.dist ? `${s.dist}m` : `${formatTime(s.duration)}`;
            }).join(' + ');
            document.getElementById('stratSummary').innerText = summary;
            
            // History Matching
            const json = JSON.stringify(App.mission.intervals);
            const match = App.history.find(h => (h.dist > 0 && json.includes(h.dist)) || h.desc.includes("2000"));
            // (Note: Context box was removed from UI per user request, but logic kept for internal AI use)
            
            askCoach(true);
        }
        
        async function connectBluetooth() { try { await navigator.bluetooth.requestDevice({filters:[{namePrefix:'PM5'}],optionalServices:[PM5_SERVICE]}); App.state.connected=true; document.getElementById('btConnectBtn').innerText="LINKED"; document.getElementById('btConnectBtn').style.color="#00FF00"; } catch(e){showToast("BT Error",'error');} }
        function exportHistory() { alert("Exporting CSV..."); }
        async function scanModels() { alert("Scanning..."); }
        async function testConnection() { alert("Testing..."); }
        function clearData() { if(confirm("Reset?")) { localStorage.clear(); location.reload(); } }
    </script>
</body>
</html>
