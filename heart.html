<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Analyst V6.3 - Timeout</title>
    <style>
        :root { --bg-color: #000000; --text-primary: #FF0000; }
        body { background-color: var(--bg-color); color: var(--text-primary); font-family: monospace; text-align: center; padding: 20px; }
        button { background: #333; color: white; border: 1px solid red; padding: 20px; font-size: 20px; width: 100%; margin-top: 20px; }
        #log { text-align: left; margin-top: 30px; color: #888; font-size: 12px; border-top: 1px solid #333; padding-top: 10px; }
    </style>
</head>
<body>
    <h1>DIAGNOSTIC V6.3</h1>
    <h2 id="bpm">-- BPM</h2>
    <button id="btn">CONNECT (5s TIMEOUT)</button>
    <div id="log">Logs appear here...</div>

    <script>
        const btn = document.getElementById('btn');
        const log = document.getElementById('log');
        const bpmDisplay = document.getElementById('bpm');

        function print(msg) {
            log.innerHTML = "> " + msg + "<br>" + log.innerHTML;
        }

        btn.addEventListener('click', async () => {
            try {
                print("Requesting Device...");
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [0x180D] }]
                });

                print("Device selected: " + device.name);
                print("Connecting (5s Timeout)...");

                // TIMEOUT LOGIC
                const connectPromise = device.gatt.connect();
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error("TIMEOUT: Device took too long.")), 5000)
                );

                const server = await Promise.race([connectPromise, timeoutPromise]);
                
                print("CONNECTED!");
                print("Getting Service...");
                const service = await server.getPrimaryService(0x180D);
                print("Getting Characteristic...");
                const characteristic = await service.getCharacteristic(0x2A37);
                
                await characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', (e) => {
                    const val = e.target.value;
                    const flags = val.getUint8(0);
                    let hr = (flags & 1) ? val.getUint16(1, true) : val.getUint8(1);
                    bpmDisplay.innerText = hr + " BPM";
                    print("Data Rx: " + hr);
                });

            } catch (error) {
                print("ERROR: " + error.message);
            }
        });
    </script>
</body>
</html>
